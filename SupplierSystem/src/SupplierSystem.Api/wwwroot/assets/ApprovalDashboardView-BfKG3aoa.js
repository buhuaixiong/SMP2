import{aP as e,h as a,d as l,u as t,g as s,c as r,C as o,aU as i,b as n,j as d,z as u,y as p,k as c,F as v,r as m,f as b,H as f,e as g,t as h,A as _,a9 as y,x as D,E as w,m as k,S as A,a4 as j,O as C,a1 as V,d_ as E,o as T,_ as q}from"./index-z18YH7Dc.js";import{v as I}from"./el-loading-7xWQcrrA.js";import{E as N,a as x}from"./el-radio-group-CyoiCAxu.js";import{a as S,E as z}from"./el-timeline-item-CTcraKjO.js";import{a as U,E as $}from"./el-table-column-CA4nIRHh.js";import"./el-scrollbar-CG2II4zE.js";import{E as B}from"./el-tag-S4xrfAE-.js";import{E as L}from"./el-divider-BD_m2uVZ.js";import{E as F,a as M}from"./el-descriptions-item-BLj0c7L_.js";import{E as P}from"./el-progress-BWguS6aN.js";import{E as W}from"./el-empty-BjWeTOWy.js";import{E as R,a as H}from"./el-form-item-cm6i1Rmw.js";/* empty css                 */import{E as O,a as K}from"./el-select-DoDq5h9m.js";import{E as Y}from"./el-card-D9ai6MQf.js";import{a as G,f as J,s as Q,u as X,b as Z,c as ee,e as ae}from"./upgrade-EIUR_vmF.js";import{r as le}from"./apiBaseUrl-Bx8aB0Mq.js";import{o as te}from"./fileDownload-CLokrmkZ.js";import{u as se}from"./useNotification-Bhw0wSDz.js";import"./_baseClone-DK5jo9D5.js";import"./castArray-0lMpEhXd.js";import"./debounce-CStugFZ2.js";const re=e("upgrade",()=>{const e=a([]),l=a(null),t=a(!1),s=a(!1),r=a(!1),o=a=>{if(!e.value.length&&!a)return;const l=e.value.length?e.value:a??[],t=new Map((a??l).map(e=>[e.code,e]));e.value=l.map(e=>{const a=t.get(e.code);return{...a??e,fulfilled:a?.fulfilled??e.fulfilled??!1,documentId:a?.documentId??e.documentId??null,template:a?.template??e.template??null}})},i=async e=>{t.value=!0;try{const a=await J(e);return l.value=a,o(a.requirements),a}finally{t.value=!1}};return{requirements:e,status:l,loading:t,submitting:s,actionLoading:r,loadRequirements:async()=>{const a=await G();return e.value=a,a},loadStatus:i,submitApplication:async(e,a)=>{s.value=!0;try{await Q(e,{documents:a}),await i(e)}finally{s.value=!1}},uploadRequirementFile:async e=>{const a=await X(e);return o(),{fileId:a.id}},decide:async(e,a,t,s)=>{r.value=!0;try{await Z(e,a,t),s?await i(s):l.value?.supplierId&&await i(l.value.supplierId)}finally{r.value=!1}},reset:()=>{e.value=[],l.value=null}}}),oe={class:"approval-dashboard-container"},ie={class:"header-content"},ne={class:"subtitle"},de={class:"stats-grid"},ue={class:"stat-item"},pe={class:"stat-value"},ce={class:"stat-label"},ve={class:"stat-item"},me={class:"stat-value urgent"},be={class:"stat-label"},fe={class:"stat-item"},ge={class:"stat-value"},he={class:"stat-label"},_e={class:"stat-item"},ye={class:"stat-value"},De={class:"stat-label"},we={class:"section-header"},ke={key:0,class:"empty-state"},Ae={key:1,class:"applications-list"},je={class:"app-header"},Ce={class:"app-info"},Ve={class:"app-title"},Ee={class:"supplier-name"},Te={class:"app-meta"},qe={key:0},Ie={key:0,class:"remaining-days"},Ne={class:"app-actions"},xe={class:"app-body"},Se={class:"progress-section"},ze={class:"progress-label"},Ue={class:"completeness"},$e={class:"documents-preview"},Be={class:"section-title"},Le={class:"document-tags"},Fe={key:0,class:"detail-content"},Me={key:0},Pe={class:"documents-section"},We={key:0},Re={key:1},He={key:1},Oe={class:"approval-history-section"},Ke={class:"timeline-content"},Ye={class:"timeline-header"},Ge={class:"step-name"},Je={class:"timeline-body"},Qe={class:"reviewer"},Xe={key:0,class:"comments"},Ze={key:0,class:"decision-section"},ea=q(l({__name:"ApprovalDashboardView",setup(e){const l=se(),{t:q}=t(),G=s(),J=re(),Q=a(!1),X=a(!1),ea=a(!1),aa=a(!1),la=a([]),ta=a([]),sa=a(!1),ra=a(null),oa=a([]),ia=a("pending"),na=a({status:"",urgency:"",search:""}),da=a({decision:"",comments:""});let ua=null;const pa=[{value:"pending_procurement_review",label:"approvalDashboard.statuses.pending_procurement_review"},{value:"pending_quality_review",label:"approvalDashboard.statuses.pending_quality_review"},{value:"pending_procurement_manager_review",label:"approvalDashboard.statuses.pending_procurement_manager_review"},{value:"pending_procurement_director_review",label:"approvalDashboard.statuses.pending_procurement_director_review"},{value:"pending_finance_director_review",label:"approvalDashboard.statuses.pending_finance_director_review"}],ca=r(()=>{if(!la.value.length)return null;const e=la.value.length,a=la.value.filter(e=>ka(e.dueAt)).length,l=new Date;l.setDate(l.getDate()-7);return{total:e,urgent:a,thisWeek:la.value.filter(e=>new Date(e.submittedAt)>=l).length,avgCompleteness:la.value.reduce((e,a)=>e+a.documentCompleteness,0)/e}}),va=(e,a)=>{let l=[...e];if(a&&na.value.status&&(l=l.filter(e=>e.status===na.value.status)),"urgent"===na.value.urgency?l=l.filter(e=>ka(e.dueAt)):"normal"===na.value.urgency&&(l=l.filter(e=>!ka(e.dueAt))),na.value.search){const e=na.value.search.toLowerCase();l=l.filter(a=>a.supplierName.toLowerCase().includes(e)||a.submittedBy.toLowerCase().includes(e))}return l.sort((e,a)=>{const l=ka(e.dueAt);return l!==ka(a.dueAt)?l?-1:1:new Date(a.submittedAt).getTime()-new Date(e.submittedAt).getTime()})},ma=r(()=>va(la.value,!0)),ba=r(()=>va(ta.value,!1)),fa=r(()=>[{key:"pending",title:q("approvalDashboard.sections.pending"),items:ma.value,loading:Q.value,emptyText:q("approvalDashboard.noApplications")},{key:"approved",title:q("approvalDashboard.sections.approved"),items:ba.value,loading:X.value,emptyText:q("approvalDashboard.noApprovedApplications")}]),ga=async()=>{Q.value=!0;try{const e=await ee();la.value=e}catch(e){l.error(e.message||q("approvalDashboard.loadError"))}finally{Q.value=!1}},ha=async()=>{X.value=!0;try{const e=await ae();ta.value=e}catch(e){l.error(e.message||q("approvalDashboard.loadError"))}finally{X.value=!1}},_a=async()=>{await Promise.all([ga(),ha()])},ya=e=>{if(!G.user)return!1;const a={pending_procurement_review:"supplier.upgrade.init",pending_quality_review:"supplier.upgrade.approve.quality",pending_procurement_manager_review:"supplier.upgrade.approve.manager",pending_procurement_director_review:"supplier.upgrade.approve.director",pending_finance_director_review:"supplier.upgrade.approve.finance"}[e.status];return!!a&&G.user.permissions?.includes(a)},Da=async()=>{if(ra.value&&da.value.decision){await l.confirm(q("approvalDashboard.confirmDecision",{decision:q(`approvalDashboard.decisions.${da.value.decision}`)}),q("common.confirm"),{type:"warning"}),aa.value=!0;try{const e={pending_procurement_review:"procurement_review",pending_quality_review:"quality_review",pending_procurement_manager_review:"procurement_manager_review",pending_procurement_director_review:"procurement_director_review",pending_finance_director_review:"finance_director_review"}[ra.value.status]||"";await Z(ra.value.id,e,{decision:da.value.decision,comments:da.value.comments||null}),l.success(q("approvalDashboard.decisionSuccess")),sa.value=!1,da.value={decision:"",comments:""},await _a()}catch(e){l.error(e.message||q("approvalDashboard.decisionError"))}finally{aa.value=!1}}},wa=async e=>{if(!e?.id)return;const a=(t=e.id,le(`/api/files/download/${t}`));var t;try{await te(a)}catch(s){l.error(s?.message||q("approvalDashboard.messages.fileNotFound"))}},ka=e=>{if(!e)return!1;const a=new Date(e),l=new Date,t=(a.getTime()-l.getTime())/864e5;return t<=3&&t>=0},Aa=e=>{if(!e)return null;const a=new Date(e),l=new Date;return Math.ceil((a.getTime()-l.getTime())/864e5)},ja=e=>e?new Date(e).toLocaleDateString():"-",Ca=e=>e?new Date(e).toLocaleString():"-",Va=e=>`${Math.round(e)}%`,Ea=e=>"approved"===e?"success":e.startsWith("pending")?"warning":"rejected"===e||"returned"===e?"danger":"info";let Ta=null;const qa=()=>{Ta&&clearTimeout(Ta),Ta=window.setTimeout(()=>{ga()},500)};return o(()=>{_a(),ua=window.setInterval(()=>{_a()},3e4)}),i(()=>{ua&&(clearInterval(ua),ua=null),Ta&&clearTimeout(Ta)}),(e,a)=>{const t=_,s=Y,r=K,o=O,i=H,G=w,Z=R,ee=W,ae=B,le=C,te=P,se=M,re=F,la=L,ta=$,ua=U,va=S,ma=z,ba=x,ha=N,Ta=f,Ia=I;return T(),n("div",oe,[d(s,{class:"header-card"},{default:c(()=>[g("div",ie,[g("div",null,[g("h2",null,h(b(q)("approvalDashboard.title")),1),g("p",ne,h(b(q)("approvalDashboard.subtitle")),1)]),d(t,{type:"primary",icon:b(y),onClick:_a,loading:Q.value||X.value},{default:c(()=>[D(h(b(q)("common.refresh")),1)]),_:1},8,["icon","loading"])])]),_:1}),ca.value?(T(),u(s,{key:0,class:"stats-card"},{default:c(()=>[g("div",de,[g("div",ue,[g("div",pe,h(ca.value.total),1),g("div",ce,h(b(q)("approvalDashboard.stats.total")),1)]),g("div",ve,[g("div",me,h(ca.value.urgent),1),g("div",be,h(b(q)("approvalDashboard.stats.urgent")),1)]),g("div",fe,[g("div",ge,h(ca.value.thisWeek),1),g("div",he,h(b(q)("approvalDashboard.stats.thisWeek")),1)]),g("div",_e,[g("div",ye,h(Va(ca.value.avgCompleteness)),1),g("div",De,h(b(q)("approvalDashboard.stats.avgCompleteness")),1)])])]),_:1})):p("",!0),d(s,{class:"filter-card"},{default:c(()=>[d(Z,{inline:!0,model:na.value,class:"filter-form"},{default:c(()=>[d(i,{label:b(q)("approvalDashboard.filters.status")},{default:c(()=>[d(o,{modelValue:na.value.status,"onUpdate:modelValue":a[0]||(a[0]=e=>na.value.status=e),clearable:"",onChange:ga},{default:c(()=>[(T(),n(v,null,m(pa,e=>d(r,{key:e.value,label:b(q)(e.label),value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),d(i,{label:b(q)("approvalDashboard.filters.urgency")},{default:c(()=>[d(o,{modelValue:na.value.urgency,"onUpdate:modelValue":a[1]||(a[1]=e=>na.value.urgency=e),clearable:"",onChange:ga},{default:c(()=>[d(r,{label:b(q)("approvalDashboard.urgency.urgent"),value:"urgent"},null,8,["label"]),d(r,{label:b(q)("approvalDashboard.urgency.normal"),value:"normal"},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),d(i,{label:b(q)("approvalDashboard.filters.search")},{default:c(()=>[d(G,{modelValue:na.value.search,"onUpdate:modelValue":a[2]||(a[2]=e=>na.value.search=e),placeholder:b(q)("approvalDashboard.searchPlaceholder"),clearable:"",onInput:qa},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1}),(T(!0),n(v,null,m(fa.value,e=>k((T(),u(s,{key:e.key,class:"applications-card"},{header:c(()=>[g("div",we,[g("span",null,h(e.title)+" ("+h(e.items.length)+")",1)])]),default:c(()=>[e.items.length?(T(),n("div",Ae,[(T(!0),n(v,null,m(e.items,a=>{return T(),n("div",{key:a.id,class:A(["application-item",{urgent:ka(a.dueAt)}])},[g("div",je,[g("div",Ce,[g("div",Ve,[g("span",Ee,h(a.supplierName),1),d(ae,{type:Ea(a.status),size:"small"},{default:c(()=>[D(h(b(q)(`approvalDashboard.statuses.${a.status}`)),1)]),_:2},1032,["type"]),ka(a.dueAt)?(T(),u(ae,{key:0,type:"danger",size:"small"},{default:c(()=>[D(h(b(q)("approvalDashboard.urgent")),1)]),_:1})):p("",!0)]),g("div",Te,[g("span",null,[d(le,null,{default:c(()=>[d(b(j))]),_:1}),D(" "+h(a.submittedBy),1)]),g("span",null,[d(le,null,{default:c(()=>[d(b(V))]),_:1}),D(" "+h(ja(a.submittedAt)),1)]),a.dueAt?(T(),n("span",qe,[d(le,null,{default:c(()=>[d(b(E))]),_:1}),D(" "+h(b(q)("approvalDashboard.dueDate"))+": "+h(ja(a.dueAt))+" ",1),null!==Aa(a.dueAt)?(T(),n("span",Ie," ("+h(Aa(a.dueAt))+h(b(q)("common.daysRemaining"))+") ",1)):p("",!0)])):p("",!0)])]),g("div",Ne,[d(t,{type:"primary",size:"small",onClick:t=>(async(e,a="pending")=>{ra.value=e,sa.value=!0,ia.value=a,ea.value=!0;try{const a=await J.loadStatus(e.supplierId);oa.value=a.reviews||[]}catch(t){l.error(t.message||q("approvalDashboard.loadDetailError"))}finally{ea.value=!1}})(a,e.key)},{default:c(()=>[D(h(b(q)("approvalDashboard.viewDetails")),1)]),_:1},8,["onClick"])])]),g("div",xe,[g("div",Se,[g("div",ze,[g("span",null,h(b(q)("approvalDashboard.currentStep"))+": "+h(b(q)(`upgradeManagement.steps.${a.currentStep}`)),1),g("span",Ue,h(Va(a.documentCompleteness)),1)]),d(te,{percentage:a.documentCompleteness,color:(s=a.documentCompleteness,s>=100?"#67c23a":s>=80?"#e6a23c":"#f56c6c")},null,8,["percentage","color"])]),g("div",$e,[g("div",Be,h(b(q)("approvalDashboard.documents")),1),g("div",Le,[(T(!0),n(v,null,m(a.documents,e=>(T(),u(ae,{key:e.id,type:e.file?"success":"info",size:"small",class:"doc-tag"},{default:c(()=>[D(h(e.requirementName),1)]),_:2},1032,["type"]))),128))])])])],2);var s}),128))])):(T(),n("div",ke,[d(ee,{description:e.emptyText},null,8,["description"])]))]),_:2},1024)),[[Ia,e.loading]])),128)),d(Ta,{modelValue:sa.value,"onUpdate:modelValue":a[6]||(a[6]=e=>sa.value=e),title:b(q)("approvalDashboard.applicationDetails"),width:"80%","close-on-click-modal":!1},{default:c(()=>[ra.value?k((T(),n("div",Fe,[d(re,{column:2,border:""},{default:c(()=>[d(se,{label:b(q)("approvalDashboard.supplierName")},{default:c(()=>[D(h(ra.value.supplierName),1)]),_:1},8,["label"]),d(se,{label:b(q)("approvalDashboard.applicationId")},{default:c(()=>[D(" #"+h(ra.value.id),1)]),_:1},8,["label"]),d(se,{label:b(q)("approvalDashboard.status")},{default:c(()=>[d(ae,{type:Ea(ra.value.status)},{default:c(()=>[D(h(b(q)(`approvalDashboard.statuses.${ra.value.status}`)),1)]),_:1},8,["type"])]),_:1},8,["label"]),d(se,{label:b(q)("approvalDashboard.currentStep")},{default:c(()=>[D(h(b(q)(`upgradeManagement.steps.${ra.value.currentStep}`)),1)]),_:1},8,["label"]),d(se,{label:b(q)("approvalDashboard.submittedBy")},{default:c(()=>[D(h(ra.value.submittedBy),1)]),_:1},8,["label"]),d(se,{label:b(q)("approvalDashboard.submittedAt")},{default:c(()=>[D(h(Ca(ra.value.submittedAt)),1)]),_:1},8,["label"]),d(se,{label:b(q)("approvalDashboard.dueDate")},{default:c(()=>[g("span",{class:A({"text-danger":ka(ra.value.dueAt)})},[D(h(ja(ra.value.dueAt))+" ",1),null!==Aa(ra.value.dueAt)?(T(),n("span",Me," ("+h(Aa(ra.value.dueAt))+h(b(q)("common.daysRemaining"))+") ",1)):p("",!0)],2)]),_:1},8,["label"]),d(se,{label:b(q)("approvalDashboard.completeness")},{default:c(()=>[D(h(Va(ra.value.documentCompleteness)),1)]),_:1},8,["label"])]),_:1}),d(la),g("div",Pe,[g("h3",null,h(b(q)("approvalDashboard.uploadedDocuments")),1),d(ua,{data:ra.value.documents,border:"",stripe:""},{default:c(()=>[d(ta,{label:b(q)("approvalDashboard.table.documentName"),prop:"requirementName","min-width":"150"},null,8,["label"]),d(ta,{label:b(q)("approvalDashboard.table.status"),width:"100"},{default:c(({row:e})=>[e.file?(T(),u(ae,{key:0,type:"success",size:"small"},{default:c(()=>[D(h(b(q)("approvalDashboard.uploaded")),1)]),_:1})):(T(),u(ae,{key:1,type:"info",size:"small"},{default:c(()=>[D(h(b(q)("approvalDashboard.notUploaded")),1)]),_:1}))]),_:1},8,["label"]),d(ta,{label:b(q)("approvalDashboard.table.validityPeriod"),width:"200"},{default:c(({row:e})=>[e.file&&e.file.validFrom&&e.file.validTo?(T(),n("span",We,h(ja(e.file.validFrom))+" ~ "+h(ja(e.file.validTo)),1)):(T(),n("span",Re,"-"))]),_:1},8,["label"]),d(ta,{label:b(q)("approvalDashboard.table.uploadedAt"),width:"180"},{default:c(({row:e})=>[D(h(e.file?Ca(e.file.uploadTime):"-"),1)]),_:1},8,["label"]),d(ta,{label:b(q)("common.actions"),width:"120",fixed:"right"},{default:c(({row:e})=>[e.file?(T(),u(t,{key:0,type:"primary",size:"small",link:"",onClick:a=>wa(e.file)},{default:c(()=>[D(h(b(q)("common.download")),1)]),_:1},8,["onClick"])):(T(),n("span",He,"-"))]),_:1},8,["label"])]),_:1},8,["data"])]),d(la),g("div",Oe,[g("h3",null,h(b(q)("approvalDashboard.approvalHistory")),1),oa.value.length?(T(),u(ma,{key:0},{default:c(()=>[(T(!0),n(v,null,m(oa.value,e=>(T(),u(va,{key:e.id,timestamp:Ca(e.decidedAt),type:"approved"===e.decision?"success":"danger"},{default:c(()=>[g("div",Ke,[g("div",Ye,[d(ae,{type:"approved"===e.decision?"success":"danger",size:"small"},{default:c(()=>[D(h(b(q)(`approvalDashboard.decisions.${e.decision}`)),1)]),_:2},1032,["type"]),g("span",Ge,h(e.stepName),1)]),g("div",Je,[g("div",Qe,h(e.decidedByName),1),e.comments?(T(),n("div",Xe,h(e.comments),1)):p("",!0)])])]),_:2},1032,["timestamp","type"]))),128))]),_:1})):(T(),u(ee,{key:1,description:b(q)("approvalDashboard.noHistory")},null,8,["description"]))]),d(la),"pending"===ia.value&&ya(ra.value)?(T(),n("div",Ze,[g("h3",null,h(b(q)("approvalDashboard.makeDecision")),1),d(Z,{model:da.value,"label-width":"100px"},{default:c(()=>[d(i,{label:b(q)("approvalDashboard.decision")},{default:c(()=>[d(ha,{modelValue:da.value.decision,"onUpdate:modelValue":a[3]||(a[3]=e=>da.value.decision=e)},{default:c(()=>[d(ba,{value:"approved"},{default:c(()=>[D(h(b(q)("approvalDashboard.approve")),1)]),_:1}),d(ba,{value:"rejected"},{default:c(()=>[D(h(b(q)("approvalDashboard.reject")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["label"]),d(i,{label:b(q)("approvalDashboard.comments")},{default:c(()=>[d(G,{modelValue:da.value.comments,"onUpdate:modelValue":a[4]||(a[4]=e=>da.value.comments=e),type:"textarea",rows:4,placeholder:b(q)("approvalDashboard.commentsPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),d(i,null,{default:c(()=>[d(t,{type:"primary",onClick:Da,loading:aa.value,disabled:!da.value.decision},{default:c(()=>[D(h(b(q)("approvalDashboard.submitDecision")),1)]),_:1},8,["loading","disabled"]),d(t,{onClick:a[5]||(a[5]=e=>sa.value=!1)},{default:c(()=>[D(h(b(q)("common.cancel")),1)]),_:1})]),_:1})]),_:1},8,["model"])])):p("",!0)])),[[Ia,ea.value]]):p("",!0)]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-0b426869"]]);export{ea as default};
