import{W as e,a as l,c as a,eu as t,aV as r,d as i,u as o,h as n,i as s,B as u,b as d,e as c,j as m,t as p,f,k as v,x as y,m as q,y as b,A as h,O as g,bW as _,F as w,r as k,S as I,z as C,w as N,aF as $,E as P,H as U,a5 as S,ev as x,o as D,_ as z,bA as V,ak as A,Z as T,a1 as R,C as j,aE as L,P as F,V as E,aO as Q,R as W,aU as O,cH as Y,I as M,N as B,g as H}from"./index-CyQdnTIC.js";import{v as G}from"./el-loading-oesi7HFc.js";import{E as K}from"./el-empty-ByHbktmc.js";import{E as J}from"./el-tag-eQgnjs1v.js";import{E as Z}from"./el-alert-BXhB-eTB.js";import{u as X,q as ee,d as le,t as ae}from"./rfq-M3h8wC6E.js";import{r as te,d as re}from"./RfqDetailView-sXRlNq7S.js";import{f as ie,p as oe}from"./dataParsing-ZXXCcBwJ.js";import{E as ne,a as se}from"./el-tab-pane-DV33jCZg.js";import{E as ue}from"./el-text-ndGzEAZg.js";import{E as de,a as ce}from"./el-descriptions-item-C3lsVx1m.js";import{E as me}from"./el-link-CQNmh80k.js";import{a as pe,E as fe,b as ve,c as ye}from"./el-table-column-DvsfEAIW.js";import{E as qe}from"./el-scrollbar-CTtrnhms.js";import{E as be,a as he}from"./el-form-item-DJ87vTOW.js";/* empty css                 */import{E as ge}from"./el-divider-BEySWtZA.js";import{E as _e,a as we}from"./el-col-DeDAYdEB.js";import{E as ke}from"./el-card-DJj_OhI8.js";import{u as Ie}from"./useNotification-DAUqvaBw.js";import{E as Ce}from"./el-result-0g-eS_qh.js";import{E as Ne,a as $e}from"./el-select-CdADVnxU.js";import{E as Pe}from"./el-switch-CQjvf-9P.js";import{E as Ue,a as Se}from"./el-timeline-item-CvFovLIE.js";import{E as xe}from"./el-upload-wfA8ygZ8.js";import"./el-progress-D5jEkcdx.js";import{P as De}from"./PriceComparisonDetailDialog-DmKI0iRx.js";import{C as ze}from"./ConfirmButton-WzHEZMVi.js";/* empty css                          */import"./PageHeader-CMpTsfBB.js";import"./apiBaseUrl-Bx8aB0Mq.js";import"./index-k8eOE22U.js";import"./_baseClone-CxGxK45k.js";import"./castArray-C2ko8TfK.js";import"./debounce-B4S_WZO2.js";import"./cloneDeep-B3nGyXfn.js";import"./el-image-viewer-Ob_QgRYt.js";async function Ve(l,a,t){return e(`/rfq/${l}/line-items/${a}/director-approve`,{method:"POST",body:t})}const Ae=(e,l=r(),a={})=>{const t=(e=>{if(e instanceof Date)return Number.isNaN(e.getTime())?null:e;if("number"==typeof e){const l=new Date(e);return Number.isNaN(l.getTime())?null:l}if("string"==typeof e){const l=new Date(e);return Number.isNaN(l.getTime())?null:l}return null})(e);if(!t)return"";return new Intl.DateTimeFormat(l,a).format(t)},Te=(e,l=r(),a={})=>{const t=(e=>{if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){const l=Number(e);return Number.isFinite(l)?l:null}return null})(e);if(null===t)return"";return new Intl.NumberFormat(l,a).format(t)},Re=()=>{const e=l(),i=a(()=>t(e.currentLocale));return{currentLocale:a(()=>e.currentLocale),intlLocale:i,formatDate:(e,l={})=>Ae(e,i.value,l),formatNumber:(e,l={})=>Te(e,i.value,l),formatCurrency:(e,l,a={})=>((e,l,a=r(),t={})=>Te(e,a,{style:"currency",currency:l,...t}))(e,l,i.value,a)}},je={class:"rfq-quote-comparison"},Le={class:"comparison-header"},Fe={key:0,class:"empty-state"},Ee={key:1,class:"comparison-content"},Qe={class:"quote-cards-section"},We={class:"cards-wrapper"},Oe={class:"detail-button-container"},Ye={class:"supplier-cards-grid"},Me=["onClick"],Be=["title"],He={class:"unit-price-display"},Ge={class:"supplier-cell"},Ke={class:"price-cell"},Je={key:0,class:"price-cell standard-cost-cell"},Ze={class:"price-meta"},Xe={key:1,class:"price-cell standard-cost-cell"},el={class:"comparison-summary"},ll={class:"summary-card"},al={class:"summary-label"},tl={class:"summary-value"},rl={class:"summary-card"},il={class:"summary-label"},ol={class:"summary-value"},nl={class:"summary-card"},sl={class:"summary-label"},ul={class:"summary-value"},dl={class:"summary-card"},cl={class:"summary-label"},ml={class:"summary-value"},pl={class:"summary-card"},fl={class:"summary-label"},vl={class:"summary-value"},yl={class:"summary-card"},ql={class:"summary-label"},bl={class:"summary-value"},hl={class:"summary-card"},gl={class:"summary-label"},_l={class:"summary-value"},wl={class:"summary-card"},kl={class:"summary-label"},Il={class:"summary-value"},Cl={key:0,class:"standard-cost-comparison"},Nl={style:{"font-size":"16px","font-weight":"600"}},$l={style:{"font-size":"13px",color:"#909399","margin-left":"8px"}},Pl={class:"cost-cards-container"},Ul={class:"supplier-name"},Sl={class:"cost-amount"},xl={class:"usd-cost"},Dl={class:"local-cost"},zl={key:1,class:"price-comparison-section"},Vl={style:{"font-size":"16px","font-weight":"600"}},Al={class:"platform-header"},Tl={class:"platform-name"},Rl={key:0,class:"uploaded-info"},jl={key:1},Ll={class:"uploaded-meta"},Fl={key:0},El={key:2,class:"uploaded-meta uploaded-meta--timestamp"},Ql=["disabled"],Wl={key:0,style:{"margin-top":"4px","font-size":"12px",color:"#909399"}},Ol={class:"platform-header"},Yl={class:"platform-name"},Ml={key:0,class:"uploaded-info"},Bl={key:1},Hl={class:"uploaded-meta"},Gl={key:0},Kl={key:2,class:"uploaded-meta uploaded-meta--timestamp"},Jl=["disabled"],Zl={key:0,style:{"margin-top":"4px","font-size":"12px",color:"#909399"}},Xl={class:"platform-header"},ea={class:"platform-name"},la={key:0,class:"uploaded-info"},aa={key:1},ta={class:"uploaded-meta"},ra={key:0},ia={key:2,class:"uploaded-meta uploaded-meta--timestamp"},oa=["disabled"],na={key:0,style:{"margin-top":"4px","font-size":"12px",color:"#909399"}},sa={key:0,class:"quote-detail"},ua={key:0,style:{margin:"0","white-space":"pre-wrap","word-break":"break-word"}},da={key:1},ca={key:0,style:{margin:"0","white-space":"pre-wrap","word-break":"break-word"}},ma={key:1},pa={class:"item-name"},fa={key:0,class:"item-spec"},va={key:0},ya={class:"tariff-detail-value"},qa={key:0,class:"tariff-detail-meta"},ba={key:1,class:"tariff-detail-meta"},ha={key:1},ga={key:0},_a={key:1},wa={key:2},ka={key:1},Ia={key:0,class:"supplier-profile"},Ca={key:1},Na={key:0},$a={key:1},Pa={key:0,class:"attachment-list"},Ua={key:1},Sa={key:1},xa=z(i({__name:"RfqQuoteComparison",props:{quotes:{},selectable:{type:Boolean,default:!1},rfqItems:{default:()=>[]},rfqId:{default:void 0},materialCategoryType:{default:void 0},distributionCategory:{default:void 0},existingPriceComparisons:{default:()=>[]}},setup(e){const l=Ie(),{t:t}=o(),{formatCurrency:r,formatDate:i,formatNumber:z}=Re(),V=["1688","jd","zkh"],A=e,T=n(!1),R=n(null),j=n(!1),L=n(null),F=e=>(e??[]).map(e=>{const l=e.storedName??e.stored_name??e.storedFileName??e.stored_file_name??null,a=e.filePath??e.file_path??null,t=te(a,l,"rfq-attachments")??e.downloadUrl??null;return{...e,storedName:l,originalName:e.originalName??e.original_name??e.fileName??e.file_name,downloadUrl:t}}),E=a(()=>F(R.value?.attachments??[])),Q=n(null),W=n(!1),O=s({1688:{file:null,url:"",price:null,uploaded:!1,records:[]},jd:{file:null,url:"",price:null,uploaded:!1,records:[]},zkh:{file:null,url:"",price:null,uploaded:!1,records:[]}}),Y=e=>{if("string"!=typeof e&&"number"!=typeof e)return null;const l=String(e).toLowerCase();return"1688"===l?"1688":"jd"===l?"jd":"zkh"===l||"������"===l||"zhenkunxing"===l?"zkh":null},M=e=>{V.forEach(e=>{const l=O[e];l.uploaded=!1,l.records=[],l.file||(l.url="",l.price=null)}),Array.isArray(e)&&e.map(e=>(e=>{const l=Y(e?.platform??e?.platformKey??e?.platform_key)??String(e?.platform??""),a=e?.original_file_name??e?.originalFileName??e?.file_name??e?.fileName??"",t=e?.filePath??e?.file_path??"",r=e?.stored_file_name??e?.storedFileName??("string"==typeof t?t.split("/").pop():"")??"",i=e?.productUrl??e?.product_url??null,o=e?.platformPrice??e?.platform_price??null,n=te(t,r,"rfq_price_comparison"),s="number"==typeof o?o:null==o||Number.isNaN(Number(o))?null:Number(o);return{...e,platform:l,fileName:a,storedFileName:r,productUrl:i,platformPrice:s,downloadUrl:n}})(e)).forEach(e=>{const l=Y(e.platform);if(!l)return;const a=O[l];if(a.uploaded=!0,a.records.push(e),e.productUrl&&(a.url=String(e.productUrl)),null!==e.platformPrice&&void 0!==e.platformPrice){const l="number"==typeof e.platformPrice?e.platformPrice:Number(e.platformPrice);Number.isFinite(l)&&(a.price=l)}})};u(()=>A.existingPriceComparisons,e=>{M(e)},{immediate:!0,deep:!0});const B=n(!1),H=a(()=>(console.log("[RfqQuoteComparison] Price comparison check:",{rfqId:A.rfqId,materialCategoryType:A.materialCategoryType,distributionCategory:A.distributionCategory,shouldShow:A.rfqId&&"IDM"===A.materialCategoryType}),!!A.rfqId&&"IDM"===A.materialCategoryType)),G=e=>{if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){const l=e.replace(/[��$���,\s]/g,""),a=Number(l);if(Number.isFinite(a))return a}return null},ee=e=>{let l=e.unitPrice??e.unit_price??null;if(!l&&e.quoteItems&&Array.isArray(e.quoteItems)&&e.quoteItems.length>0){const a=e.quoteItems.map(e=>G(e.unitPrice??e.unit_price)).filter(e=>null!==e);a.length>0&&(l=a.reduce((e,l)=>e+l,0)/a.length)}return G(l)},le=e=>e.tariffSummary??e.tariff_summary??null??null,ae=e=>{const l=le(e);if(l){if("USD"===l.standardCostCurrency&&null!==l.totalStandardCostUsd)return{amount:l.totalStandardCostUsd,currency:"USD"};if(null!==l.totalStandardCostLocal){const a=l.standardCostCurrency||l.currency||e.currency||"CNY";return{amount:l.totalStandardCostLocal,currency:a}}}if(e.quoteItems&&e.quoteItems.length>0){let l=0,a=!1;const t={};if(e.quoteItems.forEach(r=>{const i=G(r.tariffLineTotalUsd??r.standardLineCostUsd??r.standardUnitCostUsd),o=G(r.tariffLineTotal??r.standardLineCostLocal??r.standardUnitCostLocal);if(null!==i)l+=i,a=!0;else if(null!==o){const l=r.tariffCalculation?.standardCostCurrency??r.standardCostCurrency??e.currency??"CNY";t[l]=(t[l]||0)+o}}),a)return{amount:l,currency:"USD"};const[r,i]=Object.entries(t)[0]??[];if(r&&void 0!==i)return{amount:i,currency:r}}return{amount:null,currency:e.currency||"CNY"}},re=e=>{const l=ae(e),a=(e=>e.quoteItems&&0!==e.quoteItems.length?e.quoteItems.reduce((e,l)=>{const a=Number(l.quantity??l.rfqQuantity??l.lineQuantity??l.minimumOrderQuantity??0);return Number.isFinite(a)?e+a:e},0):0)(e);return l.amount&&a?{amount:l.amount/a,currency:l.currency}:{amount:null,currency:l.currency}},ie=e=>{const l=le(e);return!!l?.hasSpecialTariff||!!(e.quoteItems&&e.quoteItems.length>0)&&e.quoteItems.some(e=>Boolean(e.tariffCalculation?.hasSpecialTariff))},oe=a(()=>{console.log("[RfqQuoteComparison] Computing numeric unit prices from quotes:",A.quotes);const e=A.quotes.map(e=>{const l=ee(e);return console.log(`[RfqQuoteComparison] Quote ${e.id}:`,{unitPrice:e.unitPrice,unit_price:e.unit_price,totalAmount:e.totalAmount,quoteItemsCount:e.quoteItems?.length||0,calculated:l}),l}).filter(e=>null!==e);return console.log("[RfqQuoteComparison] Final numeric prices:",e),e}),ve=a(()=>0===oe.value.length?null:Math.min(...oe.value)),ye=a(()=>0===oe.value.length?null:Math.max(...oe.value)),qe=a(()=>{if(0===oe.value.length)return null;return oe.value.reduce((e,l)=>e+l,0)/oe.value.length}),Ce=a(()=>null===ve.value||null===ye.value||ve.value<=0||ye.value<=0?null:(ye.value-ve.value)/ve.value*100),Ne=a(()=>A.quotes.reduce((e,l)=>(e[l.id]={total:ae(l),unit:re(l),summary:le(l),hasSpecialTariff:ie(l)},e),{})),$e=a(()=>Object.values(Ne.value).map(e=>null!==e.summary?.totalStandardCostUsd&&void 0!==e.summary?.totalStandardCostUsd?e.summary.totalStandardCostUsd:"USD"===e.total.currency&&null!==e.total.amount?e.total.amount:null).filter(e=>null!==e)),Pe=a(()=>0===$e.value.length?null:Math.min(...$e.value)),Ue=a(()=>0===$e.value.length?null:Math.max(...$e.value)),Se=a(()=>{if(0===$e.value.length)return null;return $e.value.reduce((e,l)=>e+l,0)/$e.value.length}),xe=a(()=>{let e=null,l=null;return Object.entries(Ne.value).forEach(([a,t])=>{const r=t.summary?.totalStandardCostUsd??("USD"===t.total.currency?t.total.amount:null);null!=r&&(null===e||r<e)&&(e=r,l=Number(a))}),l}),De=a(()=>Object.values(Ne.value).filter(e=>e.hasSpecialTariff).length),ze=a(()=>[...A.quotes].filter(e=>{const l=Ne.value[e.id];if(!l)return!1;const a=l.summary?.totalStandardCostUsd??("USD"===l.total.currency?l.total.amount:null);return null!=a}).sort((e,l)=>{const a=Ne.value[e.id],t=Ne.value[l.id];return(a.summary?.totalStandardCostUsd??a.total.amount??0)-(t.summary?.totalStandardCostUsd??t.total.amount??0)})),Ve=(e,l)=>{const a=Ne.value[e.id];if(!a)return"-";if("USD"===l){const e=a.summary?.totalStandardCostUsd??("USD"===a.total.currency?a.total.amount:null);return null==e?"-":`US${e.toFixed(2)}`}{const e=a.summary?.totalStandardCostLocal??a.total.amount;return a.summary?.standardCostCurrency??a.total.currency,null==e?"-":`¥${e.toFixed(2)}`}},Ae=n(!1),Te=n(null),xa=(e,l="CNY")=>{const a=G(e);return null===a?"-":r(a,l)},Da=e=>e?i(e,{year:"numeric",month:"2-digit",day:"2-digit"}):"-",za=e=>e?i(e,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",Va=a(()=>{const e=new Map;return A.rfqItems.forEach(l=>{const a=l.id??(null!=l.rfqLineItemId?Number(l.rfqLineItemId):void 0)??(null!=l.rfqItemId?Number(l.rfqItemId):void 0);null!=a&&e.set(a,l)}),e}),Aa=a(()=>{const e=R.value;return e?.quoteItems&&0!==e.quoteItems.length?e.quoteItems.map((l,a)=>{const r=l,i=l.rfqLineItemId??l.rfqItemId??("number"==typeof r.rfq_line_item_id?r.rfq_line_item_id:null==r.rfq_line_item_id||Number.isNaN(Number(r.rfq_line_item_id))?void 0:Number(r.rfq_line_item_id))??("number"==typeof r.rfq_item_id?r.rfq_item_id:null==r.rfq_item_id||Number.isNaN(Number(r.rfq_item_id))?void 0:Number(r.rfq_item_id)),o=null!=i?Va.value.get(i):void 0,n=l.quantity??("number"==typeof r.quantity?r.quantity:void 0)??o?.quantity??null,s=o?.unit??null,u="number"==typeof n?n:null==n||Number.isNaN(Number(n))?null:Number(n),d=null!=u?s?`${u} ${s}`:`${u}`:s||"-",c=G(l.unitPrice),m=G(l.totalPrice??l.totalAmount),p=o?.itemName??o?.materialCategory??t("rfq.quotes.items.unknownItem",{index:a+1}),f=o?.specifications??o?.parameters??("string"==typeof l.parameters?l.parameters:"string"==typeof r.parameters?r.parameters:void 0),v="string"==typeof l.brand&&l.brand.trim().length>0?l.brand.trim():o?.brand?String(o.brand):"",y=l.productGroup??r.product_group??o?.materialCategory??null,q=l.productOrigin??r.product_origin??null,b=l.tariffCalculation??(r.tariffCalculation||r.tariff_calculation)??null;let h=G(b?.standardCost),g=b?.standardCostCurrency?.toString()??r.standard_cost_currency??(null!==h?e.currency??"CNY":"USD"),_=G(l.standardLineCostUsd??l.standardLineCostLocal??r.standard_line_cost_usd??r.standard_line_cost_local);if(b&&void 0!==b.standardCostUsd&&null!==b.standardCostUsd){const e=G(b.standardCostUsd);null!==e&&(h=e,g="USD",null!=u&&(_=Number((e*u).toFixed(2))))}else null===h||null==u||null!==_&&!Number.isNaN(_)||(_=Number((h*u).toFixed(2)));null===h&&null!==_&&u&&(h=Number((_/u).toFixed(4)));const w=b&&"number"==typeof b.tariffRate?b.tariffRate:null,k=b&&"number"==typeof b.specialTariffRate?b.specialTariffRate:null,I=Boolean(b?.hasSpecialTariff)??!1;return g=g||e.currency||"CNY",{key:`${e.id}-${a}`,itemName:p,specifications:f||void 0,quantityLabel:d,unitPrice:c,totalPrice:m,deliveryDate:l.deliveryDate??null,brandLabel:v,productGroup:y||null,productOrigin:q||null,standardUnitCost:h,standardUnitCostCurrency:g,standardLineTotal:_,tariffRate:w,specialTariffRate:k,hasSpecialTariff:I}}):[]}),Ta=e=>null===e?"-":`${z(e,{minimumFractionDigits:1,maximumFractionDigits:1})}%`,Ra=e=>null===e?"-":Ta(100*e),ja=e=>{const l="string"==typeof e.brand&&e.brand.trim().length>0?e.brand.trim():"",a=(e=>{if(!e?.quoteItems||0===e.quoteItems.length)return[];const l=new Set;return e.quoteItems.forEach(e=>{const a=e.brand;"string"==typeof a&&a.trim().length>0&&l.add(a.trim())}),Array.from(l)})(e),t=new Set;return l&&l.split(",").map(e=>e.trim()).forEach(e=>{e.length>0&&t.add(e)}),a.forEach(e=>{e.length>0&&t.add(e)}),0===t.size?"-":Array.from(t).join(", ")},La=e=>{if(null==e||Number.isNaN(e))return"-";if(e<1024)return`${e} B`;const l=e/1024;if(l<1024)return`${z(l,{maximumFractionDigits:1})} KB`;const a=l/1024;if(a<1024)return`${z(a,{maximumFractionDigits:1})} MB`;return`${z(a/1024,{maximumFractionDigits:1})} GB`},Fa=({row:e})=>{const l=[];"selected"===e.status&&l.push("selected-row");const a=G(e.unitPrice??e.unit_price);var t;return null!==a&&null!==ve.value&&a===ve.value&&l.push("lowest-price-row"),null!==xe.value&&e.id===xe.value&&l.push("lowest-standard-row"),(t=e,Ne.value[t.id])?.hasSpecialTariff&&l.push("special-tariff-row"),l.join(" ")},Ea=e=>{Qa(e)},Qa=e=>{R.value=e,T.value=!0},Wa=a(()=>{if(0===A.quotes.length)return[];return[{key:"standardCost",label:"rfq.priceComparison.detailLabels.standardCost"},{key:"originalPrice",label:"rfq.priceComparison.detailLabels.originalPrice"},{key:"shippingFee",label:"rfq.quoteComparison.shippingFee"},{key:"specialTariff",label:"rfq.priceComparison.detailLabels.specialTariff"},{key:"moq",label:"rfq.priceComparison.detailLabels.moq"},{key:"spq",label:"rfq.priceComparison.detailLabels.spq"},{key:"deliveryTime",label:"rfq.priceComparison.detailLabels.leadTime"},{key:"productOrigin",label:"rfq.priceComparison.detailLabels.productOrigin"},{key:"quoteAttachments",label:"rfq.quoteComparison.quoteAttachments"}].map(e=>{const l={};let a=null,t=null;return A.quotes.forEach(r=>{const i=Ne.value[r.id];let o=null;switch(e.key){case"standardCost":o=null!==i?.total.amount?xa(i.total.amount,i.total.currency||"USD"):"-",null!==i?.total.amount&&(null===t||i.total.amount<t)&&(t=i.total.amount,a=r.id);break;case"originalPrice":o=xa(ee(r),r.currency||"CNY");const e=ee(r);null!==e&&(null===t||e<t)&&(t=e,a=r.id);break;case"shippingFee":o="-";break;case"specialTariff":if(r.quoteItems&&r.quoteItems[0]?.tariffCalculation){const e=r.quoteItems[0].tariffCalculation.specialTariffRate;o=null!=e?Ra(e):"-"}else o="-";break;case"moq":if(r.quoteItems&&r.quoteItems[0]){const e=r.quoteItems[0].minimumOrderQuantity||r.quoteItems[0].moq;o=null!=e?Oa(e):"-",null!=e&&(null===t||e<t)&&(t=e,a=r.id)}else o="-";break;case"spq":if(r.quoteItems&&r.quoteItems[0]){const e=r.quoteItems[0].standardPackageQuantity||r.quoteItems[0].spq;o=null!=e?Oa(e):"-"}else o="-";break;case"deliveryTime":if(r.quoteItems&&r.quoteItems[0]){const e=r.quoteItems[0].deliveryDate||r.deliveryDate;o=e?Da(e):"-"}else o=r.deliveryDate?Da(r.deliveryDate):"-";break;case"productOrigin":o=r.quoteItems&&r.quoteItems[0]?r.quoteItems[0].productOrigin||r.shippingCountry||"-":r.shippingCountry||"-";break;case"quoteAttachments":{const e=F(r.attachments??[]);o=e.length?e:[];break}}l[r.id]=o}),{key:e.key,field:e.label,values:l,bestQuoteId:["standardCost","originalPrice","moq"].includes(e.key)?a:null}})}),Oa=e=>{if(null==e)return"-";const l=G(e);return null!==l?(new Intl.NumberFormat).format(l):"string"==typeof e?e:String(e)},Ya=(e,l,a="EA")=>{if(null==e)return"-";return`${{CNY:"¥",USD:"$",EUR:"€",JPY:"¥",THB:"฿"}[l]||l}${new Intl.NumberFormat("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}/${a}`},Ma=e=>e.quoteItems&&e.quoteItems.length>0&&e.quoteItems[0].unit||"EA",Ba=e=>e.taxStatus?e.taxStatus:e.quoteItems&&e.quoteItems.length>0&&e.quoteItems[0]?.taxStatus?e.quoteItems[0].taxStatus:"inclusive",Ha=(e,l)=>{const a=l.target;a.files&&a.files.length>0&&(O[e].file=a.files[0])},Ga=async e=>{if(!A.rfqId)return void l.error("RFQ ID is missing");const a=O[e];if(a.file&&a.url&&null!==a.price){B.value=!0;try{const r=await X(A.rfqId,e,a.file,a.price,a.url);a.uploaded=!0,a.uploadedData=r,l.success(t("rfq.priceComparison.uploadSuccess",{platform:t(`rfq.priceComparison.${e}`)})||`${e}�۸�Ա��ϴ��ɹ�`)}catch(r){l.error(r.message||t("rfq.priceComparison.uploadError"))}finally{B.value=!1}}else l.warning(t("rfq.priceComparison.required",{platforms:t(`rfq.priceComparison.${e}`)}))};return(l,a)=>{const r=ue,i=K,o=g,n=h,s=J,u=fe,z=pe,V=ke,A=we,F=_e,Y=ge,M=Z,G=me,X=he,le=P,ae=be,te=ce,re=de,ie=U,oe=se,Ie=ne;return D(),d("div",je,[c("div",Le,[c("h3",null,p(f(t)("rfq.quotes.comparison")),1),m(r,{type:"info"},{default:v(()=>[y(p(f(t)("rfq.quotes.totalQuotes",{count:e.quotes.length})),1)]),_:1})]),0===e.quotes.length?(D(),d("div",Fe,[m(i,{description:f(t)("rfq.quotes.noQuotes")},null,8,["description"])])):(D(),d("div",Ee,[c("div",Qe,[c("div",We,[c("div",Oe,[m(n,{type:"primary",text:"",onClick:a[0]||(a[0]=e=>W.value=!0)},{default:v(()=>[y(p(f(t)("rfq.quoteComparison.viewDetails"))+" ",1),m(o,null,{default:v(()=>[m(f(_))]),_:1})]),_:1})]),c("div",Ye,[(D(!0),d(w,null,k(e.quotes,e=>(D(),d("div",{key:e.id,class:I(["supplier-card",{selected:Q.value===e.id,"has-special-tariff":Ne.value[e.id]?.hasSpecialTariff}]),onClick:l=>{return a=e.id,void(Q.value=a);var a}},[c("div",{class:"company-name",title:e.companyName||e.supplierName},p(e.companyName||e.supplierName),9,Be),c("div",He,[e.quoteItems&&e.quoteItems[0]?(D(),d(w,{key:0},[null!==e.quoteItems[0].standardUnitCostLocal&&void 0!==e.quoteItems[0].standardUnitCostLocal?(D(),d(w,{key:0},[y(p(Ya(e.quoteItems[0].standardUnitCostLocal,e.quoteItems[0].currency||"CNY",e.quoteItems[0].unit||"EA")),1)],64)):null!==e.quoteItems[0].standardUnitCostUsd&&void 0!==e.quoteItems[0].standardUnitCostUsd?(D(),d(w,{key:1},[y(p(Ya(e.quoteItems[0].standardUnitCostUsd,"USD",e.quoteItems[0].unit||"EA")),1)],64)):(D(),d(w,{key:2},[y(p(Ya(e.quoteItems[0].unitPrice,e.quoteItems[0].currency||"CNY",e.quoteItems[0].unit||"EA")),1)],64))],64)):(D(),d(w,{key:1},[y(p(Ya(ee(e),e.currency||"CNY",Ma(e))),1)],64))]),c("div",{class:I(["radio-dot",{selected:Q.value===e.id}])},null,2),Ne.value[e.id]?.hasSpecialTariff?(D(),C(s,{key:0,type:"warning",size:"small",class:"tariff-badge"},{default:v(()=>[y(p(f(t)("rfq.quote.specialTariffTag")),1)]),_:1})):b("",!0)],10,Me))),128))])])]),q(m(z,{data:e.quotes,style:{width:"100%"},"row-class-name":Fa,onRowClick:Ea},{default:v(()=>[e.selectable?(D(),C(u,{key:0,type:"selection",width:"55"})):b("",!0),m(u,{label:f(t)("supplier.companyName"),"min-width":"180"},{default:v(({row:e})=>[c("div",Ge,[c("strong",null,p(e.companyName),1),"selected"===e.status?(D(),C(s,{key:0,type:"success",size:"small",style:{"margin-left":"8px"}},{default:v(()=>[y(p(f(t)("rfq.quotes.selected")),1)]),_:1})):b("",!0)])]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.unitPrice"),width:"150",sortable:""},{default:v(({row:e})=>[c("div",Ke,[c("strong",null,p(xa(ee(e),e.currency||"CNY")),1),null!==ee(e)&&null!==ve.value&&ee(e)===ve.value?(D(),C(s,{key:0,type:"success",size:"small",effect:"dark"},{default:v(()=>[y(p(f(t)("rfq.quotes.lowest")),1)]),_:1})):b("",!0)])]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.totalAmount"),width:"150",sortable:""},{default:v(({row:e})=>[y(p(xa(e.totalAmount,e.currency||"CNY")),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.standardCost"),width:"220",sortable:""},{default:v(({row:e})=>[null!==Ne.value[e.id]?.total.amount?(D(),d("div",Je,[c("strong",null,p(xa(Ne.value[e.id]?.total.amount??null,Ne.value[e.id]?.total.currency||"USD")),1),Ne.value[e.id]?.hasSpecialTariff?(D(),C(s,{key:0,type:"warning",size:"small",effect:"dark"},{default:v(()=>[y(p(f(t)("rfq.quote.specialTariffTag")),1)]),_:1})):b("",!0),c("div",Ze,p(f(t)("rfq.quotes.unitStandardCost",{value:xa(Ne.value[e.id]?.unit.amount??null,Ne.value[e.id]?.unit.currency||"USD")})),1)])):(D(),d("div",Xe,[...a[17]||(a[17]=[c("span",null,"-",-1)])]))]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.brand"),width:"120"},{default:v(({row:e})=>[y(p(ja(e)),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.taxStatus"),width:"110"},{default:v(({row:e})=>[m(s,{type:"inclusive"===Ba(e)?"success":"warning",size:"small"},{default:v(()=>[y(p(f(t)(`rfq.taxStatus.${Ba(e)||"inclusive"}`)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.version"),width:"100",align:"center"},{default:v(({row:e})=>[e.version>1?(D(),C(r,{key:0,type:"warning",size:"small"},{default:v(()=>[y(" v"+p(e.version)+" ("+p(e.modifiedCount)+" "+p(f(t)("rfq.quotes.modifications"))+") ",1)]),_:2},1024)):(D(),C(r,{key:1,type:"info",size:"small"},{default:v(()=>[...a[18]||(a[18]=[y(" v1 ",-1)])]),_:1}))]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.deliveryDate"),width:"140"},{default:v(({row:e})=>[y(p(Da(e.deliveryDate)),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.paymentTerms"),width:"150"},{default:v(({row:e})=>[y(p(e.paymentTerms||"-"),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.status"),width:"120"},{default:v(({row:e})=>{return[m(s,{type:(l=e.status,{submitted:"info",under_review:"warning",selected:"success",rejected:"danger",withdrawn:"info"}[l]||"info"),size:"small"},{default:v(()=>[y(p(f(t)(`rfq.quoteStatus.${e.status}`)),1)]),_:2},1032,["type"])];var l}),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.submittedAt"),width:"160"},{default:v(({row:e})=>[y(p(za(e.submittedAt)),1)]),_:1},8,["label"]),m(u,{label:f(t)("common.actions"),width:"200",align:"center",fixed:"right"},{default:v(({row:e})=>[m(n,{type:"primary",size:"small",link:"",onClick:N(l=>Qa(e),["stop"])},{default:v(()=>[y(p(f(t)("common.view")),1)]),_:1},8,["onClick"]),m(n,{type:"info",size:"small",link:"",onClick:N(l=>{return a=e,L.value=a,void(j.value=!0);var a},["stop"])},{default:v(()=>[y(p(f(t)("rfq.quotes.viewSupplierProfile")),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"]),[[$,!1]]),c("div",el,[m(F,{gutter:16},{default:v(()=>[m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",ll,[c("div",al,p(f(t)("rfq.quotes.lowestPrice")),1),c("div",tl,p(null!==ve.value?xa(ve.value,"CNY"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",rl,[c("div",il,p(f(t)("rfq.quotes.highestPrice")),1),c("div",ol,p(null!==ye.value?xa(ye.value,"CNY"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",nl,[c("div",sl,p(f(t)("rfq.quotes.averagePrice")),1),c("div",ul,p(null!==qe.value?xa(qe.value,"CNY"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",dl,[c("div",cl,p(f(t)("rfq.quotes.priceRange")),1),c("div",ml,p(Ta(Ce.value)),1)])]),_:1})]),_:1})]),_:1}),m(F,{gutter:16,style:{"margin-top":"16px"}},{default:v(()=>[m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",pl,[c("div",fl,p(f(t)("rfq.quotes.lowestStandardCost")),1),c("div",vl,p(null!==Pe.value?xa(Pe.value,"USD"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",yl,[c("div",ql,p(f(t)("rfq.quotes.highestStandardCost")),1),c("div",bl,p(null!==Ue.value?xa(Ue.value,"USD"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",hl,[c("div",gl,p(f(t)("rfq.quotes.averageStandardCost")),1),c("div",_l,p(null!==Se.value?xa(Se.value,"USD"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",wl,[c("div",kl,p(f(t)("rfq.quotes.specialTariffCount")),1),c("div",Il,p(De.value),1)])]),_:1})]),_:1})]),_:1})]),ze.value.length>0?(D(),d("div",Cl,[m(Y,{"content-position":"left"},{default:v(()=>[c("span",Nl,p(f(t)("rfq.priceComparison.standardCostComparison")),1),c("span",$l,"("+p(f(t)("rfq.priceComparison.sortedByStandardCost"))+")",1)]),_:1}),c("div",Pl,[(D(!0),d(w,null,k(ze.value,(e,l)=>(D(),d("div",{key:e.id,class:I(["cost-card",{recommended:0===l}])},[0===l?(D(),C(s,{key:0,type:"success",size:"small",class:"recommend-tag"},{default:v(()=>[y(p(f(t)("rfq.priceComparison.recommended")),1)]),_:1})):b("",!0),c("div",Ul,p(e.companyName||e.supplierName),1),c("div",Sl,[c("div",xl,p(Ve(e,"USD")),1),c("div",Dl,"("+p(Ve(e,"local"))+")",1)]),m(n,{type:"primary",size:"small",onClick:l=>(e=>{Te.value=e,Ae.value=!0})(e)},{default:v(()=>[y(p(f(t)("rfq.priceComparison.viewDetail")),1)]),_:1},8,["onClick"])],2))),128))])])):b("",!0),H.value?(D(),d("div",zl,[m(Y,{"content-position":"left"},{default:v(()=>[c("span",Vl,p(f(t)("rfq.priceComparison.title")),1)]),_:1}),m(M,{title:f(t)("rfq.priceComparison.alert"),type:"info",closable:!1,style:{"margin-bottom":"20px"}},null,8,["title"]),m(F,{gutter:20},{default:v(()=>[m(A,{span:8},{default:v(()=>[m(V,{shadow:"hover",class:I({"uploaded-card":O[1688].uploaded})},{header:v(()=>[c("div",Al,[c("span",Tl,p(f(t)("rfq.priceComparison.1688")),1),O[1688].uploaded?(D(),C(s,{key:0,type:"success",size:"small"},{default:v(()=>[y(p(f(t)("rfq.priceComparison.uploaded")),1)]),_:1})):b("",!0)])]),default:v(()=>[O[1688].records.length?(D(),d("div",Rl,[(D(!0),d(w,null,k(O[1688].records,(e,l)=>(D(),d("div",{key:"1688-"+(e.id??e.fileName??l),class:"uploaded-item"},[e.downloadUrl?(D(),C(G,{key:0,href:String(e.downloadUrl),target:"_blank",underline:!1},{default:v(()=>[y(p(e.fileName||f(t)("rfq.priceComparison.screenshot")),1)]),_:2},1032,["href"])):(D(),d("span",jl,p(e.fileName||f(t)("rfq.priceComparison.screenshot")),1)),c("div",Ll,[null!==e.platformPrice&&void 0!==e.platformPrice?(D(),d("span",Fl,p(f(t)("rfq.priceComparison.pricePlaceholder"))+": "+p(xa(e.platformPrice,"CNY")),1)):b("",!0),e.productUrl?(D(),C(G,{key:1,href:String(e.productUrl),target:"_blank",type:"primary",underline:!1},{default:v(()=>[y(p(f(t)("rfq.priceComparison.urlPlaceholder")),1)]),_:1},8,["href"])):b("",!0)]),e.uploadedAt?(D(),d("div",El,p(za(String(e.uploadedAt))),1)):b("",!0)]))),128))])):b("",!0),m(ae,{"label-position":"top",size:"small"},{default:v(()=>[m(X,{label:f(t)("rfq.priceComparison.screenshot")},{default:v(()=>[c("input",{type:"file",accept:"image/*",onChange:a[1]||(a[1]=e=>Ha("1688",e)),disabled:O[1688].uploaded,style:{width:"100%"}},null,40,Ql),O[1688].file?(D(),d("div",Wl,p(O[1688].file?.name),1)):b("",!0)]),_:1},8,["label"]),m(X,{label:f(t)("rfq.priceComparison.urlPlaceholder")},{default:v(()=>[m(le,{modelValue:O[1688].url,"onUpdate:modelValue":a[2]||(a[2]=e=>O[1688].url=e),placeholder:f(t)("rfq.priceComparison.urlPlaceholder"),disabled:O[1688].uploaded},null,8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),m(X,{label:f(t)("rfq.priceComparison.pricePlaceholder")},{default:v(()=>[m(le,{modelValue:O[1688].price,"onUpdate:modelValue":a[3]||(a[3]=e=>O[1688].price=e),modelModifiers:{number:!0},type:"number",placeholder:f(t)("rfq.priceComparison.pricePlaceholder"),disabled:O[1688].uploaded},{prepend:v(()=>[...a[19]||(a[19]=[y("��",-1)])]),_:1},8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),O[1688].uploaded?b("",!0):(D(),C(n,{key:0,type:"primary",size:"small",onClick:a[4]||(a[4]=e=>Ga("1688")),loading:B.value,disabled:!O[1688].file||!O[1688].url||null===O[1688].price,style:{width:"100%"}},{default:v(()=>[y(p(f(t)("rfq.priceComparison.upload")),1)]),_:1},8,["loading","disabled"]))]),_:1})]),_:1},8,["class"])]),_:1}),m(A,{span:8},{default:v(()=>[m(V,{shadow:"hover",class:I({"uploaded-card":O.jd.uploaded})},{header:v(()=>[c("div",Ol,[c("span",Yl,p(f(t)("rfq.priceComparison.jd")),1),O.jd.uploaded?(D(),C(s,{key:0,type:"success",size:"small"},{default:v(()=>[y(p(f(t)("rfq.priceComparison.uploaded")),1)]),_:1})):b("",!0)])]),default:v(()=>[O.jd.records.length?(D(),d("div",Ml,[(D(!0),d(w,null,k(O.jd.records,(e,l)=>(D(),d("div",{key:"jd-"+(e.id??e.fileName??l),class:"uploaded-item"},[e.downloadUrl?(D(),C(G,{key:0,href:String(e.downloadUrl),target:"_blank",underline:!1},{default:v(()=>[y(p(e.fileName||f(t)("rfq.priceComparison.screenshot")),1)]),_:2},1032,["href"])):(D(),d("span",Bl,p(e.fileName||f(t)("rfq.priceComparison.screenshot")),1)),c("div",Hl,[null!==e.platformPrice&&void 0!==e.platformPrice?(D(),d("span",Gl,p(f(t)("rfq.priceComparison.pricePlaceholder"))+": "+p(xa(e.platformPrice,"CNY")),1)):b("",!0),e.productUrl?(D(),C(G,{key:1,href:String(e.productUrl),target:"_blank",type:"primary",underline:!1},{default:v(()=>[y(p(f(t)("rfq.priceComparison.urlPlaceholder")),1)]),_:1},8,["href"])):b("",!0)]),e.uploadedAt?(D(),d("div",Kl,p(za(String(e.uploadedAt))),1)):b("",!0)]))),128))])):b("",!0),m(ae,{"label-position":"top",size:"small"},{default:v(()=>[m(X,{label:f(t)("rfq.priceComparison.screenshot")},{default:v(()=>[c("input",{type:"file",accept:"image/*",onChange:a[5]||(a[5]=e=>Ha("jd",e)),disabled:O.jd.uploaded,style:{width:"100%"}},null,40,Jl),O.jd.file?(D(),d("div",Zl,p(O.jd.file?.name),1)):b("",!0)]),_:1},8,["label"]),m(X,{label:f(t)("rfq.priceComparison.urlPlaceholder")},{default:v(()=>[m(le,{modelValue:O.jd.url,"onUpdate:modelValue":a[6]||(a[6]=e=>O.jd.url=e),placeholder:f(t)("rfq.priceComparison.urlPlaceholder"),disabled:O.jd.uploaded},null,8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),m(X,{label:f(t)("rfq.priceComparison.pricePlaceholder")},{default:v(()=>[m(le,{modelValue:O.jd.price,"onUpdate:modelValue":a[7]||(a[7]=e=>O.jd.price=e),modelModifiers:{number:!0},type:"number",placeholder:f(t)("rfq.priceComparison.pricePlaceholder"),disabled:O.jd.uploaded},{prepend:v(()=>[...a[20]||(a[20]=[y("��",-1)])]),_:1},8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),O.jd.uploaded?b("",!0):(D(),C(n,{key:0,type:"primary",size:"small",onClick:a[8]||(a[8]=e=>Ga("jd")),loading:B.value,disabled:!O.jd.file||!O.jd.url||null===O.jd.price,style:{width:"100%"}},{default:v(()=>[y(p(f(t)("rfq.priceComparison.upload")),1)]),_:1},8,["loading","disabled"]))]),_:1})]),_:1},8,["class"])]),_:1}),m(A,{span:8},{default:v(()=>[m(V,{shadow:"hover",class:I({"uploaded-card":O.zkh.uploaded})},{header:v(()=>[c("div",Xl,[c("span",ea,p(f(t)("rfq.priceComparison.zkh")),1),O.zkh.uploaded?(D(),C(s,{key:0,type:"success",size:"small"},{default:v(()=>[y(p(f(t)("rfq.priceComparison.uploaded")),1)]),_:1})):b("",!0)])]),default:v(()=>[O.zkh.records.length?(D(),d("div",la,[(D(!0),d(w,null,k(O.zkh.records,(e,l)=>(D(),d("div",{key:"zkh-"+(e.id??e.fileName??l),class:"uploaded-item"},[e.downloadUrl?(D(),C(G,{key:0,href:String(e.downloadUrl),target:"_blank",underline:!1},{default:v(()=>[y(p(e.fileName||f(t)("rfq.priceComparison.screenshot")),1)]),_:2},1032,["href"])):(D(),d("span",aa,p(e.fileName||f(t)("rfq.priceComparison.screenshot")),1)),c("div",ta,[null!==e.platformPrice&&void 0!==e.platformPrice?(D(),d("span",ra,p(f(t)("rfq.priceComparison.pricePlaceholder"))+": "+p(xa(e.platformPrice,"CNY")),1)):b("",!0),e.productUrl?(D(),C(G,{key:1,href:String(e.productUrl),target:"_blank",type:"primary",underline:!1},{default:v(()=>[y(p(f(t)("rfq.priceComparison.urlPlaceholder")),1)]),_:1},8,["href"])):b("",!0)]),e.uploadedAt?(D(),d("div",ia,p(za(String(e.uploadedAt))),1)):b("",!0)]))),128))])):b("",!0),m(ae,{"label-position":"top",size:"small"},{default:v(()=>[m(X,{label:f(t)("rfq.priceComparison.screenshot")},{default:v(()=>[c("input",{type:"file",accept:"image/*",onChange:a[9]||(a[9]=e=>Ha("zkh",e)),disabled:O.zkh.uploaded,style:{width:"100%"}},null,40,oa),O.zkh.file?(D(),d("div",na,p(O.zkh.file?.name),1)):b("",!0)]),_:1},8,["label"]),m(X,{label:f(t)("rfq.priceComparison.urlPlaceholder")},{default:v(()=>[m(le,{modelValue:O.zkh.url,"onUpdate:modelValue":a[10]||(a[10]=e=>O.zkh.url=e),placeholder:f(t)("rfq.priceComparison.urlPlaceholder"),disabled:O.zkh.uploaded},null,8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),m(X,{label:f(t)("rfq.priceComparison.pricePlaceholder")},{default:v(()=>[m(le,{modelValue:O.zkh.price,"onUpdate:modelValue":a[11]||(a[11]=e=>O.zkh.price=e),modelModifiers:{number:!0},type:"number",placeholder:f(t)("rfq.priceComparison.pricePlaceholder"),disabled:O.zkh.uploaded},{prepend:v(()=>[...a[21]||(a[21]=[y("��",-1)])]),_:1},8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),O.zkh.uploaded?b("",!0):(D(),C(n,{key:0,type:"primary",size:"small",onClick:a[12]||(a[12]=e=>Ga("zkh")),loading:B.value,disabled:!O.zkh.file||!O.zkh.url||null===O.zkh.price,style:{width:"100%"}},{default:v(()=>[y(p(f(t)("rfq.priceComparison.upload")),1)]),_:1},8,["loading","disabled"]))]),_:1})]),_:1},8,["class"])]),_:1})]),_:1})])):b("",!0)])),m(ie,{modelValue:T.value,"onUpdate:modelValue":a[13]||(a[13]=e=>T.value=e),title:f(t)("rfq.quotes.quoteDetail"),width:"600px"},{default:v(()=>[R.value?(D(),d("div",sa,[m(re,{column:1,border:""},{default:v(()=>[m(te,{label:f(t)("supplier.companyName")},{default:v(()=>[y(p(R.value.companyName),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.unitPrice")},{default:v(()=>[y(p(xa(R.value.unitPrice,R.value.currency||"CNY")),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.totalAmount")},{default:v(()=>[y(p(xa(R.value.totalAmount,R.value.currency||"CNY")),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.brand")},{default:v(()=>[y(p(ja(R.value)),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.taxStatus")},{default:v(()=>[m(s,{type:"inclusive"===Ba(R.value)?"success":"warning",size:"small"},{default:v(()=>[y(p(f(t)(`rfq.taxStatus.${Ba(R.value)||"inclusive"}`)),1)]),_:1},8,["type"])]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.parameters")},{default:v(()=>[R.value.parameters?(D(),d("pre",ua,p(R.value.parameters),1)):(D(),d("span",da,"-"))]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.optionalConfig")},{default:v(()=>[R.value.optionalConfig?(D(),d("pre",ca,p(R.value.optionalConfig),1)):(D(),d("span",ma,"-"))]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.deliveryDate")},{default:v(()=>[y(p(Da(R.value.deliveryDate)),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.paymentTerms")},{default:v(()=>[y(p(R.value.paymentTerms||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quote.deliveryTerms")},{default:v(()=>[y(p(R.value.deliveryTerms||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quote.shippingCountry")},{default:v(()=>[y(p(R.value.shippingCountry||R.value.shipping_country||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quote.shippingLocation")},{default:v(()=>[y(p(R.value.shippingLocation||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.version")},{default:v(()=>[c("div",null,[m(r,{type:"primary"},{default:v(()=>[y("v"+p(R.value.version||1),1)]),_:1}),(R.value.modifiedCount||0)>0?(D(),C(r,{key:0,type:"info",size:"small",style:{"margin-left":"8px"}},{default:v(()=>[y(" ("+p(R.value.modifiedCount)+" "+p(f(t)("rfq.quotes.modifications"))+") ",1)]),_:1})):b("",!0)])]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.submittedAt")},{default:v(()=>[y(p(za(R.value.submittedAt)),1)]),_:1},8,["label"]),m(te,{label:f(t)("rfq.quotes.notes")},{default:v(()=>[y(p(R.value.notes||"-"),1)]),_:1},8,["label"])]),_:1}),Aa.value.length?(D(),C(z,{key:0,data:Aa.value,border:"",size:"small",style:{"margin-top":"16px"}},{default:v(()=>[m(u,{type:"index",width:"60"}),m(u,{label:f(t)("rfq.quote.summaryColumns.item"),"min-width":"160"},{default:v(({row:e})=>[c("div",pa,p(e.itemName),1),e.specifications?(D(),d("div",fa,p(e.specifications),1)):b("",!0)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quote.summaryColumns.quantity"),width:"140"},{default:v(({row:e})=>[y(p(e.quantityLabel),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quote.summaryColumns.brand"),width:"160"},{default:v(({row:e})=>[y(p(e.brandLabel||"-"),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quote.productGroupLabel"),width:"160"},{default:v(({row:e})=>[y(p(e.productGroup||"-"),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quote.productOriginLabel"),width:"160"},{default:v(({row:e})=>[y(p(e.productOrigin||"-"),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quote.summaryColumns.unitPrice"),width:"150"},{default:v(({row:e})=>[y(p(xa(e.unitPrice,R.value?.currency||"CNY")),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quote.summaryColumns.totalPrice"),width:"150"},{default:v(({row:e})=>[y(p(xa(e.totalPrice,R.value?.currency||"CNY")),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quote.standardUnitCost"),width:"180"},{default:v(({row:e})=>[null!==e.standardUnitCost?(D(),d("div",va,[c("div",ya,[y(p(xa(e.standardUnitCost,e.standardUnitCostCurrency||"USD"))+" ",1),e.hasSpecialTariff?(D(),C(s,{key:0,type:"warning",size:"small",effect:"dark",style:{"margin-left":"8px"}},{default:v(()=>[y(p(f(t)("rfq.quote.specialTariffTag")),1)]),_:1})):b("",!0)]),null!==e.tariffRate?(D(),d("div",qa,p(f(t)("rfq.quote.tariffRateLabel",{rate:Ra(e.tariffRate)})),1)):b("",!0),null!==e.specialTariffRate?(D(),d("div",ba,p(f(t)("rfq.quote.specialTariffRateLabel",{rate:Ra(e.specialTariffRate)})),1)):b("",!0)])):(D(),d("span",ha,"-"))]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quote.standardLineTotalColumn"),width:"180"},{default:v(({row:e})=>[null!==e.standardLineTotal?(D(),d("span",ga,p(xa(e.standardLineTotal,e.standardUnitCostCurrency||"USD")),1)):(D(),d("span",_a,"-"))]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quote.deliveryDate"),width:"160"},{default:v(({row:e})=>[y(p(Da(e.deliveryDate)),1)]),_:1},8,["label"])]),_:1},8,["data"])):(D(),C(M,{key:1,title:f(t)("rfq.quotes.noLineItems"),type:"info",closable:!1,style:{"margin-top":"16px"}},null,8,["title"])),m(Y,{"content-position":"left"},{default:v(()=>[y(p(f(t)("rfq.quotes.attachments")),1)]),_:1}),E.value.length?(D(),d("div",wa,[m(z,{data:E.value,border:"",size:"small"},{default:v(()=>[m(u,{label:f(t)("rfq.quotes.fileName"),"min-width":"220"},{default:v(({row:e})=>[e.downloadUrl?(D(),C(G,{key:0,href:e.downloadUrl,type:"primary",target:"_blank",download:""},{default:v(()=>[y(p(e.originalName||e.storedName||"-"),1)]),_:2},1032,["href"])):(D(),d("span",ka,p(e.originalName||e.storedName||"-"),1))]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.fileSize"),width:"130"},{default:v(({row:e})=>[y(p(La(e.fileSize)),1)]),_:1},8,["label"]),m(u,{label:f(t)("rfq.quotes.uploadedAt"),width:"180"},{default:v(({row:e})=>[y(p(za(e.uploadedAt??null)),1)]),_:1},8,["label"])]),_:1},8,["data"])])):(D(),C(M,{key:3,title:f(t)("rfq.quotes.noAttachments"),type:"info",closable:!1},null,8,["title"]))])):b("",!0)]),_:1},8,["modelValue","title"]),m(ie,{modelValue:j.value,"onUpdate:modelValue":a[14]||(a[14]=e=>j.value=e),title:f(t)("rfq.quotes.supplierProfile"),width:"700px"},{default:v(()=>[L.value?(D(),d("div",Ia,[m(Ie,{type:"border-card"},{default:v(()=>[m(oe,{label:f(t)("rfq.quotes.basicInfo")},{default:v(()=>[m(re,{column:2,border:""},{default:v(()=>[m(te,{label:f(t)("supplier.companyName")},{default:v(()=>[y(p(L.value.companyName),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.companyId")},{default:v(()=>[y(p(L.value.companyId||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.stage")},{default:v(()=>[m(s,{type:"formal"===L.value.stage?"success":"warning"},{default:v(()=>[y(p(f(t)(`supplier.stages.${L.value.stage??"null"}`)),1)]),_:1},8,["type"])]),_:1},8,["label"]),m(te,{label:f(t)("supplier.category")},{default:v(()=>[y(p(L.value.category||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.region")},{default:v(()=>[y(p(L.value.region||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.address")},{default:v(()=>[y(p(L.value.address||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(oe,{label:f(t)("rfq.quotes.financialInfo")},{default:v(()=>[m(re,{column:2,border:""},{default:v(()=>[m(te,{label:f(t)("supplier.registeredCapital")},{default:v(()=>[L.value.registeredCapital?(D(),C(r,{key:0,type:"primary",size:"large"},{default:v(()=>[y(p(xa(L.value.registeredCapital,"CNY")),1)]),_:1})):(D(),d("span",Ca,"-"))]),_:1},8,["label"]),m(te,{label:f(t)("supplier.registrationDate")},{default:v(()=>[y(p(L.value.registrationDate?Da(L.value.registrationDate):"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.paymentTerms")},{default:v(()=>[y(p(L.value.paymentTerms||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.paymentCurrency")},{default:v(()=>[y(p(L.value.paymentCurrency||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.bankName")},{default:v(()=>[y(p(L.value.bankName||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.bankAccount")},{default:v(()=>[y(p(L.value.bankAccount||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.taxRegistrationNumber")},{default:v(()=>[y(p(L.value.taxRegistrationNumber||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(oe,{label:f(t)("rfq.quotes.legalInfo")},{default:v(()=>[m(re,{column:2,border:""},{default:v(()=>[m(te,{label:f(t)("supplier.businessRegistrationNumber")},{default:v(()=>[m(r,{type:"primary"},{default:v(()=>[y(p(L.value.businessRegistrationNumber||"-"),1)]),_:1})]),_:1},8,["label"]),m(te,{label:f(t)("supplier.legalRepresentative")},{default:v(()=>[y(p(L.value.legalRepresentative||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(oe,{label:f(t)("rfq.quotes.contactInfo")},{default:v(()=>[m(re,{column:2,border:""},{default:v(()=>[m(te,{label:f(t)("supplier.contactPerson")},{default:v(()=>[y(p(L.value.contactPerson||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.contactPhone")},{default:v(()=>[y(p(L.value.contactPhone||"-"),1)]),_:1},8,["label"]),m(te,{label:f(t)("supplier.contactEmail"),span:2},{default:v(()=>[y(p(L.value.contactEmail||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),L.value.supplierDocuments?.length?(D(),C(oe,{key:0,label:f(t)("rfq.quotes.documentsInfo")},{default:v(()=>[m(z,{data:L.value.supplierDocuments,border:""},{default:v(()=>[m(u,{label:f(t)("supplier.documentCategory"),width:"180"},{default:v(({row:e})=>[m(s,{size:"small"},{default:v(()=>[y(p(f(t)(`supplier.documentCategories.${e.category}`)),1)]),_:2},1024)]),_:1},8,["label"]),m(u,{label:f(t)("supplier.fileName"),prop:"file_name"},null,8,["label"]),m(u,{label:f(t)("supplier.uploadedAt"),width:"160"},{default:v(({row:e})=>[y(p(Da(e.uploaded_at)),1)]),_:1},8,["label"]),m(u,{label:f(t)("supplier.expiryDate"),width:"120"},{default:v(({row:e})=>[e.expiry_date?(D(),d("span",Na,p(Da(e.expiry_date)),1)):(D(),d("span",$a,"-"))]),_:1},8,["label"]),m(u,{label:f(t)("supplier.verified"),width:"100",align:"center"},{default:v(({row:e})=>[e.verified?(D(),C(o,{key:0,color:"green",size:"20"},{default:v(()=>[(D(),C(S("CircleCheck")))]),_:1})):(D(),C(o,{key:1,color:"gray",size:"20"},{default:v(()=>[(D(),C(S("Clock")))]),_:1}))]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["label"])):b("",!0)]),_:1})])):b("",!0)]),_:1},8,["modelValue","title"]),m(ie,{modelValue:W.value,"onUpdate:modelValue":a[16]||(a[16]=e=>W.value=e),title:f(t)("rfq.quoteComparison.detailDialogTitle"),width:"1200px","close-on-click-modal":!1,class:"quote-detail-comparison-dialog"},{footer:v(()=>[m(n,{onClick:a[15]||(a[15]=e=>W.value=!1)},{default:v(()=>[y(p(f(t)("common.close")),1)]),_:1})]),default:v(()=>[m(z,{data:Wa.value,border:"",stripe:""},{default:v(()=>[m(u,{label:f(t)("rfq.quoteComparison.comparisonField"),prop:"field",width:"160",fixed:""},{default:v(({row:e})=>[c("strong",null,p(f(t)(e.field)),1)]),_:1},8,["label"]),(D(!0),d(w,null,k(e.quotes,e=>(D(),C(u,{key:e.id,align:"center","min-width":"150"},{header:v(()=>[m(G,{type:"primary",underline:!1,class:"supplier-name-link",onClick:N(l=>(e=>{L.value=e,j.value=!0})(e),["stop"])},{default:v(()=>[y(p(e.companyName||e.supplierName)+" ",1),m(o,{class:"link-icon"},{default:v(()=>[m(f(x))]),_:1})]),_:2},1032,["onClick"])]),default:v(({row:l})=>["quoteAttachments"===l.key?(D(),d("div",Pa,[l.values[e.id]&&l.values[e.id].length?(D(!0),d(w,{key:0},k(l.values[e.id],e=>(D(),d("div",{key:e.id||e.storedName||e.originalName||e.downloadUrl},[e.downloadUrl?(D(),C(G,{key:0,href:e.downloadUrl,target:"_blank",underline:!1,download:e.originalName||e.storedName||""},{default:v(()=>[y(p(e.originalName||e.storedName||"-"),1)]),_:2},1032,["href","download"])):(D(),d("span",Ua,p(e.originalName||e.storedName||"-"),1))]))),128)):(D(),d("span",Sa,"-"))])):(D(),d("div",{key:1,class:I({"best-value":l.bestQuoteId===e.id})},p(l.values[e.id]),3))]),_:2},1024))),128))]),_:1},8,["data"])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-aaed2765"]]),Da={class:"price-comparison-section"},za={class:"section-header"},Va={class:"item-name"},Aa={key:0,class:"brand"},Ta={class:"specifications"},Ra={key:1},ja={key:0,class:"quote-comparison"},La={class:"quote-header"},Fa={class:"quote-count"},Ea={class:"quote-cards-wrapper"},Qa={class:"detail-button-container"},Wa={class:"supplier-cards-grid"},Oa=["onClick"],Ya={class:"card-header"},Ma={class:"supplier-avatar"},Ba={class:"supplier-info"},Ha=["title"],Ga={class:"tag-row"},Ka={class:"price-highlight"},Ja={class:"price-value"},Za={class:"price-sub"},Xa={class:"moq-chip"},et={class:"meta-label"},lt={class:"meta-value"},at={class:"card-footer"},tt={class:"selection-hint"},rt={key:0,class:"dialog-header-info"},it={style:{color:"#409eff"}},ot={key:0},nt={key:1},st={key:0,class:"quote-attachments-cell"},ut=["title"],dt={key:1},ct={key:0,class:"supplier-profile"},mt={key:1},pt={key:0},ft={key:1},vt=z(i({__name:"RfqPriceComparisonSection",props:{rfq:{},lineItems:{},quotes:{},selectedLineItemId:{},userRole:{}},emits:["selectItem","selectQuote"],setup(e,{emit:l}){const t=e,r=l,{t:i}=o(),s=n(!1),q=n(!1),$=n(null),P=n(!1),S=n(null),z={CNY:"¥",USD:"$",EUR:"€",JPY:"¥",THB:"฿"},j=new Intl.NumberFormat("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),L=new Intl.NumberFormat("zh-CN",{maximumFractionDigits:0}),F={pending_director:"procurement_director",pending_po:"purchaser"};function E(e){if(e.currentApproverRole){const l=`common.roles.${e.currentApproverRole}`;return i(l)}const l=F[e.status];return l?i(`common.roles.${l}`):"completed"===e.status?i("common.completed"):"draft"===e.status||"rejected"===e.status?i("common.roles.purchaser"):"-"}const Q=a(()=>t.selectedLineItemId?t.lineItems.find(e=>e.id===t.selectedLineItemId):null),W=a(()=>Q.value?.selectedQuoteId??null),O=n(W.value),Y=(...e)=>{for(const l of e){if(null==l||""===l)continue;const e=Number(l);if(!Number.isNaN(e))return e}return null},M=e=>{if(null==e||""===e)return null;const l=Number(e);return Number.isFinite(l)?l:null},B=e=>{if(null==e||""===e)return null;if("string"==typeof e){const l=e.replace("%","").trim();if(!l.length)return null;const a=Number(l);return Number.isNaN(a)?null:a/100}const l=Number(e);return Number.isNaN(l)?null:l},H=(e,l)=>{const a=e.tariffCalculation||{},t=((e,l)=>{const a=e.tariffCalculation||{},t=M(a.standardCostUsd??e.standardUnitCostUsd??e.standardCostUsd??e.standard_unit_cost_usd);if(null!==t)return t;const r=M(a.standardCostLocal??e.standardUnitCostLocal??e.standardCostLocal??e.standard_unit_cost_local),i=M(a.exchangeRate??e.exchangeRate??l.exchangeRate);if(null!==r&&null!==i&&i>0)return r*i;const o=M(e.unitPrice??e.standardUnitCost??e.standardUnitCostLocal??l.unitPrice??l.unit_price);if(null===o||null===i||i<=0)return null;const n=1+(B(a.freightRate??a.freight_rate??a.tariffRate??e.freightRate??e.freight_rate??l.freightRate??l.freight_rate)??0)+(B(a.specialTariffRate??a.special_tariff_rate??e.specialTariffRate??e.special_tariff_rate??l.specialTariffRate??l.special_tariff_rate)??0);return n<=0?null:o*i*n})(e,l);if(null!==t)return{amount:Number(t),currency:"USD"};const r=[{amount:a.standardCost,currency:a.standardCostCurrency||"USD"},{amount:e.standardUnitCostLocal,currency:e.currency},{amount:e.standardUnitCost,currency:e.currency},{amount:e.unitPrice,currency:e.currency},{amount:l.unitPrice,currency:l.currency}];for(const i of r)if(void 0!==i.amount&&null!==i.amount&&""!==i.amount){const e=Number(i.amount);if(Number.isNaN(e))continue;return{amount:e,currency:i.currency||"USD"}}return{amount:null,currency:"USD"}};u(W,e=>{O.value=e??null},{immediate:!0});const G=a(()=>!!Q.value&&("procurement_director"===t.userRole||!["draft","rejected"].includes(Q.value.status)));const Z=a(()=>{if(!Q.value)return[];const e=t.quotes.map(e=>{const l=e.quoteItems?.find(e=>e.rfqLineItemId===Q.value?.id);if(!l)return null;const{amount:a,currency:t}=H(l,e),r=Q.value?.unit||"EA",i=Y(l.totalAmount,l.totalPrice,e.totalAmount),o=Y(l.tariffCalculation?.freightAmount,l.tariffCalculation?.shippingFee,l.tariffCalculation?.freightCost,l.freightAmount,l.shippingFee,l.shipping_fee,e.freightAmount,e.shippingFee,e.shipping_fee),n=Y(l.tariffCalculation?.specialTariffRate,l.specialTariffRate,e.special_tariff_rate),s=B(l.tariffCalculation?.freightRate)??B(l.tariffCalculation?.freight_rate)??B(l.freightRate)??B(l.freight_rate)??B(e.freightRate)??B(e.freight_rate)??0,u=Y(l.minimumOrderQuantity,l.minimum_order_quantity,l.moq),d=Y(l.spq,l.standardPackageQuantity,l.standard_package_quantity,l.standardPackQuantity),c=((...e)=>{for(const l of e)if(null!=l&&""!==l)return l;return null})(l.deliveryPeriod,l.delivery_period,l.delivery_time,e.deliveryPeriod,e.delivery_period,e.delivery_time,l.deliveryDate,e.deliveryDate);return{id:e.id??e.quoteId??l.id??`${e.companyName}-${Q.value?.id}`,supplierName:e.companyName||e.supplierName||e.vendorName||e.supplier?.name||"-",unitPrice:a,currency:t,originalCurrency:e.currency||"CNY",unit:r,totalAmount:i,deliveryTime:c,status:e.status,originalUnitPrice:Y(l.unitPrice,l.unit_price),shippingFee:o,freightRate:s,specialTariff:n,moq:u,spq:d,productOrigin:l.productOrigin??e.productOrigin??null,hasSpecialTariff:Boolean(l.tariffCalculation?.hasSpecialTariff),attachments:le(e.attachments??[])}}).filter(e=>Boolean(e));if(!e.length)return[];let l=e;if("department_user"===t.userRole){const a=Q.value?.selectedQuoteId??Q.value?.selected_quote_id??null;l=a?e.filter(e=>Number(e.id)===Number(a)):e.filter(e=>"selected"===e.status)}if(!l.length)return[];const a=l.reduce((e,l)=>null===l.unitPrice||void 0===l.unitPrice?e:l.unitPrice<e?l.unitPrice:e,Number.POSITIVE_INFINITY);return l.map(e=>({...e,isLowest:a!==Number.POSITIVE_INFINITY&&null!==e.unitPrice&&void 0!==e.unitPrice&&e.unitPrice===a}))});function X(e){e&&r("selectItem",e.id)}function ee({row:e}){return e.id===t.selectedLineItemId?"selected-row":""}const le=e=>(e??[]).map(e=>{const l=e.storedName??e.stored_name??e.storedFileName??e.stored_file_name??null,a=e.filePath??e.file_path??null,t=te(a,l,"rfq-attachments")??e.downloadUrl??null;return{...e,storedName:l,originalName:e.originalName??e.original_name??e.fileName??e.file_name,downloadUrl:t}});function ae(e,l="CNY"){if(null==e)return"-";return`${z[l]||l}${j.format(e)}`}function ie(e,l="CNY"){return ae(e,l)}function oe(e){if(!e)return"-";const l=new Date(e);return isNaN(l.getTime())?"-":l.toLocaleDateString("zh-CN")}function ve(e,l="CNY",a="EA"){const t=ae(e,l);return"-"===t?"-":`${t}/${a}`}function ye(e,l="EA"){return null==e||e<=0?"-":`${L.format(e)} ${l}`}function qe(e){if(!e)return"?";const l=e.trim();if(!l)return"?";const a=l.split(/\s+/).filter(Boolean);return 0===a.length?l.slice(0,2).toUpperCase():1===a.length?a[0].slice(0,2).toUpperCase():(a[0][0]+a[1][0]).toUpperCase()}function be(e){return null!==O.value&&void 0!==O.value&&String(e)===String(O.value)}return(l,a)=>{const i=fe,o=J,n=V,u=pe,z=g,j=h,L=K,F=me,W=U,Y=ce,M=de,B=se,H=ue,le=ne;return D(),d("div",Da,[c("div",za,[c("h4",null,p(l.$t("rfq.lineItemWorkflow.priceComparison")),1)]),m(u,{data:e.lineItems,border:"","highlight-current-row":"","row-class-name":ee,onCurrentChange:X,height:"400",style:{width:"100%"}},{default:v(()=>[m(i,{type:"index",label:"#",width:"50",align:"center"}),m(i,{prop:"lineNumber",label:l.$t("rfq.items.lineNumber"),width:"80",align:"center"},null,8,["label"]),m(i,{label:l.$t("rfq.items.itemName"),"min-width":"180"},{default:v(({row:e})=>[c("div",Va,[c("div",null,p(e.itemName||e.description),1),e.brand?(D(),d("div",Aa,[m(o,{size:"small",type:"info"},{default:v(()=>[y(p(e.brand),1)]),_:2},1024)])):b("",!0)])]),_:1},8,["label"]),m(i,{label:l.$t("rfq.items.specifications"),width:"180"},{default:v(({row:e})=>[e.specifications?(D(),C(n,{key:0,content:e.specifications,placement:"top"},{default:v(()=>{return[c("div",Ta,p((l=e.specifications,a=30,l?l.length<=a?l:l.substring(0,a)+"...":"")),1)];var l,a}),_:2},1032,["content"])):(D(),d("span",Ra,"-"))]),_:1},8,["label"]),m(i,{label:l.$t("rfq.items.quantity"),width:"100"},{default:v(({row:e})=>[y(p(e.quantity)+" "+p(e.unit),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.lineItemWorkflow.status"),width:"140"},{default:v(({row:e})=>{return[m(o,{type:(a=e.status,{draft:"info",pending_director:"warning",pending_po:"primary",completed:"success",rejected:"danger"}[a]||"info"),size:"small"},{default:v(()=>[y(p(l.$t(`rfq.lineItemWorkflow.statuses.${e.status}`)),1)]),_:2},1032,["type"])];var a}),_:1},8,["label"]),m(i,{label:l.$t("rfq.lineItemWorkflow.currentApprover"),width:"120"},{default:v(({row:e})=>[c("span",null,p(E(e)),1)]),_:1},8,["label"])]),_:1},8,["data"]),e.selectedLineItemId&&Z.value.length>0?(D(),d("div",ja,[c("div",La,[c("h4",null,p(l.$t("rfq.lineItemWorkflow.quoteComparison")),1),c("span",Fa,p(Z.value.length)+" "+p(l.$t("rfq.quote.quotes")),1)]),c("div",Ea,[c("div",Qa,[m(j,{type:"primary",text:"",onClick:a[0]||(a[0]=e=>s.value=!0)},{default:v(()=>[y(p(l.$t("rfq.quoteComparison.viewDetails"))+" ",1),m(z,null,{default:v(()=>[m(f(_))]),_:1})]),_:1})]),c("div",Wa,[(D(!0),d(w,null,k(Z.value,e=>{return D(),d("div",{key:e.id,class:I(["supplier-card",{selected:be(e.id),"has-special-tariff":e.hasSpecialTariff,"read-only":G.value}]),onClick:l=>{return a=e.id,void(G.value||(O.value=a,r("selectQuote",a)));var a}},[c("div",Ya,[c("div",Ma,p(qe(e.supplierName)),1),c("div",Ba,[c("div",{class:"company-name",title:e.supplierName},p(e.supplierName||"-"),9,Ha),G.value&&be(e.id)?(D(),C(o,{key:0,type:"success",size:"small"},{default:v(()=>[y(p(l.$t("rfq.lineItemWorkflow.purchaserSelected")),1)]),_:1})):b("",!0),c("div",Ga,[e.status&&"submitted"!==e.status?(D(),C(o,{key:0,type:(a=e.status,{draft:"info",submitted:"primary",selected:"success",rejected:"danger"}[a]||"info"),size:"small",effect:"plain",class:"status-pill"},{default:v(()=>[y(p(l.$t(`rfq.quote.statuses.${e.status}`)),1)]),_:2},1032,["type"])):b("",!0),e.hasSpecialTariff?(D(),C(o,{key:1,type:"warning",size:"small",effect:"plain",class:"tariff-pill"},{default:v(()=>[y(p(l.$t("rfq.quote.specialTariffTag")),1)]),_:1})):b("",!0)])]),e.isLowest?(D(),C(o,{key:0,size:"small",type:"success",effect:"dark",class:"lowest-badge"},{default:v(()=>[y(p(l.$t("rfq.priceComparison.lowest")),1)]),_:1})):b("",!0)]),c("div",Ka,[c("span",Ja,p(ve(e.unitPrice,e.currency,e.unit)),1),c("span",Za,p(ie(e.totalAmount,e.currency)),1)]),c("div",Xa,[c("span",et,p(l.$t("rfq.quote.moq")),1),c("span",lt,p(ye(e.moq,e.unit)),1)]),c("div",at,[c("span",tt,p(be(e.id)?G.value?l.$t("rfq.lineItemWorkflow.purchaserSelected"):l.$t("rfq.review.selected"):G.value?l.$t("rfq.lineItemWorkflow.viewOnly"):l.$t("rfq.review.select")),1),c("div",{class:I(["radio-dot",{selected:be(e.id),disabled:G.value}])},null,2)])],10,Oa);var a}),128))])])])):e.selectedLineItemId?(D(),C(L,{key:1,description:l.$t("rfq.lineItemWorkflow.noQuotes"),"image-size":100},null,8,["description"])):b("",!0),m(W,{modelValue:s.value,"onUpdate:modelValue":a[2]||(a[2]=e=>s.value=e),title:l.$t("rfq.quoteComparison.detailDialogTitle"),width:"1200px","close-on-click-modal":!1},{footer:v(()=>[m(j,{onClick:a[1]||(a[1]=e=>s.value=!1)},{default:v(()=>[y(p(l.$t("common.close")),1)]),_:1})]),default:v(()=>[Q.value?(D(),d("div",rt,[c("p",null,[c("strong",null,p(l.$t("rfq.items.itemName"))+":",1),y(" "+p(Q.value.itemName||Q.value.description),1)]),c("p",null,[c("strong",null,p(l.$t("rfq.items.quantity"))+":",1),y(" "+p(Q.value.quantity)+" "+p(Q.value.unit),1)])])):b("",!0),m(u,{data:Z.value,border:"",stripe:""},{default:v(()=>[m(i,{label:l.$t("supplier.companyName"),"min-width":"160",fixed:""},{default:v(({row:e})=>[m(F,{type:"primary",underline:!1,class:"supplier-name-link",onClick:N(l=>function(e){const l=t.quotes.find(l=>Number(l.id)===Number(e.id));l?(S.value=l,P.value=!0):console.warn("[RfqPriceComparisonSection] Full quote not found for ID:",e.id)}(e),["stop"])},{default:v(()=>[y(p(e.supplierName)+" ",1),m(z,{class:"link-icon"},{default:v(()=>[m(f(x))]),_:1})]),_:2},1032,["onClick"])]),_:1},8,["label"]),m(i,{label:l.$t("rfq.lineItemWorkflow.unitStandardCost"),width:"130"},{default:v(({row:e})=>[c("strong",it,p(ve(e.unitPrice,e.currency,e.unit)),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.originalUnitPrice"),width:"130"},{default:v(({row:e})=>[y(p(ve(e.originalUnitPrice,e.originalCurrency,e.unit)),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quoteComparison.shippingFee"),width:"120"},{default:v(({row:e})=>{return[null!==e.shippingFee&&void 0!==e.shippingFee?(D(),d("span",ot,p(ie(e.shippingFee,e.currency)),1)):(D(),d("span",nt,p((l=e.freightRate??0,null==l||Number.isNaN(l)?"-":`${(100*l).toFixed(2)}%`)),1))];var l}),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.specialTariff"),width:"100"},{default:v(({row:e})=>[c("span",{style:A({color:e.specialTariff>0?"#e6a23c":"#67c23a"})},p(e.specialTariff>0?`${e.specialTariff}%`:"0%"),5)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.moq"),width:"90",align:"center"},{default:v(({row:e})=>[y(p(e.moq||"-"),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.spq"),width:"90",align:"center"},{default:v(({row:e})=>[y(p(e.spq||"-"),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.deliveryTime"),width:"110",prop:"deliveryTime"},null,8,["label"]),m(i,{label:l.$t("rfq.quote.productOrigin"),width:"100",prop:"productOrigin"},null,8,["label"]),m(i,{label:l.$t("rfq.quoteComparison.quoteAttachments"),"min-width":"180"},{default:v(({row:e})=>[e.attachments&&e.attachments.length?(D(),d("div",st,[(D(!0),d(w,null,k(e.attachments,e=>(D(),d("div",{key:e.id||e.storedName||e.originalName||e.downloadUrl,class:"quote-attachment-row"},[c("span",{class:"quote-attachment-name",title:e.originalName||e.storedName},p(e.originalName||e.storedName||"-"),9,ut),m(j,{size:"small",link:"",type:"primary",onClick:N(l=>{var a;(a=e).downloadUrl&&window.open(String(a.downloadUrl),"_blank")},["stop"])},{default:v(()=>[y(p(l.$t("common.view")),1)]),_:1},8,["onClick"]),m(j,{size:"small",link:"",type:"info",onClick:N(l=>async function(e){if(!e.downloadUrl)return;const l=e.originalName||e.storedName||"download";try{await re(String(e.downloadUrl),l)}catch(a){console.error("[RfqPriceComparisonSection] download failed",a)}}(e),["stop"])},{default:v(()=>[y(p(l.$t("rfq.quotes.download")),1)]),_:1},8,["onClick"])]))),128))])):(D(),d("span",dt,"-"))]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["modelValue","title"]),m(W,{modelValue:P.value,"onUpdate:modelValue":a[3]||(a[3]=e=>P.value=e),title:l.$t("rfq.quotes.supplierProfile"),width:"700px"},{default:v(()=>[S.value?(D(),d("div",ct,[m(le,{type:"border-card"},{default:v(()=>[m(B,{label:l.$t("rfq.quotes.basicInfo")},{default:v(()=>[m(M,{column:2,border:""},{default:v(()=>[m(Y,{label:l.$t("supplier.companyName")},{default:v(()=>[y(p(S.value.companyName||S.value.supplierName),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.companyId")},{default:v(()=>[y(p(S.value.companyId||"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.stage")},{default:v(()=>[m(o,{type:"formal"===S.value.stage?"success":"warning"},{default:v(()=>[y(p(l.$t(`supplier.stages.${S.value.stage??"null"}`)),1)]),_:1},8,["type"])]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.category")},{default:v(()=>[y(p(S.value.category||"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.region")},{default:v(()=>[y(p(S.value.region||"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.address")},{default:v(()=>[y(p(S.value.address||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(B,{label:l.$t("rfq.quotes.financialInfo")},{default:v(()=>[m(M,{column:2,border:""},{default:v(()=>[m(Y,{label:l.$t("supplier.registeredCapital")},{default:v(()=>[S.value.registeredCapital?(D(),C(H,{key:0,type:"primary",size:"large"},{default:v(()=>[y(p(ae(S.value.registeredCapital,"CNY")),1)]),_:1})):(D(),d("span",mt,"-"))]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.registrationDate")},{default:v(()=>[y(p(S.value.registrationDate?oe(S.value.registrationDate):"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.paymentTerms")},{default:v(()=>[y(p(S.value.paymentTerms||"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.paymentCurrency")},{default:v(()=>[y(p(S.value.paymentCurrency||"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.bankName")},{default:v(()=>[y(p(S.value.bankName||"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.bankAccount")},{default:v(()=>[y(p(S.value.bankAccount||"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.taxRegistrationNumber")},{default:v(()=>[y(p(S.value.taxRegistrationNumber||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(B,{label:l.$t("rfq.quotes.legalInfo")},{default:v(()=>[m(M,{column:2,border:""},{default:v(()=>[m(Y,{label:l.$t("supplier.businessRegistrationNumber")},{default:v(()=>[m(H,{type:"primary"},{default:v(()=>[y(p(S.value.businessRegistrationNumber||"-"),1)]),_:1})]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.legalRepresentative")},{default:v(()=>[y(p(S.value.legalRepresentative||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(B,{label:l.$t("rfq.quotes.contactInfo")},{default:v(()=>[m(M,{column:2,border:""},{default:v(()=>[m(Y,{label:l.$t("supplier.contactPerson")},{default:v(()=>[y(p(S.value.contactPerson||"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.contactPhone")},{default:v(()=>[y(p(S.value.contactPhone||"-"),1)]),_:1},8,["label"]),m(Y,{label:l.$t("supplier.contactEmail"),span:2},{default:v(()=>[y(p(S.value.contactEmail||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),S.value.supplierDocuments?.length?(D(),C(B,{key:0,label:l.$t("rfq.quotes.documentsInfo")},{default:v(()=>[m(u,{data:S.value.supplierDocuments,border:""},{default:v(()=>[m(i,{label:l.$t("supplier.documentCategory"),width:"180"},{default:v(({row:e})=>[m(o,{size:"small"},{default:v(()=>[y(p(l.$t(`supplier.documentCategories.${e.category}`)),1)]),_:2},1024)]),_:1},8,["label"]),m(i,{label:l.$t("supplier.fileName"),width:"200"},{default:v(({row:e})=>[y(p(e.originalName||e.file_name||"-"),1)]),_:1},8,["label"]),m(i,{label:l.$t("supplier.uploadedAt"),width:"160"},{default:v(({row:e})=>[y(p(oe(e.uploadedAt||e.uploaded_at)),1)]),_:1},8,["label"]),m(i,{label:l.$t("supplier.expiryDate"),width:"120"},{default:v(({row:e})=>[e.expiresAt||e.expiry_date?(D(),d("span",pt,p(oe(e.expiresAt||e.expiry_date)),1)):(D(),d("span",ft,"-"))]),_:1},8,["label"]),m(i,{label:l.$t("supplier.verified"),width:"100",align:"center"},{default:v(({row:e})=>[e.verified?(D(),C(z,{key:0,color:"green",size:"20"},{default:v(()=>[m(f(T))]),_:1})):(D(),C(z,{key:1,color:"gray",size:"20"},{default:v(()=>[m(f(R))]),_:1}))]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["label"])):b("",!0)]),_:1})])):b("",!0)]),_:1},8,["modelValue","title"]),m(W,{modelValue:q.value,"onUpdate:modelValue":a[4]||(a[4]=e=>q.value=e),title:l.$t("rfq.quote.details"),width:"800px"},{default:v(()=>[$.value?(D(),C(xa,{key:0,quotes:[$.value],"line-item":Q.value},null,8,["quotes","line-item"])):b("",!0)]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-7ac87501"]]),yt={class:"approval-history-timeline"},qt={class:"history-item"},bt={class:"item-header"},ht={class:"step-info"},gt={class:"step-name"},_t={class:"approver-info"},wt={class:"approver-name"},kt={class:"approver-role"},It={key:0,class:"comments"},Ct={key:1,class:"quote-change"},Nt={class:"change-details"},$t={key:0},Pt=z(i({__name:"RfqApprovalHistoryTimeline",props:{rfqId:{},lineItemId:{}},setup(l){const a=Ie(),t=l,{t:r}=o(),i=n(!1),s=n([]);async function u(){i.value=!0;try{s.value=await async function(l,a){return(await e(`/rfq/${l}/line-items/${a}/history`)).data}(t.rfqId,t.lineItemId)}catch(l){a.error(l.message||r("common.loadFailed"))}finally{i.value=!1}}function f(e){return{approved:T,rejected:E,confirmed:F,refused:L}[e]||void 0}function h(e){return{approved:"success",rejected:"danger",confirmed:"success",refused:"danger",submitted:"primary"}[e]||"info"}function g(e){if(!e)return"-";return new Date(e).toLocaleString()}return j(()=>{u()}),(e,l)=>{const a=J,t=Z,r=ke,o=Se,n=Ue,u=K,_=G;return q((D(),d("div",yt,[s.value.length>0?(D(),C(n,{key:0},{default:v(()=>[(D(!0),d(w,null,k(s.value,l=>{return D(),C(o,{key:l.id,timestamp:g(l.createdAt),type:(i=l.decision,{approved:"success",rejected:"danger",confirmed:"success",refused:"danger",submitted:"primary"}[i]||"info"),icon:f(l.decision),placement:"top"},{default:v(()=>[m(r,null,{default:v(()=>[c("div",qt,[c("div",bt,[c("div",ht,[m(a,{type:h(l.decision),size:"small"},{default:v(()=>[y(p(e.$t(`rfq.lineItemWorkflow.decisions.${l.decision}`)),1)]),_:2},1032,["type"]),c("span",gt,p(e.$t(`rfq.lineItemWorkflow.steps.${l.step}`)),1)]),c("div",_t,[c("span",wt,p(l.approverName),1),c("span",kt," ("+p(e.$t(`roles.${l.approverRole}`))+") ",1)])]),l.comments?(D(),d("div",It,[c("strong",null,p(e.$t("common.comments"))+":",1),c("p",null,p(l.comments),1)])):b("",!0),l.newQuoteId&&l.previousQuoteId?(D(),d("div",Ct,[m(t,{title:e.$t("rfq.lineItemWorkflow.quoteChanged"),type:"warning",closable:!1,"show-icon":""},{default:v(()=>[c("div",Nt,[c("div",null,p(e.$t("rfq.lineItemWorkflow.previousQuote"))+": #"+p(l.previousQuoteId),1),c("div",null,p(e.$t("rfq.lineItemWorkflow.newQuote"))+": #"+p(l.newQuoteId),1),l.changeReason?(D(),d("div",$t,p(e.$t("common.reason"))+": "+p(l.changeReason),1)):b("",!0)])]),_:2},1032,["title"])])):b("",!0)])]),_:2},1024)]),_:2},1032,["timestamp","type","icon"]);var i}),128))]),_:1})):(D(),C(u,{key:1,description:e.$t("rfq.lineItemWorkflow.noHistory"),"image-size":100},null,8,["description"]))])),[[_,i.value]])}}}),[["__scopeId","data-v-7ecabef8"]]),Ut={class:"price-comparison-cell"},St={key:0,class:"uploaded-state"},xt={key:0,class:"price-display"},Dt={key:0,class:"not-uploaded-state"},zt={key:1,class:"upload-restricted-state"},Vt={class:"restricted-copy"},At={class:"title"},Tt={class:"hint"},Rt={class:"el-upload__tip"},jt=z(i({__name:"PriceComparisonCell",props:{rfqId:{default:void 0},lineItem:{},platform:{},comparisonData:{},canUpload:{type:Boolean,default:!0}},emits:["uploaded","viewDetail"],setup(e,{emit:l}){const t=Ie(),r=e,i=l,{t:s}=o(),u=n(!1),q=n(!1),_=n([]),k=n(null),I=n({price:null,url:"",notes:""}),C=a(()=>({1688:"1688",jd:s("rfq.priceComparison.platforms.jd"),zkh:s("rfq.priceComparison.platforms.zkh")}[r.platform]||r.platform));function $(){r.canUpload&&(u.value=!0,I.value={price:null,url:"",notes:""},_.value=[],k.value=null)}function S(e){k.value=e.raw,_.value=[e]}async function x(){if(r.canUpload)if(r.rfqId)if(k.value)if(!I.value.price||I.value.price<=0)t.warning(s("rfq.priceComparison.uploadDialog.pleaseEnterPrice"));else{q.value=!0;try{await X(r.rfqId,r.platform,k.value,I.value.price,I.value.url,r.lineItem.id),t.success(s("rfq.priceComparison.uploadSuccess")),u.value=!1,i("uploaded")}catch(e){console.error("Upload failed:",e),t.error(e.message||s("rfq.priceComparison.uploadFailed"))}finally{q.value=!1}}else t.warning(s("rfq.priceComparison.uploadDialog.pleaseSelectFile"));else t.error(s("rfq.priceComparison.uploadDialog.rfqIdRequired"))}function z(){i("viewDetail",{...r.comparisonData,lineItemId:r.lineItem.id,lineItemNumber:r.lineItem.itemNumber,lineItemDescription:r.lineItem.description})}return(l,a)=>{const t=J,r=h,i=g,o=xe,n=he,k=P,V=be,A=U;return D(),d("div",Ut,[e.comparisonData?(D(),d("div",St,[m(t,{type:"success",size:"small"},{default:v(()=>[y(p(f(s)("rfq.priceComparison.cell.uploaded")),1)]),_:1}),e.comparisonData.platformPrice?(D(),d("div",xt," ¥"+p(e.comparisonData.platformPrice.toFixed(2)),1)):b("",!0),m(r,{text:"",type:"primary",size:"small",onClick:z},{default:v(()=>[y(p(f(s)("rfq.priceComparison.cell.viewDetail")),1)]),_:1})])):(D(),d(w,{key:1},[e.canUpload?(D(),d("div",Dt,[m(r,{size:"small",type:"primary",plain:"",disabled:!e.rfqId,onClick:$},{default:v(()=>[m(i,null,{default:v(()=>[m(f(Q))]),_:1}),y(" "+p(f(s)("rfq.lineItemWorkflow.uploadMarketPrice")),1)]),_:1},8,["disabled"])])):(D(),d("div",zt,[m(i,{class:"lock-icon"},{default:v(()=>[m(f(W))]),_:1}),c("div",Vt,[c("span",At,p(f(s)("rfq.priceComparison.cell.purchaserOnly")),1),c("span",Tt,p(f(s)("rfq.priceComparison.cell.viewOnlyHint")),1)])]))],64)),m(A,{modelValue:u.value,"onUpdate:modelValue":a[4]||(a[4]=e=>u.value=e),title:f(s)("rfq.priceComparison.uploadDialog.title",{platform:C.value,item:e.lineItem.itemNumber}),width:"500px"},{footer:v(()=>[m(r,{onClick:a[3]||(a[3]=e=>u.value=!1)},{default:v(()=>[y(p(f(s)("common.cancel")),1)]),_:1}),m(r,{type:"primary",loading:q.value,onClick:x},{default:v(()=>[y(p(f(s)("common.submit")),1)]),_:1},8,["loading"])]),default:v(()=>[m(V,{model:I.value,"label-width":"100px",onSubmit:N(x,["prevent"])},{default:v(()=>[m(n,{label:f(s)("rfq.priceComparison.uploadDialog.screenshot")},{default:v(()=>[m(o,{ref:"uploadRef","auto-upload":!1,limit:1,accept:"image/*","on-change":S,"file-list":_.value},{tip:v(()=>[c("div",Rt,p(f(s)("rfq.priceComparison.uploadDialog.fileHint")),1)]),default:v(()=>[m(r,{size:"small"},{default:v(()=>[y(p(f(s)("rfq.priceComparison.uploadDialog.chooseFile")),1)]),_:1})]),_:1},8,["file-list"])]),_:1},8,["label"]),m(n,{label:f(s)("rfq.priceComparison.uploadDialog.price"),required:""},{default:v(()=>[m(k,{modelValue:I.value.price,"onUpdate:modelValue":a[0]||(a[0]=e=>I.value.price=e),modelModifiers:{number:!0},type:"number",placeholder:f(s)("rfq.priceComparison.uploadDialog.pricePlaceholder"),step:"0.01"},{prepend:v(()=>[...a[5]||(a[5]=[y("¥",-1)])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),m(n,{label:f(s)("rfq.priceComparison.uploadDialog.productUrl")},{default:v(()=>[m(k,{modelValue:I.value.url,"onUpdate:modelValue":a[1]||(a[1]=e=>I.value.url=e),placeholder:f(s)("rfq.priceComparison.uploadDialog.urlPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),m(n,{label:f(s)("rfq.priceComparison.uploadDialog.notes")},{default:v(()=>[m(k,{modelValue:I.value.notes,"onUpdate:modelValue":a[2]||(a[2]=e=>I.value.notes=e),type:"textarea",rows:3,placeholder:f(s)("rfq.priceComparison.uploadDialog.notesPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-b6497c9b"]]),Lt={class:"approval-operation-panel"},Ft={class:"panel-header"},Et={class:"selected-quote-info"},Qt={class:"price"},Wt={key:0,class:"operation-section"},Ot={key:1,class:"operation-section"},Yt={key:0,class:"invite-link"},Mt={class:"action-buttons"},Bt={key:2,class:"operation-section"},Ht={class:"approval-history"},Gt={key:3,class:"price-comparison-upload-section"},Kt={class:"section-header"},Jt={class:"platforms-grid"},Zt={class:"platform-header"},Xt={class:"platform-name"},er={class:"platform-header"},lr={class:"platform-name"},ar={key:0,class:"invite-hint"},tr=z(i({__name:"RfqApprovalOperationPanel",props:{rfq:{},lineItem:{},selectedQuote:{},userRole:{},priceComparisons:{}},emits:["approve","reject","submit","refresh","priceUploaded"],setup(l,{emit:t}){const r=Ie(),i=l,f=t,{t:q}=o(),g=n(!1),_=n(!1),I=n(!1),N=n(!1),$=n(null),S=s({purchaserIds:[],message:""}),x=n([]),z=n(!1),V=n(!1),A=n(null),T=n([]),R=s({changeQuote:!1,newQuoteId:null,comments:""}),j=a(()=>i.rfq?.quotes||[]),L=a(()=>("purchaser"===i.userRole||"admin"===i.userRole)&&("draft"===i.lineItem.status||"rejected"===i.lineItem.status)),F=a(()=>("procurement_director"===i.userRole||"admin"===i.userRole)&&"pending_director"===i.lineItem.status),E=a(()=>"purchaser"===i.userRole),Q=a(()=>"procurement_director"===i.userRole),W=a(()=>Q.value),O=a(()=>Q.value),Y=a(()=>{const e=q("rfq.approval.invitePurchaser");return $.value?`${e} - ${q("common.roles.procurement_director")}`:e});async function M(){if(i.selectedQuote){g.value=!0;try{f("submit",i.selectedQuote.id),r.success(q("rfq.lineItemWorkflow.submitSuccess"))}catch(e){r.error(q("rfq.lineItemWorkflow.submitFailed"))}finally{g.value=!1}}}async function B(){g.value=!0;try{const e={comments:R.comments};R.changeQuote&&R.newQuoteId&&(e.newQuoteId=R.newQuoteId),f("approve",e),r.success(q("rfq.lineItemWorkflow.approveSuccess"))}catch(e){r.error(q("rfq.lineItemWorkflow.approveFailed"))}finally{g.value=!1}}async function H(){g.value=!0;try{f("reject",R.comments),r.success(q("rfq.lineItemWorkflow.rejectSuccess"))}catch(e){r.error(q("rfq.lineItemWorkflow.rejectFailed"))}finally{g.value=!1}}async function G(){if(!z.value)try{const l=await e("/users",{params:{role:"purchaser"}});x.value=l.data||[],z.value=!0}catch(l){console.error("[RfqApprovalOperationPanel] Failed to load purchasers",l),r.error(q("rfq.approval.inviteError"))}}async function K(){if(i.rfq?.id&&i.lineItem?.id)if(S.purchaserIds.length){N.value=!0;try{await async function(l,a,t){return e(`/rfq/${l}/line-items/${a}/invite-purchasers`,{method:"POST",body:t})}(i.rfq.id,i.lineItem.id,{purchaserIds:S.purchaserIds,message:S.message}),r.success(q("rfq.approval.inviteSuccess")),I.value=!1}catch(l){r.error(l.message||q("rfq.approval.inviteError"))}finally{N.value=!1}}else r.warning(q("rfq.approval.selectPurchasersFirst"));else r.error(q("rfq.approval.inviteError"))}function X(){_.value=!0}function ee(e,l="CNY"){return e?`${e.toFixed(2)} ${l}`:"-"}function le(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e.toString():null;if("string"==typeof e){const l=e.trim();if(!l)return null;const a=Number(l);return!Number.isNaN(a)&&Number.isFinite(a)?a.toString():l.toLowerCase()}try{const l=Number(e);if(!Number.isNaN(l)&&Number.isFinite(l))return l.toString()}catch{}const l=String(e).trim();return l?l.toLowerCase():null}function ae(e){if(!i.rfq?.quotes)return[];const l=function(e){const l=new Set,a=i.lineItem||{};return[a.id,a.lineItemId,a.line_item_id,a.lineId,a.line_id,a.itemId,a.item_id,a.lineNumber,a.line_number,a.itemNumber,a.item_number,e?.lineItemId,e?.lineItemNumber,e?.lineItemId??e?.line_item_id].forEach(e=>{const a=le(e);a&&l.add(a)}),l}(e);if(0===l.size)return[];const a=[];return i.rfq.quotes.forEach(e=>{const t=Array.isArray(e?.items)?e.items:Array.isArray(e?.quoteItems)?e.quoteItems:[];if(0===t.length)return;const r=function(e,l){return Array.isArray(e)&&0!==e.length&&0!==l.size?e.find(e=>[e?.lineItemId,e?.rfqLineItemId,e?.rfq_line_item_id,e?.lineId,e?.line_id,e?.id,e?.lineNumber,e?.line_number,e?.itemNumber,e?.item_number,e?.sku].some(e=>{const a=le(e);return null!==a&&l.has(a)})):null}(t,l);r&&void 0!==r.unitPrice&&null!==r.unitPrice&&!Number.isNaN(Number(r.unitPrice))&&a.push({supplierId:e.supplierId??e.supplier_id??e.id,supplierName:e.supplierName||e.companyName||e.supplier_name||q("rfq.quote.unknownSupplier"),price:Number(r.unitPrice)})}),a}function te(e){e&&(A.value=e,T.value=ae(e),V.value=!0)}function re(e){const l=e?.downloadUrl;l&&window.open(l,"_blank","noopener")}function ie(e){if(!i.priceComparisons)return null;const l=e=>{const l=String(e||"").toLowerCase();return"zhenkunxing"===l?"zkh":l},a=e=>{if(null==e||""===e)return null;const l=Number(e);return Number.isFinite(l)?l:null},t=a(i.lineItem?.id),r=l(e);return i.priceComparisons.find(e=>{if(l(e.platform??e.platformKey??"")!==r)return!1;const i=a(e.lineItemId??e.line_item_id);return null===t?null===i:i===t})}function oe(){f("priceUploaded")}return u(()=>W.value,e=>{e&&!z.value&&G()},{immediate:!0}),(e,a)=>{const t=J,o=ce,n=de,s=ge,u=Z,f=Pe,Q=he,W=$e,le=Ne,ae=P,ne=be,se=h,ue=Ce,me=ke,pe=U;return D(),d("div",Lt,[c("div",Ft,[c("h4",null,p(e.$t("rfq.lineItemWorkflow.approvalOperations")),1),m(t,{type:(fe=l.lineItem.status,{draft:"info",pending_director:"warning",completed:"success",rejected:"danger"}[fe]||"info"),size:"small"},{default:v(()=>[y(p(e.$t(`rfq.lineItemWorkflow.statuses.${l.lineItem.status}`)),1)]),_:1},8,["type"])]),m(n,{column:1,border:"",size:"small",class:"item-info"},{default:v(()=>[m(o,{label:e.$t("rfq.items.lineNumber")},{default:v(()=>[y(" #"+p(l.lineItem.lineNumber),1)]),_:1},8,["label"]),m(o,{label:e.$t("rfq.items.itemName")},{default:v(()=>[y(p(l.lineItem.itemName||l.lineItem.description),1)]),_:1},8,["label"]),m(o,{label:e.$t("rfq.items.quantity")},{default:v(()=>[y(p(l.lineItem.quantity)+" "+p(l.lineItem.unit),1)]),_:1},8,["label"]),l.selectedQuote?(D(),C(o,{key:0,label:e.$t("rfq.quote.selectedQuote")},{default:v(()=>[c("div",Et,[c("div",null,p(l.selectedQuote.supplierName),1),c("div",Qt,p(ee(l.selectedQuote.totalAmount,l.selectedQuote.currency)),1)])]),_:1},8,["label"])):b("",!0)]),_:1}),m(s),L.value?(D(),d("div",Wt,[c("h5",null,p(e.$t("rfq.lineItemWorkflow.submitForApproval")),1),m(u,{title:e.$t("rfq.lineItemWorkflow.selectQuoteHint"),type:"info",closable:!1,"show-icon":"",class:"hint-alert"},null,8,["title"]),m(ze,{type:"primary",disabled:!l.selectedQuote,loading:g.value,text:e.$t("rfq.lineItemWorkflow.submitToDirector"),"confirm-text":e.$t("rfq.lineItemWorkflow.confirmSubmit"),onConfirm:M,block:""},null,8,["disabled","loading","text","confirm-text"])])):F.value?(D(),d("div",Ot,[c("h5",null,p(e.$t("rfq.lineItemWorkflow.directorApproval")),1),m(ne,{model:R,"label-position":"top"},{default:v(()=>[m(Q,{label:e.$t("rfq.lineItemWorkflow.changeQuote")},{default:v(()=>[m(f,{modelValue:R.changeQuote,"onUpdate:modelValue":a[0]||(a[0]=e=>R.changeQuote=e),"active-text":e.$t("common.yes"),"inactive-text":e.$t("common.no")},null,8,["modelValue","active-text","inactive-text"])]),_:1},8,["label"]),R.changeQuote?(D(),C(Q,{key:0,label:e.$t("rfq.quote.selectNewQuote")},{default:v(()=>[m(le,{modelValue:R.newQuoteId,"onUpdate:modelValue":a[1]||(a[1]=e=>R.newQuoteId=e),placeholder:"Select quote",style:{width:"100%"}},{default:v(()=>[(D(!0),d(w,null,k(j.value,e=>(D(),C(W,{key:e.id,label:`${e.supplierName} - ${ee(e.totalAmount,e.currency)}`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"])):b("",!0),m(Q,{label:e.$t("common.comments")},{default:v(()=>[m(ae,{modelValue:R.comments,"onUpdate:modelValue":a[2]||(a[2]=e=>R.comments=e),type:"textarea",rows:3,placeholder:e.$t("rfq.lineItemWorkflow.commentsPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),O.value?(D(),d("div",Yt,[m(se,{type:"primary",plain:"",size:"small",onClick:a[3]||(a[3]=e=>async function(e){i.rfq?.id&&i.lineItem?.id?($.value=e,z.value||await G(),S.purchaserIds=[],S.message="",I.value=!0):r.error(q("rfq.approval.inviteError"))}("procurement_director"))},{default:v(()=>[y(p(e.$t("rfq.approval.invitePurchaser")),1)]),_:1})])):b("",!0),c("div",Mt,[m(ze,{type:"success",loading:g.value,text:e.$t("common.approve"),"confirm-text":e.$t("rfq.lineItemWorkflow.confirmApprove"),onConfirm:B},null,8,["loading","text","confirm-text"]),m(ze,{type:"danger","confirm-type":"danger",loading:g.value,text:e.$t("common.reject"),"confirm-text":e.$t("rfq.lineItemWorkflow.confirmReject"),onConfirm:H},null,8,["loading","text","confirm-text"])])])):(D(),d("div",Bt,[m(ue,{icon:"completed"===l.lineItem.status?"success":"info",title:"completed"===i.lineItem.status?q("rfq.lineItemWorkflow.completed"):q("rfq.lineItemWorkflow.noActionRequired"),"sub-title":q(`rfq.lineItemWorkflow.statusDescriptions.${i.lineItem.status}`)},null,8,["icon","title","sub-title"])])),m(s),c("div",Ht,[c("h5",null,p(e.$t("rfq.lineItemWorkflow.approvalHistory")),1),m(se,{type:"primary",text:"",onClick:X},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.viewHistory")),1)]),_:1})]),m(s),l.lineItem?(D(),d("div",Gt,[c("div",Kt,[c("h5",null,p(e.$t("rfq.lineItemWorkflow.marketPriceReference")),1),m(t,{size:"small",type:"info"},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.optionalUpload")),1)]),_:1})]),m(u,{title:e.$t("rfq.lineItemWorkflow.priceReferenceHint"),type:"info",closable:!1,"show-icon":"",class:"hint-alert"},null,8,["title"]),c("div",Jt,[m(me,{shadow:"hover",class:"platform-card"},{header:v(()=>[...a[10]||(a[10]=[c("div",{class:"platform-header"},[c("span",{class:"platform-name"},"1688")],-1)])]),default:v(()=>[m(jt,{"rfq-id":l.rfq.id,"line-item":l.lineItem,platform:"1688","comparison-data":ie("1688"),"can-upload":E.value,onViewDetail:te,onUploaded:oe},null,8,["rfq-id","line-item","comparison-data","can-upload"])]),_:1}),m(me,{shadow:"hover",class:"platform-card"},{header:v(()=>[c("div",Zt,[c("span",Xt,p(e.$t("rfq.priceComparison.jd")),1)])]),default:v(()=>[m(jt,{"rfq-id":l.rfq.id,"line-item":l.lineItem,platform:"jd","comparison-data":ie("jd"),"can-upload":E.value,onViewDetail:te,onUploaded:oe},null,8,["rfq-id","line-item","comparison-data","can-upload"])]),_:1}),m(me,{shadow:"hover",class:"platform-card"},{header:v(()=>[c("div",er,[c("span",lr,p(e.$t("rfq.priceComparison.zkh")),1)])]),default:v(()=>[m(jt,{"rfq-id":l.rfq.id,"line-item":l.lineItem,platform:"zkh","comparison-data":ie("zkh"),"can-upload":E.value,onViewDetail:te,onUploaded:oe},null,8,["rfq-id","line-item","comparison-data","can-upload"])]),_:1})])])):b("",!0),m(De,{visible:V.value,"onUpdate:visible":a[4]||(a[4]=e=>V.value=e),"detail-data":A.value,"supplier-prices":T.value,onDownload:re},null,8,["visible","detail-data","supplier-prices"]),m(pe,{modelValue:I.value,"onUpdate:modelValue":a[8]||(a[8]=e=>I.value=e),title:Y.value,width:"520px"},{footer:v(()=>[m(se,{onClick:a[7]||(a[7]=e=>I.value=!1)},{default:v(()=>[y(p(e.$t("common.cancel")),1)]),_:1}),m(se,{type:"primary",loading:N.value,disabled:0===S.purchaserIds.length,onClick:K},{default:v(()=>[y(p(e.$t("common.confirm")),1)]),_:1},8,["loading","disabled"])]),default:v(()=>[m(ne,{"label-position":"top"},{default:v(()=>[m(Q,{label:e.$t("rfq.approval.selectPurchasers")},{default:v(()=>[m(le,{modelValue:S.purchaserIds,"onUpdate:modelValue":a[5]||(a[5]=e=>S.purchaserIds=e),multiple:"",filterable:"","collapse-tags":"",style:{width:"100%"},placeholder:e.$t("rfq.approval.selectPurchasersPlaceholder")},{default:v(()=>[(D(!0),d(w,null,k(x.value,e=>(D(),C(W,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"]),0===x.value.length?(D(),d("div",ar,p(e.$t("rfq.approval.selectPurchasersPlaceholder")),1)):b("",!0)]),_:1},8,["label"]),m(Q,{label:e.$t("common.comments")},{default:v(()=>[m(ae,{modelValue:S.message,"onUpdate:modelValue":a[6]||(a[6]=e=>S.message=e),type:"textarea",rows:3,placeholder:e.$t("rfq.lineItemWorkflow.commentsPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1},8,["modelValue","title"]),m(pe,{modelValue:_.value,"onUpdate:modelValue":a[9]||(a[9]=e=>_.value=e),title:e.$t("rfq.lineItemWorkflow.approvalHistory"),width:"700px"},{default:v(()=>[m(Pt,{"rfq-id":l.rfq.id,"line-item-id":l.lineItem.id},null,8,["rfq-id","line-item-id"])]),_:1},8,["modelValue","title"])]);var fe}}}),[["__scopeId","data-v-e1c808b1"]]),rr={class:"pr-excel-generator"},ir={class:"items-selection"},or={class:"currency-list"},nr={class:"selection-header"},sr={class:"item-info"},ur={class:"item-name"},dr={class:"item-qty"},cr={key:0,class:"quote-info"},mr={class:"supplier"},pr={class:"price"},fr={class:"total"},vr={key:1,class:"quote-warning"},yr={class:"instruction-list"},qr={class:"dialog-footer"},br=z(i({__name:"RfqPoAttachmentDialog",props:{modelValue:{type:Boolean},rfqId:{},rfq:{},lineItems:{},preselectedItemId:{}},emits:["update:modelValue","success"],setup(e,{emit:l}){const t=Ie(),r=e,i=l,{t:q}=o(),g=a({get:()=>r.modelValue,set:e=>i("update:modelValue",e)}),_=n(),N=n(!1),$=n([]),S=n(!1),x=s({prNumber:"",department:"",accountNo:""}),z=a(()=>Array.isArray(r.lineItems)?r.lineItems:[]),V=a(()=>z.value.length>0&&$.value.length===z.value.length),A=a(()=>$.value.length>0&&!V.value),T=a(()=>{const e={};return z.value.forEach(l=>{const a=l.selectedQuote?.currency||l.currency||"CNY";e[a]||(e[a]=[]),e[a].push(l)}),e}),R=a(()=>Object.keys(T.value).length>1);function L(){const e=new Date,l=`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}`,a=(x.department||r.rfq?.requestingDepartment||"IT").toUpperCase();x.prNumber=`HZ_${a}_${l}001`}function F(){const e=z.value;return 0===e.length?[]:r.preselectedItemId&&e.some(e=>e.id===r.preselectedItemId)?[r.preselectedItemId]:e.map(e=>e.id)}function E(e){$.value=e?z.value.map(e=>e.id):[]}function Q(e){if(null==e||""===e)return"0.00";const l=Number(e);return Number.isNaN(l)?String(e):new Intl.NumberFormat("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:4}).format(l)}async function W(){try{if(N.value)return void console.warn("[PR Excel] Generation already in progress, ignoring duplicate request");if(N.value=!0,0===z.value.length)return void t.warning(q("rfq.pr.noLineItemsSelected"));if(0===$.value.length)return void t.warning(q("rfq.pr.pleaseSelectItems"));const l=new Set(z.value.map(e=>e.id)),a=$.value.filter(e=>l.has(e));if(0===a.length)return void t.error(q("rfq.pr.noLineItemsSelected"));let o;a.length>500&&t.warning({message:q("rfq.pr.exportCount",{count:a.length}),duration:5e3}),a.length>100&&(o=t.info({message:q("rfq.pr.generatingProgress",{count:a.length}),duration:0,showClose:!1}));try{const e=await ee(r.rfqId,a,{prNumber:x.prNumber||void 0,department:x.department||void 0,accountNo:x.accountNo||void 0});if(o&&o.close(),e.size<102400)console.warn(`[PR Excel] Generated file is small: ${(e.size/1024).toFixed(2)} KB`),t.warning({message:q("rfq.pr.fileSmallWarning",{size:(e.size/1024).toFixed(2)}),duration:8e3});else if(e.size>52428800)return void t.error({message:q("rfq.pr.fileLargeError",{size:(e.size/1024/1024).toFixed(2)}),duration:8e3});if(!(await(async()=>!(!S.value||"undefined"==typeof document||"undefined"==typeof window||(await M(),0)))()))return;const l=window.URL.createObjectURL(e),n=document.createElement("a");n.href=l;const s=(new Date).getTime(),u=x.prNumber||`HZ_PR_${s}`;n.download=`PR_(${u})_${s}.xlsm`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(l),t.success({message:q("rfq.pr.generateSuccessWithSize",{size:(e.size/1024).toFixed(2)}),duration:5e3}),i("success"),H()}catch(e){throw o&&o.close(),e}}catch(l){if(console.error("[PR Excel] Generation error:",l),"INVALID_LINE_ITEM_STATUS"===l?.code)!function(e){const l=e?.details?.invalidItems??[];if(!l.length)return void t.warning(e?.message||q("rfq.pr.invalidStatusMessage"));const a=l.map(e=>`${e.lineNumber?`#${e.lineNumber}`:`ID:${e.id}`} - ${e.reason||e.status||"invalid"}`).join("\n");B.alert(`<div>${q("rfq.pr.invalidStatusMessage")}<pre style="background:#f5f5f5;padding:10px;margin-top:10px;max-height:200px;overflow:auto;">${a}</pre></div>`,q("rfq.pr.invalidStatusTitle"),{dangerouslyUseHTMLString:!0,type:"warning",confirmButtonText:q("common.ok")});const r=new Set(l.map(e=>e.id));$.value=$.value.filter(e=>!r.has(e))}(l);else if("MISSING_SELECTED_QUOTE"===l?.code)!function(e){const l=e?.details?.missingQuoteItems??[];if(!l.length)return void t.error(e?.message||q("rfq.pr.generateFailed"));const a=l.map(e=>e.lineNumber?`#${e.lineNumber}`:`ID:${e.id}`).join(", ");t.error(`${q("rfq.pr.missingQuoteMessage")}: ${a}`,void 0,{duration:1e4,showClose:!0});const r=new Set(l.map(e=>e.id));$.value=$.value.filter(e=>!r.has(e))}(l);else{const e=l?.code||"UNKNOWN",a=l?.message||q("rfq.pr.generateFailed");"NO_VALID_LINE_ITEMS"===e||"INVALID_LINE_ITEMS"===e?t.warning({message:a,duration:8e3,showClose:!0}):"TEMPLATE_ERROR"===e||"FILE_TOO_SMALL"===e?t.error({message:a,duration:1e4,showClose:!0}):t.error({message:a,duration:8e3,showClose:!0})}l?.details&&console.error("[PR Excel] Error details:",l.details)}finally{N.value=!1}}function H(){x.prNumber="",x.department="",x.accountNo="",$.value=[],i("update:modelValue",!1)}return j(()=>{S.value=!0}),O(()=>{S.value=!1}),u(()=>r.modelValue,e=>{e?(r.rfq&&(x.department=r.rfq.requestingDepartment||""),$.value=F()):$.value=[]}),u(()=>r.lineItems,e=>{const l=Array.isArray(e)?e:[],a=new Set(l.map(e=>e.id));$.value=$.value.filter(e=>a.has(e)),r.modelValue&&0===$.value.length&&l.length>0&&($.value=F())},{deep:!0}),(l,a)=>{const t=Z,r=ve,i=J,o=ye,n=qe,s=h,u=P,q=he,S=we,z=_e,j=be,F=U;return D(),C(F,{modelValue:g.value,"onUpdate:modelValue":a[4]||(a[4]=e=>g.value=e),title:l.$t("rfq.pr.generatePrExcel"),width:"700px","close-on-click-modal":!1,onClose:H},{footer:v(()=>[c("div",qr,[m(s,{onClick:H},{default:v(()=>[y(p(l.$t("common.cancel")),1)]),_:1}),m(s,{type:"primary",loading:N.value,disabled:0===$.value.length,icon:f(Y),onClick:W},{default:v(()=>[y(p(l.$t("rfq.pr.generateAndDownload"))+" ",1),$.value.length?(D(),d(w,{key:0},[y(" ("+p($.value.length)+") ",1)],64)):b("",!0)]),_:1},8,["loading","disabled","icon"])])]),default:v(()=>[c("div",rr,[m(t,{title:l.$t("rfq.pr.selectItemsToExport"),type:"info",closable:!1,"show-icon":"",class:"selected-items-alert"},{default:v(()=>[c("div",ir,[R.value?(D(),C(t,{key:0,type:"warning",closable:!1,"show-icon":"",class:"currency-warning"},{title:v(()=>[y(p(l.$t("rfq.pr.multipleCurrencyWarning")),1)]),default:v(()=>[c("div",null,[y(p(l.$t("rfq.pr.multipleCurrencyHint"))+" ",1),c("ul",or,[(D(!0),d(w,null,k(T.value,(e,a)=>(D(),d("li",{key:a},p(a)+": "+p(e.length)+" "+p(l.$t("rfq.pr.items")),1))),128))])])]),_:1})):b("",!0),c("div",nr,[m(r,{"model-value":V.value,indeterminate:A.value,onChange:E},{default:v(()=>[y(p(l.$t("rfq.pr.selectAll"))+" ("+p($.value.length)+"/"+p(e.lineItems.length)+") ",1)]),_:1},8,["model-value","indeterminate"])]),m(n,{"max-height":"280px"},{default:v(()=>[m(o,{modelValue:$.value,"onUpdate:modelValue":a[0]||(a[0]=e=>$.value=e),class:"item-checkbox-group"},{default:v(()=>[(D(!0),d(w,null,k(e.lineItems,e=>(D(),d("div",{key:e.id,class:I(["item-row",{"is-selected":$.value.includes(e.id)}])},[m(r,{label:e.id,class:"item-checkbox"},{default:v(()=>[c("div",sr,[m(i,{size:"small",type:"primary"},{default:v(()=>[y("#"+p(e.lineNumber),1)]),_:2},1024),c("span",ur,p(e.itemName||e.description),1),c("span",dr,p(e.quantity)+" "+p(e.unit),1)])]),_:2},1032,["label"]),e.selectedQuote?(D(),d("div",cr,[c("span",mr,p(e.selectedQuote.supplierName),1),c("span",pr,p(e.selectedQuote.currency)+" "+p(Q(e.selectedQuote.unitPrice)),1),c("span",fr,p(l.$t("rfq.pr.total"))+": "+p(e.selectedQuote.currency)+" "+p(Q(e.selectedQuote.totalPrice)),1)])):(D(),d("div",vr,[m(i,{type:"warning",size:"small"},{default:v(()=>[y(p(l.$t("rfq.pr.noQuoteSelected")),1)]),_:1})]))],2))),128))]),_:1},8,["modelValue"])]),_:1})])]),_:1},8,["title"]),m(j,{ref_key:"formRef",ref:_,model:x,"label-position":"top",class:"pr-form"},{default:v(()=>[m(z,{gutter:20},{default:v(()=>[m(S,{span:12},{default:v(()=>[m(q,{label:l.$t("rfq.pr.prNumber")},{default:v(()=>[m(u,{modelValue:x.prNumber,"onUpdate:modelValue":a[1]||(a[1]=e=>x.prNumber=e),placeholder:l.$t("rfq.pr.autoGenerated"),clearable:""},{append:v(()=>[m(s,{onClick:L},{default:v(()=>[y(p(l.$t("rfq.pr.autoGenerate")),1)]),_:1})]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1}),m(S,{span:12},{default:v(()=>[m(q,{label:l.$t("rfq.pr.department")},{default:v(()=>[m(u,{modelValue:x.department,"onUpdate:modelValue":a[2]||(a[2]=e=>x.department=e),placeholder:e.rfq?.requestingDepartment||l.$t("rfq.pr.departmentPlaceholder"),clearable:""},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1}),m(z,{gutter:20},{default:v(()=>[m(S,{span:12},{default:v(()=>[m(q,{label:l.$t("rfq.pr.accountNo")},{default:v(()=>[m(u,{modelValue:x.accountNo,"onUpdate:modelValue":a[3]||(a[3]=e=>x.accountNo=e),placeholder:l.$t("rfq.pr.accountNoPlaceholder"),clearable:""},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1}),m(t,{title:l.$t("rfq.pr.instructions"),type:"success",closable:!1,"show-icon":""},{default:v(()=>[c("ul",yr,[c("li",null,p(l.$t("rfq.pr.instruction1")),1),c("li",null,p(l.$t("rfq.pr.instruction2")),1),c("li",null,p(l.$t("rfq.pr.instruction3")),1),c("li",null,p(l.$t("rfq.pr.instruction4")),1)])]),_:1},8,["title"])]),_:1},8,["model"])])]),_:1},8,["modelValue","title"])}}}),[["__scopeId","data-v-976be8d8"]]),hr={class:"rfq-line-item-workflow"},gr={class:"quote-lock-meta"},_r={key:0},wr={class:"workflow-header"},kr={class:"header-info"},Ir={class:"workflow-content"},Cr={class:"price-comparison-section"},Nr={class:"approval-operation-section"},$r=z(i({__name:"RfqLineItemWorkflowLayout",props:{rfqId:{}},setup(l){const t=Ie(),r=l,{t:i}=o(),s=H(),g=n(!1),_=n(null),w=n([]),k=n([]),I=n(null),N=n(null),$=n(!1),P=a(()=>s.user?.role||""),U=a(()=>Boolean(_.value&&!1===_.value.quotesVisible&&_.value.visibilityReason)),S=a(()=>_.value?.visibilityReason||null),x=a(()=>I.value?w.value.find(e=>e.id===I.value):null),z=a(()=>N.value?k.value.find(e=>e.id===N.value):null),V=a(()=>"purchaser"===P.value),A=a(()=>{if(!x.value)return!1;if("purchaser"!==P.value)return!1;const e=x.value.status??"";return["draft","rejected"].includes(e)}),T=a(()=>{const e=["pending_director","pending_po"];return w.value.filter(l=>e.includes(l.status??"")).length}),R=a(()=>w.value.filter(e=>"completed"===(e.status??"")).length),L=a(()=>w.value.filter(e=>"pending_po"===(e.status??""))),F=a(()=>{const e=Array.isArray(k.value)?k.value:[];return L.value.map(l=>{const a=l.selectedQuoteId?e.find(e=>e.id===l.selectedQuoteId):null,t=(a&&(a.lineItems||a.items||a.quoteItems)||[]).find(e=>ie(e.rfqLineItemId,e.lineItemId,e.rfq_line_item_id)===l.id),r=ie(t?.currency,t?.currency_code,a?.currency,l.currency,"CNY"),i=oe(t?.unitPrice,t?.unit_price,a?.unitPrice,a?.unit_price,l.unitPrice,l.unit_price,0)??0,o=oe(t?.totalPrice,t?.total_price,a?.totalAmount,a?.total_price,l.totalPrice,l.total_price,i*(l.quantity||1))??0;return{id:l.id,lineNumber:l.lineNumber??l.line_number??0,quantity:l.quantity??0,unit:l.unit??"",itemName:l.itemName,description:l.description,currency:l.currency,status:l.status??void 0,selectedQuoteId:l.selectedQuoteId,selectedQuote:a?{id:a.id,supplierId:ie(a.supplierId,a.supplier_id),supplierName:ie(a.supplierName,a.companyName,a.supplier_name,""),supplierCode:ie(a.companyId,a.company_id,a.supplierCode,""),currency:r,unitPrice:i,totalPrice:o,deliveryPeriod:ie(t?.deliveryPeriod,t?.delivery_period,a?.deliveryPeriod,a?.delivery_period,null)}:null}})});async function E(){g.value=!0;try{let l;try{l=await le(r.rfqId)}catch(e){console.warn("[RfqLineItemWorkflow] fetchRfqWorkflow failed, falling back to fetchRfqById",e),l=await ae(r.rfqId)}!Array.isArray(l.items)&&Array.isArray(l.lineItems)&&(l.items=l.lineItems),l.priceComparisons=function(e){if(!Array.isArray(e))return[];const l=e=>{if(null==e||""===e)return null;const l=Number(e);return Number.isFinite(l)?l:null};return e.map(e=>{const a=e.platform??e.platformKey??e.platform_key??"";let t=String(a||"").toLowerCase();"zhenkunxing"===t&&(t="zkh"),"1688"!==t&&"jd"!==t&&"zkh"!==t&&(t=String(a||""));const r=e.originalFileName??e.original_file_name??e.fileName??e.file_name??"",i=e.filePath??e.file_path??"",o=e.storedFileName??e.stored_file_name??("string"==typeof i?i.split("/").pop():"")??"",n=e.productUrl??e.product_url??"",s=e.platformPrice??e.platform_price??null,u=te(i,o,"rfq_price_comparison");return{...e,platform:t,fileName:r,originalFileName:e.originalFileName??e.original_file_name??r,productUrl:n,platformPrice:s,downloadUrl:u,lineItemId:l(e.lineItemId??e.line_item_id)}})}(l.priceComparisons),_.value=l;const a=Array.isArray(l.lineItems)?l.lineItems:Array.isArray(l.items)?l.items:[];if(w.value=a,k.value=l.quotes||[],!I.value&&a.length>0&&(I.value=a[0].id),I.value){const e=a.find(e=>e.id===I.value);e?.selectedQuoteId&&(N.value=e.selectedQuoteId)}}catch(l){t.error(l.message||i("common.loadFailed"))}finally{g.value=!1}}function Q(e){I.value=e;const l=w.value.find(l=>l.id===e);l?.selectedQuoteId&&(N.value=l.selectedQuoteId)}function W(e){A.value&&(N.value=Number(e))}function O(e){if(!e)return"-";try{return new Date(e).toLocaleString()}catch{return e}}async function M(l){if(I.value){g.value=!0;try{await async function(l,a,t){return e(`/rfq/${l}/line-items/${a}/submit`,{method:"POST",body:{selectedQuoteId:t}})}(r.rfqId,I.value,l),t.success(i("rfq.lineItemWorkflow.submitSuccess")),await E()}catch(a){t.error(a.message||i("common.operationFailed"))}finally{g.value=!1}}}async function B(e){if(I.value){g.value=!0;try{const l=x.value;if(!l)return;const a={decision:"approved",comments:e.comments,newQuoteId:e.newQuoteId};"pending_director"===l.status&&(await Ve(r.rfqId,I.value,a),t.success(i("rfq.lineItemWorkflow.directorApproveSuccess"))),await E()}catch(l){t.error(l.message||i("common.operationFailed"))}finally{g.value=!1}}}async function X(e){if(I.value){g.value=!0;try{const l=x.value;if(!l)return;const a={decision:"rejected",comments:e};"pending_director"===l.status&&(await Ve(r.rfqId,I.value,a),t.success(i("rfq.lineItemWorkflow.directorRejectSuccess"))),await E()}catch(l){t.error(l.message||i("common.operationFailed"))}finally{g.value=!1}}}function ee(){V.value&&(0!==L.value.length?$.value=!0:t.warning(i("rfq.pr.noLineItemsSelected")))}function re(){t.success(i("rfq.pr.generateSuccess")),E()}return u(()=>r.rfqId,()=>{E()},{immediate:!0}),j(()=>{E()}),(e,a)=>{const t=Z,r=J,i=h,o=K,n=G;return q((D(),d("div",hr,[U.value&&S.value?(D(),C(t,{key:0,type:"warning",closable:!1,class:"quote-lock-alert"},{title:v(()=>[y(p(S.value.message),1)]),default:v(()=>[c("p",gr,[c("span",null,p(S.value.submittedCount??0)+"/"+p(S.value.totalInvited??0)+" "+p(e.$t("rfq.quote.quotes")),1),S.value.deadline?(D(),d("span",_r," · "+p(O(S.value.deadline)),1)):b("",!0)])]),_:1})):b("",!0),c("div",wr,[c("h3",null,p(e.$t("rfq.lineItemWorkflow.title")),1),c("div",kr,[m(r,{type:"info",size:"large"},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.totalItems",{count:w.value.length})),1)]),_:1}),T.value>0?(D(),C(r,{key:0,type:"warning",size:"large"},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.pendingItems",{count:T.value})),1)]),_:1})):b("",!0),R.value>0?(D(),C(r,{key:1,type:"success",size:"large"},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.completedItems",{count:R.value})),1)]),_:1})):b("",!0),V.value&&L.value.length>0?(D(),C(i,{key:2,type:"primary",icon:f(Y),onClick:ee},{default:v(()=>[y(p(e.$t("rfq.pr.batchGenerate"))+" ("+p(L.value.length)+") ",1)]),_:1},8,["icon"])):b("",!0)])]),c("div",Ir,[c("div",Cr,[m(vt,{rfq:_.value,"line-items":w.value,quotes:k.value,"selected-line-item-id":I.value,"user-role":P.value,onSelectItem:Q,onSelectQuote:W},null,8,["rfq","line-items","quotes","selected-line-item-id","user-role"])]),c("div",Nr,[x.value?(D(),C(tr,{key:0,rfq:_.value,"line-item":x.value,"selected-quote":z.value,"user-role":P.value,"price-comparisons":_.value.priceComparisons,onApprove:B,onReject:X,onSubmit:M,onRefresh:E,onPriceUploaded:E},null,8,["rfq","line-item","selected-quote","user-role","price-comparisons"])):(D(),C(o,{key:1,description:e.$t("rfq.lineItemWorkflow.selectItemHint"),"image-size":120},null,8,["description"]))])]),m(br,{modelValue:$.value,"onUpdate:modelValue":a[0]||(a[0]=e=>$.value=e),"rfq-id":l.rfqId,rfq:_.value,"line-items":F.value,"preselected-item-id":I.value,onSuccess:re},null,8,["modelValue","rfq-id","rfq","line-items","preselected-item-id"])])),[[n,g.value]])}}}),[["__scopeId","data-v-249a2db7"]]);export{$r as default};
