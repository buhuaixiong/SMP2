import{d as e,c as l,h as a,i,z as o,k as t,j as r,e as s,x as d,y as u,A as n,O as p,f as m,aO as f,E as v,a0 as c,t as g,H as y,o as _,_ as h}from"./index-CA1ThEvj.js";import{a as b,E as x}from"./el-form-item-CIgjZRq6.js";import{E as D}from"./el-date-picker-panel-DXckY9Ty.js";/* empty css                 */import"./el-scrollbar-DefzV4pD.js";import{E as j}from"./el-upload-fKDgI81Q.js";import"./el-progress-zXB2nP8i.js";import{E as w}from"./el-alert-VmMlafpt.js";import{u as F}from"./fileUploads-D_zl5Zyt.js";import{u as Y}from"./useNotification-BAKLaPVZ.js";import"./castArray-BAWcvkMO.js";import"./_baseClone-AiIcXXKO.js";import"./dayjs.min-CuEfV50W.js";import"./index-BHkcXN0Y.js";import"./debounce-D9fFbg8F.js";import"./cloneDeep-BbGJWJjn.js";const M={style:{display:"flex","align-items":"center",gap:"8px"}},T={style:{color:"#909399"}},V={class:"dialog-footer"},B=h(e({__name:"SupplierFileUploadDialog",props:{visible:{type:Boolean},supplierId:{}},emits:["update:visible","success"],setup(e,{emit:h}){const B=Y(),E=e,k=h,U=l({get:()=>E.visible,set:e=>k("update:visible",e)}),q=a(),z=a(),H=a(!1),I=a([]),C=i({fileDescription:"",validFrom:"",validTo:""}),O={validFrom:[{required:!0,message:"请选择生效日期",trigger:"change"}],validTo:[{required:!0,message:"请选择过期日期",trigger:"change"},{validator:(e,l,a)=>{l&&C.validFrom&&l<=C.validFrom?a(new Error("过期日期必须晚于生效日期")):a()},trigger:"change"}]},A=a(null),K=e=>{const l=new Date;return l.setHours(0,0,0,0),e.getTime()<l.getTime()},N=e=>{if(!C.validFrom){const l=new Date;return l.setHours(0,0,0,0),e.getTime()<l.getTime()}const l=new Date(C.validFrom);return l.setHours(0,0,0,0),e.getTime()<=l.getTime()},R=e=>{A.value=e.raw||null},W=()=>{A.value=null},G=e=>{if(0===e)return"0 B";const l=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,l)*100)/100+" "+["B","KB","MB","GB"][l]},J=()=>{H.value?B.warning("文件正在上传,请稍候..."):(U.value=!1,P())},P=()=>{C.fileDescription="",C.validFrom="",C.validTo="",A.value=null,I.value=[],q.value&&q.value.clearValidate(),z.value&&z.value.clearFiles()},S=async()=>{if(!A.value)return void B.warning("请选择要上传的文件");try{await q.value.validate()}catch(e){return void B.warning("请完整填写表单")}if(!C.validFrom||!C.validTo)return void B.warning("请选择文件有效期");if(A.value.size>20971520)B.error("文件大小不能超过20MB");else try{H.value=!0;const e=await F({supplierId:E.supplierId,file:A.value,fileDescription:C.fileDescription||void 0,validFrom:C.validFrom,validTo:C.validTo});B.success({message:e.message||"文件上传成功,已进入审批流程",duration:3e3}),k("success"),U.value=!1,P()}catch(e){console.error("Failed to upload file:",e),B.error(e?.message||"文件上传失败,请稍后重试")}finally{H.value=!1}};return(e,l)=>{const a=w,i=p,h=n,F=j,Y=b,B=v,E=D,k=x,P=y;return _(),o(P,{modelValue:U.value,"onUpdate:modelValue":l[3]||(l[3]=e=>U.value=e),title:"上传文件",width:"600px","before-close":J},{footer:t(()=>[s("span",V,[r(h,{onClick:J},{default:t(()=>[...l[8]||(l[8]=[d("取消",-1)])]),_:1}),r(h,{type:"primary",loading:H.value,disabled:!A.value,onClick:S},{default:t(()=>[...l[9]||(l[9]=[d(" 上传并提交审批 ",-1)])]),_:1},8,["loading","disabled"])])]),default:t(()=>[r(a,{title:"审批流程说明",type:"warning",closable:!1,style:{"margin-bottom":"20px"}},{default:t(()=>[...l[4]||(l[4]=[s("p",null,[d("文件上传后将进入"),s("strong",null,"5级审批流程"),d(":")],-1),s("ol",{style:{margin:"8px 0","padding-left":"20px"}},[s("li",null,"采购员审批"),s("li",null,"品质审批"),s("li",null,"采购经理审批"),s("li",null,"采购总监审批"),s("li",null,"财务总监审批")],-1),s("p",{style:{"margin-top":"8px",color:"#909399","font-size":"13px"}}," 文件审批完成后才能生效。如任何步骤被拒绝,需重新提交。 ",-1)])]),_:1}),r(k,{ref_key:"formRef",ref:q,model:C,rules:O,"label-width":"100px"},{default:t(()=>[r(Y,{label:"文件选择",prop:"file",required:""},{default:t(()=>[r(F,{ref_key:"uploadRef",ref:z,"auto-upload":!1,limit:1,"on-change":R,"on-remove":W,"file-list":I.value,accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"},{tip:t(()=>[...l[6]||(l[6]=[s("div",{class:"el-upload__tip"},"支持格式: PDF, Word, Excel, 图片 (最大20MB)",-1)])]),default:t(()=>[r(h,{type:"primary"},{default:t(()=>[r(i,null,{default:t(()=>[r(m(f))]),_:1}),l[5]||(l[5]=d(" 选择文件 ",-1))]),_:1})]),_:1},8,["file-list"])]),_:1}),r(Y,{label:"文件说明",prop:"fileDescription"},{default:t(()=>[r(B,{modelValue:C.fileDescription,"onUpdate:modelValue":l[0]||(l[0]=e=>C.fileDescription=e),type:"textarea",rows:3,placeholder:"请简要说明文件内容和用途(可选)",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),r(Y,{label:"生效日期",prop:"validFrom",required:""},{default:t(()=>[r(E,{modelValue:C.validFrom,"onUpdate:modelValue":l[1]||(l[1]=e=>C.validFrom=e),type:"date",placeholder:"选择生效日期","disabled-date":K,style:{width:"100%"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),r(Y,{label:"过期日期",prop:"validTo",required:""},{default:t(()=>[r(E,{modelValue:C.validTo,"onUpdate:modelValue":l[2]||(l[2]=e=>C.validTo=e),type:"date",placeholder:"选择过期日期","disabled-date":N,style:{width:"100%"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),A.value?(_(),o(a,{key:0,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:t(()=>[s("div",M,[r(i,null,{default:t(()=>[r(m(c))]),_:1}),s("span",null,[l[7]||(l[7]=s("strong",null,"已选文件:",-1)),d(" "+g(A.value.name),1)]),s("span",T,"("+g(G(A.value.size))+")",1)])]),_:1})):u("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-f25658ef"]]);export{B as default};
