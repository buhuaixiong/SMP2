import{W as e,aT as t,d as a,u as i,h as s,i as n,c as o,C as r,aU as l,b as d,j as u,e as c,k as g,f as p,y as m,t as y,x as v,m as A,v as h,aQ as L,F as f,r as b,J as k,I as w,S,aV as D,o as I,_ as T}from"./index-DjspUdFg.js";import{P as _}from"./PageHeader-BUkm-SxF.js";import{u as C}from"./useNotification-DwlfXzSY.js";const x=e=>e&&"object"==typeof e&&"data"in e?e.data:e,U=async(t={})=>{const a=new URLSearchParams;t.entityType&&a.set("entityType",t.entityType),t.entityId&&a.set("entityId",t.entityId),t.actorId&&a.set("actorId",t.actorId),t.ipAddress&&a.set("ipAddress",t.ipAddress),t.keyword&&a.set("keyword",t.keyword),t.startDate&&a.set("startDate",t.startDate),t.endDate&&a.set("endDate",t.endDate),void 0!==t.isSensitive&&a.set("isSensitive",String(t.isSensitive)),t.page&&a.set("page",String(t.page)),t.limit&&a.set("limit",String(t.limit)),t.includeDiagnostics&&a.set("includeDiagnostics","true");const i=a.toString();return await e("/audit"+(i?`?${i}`:""))},E=Object.freeze(Object.defineProperty({__proto__:null,exportAuditLogs:async e=>{const a=new URLSearchParams;e.startDate&&a.set("startDate",e.startDate),e.endDate&&a.set("endDate",e.endDate),void 0!==e.isSensitive&&a.set("isSensitive",String(e.isSensitive)),e.entityType&&a.set("entityType",e.entityType),e.entityId&&a.set("entityId",e.entityId);const i=a.toString(),s=await fetch(`${t}/audit-archive/export${i?`?${i}`:""}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!s.ok)throw new Error("Failed to export audit logs");return s.blob()},getAuditAggregatorDiagnostics:async()=>{const t=await e("/audit/diagnostics/aggregator");return x(t)},listAuditLogs:U,verifyArchivedLog:async t=>{const a=await e(`/audit-archive/verify/${t}`,{method:"POST"});return x(a)},verifyHashChain:async(t,a)=>{const i=new URLSearchParams;t&&i.set("startId",String(t)),a&&i.set("endId",String(a));const s=i.toString(),n=await e("/audit-archive/verify-chain"+(s?`?${s}`:""),{method:"POST"});return x(n)}},Symbol.toStringTag,{value:"Module"})),P={class:"audit-log-viewer"},V={class:"header-actions"},F={class:"panel filters-panel"},q={class:"filter-grid"},O=["placeholder"],R=["placeholder"],j={value:""},$={value:"user"},B={value:"user_role"},H={value:"supplier"},N={value:"supplier_status"},W={value:"supplier_document"},z={value:"contract"},J={value:"rating"},M={value:"buyer_assignment"},Q={value:"audit_log"},G=["placeholder"],K={value:""},X={value:"true"},Y={value:"false"},Z=["placeholder"],ee={class:"filter-actions"},te=["disabled"],ae={key:0,class:"query-stats"},ie={key:0},se={key:1},ne={key:2},oe={key:3,class:"query-warning"},re={key:1,class:"query-diagnostics"},le={key:0},de={key:1},ue={class:"panel"},ce={class:"section-header"},ge={key:0,class:"muted"},pe={key:0,class:"placeholder"},me={key:1,class:"placeholder"},ye={key:2,class:"log-list"},ve={class:"entry-header"},Ae={class:"entry-meta"},he={class:"entry-id"},Le=["title"],fe={class:"entry-type"},be={key:1,class:"entry-entity"},ke={class:"entry-action"},we=["title"],Se=["datetime"],De={class:"entry-body"},Ie={class:"entry-actor"},Te={key:0,class:"muted"},_e={key:0,class:"entry-changes"},Ce=["onClick"],xe={key:0,class:"changes-detail"},Ue={key:1,class:"entry-hash"},Ee={class:"hash-label"},Pe={class:"hash-value"},Ve=["onClick"],Fe={key:3,class:"pagination-footer"},qe=["disabled"],Oe={class:"page-info"},Re=["disabled"],je=T(a({__name:"AdminAuditLogView",setup(e){const t=C(),{t:a}=i(),T=s([]),x=s(!1),je=s(1),$e=s(50),Be=s(new Set),He=s(null),Ne=s(void 0),We=s(null),ze=s(null),Je=s([]),Me=s(null),Qe=s(!1),Ge=s(!1),Ke=n({entityType:"",entityId:"",actorId:"",ipAddress:"",keyword:"",startDate:"",endDate:"",isSensitive:""}),Xe=o(()=>Boolean(Ke.entityType||Ke.entityId||Ke.actorId||Ke.ipAddress||Ke.keyword||Ke.startDate||Ke.endDate||Ke.isSensitive)),Ye=o(()=>{if(!We.value)return null;const e=We.value.toLowerCase();return["elasticsearch","loki","aggregator","sqlite"].includes(e)?a(`adminAuditLog.querySources.${e}`):We.value}),Ze=o(()=>Je.value.length?Je.value.join(", "):"");let et=null;const tt=()=>{et&&clearTimeout(et),et=setTimeout(()=>{rt()},500)},at={user:"user",user_role:"userRole",supplier:"supplier",supplier_status:"supplierStatus",supplier_document:"supplierDocument",contract:"contract",rating:"rating",buyer_assignment:"buyerAssignment"},it=e=>{if(!e)return a("adminAuditLog.format.unknown");const t=at[e];return t?a(`adminAuditLog.filters.options.${t}`):e.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")},st=e=>{try{const t=new Date(e);return new Intl.DateTimeFormat(D(),{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(t)}catch{return e}},nt=async()=>{x.value=!0;try{const e={page:je.value,limit:$e.value};Ke.entityType&&(e.entityType=Ke.entityType),Ke.entityId&&(e.entityId=Ke.entityId),Ke.actorId&&(e.actorId=Ke.actorId),Ke.ipAddress&&(e.ipAddress=Ke.ipAddress),Ke.keyword&&(e.keyword=Ke.keyword),Ke.startDate&&(e.startDate=Ke.startDate),Ke.endDate&&(e.endDate=Ke.endDate),Ke.isSensitive&&(e.isSensitive=Ke.isSensitive),e.includeDiagnostics=!0,We.value=null,ze.value=null,Je.value=[];const t=await U(e);T.value=t.data,He.value=t.queryTime??null,Ne.value=t.total,We.value=t.querySource??null,ze.value=t.performanceWarning??null,Je.value=Array.isArray(t.appliedFilters)?t.appliedFilters:[],Me.value=t.diagnostics?.aggregator??null}catch(e){console.error(a("adminAuditLog.messages.loadFailed"),e);const i=e instanceof Error?e.message:a("adminAuditLog.messages.loadFailed");t.error(i)}finally{x.value=!1}},ot=async()=>{Qe.value=!0;try{const{getAuditAggregatorDiagnostics:e}=await k(async()=>{const{getAuditAggregatorDiagnostics:e}=await Promise.resolve().then(()=>E);return{getAuditAggregatorDiagnostics:e}},void 0);Me.value=await e()}catch(e){console.error("Failed to fetch aggregator diagnostics",e);const i=e instanceof Error?e.message:a("adminAuditLog.messages.diagnosticsFailed");t.error(i)}finally{Qe.value=!1}},rt=()=>{je.value=1,Be.value.clear(),nt()},lt=()=>{Ke.entityType="",Ke.entityId="",Ke.actorId="",Ke.ipAddress="",Ke.keyword="",Ke.startDate="",Ke.endDate="",Ke.isSensitive="",rt()},dt=e=>{je.value=e,Be.value.clear(),nt()},ut=()=>{Be.value.clear(),nt()},ct=async()=>{try{await t.confirm(a("adminAuditLog.messages.verifyChainConfirm"),a("adminAuditLog.messages.verifyChainTitle"),{confirmButtonText:a("common.confirm"),cancelButtonText:a("common.cancel"),type:"info"});const{verifyHashChain:e}=await k(async()=>{const{verifyHashChain:e}=await Promise.resolve().then(()=>E);return{verifyHashChain:e}},void 0),i=await e();i.valid?t.success({message:a("adminAuditLog.messages.chainSuccess",{message:i.message}),duration:5e3}):(t.error({message:a("adminAuditLog.messages.chainFailure",{message:i.message}),duration:5e3}),i.brokenChains&&i.brokenChains.length>0&&console.error("Broken hash chains detected",i.brokenChains))}catch(e){if("cancel"===e)return;const i=e instanceof Error?e.message:String(e);t.error(a("adminAuditLog.messages.chainError",{message:i}))}},gt=async()=>{try{await t.confirm(a("adminAuditLog.messages.exportConfirm"),a("adminAuditLog.messages.exportTitle"),{confirmButtonText:a("common.confirm"),cancelButtonText:a("common.cancel"),type:"info"});const{exportAuditLogs:e}=await k(async()=>{const{exportAuditLogs:e}=await Promise.resolve().then(()=>E);return{exportAuditLogs:e}},void 0),i={startDate:Ke.startDate||void 0,endDate:Ke.endDate||void 0,isSensitive:Ke.isSensitive?"true"===Ke.isSensitive:void 0,entityType:Ke.entityType||void 0,entityId:Ke.entityId||void 0},s=await e(i);if(!(await(async()=>!(!Ge.value||"undefined"==typeof document||"undefined"==typeof window||(await w(),0)))()))return;const n=window.URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=`audit-logs-export-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(n),t.success(a("adminAuditLog.messages.exportSuccess"))}catch(e){if("cancel"===e)return;const i=e instanceof Error?e.message:String(e);t.error(a("adminAuditLog.messages.exportFailed",{message:i}))}};return r(()=>{Ge.value=!0,nt()}),l(()=>{Ge.value=!1}),(e,i)=>(I(),d("div",P,[u(_,{title:p(a)("adminAuditLog.title"),subtitle:p(a)("adminAuditLog.subtitle")},{actions:g(()=>[c("div",V,[c("button",{class:"link-btn",type:"button",onClick:ut},y(p(a)("common.refresh")),1),Xe.value?(I(),d("button",{key:0,class:"link-btn",type:"button",onClick:lt},y(p(a)("adminAuditLog.actions.clearFilters")),1)):m("",!0)])]),_:1},8,["title","subtitle"]),c("section",F,[c("h2",null,y(p(a)("adminAuditLog.filters.advancedTitle")),1),c("div",q,[c("label",null,[v(y(p(a)("adminAuditLog.filters.actorId"))+" ",1),A(c("input",{"onUpdate:modelValue":i[0]||(i[0]=e=>Ke.actorId=e),type:"text",placeholder:p(a)("adminAuditLog.filters.placeholders.actorId"),onInput:tt},null,40,O),[[h,Ke.actorId]])]),c("label",null,[v(y(p(a)("adminAuditLog.filters.ipAddress"))+" ",1),A(c("input",{"onUpdate:modelValue":i[1]||(i[1]=e=>Ke.ipAddress=e),type:"text",placeholder:p(a)("adminAuditLog.filters.placeholders.ipAddress"),onInput:tt},null,40,R),[[h,Ke.ipAddress]])]),c("label",null,[v(y(p(a)("adminAuditLog.filters.entityType"))+" ",1),A(c("select",{"onUpdate:modelValue":i[2]||(i[2]=e=>Ke.entityType=e),onChange:rt},[c("option",j,y(p(a)("adminAuditLog.filters.options.all")),1),c("option",$,y(p(a)("adminAuditLog.filters.options.user")),1),c("option",B,y(p(a)("adminAuditLog.filters.options.userRole")),1),c("option",H,y(p(a)("adminAuditLog.filters.options.supplier")),1),c("option",N,y(p(a)("adminAuditLog.filters.options.supplierStatus")),1),c("option",W,y(p(a)("adminAuditLog.filters.options.supplierDocument")),1),c("option",z,y(p(a)("adminAuditLog.filters.options.contract")),1),c("option",J,y(p(a)("adminAuditLog.filters.options.rating")),1),c("option",M,y(p(a)("adminAuditLog.filters.options.buyerAssignment")),1),c("option",Q,y(p(a)("adminAuditLog.filters.options.auditLog")),1)],544),[[L,Ke.entityType]])]),c("label",null,[v(y(p(a)("adminAuditLog.filters.keyword"))+" ",1),A(c("input",{"onUpdate:modelValue":i[3]||(i[3]=e=>Ke.keyword=e),type:"text",placeholder:p(a)("adminAuditLog.filters.placeholders.keyword"),onInput:tt},null,40,G),[[h,Ke.keyword]])]),c("label",null,[v(y(p(a)("adminAuditLog.filters.startDate"))+" ",1),A(c("input",{"onUpdate:modelValue":i[4]||(i[4]=e=>Ke.startDate=e),type:"datetime-local",onChange:rt},null,544),[[h,Ke.startDate]])]),c("label",null,[v(y(p(a)("adminAuditLog.filters.endDate"))+" ",1),A(c("input",{"onUpdate:modelValue":i[5]||(i[5]=e=>Ke.endDate=e),type:"datetime-local",onChange:rt},null,544),[[h,Ke.endDate]])]),c("label",null,[v(y(p(a)("adminAuditLog.filters.isSensitive"))+" ",1),A(c("select",{"onUpdate:modelValue":i[6]||(i[6]=e=>Ke.isSensitive=e),onChange:rt},[c("option",K,y(p(a)("adminAuditLog.filters.options.sensitiveAll")),1),c("option",X,y(p(a)("adminAuditLog.filters.options.sensitiveOnly")),1),c("option",Y,y(p(a)("adminAuditLog.filters.options.nonSensitive")),1)],544),[[L,Ke.isSensitive]])]),c("label",null,[v(y(p(a)("adminAuditLog.filters.entityId"))+" ",1),A(c("input",{"onUpdate:modelValue":i[7]||(i[7]=e=>Ke.entityId=e),type:"text",placeholder:p(a)("adminAuditLog.filters.placeholders.entityId"),onInput:tt},null,40,Z),[[h,Ke.entityId]])])]),c("div",ee,[c("button",{class:"btn-secondary",type:"button",onClick:lt},y(p(a)("adminAuditLog.actions.clearFilters")),1),c("button",{class:"btn-primary",type:"button",onClick:gt},y(p(a)("adminAuditLog.actions.exportLogs")),1),c("button",{class:"btn-primary",type:"button",onClick:ct},y(p(a)("adminAuditLog.actions.verifyChain")),1),c("button",{class:"btn-secondary",type:"button",disabled:Qe.value,onClick:ot},y(Qe.value?p(a)("adminAuditLog.actions.refreshDiagnosticsLoading"):p(a)("adminAuditLog.actions.refreshDiagnostics")),9,te)]),null!==He.value?(I(),d("div",ae,[v(y(p(a)("adminAuditLog.stats.queryTime",{time:He.value}))+" ",1),void 0!==Ne.value?(I(),d("span",ie," | "+y(p(a)("adminAuditLog.stats.totalRecords",{total:Ne.value})),1)):m("",!0),Ye.value?(I(),d("span",se," | "+y(p(a)("adminAuditLog.stats.dataSource",{source:Ye.value})),1)):m("",!0),Ze.value?(I(),d("span",ne," | "+y(p(a)("adminAuditLog.stats.appliedFilters",{filters:Ze.value})),1)):m("",!0),ze.value?(I(),d("span",oe," | "+y(p(a)("adminAuditLog.stats.performanceWarning",{warning:ze.value})),1)):m("",!0)])):m("",!0),Me.value?(I(),d("div",re,[c("span",null,y(p(a)("adminAuditLog.diagnostics.label",{status:Me.value.enabled?p(a)("adminAuditLog.diagnostics.status.enabled"):p(a)("adminAuditLog.diagnostics.status.disabled")})),1),Me.value.queries.last?(I(),d("span",le," | "+y(p(a)("adminAuditLog.diagnostics.latestQuery",{backend:Me.value.queries.last.backend,status:Me.value.queries.last.status,duration:Me.value.queries.last.durationMs})),1)):m("",!0),Me.value.queries.last?.error?(I(),d("span",de," | "+y(p(a)("adminAuditLog.diagnostics.error",{message:Me.value.queries.last.error.message})),1)):m("",!0)])):m("",!0)]),c("section",ue,[c("div",ce,[c("h2",null,y(p(a)("adminAuditLog.list.title")),1),x.value?(I(),d("span",ge,y(p(a)("common.loading")),1)):m("",!0)]),x.value&&!T.value.length?(I(),d("div",pe,y(p(a)("adminAuditLog.list.loadingHint")),1)):T.value.length?(I(),d("div",ye,[(I(!0),d(f,null,b(T.value,e=>{return I(),d("article",{key:e.id,class:S(["log-entry",[`type-${e.entityType}`,{sensitive:e.isSensitive}]])},[c("header",ve,[c("div",Ae,[c("span",he,"#"+y(e.id),1),e.isSensitive?(I(),d("span",{key:0,class:"sensitive-badge",title:p(a)("adminAuditLog.list.sensitiveTooltip")}," 馃敀 "+y(p(a)("adminAuditLog.list.sensitiveBadge")),9,Le)):m("",!0),c("span",fe,y(it(e.entityType)),1),e.entityId?(I(),d("span",be,y(e.entityId),1)):m("",!0),c("span",ke,y((i=e.action,i?i.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):a("adminAuditLog.format.unknown"))),1),e.ipAddress?(I(),d("span",{key:2,class:"entry-ip",title:p(a)("adminAuditLog.list.ipTooltip")}," 馃搷 "+y(e.ipAddress),9,we)):m("",!0)]),c("time",{class:"entry-time",datetime:e.createdAt},y(st(e.createdAt)),9,Se)]),c("div",De,[c("div",Ie,[c("strong",null,y(e.actorName||e.actorId||p(a)("adminAuditLog.systemActor")),1),e.actorId&&e.actorId!==e.actorName?(I(),d("span",Te," ("+y(e.actorId)+") ",1)):m("",!0)]),e.changes?(I(),d("div",_e,[c("button",{type:"button",class:"toggle-changes",onClick:t=>{return a=e.id,void(Be.value.has(a)?Be.value.delete(a):Be.value.add(a));var a}},y(Be.value.has(e.id)?p(a)("adminAuditLog.list.toggle.hide"):p(a)("adminAuditLog.list.toggle.show")),9,Ce),Be.value.has(e.id)?(I(),d("pre",xe,y(JSON.stringify(e.changes,null,2)),1)):m("",!0)])):m("",!0),e.isSensitive&&e.hashChainValue?(I(),d("div",Ue,[c("span",Ee,y(p(a)("adminAuditLog.list.hashLabel")),1),c("code",Pe,y(e.hashChainValue.substring(0,16))+"...",1),c("button",{type:"button",class:"btn-verify",onClick:i=>(async e=>{try{const{verifyArchivedLog:i}=await k(async()=>{const{verifyArchivedLog:e}=await Promise.resolve().then(()=>E);return{verifyArchivedLog:e}},void 0),s=await i(e);s.valid?t.success(a("adminAuditLog.messages.verifyLogSuccess",{id:e,message:s.message})):t.warning(a("adminAuditLog.messages.verifyLogFailure",{id:e,message:s.message}))}catch(i){const e=i instanceof Error?i.message:String(i);t.error(a("adminAuditLog.messages.verifyLogError",{message:e}))}})(e.id)},y(p(a)("adminAuditLog.list.verify")),9,Ve)])):m("",!0)])],2);var i}),128))])):(I(),d("div",me,y(p(a)("adminAuditLog.list.empty")),1)),T.value.length?(I(),d("footer",Fe,[c("button",{type:"button",disabled:1===je.value,onClick:i[8]||(i[8]=e=>dt(je.value-1))},y(p(a)("common.previous")),9,qe),c("span",Oe,y(p(a)("adminAuditLog.list.pagination.page",{page:je.value})),1),c("button",{type:"button",disabled:T.value.length<$e.value,onClick:i[9]||(i[9]=e=>dt(je.value+1))},y(p(a)("common.next")),9,Re)])):m("",!0)])]))}}),[["__scopeId","data-v-d10a43a0"]]);export{je as default};
