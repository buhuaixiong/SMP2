import{W as e,h as a,d as s,c as r,X as t,Y as l,Z as i,$ as n,a0 as o,a1 as c,a2 as u,a3 as d,a4 as p,z as m,S as h,k as v,e as f,j as g,O as y,a5 as k,t as b,o as _,_ as P,a6 as w,g as I,u as N,a7 as S,B as D,b as C,y as E,f as T,x as F,q as R,A as x,F as A,r as q,a8 as j,C as M,a9 as O}from"./index-DISlOFqe.js";import{E as z,a as G}from"./el-col-Bz5HSdbk.js";import{E as U}from"./el-empty-BXavX0tI.js";import{E as $}from"./el-skeleton-item-WAmBpnag.js";import{E as V}from"./el-tag-ByABDJ4J.js";import{E as W}from"./el-card-CGz5VnDQ.js";import{l as Y}from"./rfq-onvJUTCX.js";import{fetchSupplierRegistrationStatusBySupplier as L}from"./public-BtMXWiAD.js";import{u as H}from"./useNotification-CHtLFBIz.js";function Z(){const s=a([]),r=a(!1);async function t(){r.value=!0;try{const a=await async function(){return(await e("/dashboard/todos")).data}();s.value=a??[]}catch(a){throw console.error("Failed to fetch dashboard todos:",a),a}finally{r.value=!1}}return{todos:s,loading:r,fetchTodos:t,refreshTodos:async function(){await t()}}}const B={class:"card-content"},K={class:"card-icon"},Q={class:"card-info"},X={class:"card-count"},J={class:"card-title"},ee=P(s({__name:"TodoCard",props:{title:{},count:{},icon:{default:"Document"},priority:{default:"info"}},emits:["click"],setup(e){const a=e,s=r(()=>({User:p,FolderOpened:d,Memo:u,Clock:c,Document:o,Edit:n,CircleCheck:i,Tickets:l,Warning:t}[a.icon]||o));return(a,r)=>{const t=y,l=W;return _(),m(l,{class:h(["todo-card",`todo-card--${e.priority}`]),onClick:r[0]||(r[0]=e=>a.$emit("click"))},{default:v(()=>[f("div",B,[f("div",K,[g(t,{size:32},{default:v(()=>[(_(),m(k(s.value)))]),_:1})]),f("div",Q,[f("div",X,b(e.count),1),f("div",J,b(e.title),1)])])]),_:1},8,["class"])}}}),[["__scopeId","data-v-9c33d665"]]),ae={key:0,class:"supplier-dashboard-panel"},se={class:"dashboard-hero"},re={class:"hero-text"},te={class:"hero-kicker"},le={class:"hero-title"},ie={class:"hero-subtitle"},ne={class:"hero-actions"},oe={class:"hero-metric"},ce={class:"metric-number"},ue={class:"metric-label"},de=["disabled"],pe={class:"task-grid"},me={key:0,class:"task-card registration-status-card"},he={class:"task-card-header"},ve={class:"task-description"},fe={class:"task-actions",style:{"margin-top":"12px"}},ge={class:"task-card"},ye={class:"task-card-header"},ke={class:"task-badge"},be={class:"task-description"},_e={class:"task-list"},Pe={key:0,class:"task-empty"},we={key:1,class:"task-extra"},Ie={class:"task-card"},Ne={class:"task-card-header"},Se={class:"task-badge"},De={class:"task-description"},Ce={class:"task-list"},Ee={class:"task-meta"},Te={key:0,class:"task-empty"},Fe={key:1,class:"task-extra"},Re={class:"task-card"},xe={class:"task-card-header"},Ae={class:"task-badge"},qe={class:"task-description"},je={class:"task-list"},Me={key:0,class:"task-empty"},Oe={class:"task-meta"},ze={key:2,class:"task-empty"},Ge={key:3,class:"task-extra"},Ue={class:"task-card"},$e={class:"task-card-header"},Ve={class:"task-badge"},We={class:"task-description"},Ye={class:"task-list"},Le={key:0,class:"task-empty"},He={key:1,class:"task-extra"},Ze=864e5,Be=P(s({__name:"SupplierDashboardPanel",setup(e){const s=w(),t=I(),l=R(),{t:i}=N(),n=a(null),o=a(!1),c={requiredProfileFields:[],missingProfileFields:[],requiredDocumentTypes:[],missingDocumentTypes:[],isProfileComplete:!0,isDocumentComplete:!0,isComplete:!0,profileScore:100,documentScore:100,overallScore:100,completionCategory:"complete",missingItems:[]},u=r(()=>{const e=t.user;if(!e||null===e.supplierId||void 0===e.supplierId)return!1;if(new Set(["admin","purchaser","procurement_manager","procurement_director","finance_accountant","finance_director"]).has(e.role))return!1;return!new Set(e.permissions||[]).has("supplier.segment.manage")}),d=r(()=>{const e=t.user?.supplierId;if(null==e)return null;const a="number"==typeof e?e:Number(e);return Number.isFinite(a)?Math.trunc(a):null}),p=r(()=>s.selectedSupplier),m=r(()=>"temp_supplier"===t.user?.role),h=r(()=>t.user?.name??i("common.user")),y=r(()=>p.value?.companyName||i("dashboard.supplierPanel.defaultWorkspaceName")),k=a([]),P=a(!1),j=a(!1),M=a(!1),O=r(()=>p.value?.complianceSummary??c),z=r(()=>O.value.missingProfileFields??[]),G=r(()=>O.value.missingDocumentTypes??[]),U=r(()=>{const e=p.value?.documents??[],a=Date.now(),s=2592e6;return e.map(e=>{if(!e.expiresAt)return null;const r=Date.parse(e.expiresAt);if(!Number.isFinite(r))return null;const t=r-a;if(t>s||t<-2592e6)return null;const l=e.originalName&&e.originalName.trim().length?e.originalName:e.docType&&e.docType.trim().length?e.docType.replace(/_/g," "):"Supporting document",i=Math.ceil(t/Ze);return{id:e.id,label:l,daysRemaining:i}}).filter(e=>null!==e).sort((e,a)=>e.daysRemaining-a.daysRemaining)}),$=r(()=>k.value.filter(e=>e.needsResponse).slice().sort((e,a)=>(e.daysRemaining??Number.POSITIVE_INFINITY)-(a.daysRemaining??Number.POSITIVE_INFINITY))),W=r(()=>G.value.length+U.value.length+$.value.length+z.value.length),H=new Set(["","registration","potential","prospective",S.TEMPORARY]),Z=r(()=>{if(m.value)return!1;const e=p.value;if(!e)return!1;const a=String(e.stage??"").trim().toLowerCase();return!(a&&!H.has(a))&&!(e=>{if(!0===e)return!0;if(1===e)return!0;if("string"==typeof e){const a=e.trim().toLowerCase();return"1"===a||"true"===a||"completed"===a}return!1})(e.registrationCompleted)}),B=async(e=!1)=>{if(!u.value||null==d.value)return M.value=!1,!1;if(M.value&&!e)return!0;try{return await s.fetchSuppliers({},e),s.selectedSupplier&&s.selectedSupplier.id===d.value||await s.selectSupplier(d.value),M.value=!0,!0}catch(a){return console.error("Failed to prepare supplier context",a),!1}},K=async(e=!1)=>{if(M.value&&!P.value&&(e||!j.value)){P.value=!0;try{const e=await Y();k.value=e??[],j.value=!0}catch(a){console.error("Failed to load supplier RFQ invitations",a)}finally{P.value=!1}}},Q=async()=>{if(await B(!0)&&p.value){try{await s.refreshDocuments(p.value.id)}catch(e){console.error("Failed to refresh supplier documents",e)}await K(!0),Z.value?await X():n.value=null}},X=async()=>{if(t.user?.supplierId&&Z.value){if(!o.value){o.value=!0;try{n.value=await L(t.user.supplierId)}catch(e){console.error("Failed to load registration status:",e),n.value=null}finally{o.value=!1}}}else n.value=null},J=r(()=>{if(!Z.value||!n.value)return!1;const e=n.value.status;return"pending"===e||"under_review"===e||"pending_approval"===e}),ee=r(()=>{if(!n.value)return"";const e=n.value.status,a=`registrationStatus.statuses.${e}`,s=i(a);return s===a?e:s}),Be=r(()=>{const e=n.value?.status;switch(e){case"approved":case"completed":return"success";case"rejected":return"danger";default:return"warning"}});D([u,d],async([e,a],[s,r])=>{if(!e||null==a)return M.value=!1,k.value=[],void(j.value=!1);const t=void 0===s||r!==a;await B(t)&&(t&&(j.value=!1),await K(t))},{immediate:!0}),D(Z,e=>{e?X():n.value=null},{immediate:!0});const Ke=e=>{if(null===e||Number.isNaN(e))return i("dashboard.supplierPanel.countdowns.dueSoon");if(e<0){const a=Math.abs(e);return 1===a?i("dashboard.supplierPanel.countdowns.overdueOne"):i("dashboard.supplierPanel.countdowns.overdue",{count:a})}return 0===e?i("dashboard.supplierPanel.countdowns.dueToday"):1===e?i("dashboard.supplierPanel.countdowns.dueInOne"):i("dashboard.supplierPanel.countdowns.dueIn",{count:e})};return(e,a)=>{const s=V,r=x;return u.value&&p.value?(_(),C("section",ae,[f("div",se,[f("div",re,[f("p",te,b(T(i)("dashboard.supplierPanel.heroKicker",{name:h.value})),1),f("h2",le,b(y.value),1),f("p",ie,b(T(i)("dashboard.supplierPanel.heroSubtitle")),1)]),f("div",ne,[f("div",oe,[f("span",ce,b(W.value),1),f("span",ue,b(T(i)("dashboard.supplierPanel.metrics.pending")),1)]),f("button",{class:"hero-refresh",type:"button",disabled:P.value,onClick:Q},b(P.value?T(i)("dashboard.supplierPanel.metrics.refreshing"):T(i)("dashboard.supplierPanel.metrics.refresh")),9,de)])]),f("div",pe,[J.value?(_(),C("article",me,[f("header",he,[f("h3",null,b(T(i)("dashboard.supplierPanel.cards.registrationApplication.title","Registration Application")),1),g(s,{type:Be.value,size:"small"},{default:v(()=>[F(b(ee.value),1)]),_:1},8,["type"])]),f("p",ve,b(T(i)("dashboard.supplierPanel.cards.registrationApplication.description","Track your registration approval progress")),1),f("div",fe,[g(r,{size:"small",type:"primary",onClick:a[0]||(a[0]=e=>T(l).push("/registration-status"))},{default:v(()=>[F(b(T(i)("dashboard.supplierPanel.cards.registrationApplication.action","View Details")),1)]),_:1})])])):E("",!0),f("article",ge,[f("header",ye,[f("h3",null,b(T(i)("dashboard.supplierPanel.cards.requiredDocuments.title")),1),f("span",ke,b(G.value.length),1)]),f("p",be,b(T(i)("dashboard.supplierPanel.cards.requiredDocuments.description")),1),f("ul",_e,[(_(!0),C(A,null,q(G.value.slice(0,3),e=>(_(),C("li",{key:e.type},b(e.label),1))),128)),0===G.value.length?(_(),C("li",Pe,b(T(i)("dashboard.supplierPanel.cards.requiredDocuments.empty")),1)):G.value.length>3?(_(),C("li",we,b(T(i)("dashboard.supplierPanel.cards.requiredDocuments.more",{count:G.value.length-3})),1)):E("",!0)])]),f("article",Ie,[f("header",Ne,[f("h3",null,b(T(i)("dashboard.supplierPanel.cards.expiringDocuments.title")),1),f("span",Se,b(U.value.length),1)]),f("p",De,b(T(i)("dashboard.supplierPanel.cards.expiringDocuments.description")),1),f("ul",Ce,[(_(!0),C(A,null,q(U.value.slice(0,3),e=>(_(),C("li",{key:"exp-"+e.id,class:"task-row"},[f("span",null,b(e.label),1),f("span",Ee,b(Ke(e.daysRemaining)),1)]))),128)),0===U.value.length?(_(),C("li",Te,b(T(i)("dashboard.supplierPanel.cards.expiringDocuments.empty")),1)):U.value.length>3?(_(),C("li",Fe,b(T(i)("dashboard.supplierPanel.cards.expiringDocuments.more",{count:U.value.length-3})),1)):E("",!0)])]),f("article",Re,[f("header",xe,[f("h3",null,b(T(i)("dashboard.supplierPanel.cards.rfqs.title")),1),f("span",Ae,b($.value.length),1)]),f("p",qe,b(T(i)("dashboard.supplierPanel.cards.rfqs.description")),1),f("ul",je,[P.value?(_(),C("li",Me,b(T(i)("dashboard.supplierPanel.cards.rfqs.loading")),1)):(_(!0),C(A,{key:1},q($.value.slice(0,3),e=>(_(),C("li",{key:"rfq-"+e.id,class:"task-row"},[f("span",null,b(e.title),1),f("span",Oe,b(Ke(e.daysRemaining)),1)]))),128)),P.value||0!==$.value.length?!P.value&&$.value.length>3?(_(),C("li",Ge,b(T(i)("dashboard.supplierPanel.cards.rfqs.more",{count:$.value.length-3})),1)):E("",!0):(_(),C("li",ze,b(T(i)("dashboard.supplierPanel.cards.rfqs.empty")),1))])]),f("article",Ue,[f("header",$e,[f("h3",null,b(T(i)("dashboard.supplierPanel.cards.profile.title")),1),f("span",Ve,b(z.value.length),1)]),f("p",We,b(T(i)("dashboard.supplierPanel.cards.profile.description")),1),f("ul",Ye,[(_(!0),C(A,null,q(z.value.slice(0,3),e=>(_(),C("li",{key:e.key},b(e.label),1))),128)),0===z.value.length?(_(),C("li",Le,b(T(i)("dashboard.supplierPanel.cards.profile.empty")),1)):z.value.length>3?(_(),C("li",He,b(T(i)("dashboard.supplierPanel.cards.profile.more",{count:z.value.length-3})),1)):E("",!0)])])])])):E("",!0)}}}),[["__scopeId","data-v-5c794c15"]]),Ke={class:"unified-dashboard"},Qe={class:"welcome-section"},Xe={class:"welcome-content"},Je={class:"role-info"},ea={class:"welcome-actions"},aa={class:"todos-section"},sa={key:0,class:"loading-container"},ra=P(s({__name:"UnifiedDashboard",setup(e){const a=H(),s=R(),{t:t}=N(),l=I(),{todos:n,loading:o,fetchTodos:c}=Z(),d=w(),p=r(()=>{const e=l.user?.role;return"temp_supplier"===e||"formal_supplier"===e}),h=r(()=>l.user?.name||t("common.user")),k={admin:"role.admin",temp_supplier:"role.tempSupplier",formal_supplier:"role.formalSupplier",purchaser:"role.purchaser",procurement_manager:"role.procurementManager",procurement_director:"role.procurementDirector",quality_manager:"role.qualityManager",finance_accountant:"role.financeAccountant",finance_director:"role.financeDirector",department_user:"role.departmentUser"},P=r(()=>{const e=l.user?.role;if(!e)return"";const a=k[e];if(!a)return e;const s=t(a);return s===a?e:s}),S={admin:"danger",temp_supplier:"info",formal_supplier:"success",purchaser:"primary",procurement_manager:"success",procurement_director:"warning",quality_manager:"warning",finance_accountant:"primary",finance_director:"danger",department_user:"info"},D=r(()=>{const e=l.user?.role??"";return S[e]??"info"}),W=e=>{const a=`dashboard.todoItems.${e.type}`,s=t(a);return s===a?e.title:s},Y=async()=>{try{await c(),a.success(t("common.refreshSuccess"))}catch(e){a.error(t("common.refreshFailed"))}},L=new Set([j.PENDING_INFO,"pending_review",j.UNDER_REVIEW,j.PENDING_PURCHASER,j.PENDING_PURCHASE_MANAGER,j.PENDING_FINANCE_MANAGER]);return M(async()=>{const e=l.user;if((e=>!!e&&("tracking"===e.role||"tracking"===e.accountType||null!=e.relatedApplicationId||null!=e.tempAccountId))(e))s.replace("/registration-status");else{if(p.value&&e?.supplierId)try{await d.fetchSuppliers({},!1);const a=d.suppliers.find(a=>a.id===e.supplierId);if(a){if(!(e=>{if(!0===e||1===e)return!0;if("string"==typeof e){const a=e.trim().toLowerCase();return"1"===a||"true"===a||"completed"===a}return!1})(a.registrationCompleted)&&L.has(a.status))return void s.replace("/registration-status")}}catch(a){console.error("Failed to check supplier status:",a)}c()}}),(e,a)=>{const r=V,l=x,c=y,d=$,k=U,w=G,I=z;return _(),C("div",Ke,[f("section",Qe,[f("div",Xe,[f("h1",null,b(T(t)("dashboard.welcome",{name:h.value})),1),f("p",Je,[g(r,{type:D.value,size:"large"},{default:v(()=>[F(b(P.value),1)]),_:1},8,["type"])])]),f("div",ea,[g(l,{icon:T(O),onClick:Y,loading:T(o)},{default:v(()=>[F(b(T(t)("common.refresh")),1)]),_:1},8,["icon","loading"])])]),p.value?(_(),m(Be,{key:0})):E("",!0),f("section",aa,[f("h2",null,[g(c,null,{default:v(()=>[g(T(u))]),_:1}),F(" "+b(T(t)("dashboard.todos")),1)]),T(o)?(_(),C("div",sa,[g(d,{rows:3,animated:""})])):0===T(n).length?(_(),m(k,{key:1,description:T(t)("dashboard.noTodos"),"image-size":120},{image:v(()=>[g(c,{size:120,color:"#909399"},{default:v(()=>[g(T(i))]),_:1})]),_:1},8,["description"])):(_(),m(I,{key:2,gutter:20,class:"todos-grid"},{default:v(()=>[(_(!0),C(A,null,q(T(n),e=>(_(),m(w,{key:e.type,xs:24,sm:12,md:8,lg:6},{default:v(()=>[g(ee,{title:W(e),count:e.count,icon:e.icon,priority:e.priority,onClick:a=>(e=>{s.push(e.route)})(e)},null,8,["title","count","icon","priority","onClick"])]),_:2},1024))),128))]),_:1}))])])}}}),[["__scopeId","data-v-4ca571cc"]]);export{ra as default};
