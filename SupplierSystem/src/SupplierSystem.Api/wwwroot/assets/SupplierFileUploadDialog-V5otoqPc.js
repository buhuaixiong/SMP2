import{d as e,c as l,h as a,i,z as o,k as t,j as r,e as s,x as d,y as u,A as n,O as p,f as m,aO as f,E as v,a0 as c,t as g,H as y,o as _,_ as b}from"./index-CyQdnTIC.js";import{a as h,E as j}from"./el-form-item-DJ87vTOW.js";import{E as x}from"./el-date-picker-panel-CmBAD9wS.js";/* empty css                 */import"./el-scrollbar-CTtrnhms.js";import{E as D}from"./el-upload-wfA8ygZ8.js";import"./el-progress-D5jEkcdx.js";import{E as w}from"./el-alert-BXhB-eTB.js";import{u as F}from"./fileUploads-Do05fzJO.js";import{u as M}from"./useNotification-DAUqvaBw.js";import"./castArray-C2ko8TfK.js";import"./_baseClone-CxGxK45k.js";import"./dayjs.min-CuEfV50W.js";import"./index-CubmMpUU.js";import"./debounce-B4S_WZO2.js";import"./cloneDeep-B3nGyXfn.js";const Y={style:{display:"flex","align-items":"center",gap:"8px"}},T={style:{color:"#909399"}},V={class:"dialog-footer"},k=b(e({__name:"SupplierFileUploadDialog",props:{visible:{type:Boolean},supplierId:{}},emits:["update:visible","success"],setup(e,{emit:b}){const k=M(),B=e,E=b,U=l({get:()=>B.visible,set:e=>E("update:visible",e)}),q=a(),z=a(),H=a(!1),I=a([]),C=i({fileDescription:"",validFrom:"",validTo:""}),A={validFrom:[{required:!0,message:"请选择生效日期",trigger:"change"}],validTo:[{required:!0,message:"请选择过期日期",trigger:"change"},{validator:(e,l,a)=>{l&&C.validFrom&&l<=C.validFrom?a(new Error("过期日期必须晚于生效日期")):a()},trigger:"change"}]},O=a(null),P=e=>{const l=new Date;return l.setHours(0,0,0,0),e.getTime()<l.getTime()},R=e=>{if(!C.validFrom){const l=new Date;return l.setHours(0,0,0,0),e.getTime()<l.getTime()}const l=new Date(C.validFrom);return l.setHours(0,0,0,0),e.getTime()<=l.getTime()},W=e=>{O.value=e.raw||null},G=()=>{O.value=null},K=e=>{if(0===e)return"0 B";const l=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,l)*100)/100+" "+["B","KB","MB","GB"][l]},N=()=>{H.value?k.warning("文件正在上传,请稍候..."):(U.value=!1,S())},S=()=>{C.fileDescription="",C.validFrom="",C.validTo="",O.value=null,I.value=[],q.value&&q.value.clearValidate(),z.value&&z.value.clearFiles()},Z=async()=>{if(!O.value)return void k.warning("请选择要上传的文件");try{await q.value.validate()}catch(e){return void k.warning("请完整填写表单")}if(!C.validFrom||!C.validTo)return void k.warning("请选择文件有效期");if(O.value.size>20971520)k.error("文件大小不能超过20MB");else try{H.value=!0;const e=await F({supplierId:B.supplierId,file:O.value,fileDescription:C.fileDescription||void 0,validFrom:C.validFrom,validTo:C.validTo});k.success({message:e.message||"文件上传成功,已进入审批流程",duration:3e3}),E("success"),U.value=!1,S()}catch(e){console.error("Failed to upload file:",e),k.error(e?.message||"文件上传失败,请稍后重试")}finally{H.value=!1}};return(e,l)=>{const a=w,i=p,b=n,F=D,M=h,k=v,B=x,E=j,S=y;return _(),o(S,{modelValue:U.value,"onUpdate:modelValue":l[3]||(l[3]=e=>U.value=e),title:"上传文件",width:"600px","before-close":N},{footer:t(()=>[s("span",V,[r(b,{onClick:N},{default:t(()=>[...l[8]||(l[8]=[d("取消",-1)])]),_:1}),r(b,{type:"primary",loading:H.value,disabled:!O.value,onClick:Z},{default:t(()=>[...l[9]||(l[9]=[d(" 上传并提交审批 ",-1)])]),_:1},8,["loading","disabled"])])]),default:t(()=>[r(a,{title:"审批流程说明",type:"warning",closable:!1,style:{"margin-bottom":"20px"}},{default:t(()=>[...l[4]||(l[4]=[s("p",null,[d("文件上传后将进入"),s("strong",null,"5级审批流程"),d(":")],-1),s("ol",{style:{margin:"8px 0","padding-left":"20px"}},[s("li",null,"采购员审批"),s("li",null,"品质审批"),s("li",null,"采购经理审批"),s("li",null,"采购总监审批"),s("li",null,"财务总监审批")],-1),s("p",{style:{"margin-top":"8px",color:"#909399","font-size":"13px"}}," 文件审批完成后才能生效。如任何步骤被拒绝,需重新提交。 ",-1)])]),_:1}),r(E,{ref_key:"formRef",ref:q,model:C,rules:A,"label-width":"100px"},{default:t(()=>[r(M,{label:"文件选择",prop:"file",required:""},{default:t(()=>[r(F,{ref_key:"uploadRef",ref:z,"auto-upload":!1,limit:1,"on-change":W,"on-remove":G,"file-list":I.value,accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"},{tip:t(()=>[...l[6]||(l[6]=[s("div",{class:"el-upload__tip"},"支持格式: PDF, Word, Excel, 图片 (最大20MB)",-1)])]),default:t(()=>[r(b,{type:"primary"},{default:t(()=>[r(i,null,{default:t(()=>[r(m(f))]),_:1}),l[5]||(l[5]=d(" 选择文件 ",-1))]),_:1})]),_:1},8,["file-list"])]),_:1}),r(M,{label:"文件说明",prop:"fileDescription"},{default:t(()=>[r(k,{modelValue:C.fileDescription,"onUpdate:modelValue":l[0]||(l[0]=e=>C.fileDescription=e),type:"textarea",rows:3,placeholder:"请简要说明文件内容和用途(可选)",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),r(M,{label:"生效日期",prop:"validFrom",required:""},{default:t(()=>[r(B,{modelValue:C.validFrom,"onUpdate:modelValue":l[1]||(l[1]=e=>C.validFrom=e),type:"date",placeholder:"选择生效日期","disabled-date":P,style:{width:"100%"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),r(M,{label:"过期日期",prop:"validTo",required:""},{default:t(()=>[r(B,{modelValue:C.validTo,"onUpdate:modelValue":l[2]||(l[2]=e=>C.validTo=e),type:"date",placeholder:"选择过期日期","disabled-date":R,style:{width:"100%"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),O.value?(_(),o(a,{key:0,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:t(()=>[s("div",Y,[r(i,null,{default:t(()=>[r(m(c))]),_:1}),s("span",null,[l[7]||(l[7]=s("strong",null,"已选文件:",-1)),d(" "+g(O.value.name),1)]),s("span",T,"("+g(K(O.value.size))+")",1)])]),_:1})):u("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-f25658ef"]]);export{k as default};
