const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FileUploadTimeline-ynU4nCQy.js","assets/index-CyQdnTIC.js","assets/index-D5VxGV9f.css","assets/el-timeline-item-CvFovLIE.js","assets/el-timeline-item-BvbJTz1y.css","assets/el-tag-eQgnjs1v.js","assets/el-tag-DljBBxJR.css","assets/dayjs.min-CuEfV50W.js","assets/FileUploadTimeline-CEm7kSRR.css"])))=>i.map(i=>d[i]);
import{d as e,h as a,i as l,c as t,C as o,b as i,j as r,e as s,k as n,F as d,r as p,H as u,A as c,x as m,O as f,f as v,a9 as y,z as _,m as g,a0 as w,t as h,y as b,cH as k,G as j,E as x,J as T,o as E,_ as C}from"./index-CyQdnTIC.js";import{v as V}from"./el-loading-oesi7HFc.js";import{E as A,a as D}from"./el-form-item-DJ87vTOW.js";/* empty css                 */import{E as I,a as F}from"./el-radio-group-CWQX-m1k.js";import{E as U}from"./el-divider-BEySWtZA.js";import{E as H}from"./el-alert-BXhB-eTB.js";import{E as B,a as N}from"./el-descriptions-item-C3lsVx1m.js";import{E as P}from"./el-card-DJj_OhI8.js";import{a as q,E as S}from"./el-table-column-DvsfEAIW.js";import"./el-scrollbar-CTtrnhms.js";import{E as Y}from"./el-tag-eQgnjs1v.js";import{E as z}from"./el-empty-ByHbktmc.js";import{d as M}from"./dayjs.min-CuEfV50W.js";import{b as O,c as R,a as W,s as $,d as G}from"./fileUploads-Do05fzJO.js";import{P as J}from"./PageHeader-CMpTsfBB.js";import{r as L}from"./apiBaseUrl-Bx8aB0Mq.js";import{u as Q}from"./useNotification-DAUqvaBw.js";import"./castArray-C2ko8TfK.js";import"./_baseClone-CxGxK45k.js";import"./debounce-B4S_WZO2.js";const K={class:"approval-page"},X={class:"header-actions"},Z={class:"approval-stack"},ee={class:"section-header"},ae={style:{display:"flex","align-items":"center",gap:"8px"}},le={key:0},te={key:1,style:{color:"#909399"}},oe={key:0},ie={key:0,style:{"margin-bottom":"20px"}},re={class:"dialog-footer"},se=C(e({__name:"FileUploadApprovalView",setup(e){const C=Q(),se=j(()=>T(()=>import("./FileUploadTimeline-ynU4nCQy.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]))),ne=a(!1),de=a(!1),pe=a(!1),ue=a(!1),ce=a(!1),me=a([]),fe=a([]),ve=a(null),ye=a(!1),_e=l({decision:"",comments:""}),ge=t(()=>[{key:"pending",title:"待审批文件",items:me.value,loading:ne.value,emptyText:"暂无待审批文件",canApprove:!0},{key:"approved",title:"已审批文件",items:fe.value,loading:de.value,emptyText:"暂无已审批文件",canApprove:!1}]),we=e=>({pending_purchaser:"待采购员审批",pending_quality_manager:"待品质审批",pending_procurement_manager:"待采购经理审批",pending_procurement_director:"待采购总监审批",pending_finance_director:"待财务总监审批",approved:"已批准",rejected:"已拒绝"}[e]||e),he=e=>M(e).format("YYYY-MM-DD HH:mm"),be=async()=>{ne.value=!0;try{me.value=await O()}catch(e){console.error("Failed to fetch pending approvals:",e),C.error(e?.message||"获取待审批列表失败")}finally{ne.value=!1}},ke=async()=>{de.value=!0;try{fe.value=await R()}catch(e){console.error("Failed to fetch approved approvals:",e),C.error(e?.message||"获取已审批列表失败")}finally{de.value=!1}},je=async()=>{await Promise.all([be(),ke()])},xe=async(e,a=!1)=>{pe.value=!0,ce.value=!0,ye.value=a,_e.decision="",_e.comments="";try{ve.value=await W(e)}catch(l){console.error("Failed to fetch upload details:",l),C.error(l?.message||"获取详情失败"),ce.value=!1}finally{pe.value=!1}},Te=async()=>{if(ve.value)if(_e.decision){try{await C.confirm(`确定${"approved"===_e.decision?"批准":"拒绝"}此文件上传申请吗?`,"确认审批",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"})}catch{return}ue.value=!0;try{const e=await G(ve.value.id,{decision:_e.decision,comments:_e.comments||void 0});C.success(e.message||"审批提交成功"),ce.value=!1,je()}catch(e){console.error("Failed to submit approval:",e),C.error(e?.message||"审批提交失败")}finally{ue.value=!1}}else C.warning("请选择审批决定")};return o(()=>{je()}),(e,a)=>{const l=f,t=c,o=Y,j=z,T=S,M=q,O=P,R=N,W=B,G=H,Q=U,ne=F,de=I,me=D,fe=x,be=A,ke=u,Ee=V;return E(),i("div",K,[r(J,{title:"文件上传审批",subtitle:"审批供应商上传的文件"},{actions:n(()=>[s("div",X,[r(t,{onClick:je},{default:n(()=>[r(l,null,{default:n(()=>[r(v(y))]),_:1}),a[5]||(a[5]=m(" 刷新 ",-1))]),_:1})])]),_:1}),s("div",Z,[(E(!0),i(d,null,p(ge.value,e=>(E(),_(O,{key:e.key},{header:n(()=>[s("div",ee,[s("span",null,h(e.title)+" ("+h(e.items.length)+")",1),e.items.length>0&&e.canApprove?(E(),_(o,{key:0,type:"warning"},{default:n(()=>[m(h(e.items.length)+" 个待处理 ",1)]),_:2},1024)):b("",!0)])]),default:n(()=>[e.loading||0!==e.items.length?g((E(),_(M,{key:1,data:e.items,stripe:"",style:{width:"100%"}},{default:n(()=>[r(T,{prop:"id",label:"ID",width:"80"}),r(T,{prop:"fileName",label:"文件名","min-width":"200"},{default:n(({row:e})=>[s("div",ae,[r(l,null,{default:n(()=>[r(v(w))]),_:1}),s("span",null,h(e.fileName||"未命名文件"),1)])]),_:1}),r(T,{prop:"fileDescription",label:"文件说明","min-width":"150"},{default:n(({row:e})=>[s("span",null,h(e.fileDescription||"—"),1)]),_:1}),r(T,{prop:"supplierId",label:"供应商ID",width:"110"}),r(T,{prop:"currentStep",label:"当前步骤",width:"130"},{default:n(({row:e})=>{return[m(h((a=e.currentStep,{purchaser:"采购员审批",quality_manager:"品质审批",procurement_manager:"采购经理审批",procurement_director:"采购总监审批",finance_director:"财务总监审批"}[a]||a)),1)];var a}),_:1}),r(T,{prop:"validTo",label:"过期日期",width:"120"},{default:n(({row:e})=>[e.validTo?(E(),i("span",le,h(e.validTo),1)):(E(),i("span",te,"—"))]),_:1}),r(T,{prop:"submittedAt",label:"提交时间",width:"160"},{default:n(({row:e})=>[m(h(he(e.submittedAt)),1)]),_:1}),r(T,{label:"操作",width:"240",fixed:"right"},{default:n(({row:l})=>[e.canApprove?(E(),_(t,{key:0,type:"primary",link:"",onClick:e=>xe(l.id)},{default:n(()=>[...a[6]||(a[6]=[m(" 审批 ",-1)])]),_:1},8,["onClick"])):(E(),_(t,{key:1,type:"primary",link:"",onClick:e=>xe(l.id,!0)},{default:n(()=>[...a[7]||(a[7]=[m(" 详情 ",-1)])]),_:1},8,["onClick"])),"approved"===l.status&&l.validTo?(E(),_(t,{key:2,type:"warning",link:"",onClick:e=>(async e=>{try{await C.confirm("确定要向供应商发送文件过期提醒邮件吗?","确认发送",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"})}catch{return}try{const a=await $(e);C.success(a.message||"提醒邮件已发送")}catch(a){console.error("Failed to send reminder:",a),C.error(a?.message||"发送提醒邮件失败")}})(l.id)},{default:n(()=>[...a[8]||(a[8]=[m(" 发送提醒 ",-1)])]),_:1},8,["onClick"])):b("",!0)]),_:2},1024)]),_:2},1032,["data"])),[[Ee,e.loading]]):(E(),_(j,{key:0,description:e.emptyText},null,8,["description"]))]),_:2},1024))),128))]),r(ke,{modelValue:ce.value,"onUpdate:modelValue":a[4]||(a[4]=e=>ce.value=e),title:"文件审批",width:"900px","destroy-on-close":!0},{footer:n(()=>[s("span",re,[r(t,{onClick:a[3]||(a[3]=e=>ce.value=!1)},{default:n(()=>[...a[14]||(a[14]=[m("取消",-1)])]),_:1}),ye.value?b("",!0):(E(),_(t,{key:0,type:"primary",loading:ue.value,disabled:!_e.decision,onClick:Te},{default:n(()=>[...a[15]||(a[15]=[m(" 提交审批 ",-1)])]),_:1},8,["loading","disabled"]))])]),default:n(()=>[ve.value?g((E(),i("div",oe,[r(G,{title:"文件信息",type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:n(()=>[r(W,{column:2,border:"",size:"small"},{default:n(()=>[r(R,{label:"文件ID"},{default:n(()=>[m(h(ve.value.id),1)]),_:1}),r(R,{label:"文件名"},{default:n(()=>[m(h(ve.value.fileName||"未命名"),1)]),_:1}),r(R,{label:"文件说明",span:2},{default:n(()=>[m(h(ve.value.fileDescription||"—"),1)]),_:1}),r(R,{label:"供应商ID"},{default:n(()=>[m(h(ve.value.supplierId),1)]),_:1}),r(R,{label:"供应商名称"},{default:n(()=>[m(h(ve.value.supplier?.companyName||"—"),1)]),_:1}),r(R,{label:"提交时间"},{default:n(()=>[m(h(he(ve.value.submittedAt)),1)]),_:1}),r(R,{label:"当前状态"},{default:n(()=>{return[r(o,{type:(e=ve.value.status,"approved"===e?"success":"rejected"===e?"danger":e.startsWith("pending_")?"warning":"info")},{default:n(()=>[m(h(we(ve.value.status)),1)]),_:1},8,["type"])];var e}),_:1})]),_:1})]),_:1}),ve.value.fileId?(E(),i("div",ie,[r(t,{type:"primary",onClick:a[0]||(a[0]=e=>(e=>{const a=L(`/api/files/download/${e}`);window.open(a,"_blank")})(ve.value.fileId))},{default:n(()=>[r(l,null,{default:n(()=>[r(v(k))]),_:1}),a[9]||(a[9]=m(" 下载文件 ",-1))]),_:1})])):b("",!0),r(Q,{"content-position":"left"},{default:n(()=>[...a[10]||(a[10]=[m("审批进度",-1)])]),_:1}),r(v(se),{workflow:ve.value.workflow,"current-step":ve.value.currentStep,status:ve.value.status,"approval-history":ve.value.approvalHistory},null,8,["workflow","current-step","status","approval-history"]),ye.value?b("",!0):(E(),i(d,{key:1},[r(Q,{"content-position":"left"},{default:n(()=>[...a[11]||(a[11]=[m("审批决定",-1)])]),_:1}),r(be,{model:_e,"label-width":"100px"},{default:n(()=>[r(me,{label:"审批决定",required:""},{default:n(()=>[r(de,{modelValue:_e.decision,"onUpdate:modelValue":a[1]||(a[1]=e=>_e.decision=e)},{default:n(()=>[r(ne,{value:"approved"},{default:n(()=>[...a[12]||(a[12]=[m("批准",-1)])]),_:1}),r(ne,{value:"rejected"},{default:n(()=>[...a[13]||(a[13]=[m("拒绝",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),r(me,{label:"审批意见"},{default:n(()=>[r(fe,{modelValue:_e.comments,"onUpdate:modelValue":a[2]||(a[2]=e=>_e.comments=e),type:"textarea",rows:4,placeholder:"请输入审批意见(可选)",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])],64))])),[[Ee,pe.value]]):b("",!0)]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-cd0927a4"]]);export{se as default};
