import{h as e,c as a,d as l,u as t,g as n,i,C as s,B as r,b as o,j as u,m,k as d,f as p,z as f,F as c,e as g,y as b,x as v,t as y,a$ as q,A as h,O as w,cv as _,a0 as I,b4 as k,cw as C,q as T,o as j,_ as S}from"./index-CA1ThEvj.js";import{v as R}from"./el-loading-hoFXZ3d6.js";import{E as z}from"./el-pagination-dDlpmXjd.js";import{E as L}from"./el-tag-CxTn4T_Z.js";import{E as A,a as E}from"./el-select-DVJnbJgC.js";import"./el-scrollbar-DefzV4pD.js";/* empty css                 */import{E as $,a as M}from"./el-form-item-CIgjZRq6.js";import{E as P,a as V}from"./el-tab-pane-CvHX-4xT.js";import{E as U}from"./el-card-CgDnKMj1.js";import{E as x}from"./el-empty-Bjv8DZK3.js";import{a as D,E as N}from"./el-table-column-CkSadyqs.js";import{E as F}from"./el-link-BeYVRf_k.js";import{E as O}from"./el-alert-VmMlafpt.js";import{P as B}from"./PageHeader-CGC6-GzN.js";import{f as H,a as Q,l as W}from"./rfq-CguOQMj7.js";import{a as Y,u as G}from"./useNotification-BAKLaPVZ.js";import"./castArray-BAWcvkMO.js";import"./_baseClone-AiIcXXKO.js";import"./index-C8ephDBL.js";import"./debounce-D9fFbg8F.js";const J={class:"rfq-management-view"},K={class:"supplier-header"},X={class:"supplier-subtitle"},Z={key:0},ee={key:1},ae={key:2},le={class:"tab-label"},te={class:"tab-label"},ne={class:"pending-header"},ie={class:"pending-subtitle"},se={class:"pagination-container"},re=S(l({__name:"RfqManagementView",setup(l){const{t:S}=t(),re=T(),oe=n(),ue=G(),me=function(){const l=Y("permission"),t=e(l.getRole()),n=e(l.getPermissions());return{role:a(()=>t.value),permissions:a(()=>n.value),has:e=>l.has(e),hasAny:(...e)=>l.hasAny(...e),hasAll:(...e)=>l.hasAll(...e),hasRole:(...e)=>l.hasRole(...e),refresh:async(e=!0)=>{const a=await l.refresh(e);return n.value=a,t.value=l.getRole(),a},sync:()=>{t.value=l.getRole(),n.value=l.getPermissions()}}}(),de=function(){const a=e([]),l=e(!1),t=G();return{selectedRows:a,processing:l,setSelection:e=>{a.value=e},clearSelection:()=>{a.value=[]},runAction:async(e,n={})=>{const i=n.rows??a.value;if(n.requireSelection&&0===i.length)t.warning(n.emptySelectionMessage??"请选择需要操作的记录");else{n.confirmMessage&&await t.confirm(n.confirmMessage,n.confirmTitle??"确认操作"),l.value=!0;try{await e(i),n.successMessage&&t.success(n.successMessage)}catch(s){const e=s?.message||n.errorMessage||"操作失败";throw t.error(e),s}finally{l.value=!1}}}}}(),pe=Y("http"),fe=a(()=>me.hasRole("supplier")||!!oe.user?.supplierId),ce=a(()=>{const e=oe.user?.role;return"purchaser"===e||"admin"===e}),ge=e("IDM"),be=e(!1),ve=e([]),ye=i({materialType:"IDM",status:void 0,distributionCategory:void 0,rfqType:void 0}),qe=i({page:1,limit:20,total:0,totalPages:0}),he=e([]),we=e(!1),_e=e(null),Ie=a(()=>he.value.length),ke=e([]),Ce=e(!1),Te=e(null),je=a(()=>[...ke.value].sort((e,a)=>Number(a.needsResponse)-Number(e.needsResponse))),Se=a(()=>ke.value.filter(e=>e.needsResponse).length);function Re(){ze(),async function(){if(fe.value)return;we.value=!0,_e.value=null;try{const e=await Q({status:"pending"});he.value=e.data}catch(e){console.error(S("rfq.management.pendingLineItems.loadError"),e),_e.value=e?.message||S("rfq.management.pendingLineItems.loadError")}finally{we.value=!1}}()}async function ze(){if(!fe.value){be.value=!0;try{const e=await H({...ye,page:qe.page,limit:qe.limit});ve.value=e.data,qe.total=e.pagination.total,qe.totalPages=e.pagination.totalPages}catch(e){ue.error(S("rfq.management.loadError"))}finally{be.value=!1}}}async function Le(){Ce.value=!0,Te.value=null;try{ke.value=await W()}catch(e){Te.value=e?.message||S("rfq.management.loadError")}finally{Ce.value=!1}}function Ae(e){fe.value||(ye.materialType=e,Ee())}function Ee(){fe.value||(ye.status=void 0,ye.distributionCategory=void 0,ye.rfqType=void 0,qe.page=1,ze())}function $e(){fe.value||(qe.page=1,ze())}function Me(){fe.value||ze()}function Pe(){fe.value||re.push("/rfq/create")}function Ve(e){re.push(`/rfq/${e}`)}function Ue(e){return{draft:"info",published:"warning",in_progress:"info",closed:"success",cancelled:"danger"}[e]||"info"}function xe(e){if(!e)return"-";const a=`rfq.status.${e}`,l=S(a);return l===a?e:l}function De(e){if(!e)return"-";let a=`rfq.quoteStatus.${e}`,l=S(a);return l===a&&(a=`rfq.quotes.statuses.${e}`,l=S(a)),l===a&&(a=`rfq.quote.statuses.${e}`,l=S(a)),l===a?e:l}function Ne(e){return e?new Date(e).toLocaleString():"-"}function Fe(e,a){if("draft"===e&&a){const e="rfq.lineItemStatus.rejectedPendingResubmit",a=S(e);return a===e?"需重新处理":a}const l=`rfq.lineItemStatus.${e}`,t=S(l);return t===l?e:t}function Oe(e,a){re.push({path:`/rfq/${e}`,query:{lineItemId:a.toString()}})}return s(()=>{fe.value?Le():Re()}),r(fe,e=>{e?(ve.value=[],qe.page=1,qe.total=0,qe.totalPages=0,he.value=[],_e.value=null,Le()):(ke.value=[],Te.value=null,Re())}),(e,a)=>{const l=h,t=L,n=O,i=F,s=N,r=D,T=x,H=U,Q=w,W=V,Y=P,G=E,oe=A,me=M,ke=$,Re=z,Le=R;return j(),o("div",J,[u(B,{title:p(S)("rfq.management.title")},{actions:d(()=>[fe.value?b("",!0):(j(),f(l,{key:0,type:"primary",icon:p(q),onClick:Pe},{default:d(()=>[v(y(p(S)("rfq.management.createRfq")),1)]),_:1},8,["icon"]))]),_:1},8,["title"]),fe.value?m((j(),f(H,{key:0,class:"supplier-card",shadow:"never"},{header:d(()=>[g("div",K,[g("div",null,[g("h2",null,y(p(S)("rfq.management.supplierInvitations.title")),1),g("p",X,y(p(S)("rfq.management.supplierInvitations.subtitle")),1)]),Se.value?(j(),f(t,{key:0,type:"warning",size:"small"},{default:d(()=>[v(y(p(S)("rfq.management.supplierInvitations.pending",{count:Se.value})),1)]),_:1})):b("",!0)])]),default:d(()=>[Te.value?(j(),f(n,{key:0,class:"supplier-alert",title:Te.value,type:"error","show-icon":"",closable:!1},null,8,["title"])):je.value.length?(j(),f(r,{key:1,data:je.value,style:{width:"100%"}},{default:d(()=>[u(s,{prop:"title",label:p(S)("rfq.management.supplierInvitations.columns.title"),"min-width":"220"},{default:d(({row:e})=>[u(i,{type:"primary",onClick:a=>Ve(e.id)},{default:d(()=>[v(y(e.title),1)]),_:2},1032,["onClick"])]),_:1},8,["label"]),u(s,{prop:"rfqStatus",label:p(S)("rfq.management.supplierInvitations.columns.status"),width:"150"},{default:d(({row:e})=>[u(t,{type:Ue(e.rfqStatus||""),size:"small"},{default:d(()=>[v(y(xe(e.rfqStatus)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),u(s,{prop:"quoteStatus",label:p(S)("rfq.management.supplierInvitations.columns.quoteStatus"),width:"150"},{default:d(({row:e})=>[v(y(De(e.quoteStatus)),1)]),_:1},8,["label"]),u(s,{prop:"validUntil",label:p(S)("rfq.management.supplierInvitations.columns.validUntil"),width:"180"},{default:d(({row:e})=>[v(y(Ne(e.validUntil)),1)]),_:1},8,["label"]),u(s,{prop:"daysRemaining",label:p(S)("rfq.management.supplierInvitations.columns.daysRemaining"),width:"140"},{default:d(({row:e})=>{return[v(y((a=e.daysRemaining,null==a?"-":String(a))),1)];var a}),_:1},8,["label"]),u(s,{label:p(S)("rfq.management.supplierInvitations.columns.needsResponse"),width:"160",align:"center"},{default:d(({row:e})=>{return[u(t,{type:(a=e,a.needsResponse?"warning":a.denialReason?"info":"success"),size:"small"},{default:d(()=>[e.needsResponse?(j(),o("span",Z,y(p(S)("rfq.management.supplierInvitations.needsResponseTag")),1)):e.denialReason?(j(),o("span",ee,y(p(S)("rfq.management.supplierInvitations.expiredTag")),1)):(j(),o("span",ae,y(p(S)("rfq.management.supplierInvitations.responseSubmittedTag")),1))]),_:2},1032,["type"])];var a}),_:1},8,["label"]),u(s,{label:p(S)("rfq.management.supplierInvitations.columns.actions"),width:"140",align:"center"},{default:d(({row:e})=>[u(l,{type:"primary",link:"",size:"small",onClick:a=>Ve(e.id)},{default:d(()=>[v(y(p(S)("rfq.management.supplierInvitations.actions.view")),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])):(j(),f(T,{key:2,description:p(S)("rfq.management.supplierInvitations.empty")},null,8,["description"]))]),_:1})),[[Le,Ce.value]]):(j(),o(c,{key:1},[u(Y,{modelValue:ge.value,"onUpdate:modelValue":a[0]||(a[0]=e=>ge.value=e),class:"material-tabs",onTabChange:Ae},{default:d(()=>[u(W,{label:p(S)("rfq.materialType.idm"),name:"IDM"},{label:d(()=>[g("span",le,[u(Q,null,{default:d(()=>[u(p(_))]),_:1}),v(" "+y(p(S)("rfq.materialType.idm")),1)])]),_:1},8,["label"]),u(W,{label:p(S)("rfq.materialType.dm"),name:"DM",disabled:""},{label:d(()=>[g("span",te,[u(Q,null,{default:d(()=>[u(p(I))]),_:1}),v(" "+y(p(S)("rfq.materialType.dm"))+" ",1),u(t,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:d(()=>[v(y(p(S)("common.comingSoon")),1)]),_:1})])]),_:1},8,["label"])]),_:1},8,["modelValue"]),m((j(),f(H,{class:"pending-rfq-line-items-card",shadow:"never"},{header:d(()=>[g("div",ne,[g("div",null,[g("h2",null,y(p(S)("rfq.management.pendingLineItems.title")),1),g("p",ie,y(p(S)("rfq.management.pendingLineItems.subtitle")),1)]),Ie.value?(j(),f(t,{key:0,type:"warning",size:"small"},{default:d(()=>[v(y(Ie.value)+" "+y(p(S)("rfq.management.pendingLineItems.itemsCount")),1)]),_:1})):b("",!0)])]),default:d(()=>[Ie.value?(j(),f(n,{key:0,class:"pending-alert",title:p(S)("rfq.management.pendingLineItems.alert",{count:Ie.value}),type:"warning","show-icon":"",closable:!1},null,8,["title"])):_e.value?(j(),f(n,{key:1,class:"pending-alert",title:_e.value,type:"error","show-icon":"",closable:!1},null,8,["title"])):b("",!0),he.value.length?(j(),f(r,{key:2,data:he.value,style:{width:"100%"},class:"pending-table"},{default:d(()=>[u(s,{prop:"rfqTitle",label:p(S)("rfq.management.pendingLineItems.columns.rfqTitle"),"min-width":"180"},{default:d(({row:e})=>[u(i,{type:"primary",onClick:a=>Oe(e.rfqId,e.id)},{default:d(()=>[v(y(e.rfqTitle),1)]),_:2},1032,["onClick"])]),_:1},8,["label"]),u(s,{prop:"itemName",label:p(S)("rfq.management.pendingLineItems.columns.itemName"),"min-width":"200"},null,8,["label"]),u(s,{prop:"requestingDepartment",label:p(S)("rfq.management.pendingLineItems.columns.department"),width:"120"},null,8,["label"]),u(s,{prop:"quantity",label:p(S)("rfq.management.pendingLineItems.columns.quantity"),width:"120"},{default:d(({row:e})=>[v(y(e.quantity)+" "+y(e.unit||""),1)]),_:1},8,["label"]),u(s,{prop:"status",label:p(S)("rfq.management.pendingLineItems.columns.status"),width:"150"},{default:d(({row:e})=>{return[u(t,{type:(a=e.status,{draft:"info",pending_director:"warning",pending_po:"warning",completed:"success",rejected:"danger"}[a]||"info"),size:"small"},{default:d(()=>[v(y(Fe(e.status,e.selectedQuoteId)),1)]),_:2},1032,["type"])];var a}),_:1},8,["label"]),u(s,{prop:"supplierName",label:p(S)("rfq.management.pendingLineItems.columns.supplier"),width:"150"},{default:d(({row:e})=>[v(y(e.supplierName||"-"),1)]),_:1},8,["label"]),u(s,{prop:"updatedAt",label:p(S)("rfq.management.pendingLineItems.columns.updatedAt"),width:"180"},{default:d(({row:e})=>[v(y(Ne(e.updatedAt)),1)]),_:1},8,["label"]),u(s,{label:p(S)("rfq.management.pendingLineItems.columns.actions"),width:"150",align:"center"},{default:d(({row:e})=>[u(l,{type:"primary",size:"small",link:"",onClick:a=>Oe(e.rfqId,e.id)},{default:d(()=>[v(y(p(S)("rfq.management.pendingLineItems.actions.handle")),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])):we.value?b("",!0):(j(),f(T,{key:3,description:p(S)("rfq.management.pendingLineItems.empty")},null,8,["description"]))]),_:1})),[[Le,we.value]]),u(H,{class:"filter-card",shadow:"never"},{default:d(()=>[u(ke,{inline:!0,model:ye},{default:d(()=>[u(me,{label:p(S)("rfq.filter.status")},{default:d(()=>[u(oe,{modelValue:ye.status,"onUpdate:modelValue":a[1]||(a[1]=e=>ye.status=e),placeholder:p(S)("common.all"),clearable:""},{default:d(()=>[u(G,{label:p(S)("rfq.status.draft"),value:"draft"},null,8,["label"]),u(G,{label:p(S)("rfq.status.published"),value:"published"},null,8,["label"]),u(G,{label:p(S)("rfq.status.inProgress"),value:"in_progress"},null,8,["label"]),u(G,{label:p(S)("rfq.status.closed"),value:"closed"},null,8,["label"]),u(G,{label:p(S)("rfq.status.cancelled"),value:"cancelled"},null,8,["label"])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),u(me,{label:p(S)("rfq.filter.category")},{default:d(()=>[u(oe,{modelValue:ye.distributionCategory,"onUpdate:modelValue":a[2]||(a[2]=e=>ye.distributionCategory=e),placeholder:p(S)("common.all"),clearable:""},{default:d(()=>[u(G,{label:p(S)("rfq.distributionCategory.equipment"),value:"equipment"},null,8,["label"]),u(G,{label:p(S)("rfq.distributionCategory.auxiliaryMaterials"),value:"auxiliary_materials"},null,8,["label"])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),u(me,{label:p(S)("rfq.filter.rfqType")},{default:d(()=>[u(oe,{modelValue:ye.rfqType,"onUpdate:modelValue":a[3]||(a[3]=e=>ye.rfqType=e),placeholder:p(S)("common.all"),clearable:""},{default:d(()=>[u(G,{label:p(S)("rfq.rfqType.shortTerm"),value:"short_term"},null,8,["label"]),u(G,{label:p(S)("rfq.rfqType.longTerm"),value:"long_term"},null,8,["label"])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),u(me,null,{default:d(()=>[u(l,{type:"primary",icon:p(k),onClick:ze},{default:d(()=>[v(y(p(S)("common.search")),1)]),_:1},8,["icon"]),u(l,{icon:p(C),onClick:Ee},{default:d(()=>[v(y(p(S)("common.reset")),1)]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),m((j(),f(H,{class:"list-card",shadow:"never"},{default:d(()=>[u(r,{data:ve.value,style:{width:"100%"}},{default:d(()=>[u(s,{prop:"id",label:"ID",width:"80"}),u(s,{prop:"title",label:p(S)("rfq.form.title"),"min-width":"200"},null,8,["label"]),u(s,{label:p(S)("rfq.distributionForm.category"),width:"150"},{default:d(({row:e})=>{return[v(y((a=e.distributionCategory,a?S(`rfq.distributionCategory.${a}`):"-")),1)];var a}),_:1},8,["label"]),u(s,{label:p(S)("rfq.distributionForm.subcategory"),width:"150"},{default:d(({row:e})=>{return[v(y((a=e.distributionSubcategory,a?S(`rfq.distributionSubcategory.${a}`):"-")),1)];var a}),_:1},8,["label"]),u(s,{label:p(S)("rfq.form.rfqType"),width:"120"},{default:d(({row:e})=>[u(t,{type:"short_term"===e.rfqType?"success":"warning",size:"small"},{default:d(()=>[v(y(p(S)(`rfq.rfqType.${e.rfqType}`)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),u(s,{label:p(S)("rfq.status.label"),width:"120"},{default:d(({row:e})=>[u(t,{type:Ue(e.status),size:"small"},{default:d(()=>[v(y(p(S)(`rfq.status.${e.status}`)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),u(s,{prop:"validUntil",label:p(S)("rfq.form.validUntil"),width:"160"},{default:d(({row:e})=>[v(y(Ne(e.validUntil)),1)]),_:1},8,["label"]),u(s,{prop:"createdAt",label:p(S)("common.createdAt"),width:"160"},{default:d(({row:e})=>[v(y(Ne(e.createdAt)),1)]),_:1},8,["label"]),u(s,{label:p(S)("common.actions"),width:"200",align:"center"},{default:d(({row:e})=>[u(l,{type:"primary",size:"small",link:"",onClick:a=>Ve(e.id)},{default:d(()=>[v(y(p(S)("common.view")),1)]),_:1},8,["onClick"]),ce.value?(j(),f(l,{key:0,type:"warning",size:"small",link:"",onClick:a=>{return l=e.id,t=e.status,void(fe.value||("draft"===t?re.push(`/rfq/${l}/edit`):ue.warning(S("rfq.management.cannotEditPublished"))));var l,t}},{default:d(()=>[v(y(p(S)("common.edit")),1)]),_:1},8,["onClick"])):b("",!0),ce.value?(j(),f(l,{key:1,type:"danger",size:"small",link:"",onClick:a=>async function(e){if(!fe.value)if("draft"===e.status){try{await ue.confirm(S("rfq.management.deleteConfirm"),S("common.warning"))}catch{return}await de.runAction(async()=>{await pe.delete(`/api/rfq-workflow/${e.id}`,{silent:!0})},{rows:[e],successMessage:S("rfq.management.deleteSuccess"),errorMessage:S("common.operationFailed")}),await ze()}else ue.warning(S("rfq.management.cannotDeletePublished"))}(e)},{default:d(()=>[v(y(p(S)("common.delete")),1)]),_:1},8,["onClick"])):b("",!0)]),_:1},8,["label"])]),_:1},8,["data"])]),_:1})),[[Le,be.value]]),g("div",se,[u(Re,{background:"",layout:"prev, pager, next, sizes",total:qe.total,"current-page":qe.page,"onUpdate:currentPage":a[4]||(a[4]=e=>qe.page=e),"page-size":qe.limit,"onUpdate:pageSize":a[5]||(a[5]=e=>qe.limit=e),"page-sizes":[10,20,50,100],onCurrentChange:Me,onSizeChange:$e},null,8,["total","current-page","page-size"])])],64))])}}}),[["__scopeId","data-v-0c53658c"]]);export{re as default};
