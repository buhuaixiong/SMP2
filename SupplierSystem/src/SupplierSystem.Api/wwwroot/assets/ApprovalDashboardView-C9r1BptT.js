import{aP as e,h as a,d as l,u as t,g as s,c as r,C as o,aU as i,b as n,j as d,z as u,y as p,k as c,F as v,r as m,f as b,H as f,e as g,t as h,A as _,a9 as y,x as D,E as w,m as k,S as A,a4 as j,O as C,a1 as V,dZ as E,o as T,_ as I}from"./index-BBTXprD7.js";import{v as q}from"./el-loading-DCXIJbX2.js";import{E as N,a as S}from"./el-radio-group-BguwZukR.js";import{a as $,E as x}from"./el-timeline-item-BdujVaRY.js";import{a as z,E as U}from"./el-table-column-Ctv3S--Z.js";import"./el-scrollbar-DavFVGsf.js";import{E as B}from"./el-tag-Cyh8bl2p.js";import{E as L}from"./el-divider-M9M4Oc_1.js";import{E as M,a as P}from"./el-descriptions-item-Bk5jw2lv.js";import{E as W}from"./el-progress-g4hFwVd_.js";import{E as F}from"./el-empty-C7_R1uj6.js";import{E as R,a as H}from"./el-form-item--lL5pXgu.js";/* empty css                 */import{E as O,a as J}from"./el-select-CSgbKm39.js";import{E as X}from"./el-card-BK78pvjh.js";import{a as Z,f as G,s as K,u as Q,b as Y,c as ee,e as ae}from"./upgrade-DxK3oTEs.js";import{r as le}from"./apiBaseUrl-Bx8aB0Mq.js";import{u as te}from"./useNotification-CtllBzdG.js";import"./_baseClone-BSl38qjo.js";import"./castArray-CE_UyA2K.js";import"./debounce-DUfakjfK.js";const se=e("upgrade",()=>{const e=a([]),l=a(null),t=a(!1),s=a(!1),r=a(!1),o=a=>{if(!e.value.length&&!a)return;const l=e.value.length?e.value:a??[],t=new Map((a??l).map(e=>[e.code,e]));e.value=l.map(e=>{const a=t.get(e.code);return{...a??e,fulfilled:a?.fulfilled??e.fulfilled??!1,documentId:a?.documentId??e.documentId??null,template:a?.template??e.template??null}})},i=async e=>{t.value=!0;try{const a=await G(e);return l.value=a,o(a.requirements),a}finally{t.value=!1}};return{requirements:e,status:l,loading:t,submitting:s,actionLoading:r,loadRequirements:async()=>{const a=await Z();return e.value=a,a},loadStatus:i,submitApplication:async(e,a)=>{s.value=!0;try{await K(e,{documents:a}),await i(e)}finally{s.value=!1}},uploadRequirementFile:async e=>{const a=await Q(e);return o(),{fileId:a.id}},decide:async(e,a,t,s)=>{r.value=!0;try{await Y(e,a,t),s?await i(s):l.value?.supplierId&&await i(l.value.supplierId)}finally{r.value=!1}},reset:()=>{e.value=[],l.value=null}}}),re={class:"approval-dashboard-container"},oe={class:"header-content"},ie={class:"subtitle"},ne={class:"stats-grid"},de={class:"stat-item"},ue={class:"stat-value"},pe={class:"stat-label"},ce={class:"stat-item"},ve={class:"stat-value urgent"},me={class:"stat-label"},be={class:"stat-item"},fe={class:"stat-value"},ge={class:"stat-label"},he={class:"stat-item"},_e={class:"stat-value"},ye={class:"stat-label"},De={class:"section-header"},we={key:0,class:"empty-state"},ke={key:1,class:"applications-list"},Ae={class:"app-header"},je={class:"app-info"},Ce={class:"app-title"},Ve={class:"supplier-name"},Ee={class:"app-meta"},Te={key:0},Ie={key:0,class:"remaining-days"},qe={class:"app-actions"},Ne={class:"app-body"},Se={class:"progress-section"},$e={class:"progress-label"},xe={class:"completeness"},ze={class:"documents-preview"},Ue={class:"section-title"},Be={class:"document-tags"},Le={key:0,class:"detail-content"},Me={key:0},Pe={class:"documents-section"},We={key:0},Fe={key:1},Re={key:1},He={class:"approval-history-section"},Oe={class:"timeline-content"},Je={class:"timeline-header"},Xe={class:"step-name"},Ze={class:"timeline-body"},Ge={class:"reviewer"},Ke={key:0,class:"comments"},Qe={key:0,class:"decision-section"},Ye=I(l({__name:"ApprovalDashboardView",setup(e){const l=te(),{t:I}=t(),Z=s(),G=se(),K=a(!1),Q=a(!1),Ye=a(!1),ea=a(!1),aa=a([]),la=a([]),ta=a(!1),sa=a(null),ra=a([]),oa=a("pending"),ia=a({status:"",urgency:"",search:""}),na=a({decision:"",comments:""});let da=null;const ua=[{value:"pending_procurement_review",label:"approvalDashboard.statuses.pending_procurement_review"},{value:"pending_quality_review",label:"approvalDashboard.statuses.pending_quality_review"},{value:"pending_procurement_manager_review",label:"approvalDashboard.statuses.pending_procurement_manager_review"},{value:"pending_procurement_director_review",label:"approvalDashboard.statuses.pending_procurement_director_review"},{value:"pending_finance_director_review",label:"approvalDashboard.statuses.pending_finance_director_review"}],pa=r(()=>{if(!aa.value.length)return null;const e=aa.value.length,a=aa.value.filter(e=>wa(e.dueAt)).length,l=new Date;l.setDate(l.getDate()-7);return{total:e,urgent:a,thisWeek:aa.value.filter(e=>new Date(e.submittedAt)>=l).length,avgCompleteness:aa.value.reduce((e,a)=>e+a.documentCompleteness,0)/e}}),ca=(e,a)=>{let l=[...e];if(a&&ia.value.status&&(l=l.filter(e=>e.status===ia.value.status)),"urgent"===ia.value.urgency?l=l.filter(e=>wa(e.dueAt)):"normal"===ia.value.urgency&&(l=l.filter(e=>!wa(e.dueAt))),ia.value.search){const e=ia.value.search.toLowerCase();l=l.filter(a=>a.supplierName.toLowerCase().includes(e)||a.submittedBy.toLowerCase().includes(e))}return l.sort((e,a)=>{const l=wa(e.dueAt);return l!==wa(a.dueAt)?l?-1:1:new Date(a.submittedAt).getTime()-new Date(e.submittedAt).getTime()})},va=r(()=>ca(aa.value,!0)),ma=r(()=>ca(la.value,!1)),ba=r(()=>[{key:"pending",title:I("approvalDashboard.sections.pending"),items:va.value,loading:K.value,emptyText:I("approvalDashboard.noApplications")},{key:"approved",title:I("approvalDashboard.sections.approved"),items:ma.value,loading:Q.value,emptyText:I("approvalDashboard.noApprovedApplications")}]),fa=async()=>{K.value=!0;try{const e=await ee();aa.value=e}catch(e){l.error(e.message||I("approvalDashboard.loadError"))}finally{K.value=!1}},ga=async()=>{Q.value=!0;try{const e=await ae();la.value=e}catch(e){l.error(e.message||I("approvalDashboard.loadError"))}finally{Q.value=!1}},ha=async()=>{await Promise.all([fa(),ga()])},_a=e=>{if(!Z.user)return!1;const a={pending_procurement_review:"supplier.upgrade.init",pending_quality_review:"supplier.upgrade.approve.quality",pending_procurement_manager_review:"supplier.upgrade.approve.manager",pending_procurement_director_review:"supplier.upgrade.approve.director",pending_finance_director_review:"supplier.upgrade.approve.finance"}[e.status];return!!a&&Z.user.permissions?.includes(a)},ya=async()=>{if(sa.value&&na.value.decision){await l.confirm(I("approvalDashboard.confirmDecision",{decision:I(`approvalDashboard.decisions.${na.value.decision}`)}),I("common.confirm"),{type:"warning"}),ea.value=!0;try{const e={pending_procurement_review:"procurement_review",pending_quality_review:"quality_review",pending_procurement_manager_review:"procurement_manager_review",pending_procurement_director_review:"procurement_director_review",pending_finance_director_review:"finance_director_review"}[sa.value.status]||"";await Y(sa.value.id,e,{decision:na.value.decision,comments:na.value.comments||null}),l.success(I("approvalDashboard.decisionSuccess")),ta.value=!1,na.value={decision:"",comments:""},await ha()}catch(e){l.error(e.message||I("approvalDashboard.decisionError"))}finally{ea.value=!1}}},Da=e=>{if(!e?.id)return;const a=(e=>{const a=le(`/api/files/download/${e}`),l=localStorage.getItem("token");if(!l)return a;const t=a.includes("?")?"&":"?";return`${a}${t}token=${l}`})(e.id);window.open(a,"_blank")},wa=e=>{if(!e)return!1;const a=new Date(e),l=new Date,t=(a.getTime()-l.getTime())/864e5;return t<=3&&t>=0},ka=e=>{if(!e)return null;const a=new Date(e),l=new Date;return Math.ceil((a.getTime()-l.getTime())/864e5)},Aa=e=>e?new Date(e).toLocaleDateString():"-",ja=e=>e?new Date(e).toLocaleString():"-",Ca=e=>`${Math.round(e)}%`,Va=e=>"approved"===e?"success":e.startsWith("pending")?"warning":"rejected"===e||"returned"===e?"danger":"info";let Ea=null;const Ta=()=>{Ea&&clearTimeout(Ea),Ea=window.setTimeout(()=>{fa()},500)};return o(()=>{ha(),da=window.setInterval(()=>{ha()},3e4)}),i(()=>{da&&(clearInterval(da),da=null),Ea&&clearTimeout(Ea)}),(e,a)=>{const t=_,s=X,r=J,o=O,i=H,Z=w,Y=R,ee=F,ae=B,le=C,te=W,se=P,aa=M,la=L,da=U,ca=z,va=$,ma=x,ga=S,Ea=N,Ia=f,qa=q;return T(),n("div",re,[d(s,{class:"header-card"},{default:c(()=>[g("div",oe,[g("div",null,[g("h2",null,h(b(I)("approvalDashboard.title")),1),g("p",ie,h(b(I)("approvalDashboard.subtitle")),1)]),d(t,{type:"primary",icon:b(y),onClick:ha,loading:K.value||Q.value},{default:c(()=>[D(h(b(I)("common.refresh")),1)]),_:1},8,["icon","loading"])])]),_:1}),pa.value?(T(),u(s,{key:0,class:"stats-card"},{default:c(()=>[g("div",ne,[g("div",de,[g("div",ue,h(pa.value.total),1),g("div",pe,h(b(I)("approvalDashboard.stats.total")),1)]),g("div",ce,[g("div",ve,h(pa.value.urgent),1),g("div",me,h(b(I)("approvalDashboard.stats.urgent")),1)]),g("div",be,[g("div",fe,h(pa.value.thisWeek),1),g("div",ge,h(b(I)("approvalDashboard.stats.thisWeek")),1)]),g("div",he,[g("div",_e,h(Ca(pa.value.avgCompleteness)),1),g("div",ye,h(b(I)("approvalDashboard.stats.avgCompleteness")),1)])])]),_:1})):p("",!0),d(s,{class:"filter-card"},{default:c(()=>[d(Y,{inline:!0,model:ia.value,class:"filter-form"},{default:c(()=>[d(i,{label:b(I)("approvalDashboard.filters.status")},{default:c(()=>[d(o,{modelValue:ia.value.status,"onUpdate:modelValue":a[0]||(a[0]=e=>ia.value.status=e),clearable:"",onChange:fa},{default:c(()=>[(T(),n(v,null,m(ua,e=>d(r,{key:e.value,label:b(I)(e.label),value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),d(i,{label:b(I)("approvalDashboard.filters.urgency")},{default:c(()=>[d(o,{modelValue:ia.value.urgency,"onUpdate:modelValue":a[1]||(a[1]=e=>ia.value.urgency=e),clearable:"",onChange:fa},{default:c(()=>[d(r,{label:b(I)("approvalDashboard.urgency.urgent"),value:"urgent"},null,8,["label"]),d(r,{label:b(I)("approvalDashboard.urgency.normal"),value:"normal"},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),d(i,{label:b(I)("approvalDashboard.filters.search")},{default:c(()=>[d(Z,{modelValue:ia.value.search,"onUpdate:modelValue":a[2]||(a[2]=e=>ia.value.search=e),placeholder:b(I)("approvalDashboard.searchPlaceholder"),clearable:"",onInput:Ta},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1}),(T(!0),n(v,null,m(ba.value,e=>k((T(),u(s,{key:e.key,class:"applications-card"},{header:c(()=>[g("div",De,[g("span",null,h(e.title)+" ("+h(e.items.length)+")",1)])]),default:c(()=>[e.items.length?(T(),n("div",ke,[(T(!0),n(v,null,m(e.items,a=>{return T(),n("div",{key:a.id,class:A(["application-item",{urgent:wa(a.dueAt)}])},[g("div",Ae,[g("div",je,[g("div",Ce,[g("span",Ve,h(a.supplierName),1),d(ae,{type:Va(a.status),size:"small"},{default:c(()=>[D(h(b(I)(`approvalDashboard.statuses.${a.status}`)),1)]),_:2},1032,["type"]),wa(a.dueAt)?(T(),u(ae,{key:0,type:"danger",size:"small"},{default:c(()=>[D(h(b(I)("approvalDashboard.urgent")),1)]),_:1})):p("",!0)]),g("div",Ee,[g("span",null,[d(le,null,{default:c(()=>[d(b(j))]),_:1}),D(" "+h(a.submittedBy),1)]),g("span",null,[d(le,null,{default:c(()=>[d(b(V))]),_:1}),D(" "+h(Aa(a.submittedAt)),1)]),a.dueAt?(T(),n("span",Te,[d(le,null,{default:c(()=>[d(b(E))]),_:1}),D(" "+h(b(I)("approvalDashboard.dueDate"))+": "+h(Aa(a.dueAt))+" ",1),null!==ka(a.dueAt)?(T(),n("span",Ie," ("+h(ka(a.dueAt))+h(b(I)("common.daysRemaining"))+") ",1)):p("",!0)])):p("",!0)])]),g("div",qe,[d(t,{type:"primary",size:"small",onClick:t=>(async(e,a="pending")=>{sa.value=e,ta.value=!0,oa.value=a,Ye.value=!0;try{const a=await G.loadStatus(e.supplierId);ra.value=a.reviews||[]}catch(t){l.error(t.message||I("approvalDashboard.loadDetailError"))}finally{Ye.value=!1}})(a,e.key)},{default:c(()=>[D(h(b(I)("approvalDashboard.viewDetails")),1)]),_:1},8,["onClick"])])]),g("div",Ne,[g("div",Se,[g("div",$e,[g("span",null,h(b(I)("approvalDashboard.currentStep"))+": "+h(b(I)(`upgradeManagement.steps.${a.currentStep}`)),1),g("span",xe,h(Ca(a.documentCompleteness)),1)]),d(te,{percentage:a.documentCompleteness,color:(s=a.documentCompleteness,s>=100?"#67c23a":s>=80?"#e6a23c":"#f56c6c")},null,8,["percentage","color"])]),g("div",ze,[g("div",Ue,h(b(I)("approvalDashboard.documents")),1),g("div",Be,[(T(!0),n(v,null,m(a.documents,e=>(T(),u(ae,{key:e.id,type:e.file?"success":"info",size:"small",class:"doc-tag"},{default:c(()=>[D(h(e.requirementName),1)]),_:2},1032,["type"]))),128))])])])],2);var s}),128))])):(T(),n("div",we,[d(ee,{description:e.emptyText},null,8,["description"])]))]),_:2},1024)),[[qa,e.loading]])),128)),d(Ia,{modelValue:ta.value,"onUpdate:modelValue":a[6]||(a[6]=e=>ta.value=e),title:b(I)("approvalDashboard.applicationDetails"),width:"80%","close-on-click-modal":!1},{default:c(()=>[sa.value?k((T(),n("div",Le,[d(aa,{column:2,border:""},{default:c(()=>[d(se,{label:b(I)("approvalDashboard.supplierName")},{default:c(()=>[D(h(sa.value.supplierName),1)]),_:1},8,["label"]),d(se,{label:b(I)("approvalDashboard.applicationId")},{default:c(()=>[D(" #"+h(sa.value.id),1)]),_:1},8,["label"]),d(se,{label:b(I)("approvalDashboard.status")},{default:c(()=>[d(ae,{type:Va(sa.value.status)},{default:c(()=>[D(h(b(I)(`approvalDashboard.statuses.${sa.value.status}`)),1)]),_:1},8,["type"])]),_:1},8,["label"]),d(se,{label:b(I)("approvalDashboard.currentStep")},{default:c(()=>[D(h(b(I)(`upgradeManagement.steps.${sa.value.currentStep}`)),1)]),_:1},8,["label"]),d(se,{label:b(I)("approvalDashboard.submittedBy")},{default:c(()=>[D(h(sa.value.submittedBy),1)]),_:1},8,["label"]),d(se,{label:b(I)("approvalDashboard.submittedAt")},{default:c(()=>[D(h(ja(sa.value.submittedAt)),1)]),_:1},8,["label"]),d(se,{label:b(I)("approvalDashboard.dueDate")},{default:c(()=>[g("span",{class:A({"text-danger":wa(sa.value.dueAt)})},[D(h(Aa(sa.value.dueAt))+" ",1),null!==ka(sa.value.dueAt)?(T(),n("span",Me," ("+h(ka(sa.value.dueAt))+h(b(I)("common.daysRemaining"))+") ",1)):p("",!0)],2)]),_:1},8,["label"]),d(se,{label:b(I)("approvalDashboard.completeness")},{default:c(()=>[D(h(Ca(sa.value.documentCompleteness)),1)]),_:1},8,["label"])]),_:1}),d(la),g("div",Pe,[g("h3",null,h(b(I)("approvalDashboard.uploadedDocuments")),1),d(ca,{data:sa.value.documents,border:"",stripe:""},{default:c(()=>[d(da,{label:b(I)("approvalDashboard.table.documentName"),prop:"requirementName","min-width":"150"},null,8,["label"]),d(da,{label:b(I)("approvalDashboard.table.status"),width:"100"},{default:c(({row:e})=>[e.file?(T(),u(ae,{key:0,type:"success",size:"small"},{default:c(()=>[D(h(b(I)("approvalDashboard.uploaded")),1)]),_:1})):(T(),u(ae,{key:1,type:"info",size:"small"},{default:c(()=>[D(h(b(I)("approvalDashboard.notUploaded")),1)]),_:1}))]),_:1},8,["label"]),d(da,{label:b(I)("approvalDashboard.table.validityPeriod"),width:"200"},{default:c(({row:e})=>[e.file&&e.file.validFrom&&e.file.validTo?(T(),n("span",We,h(Aa(e.file.validFrom))+" ~ "+h(Aa(e.file.validTo)),1)):(T(),n("span",Fe,"-"))]),_:1},8,["label"]),d(da,{label:b(I)("approvalDashboard.table.uploadedAt"),width:"180"},{default:c(({row:e})=>[D(h(e.file?ja(e.file.uploadTime):"-"),1)]),_:1},8,["label"]),d(da,{label:b(I)("common.actions"),width:"120",fixed:"right"},{default:c(({row:e})=>[e.file?(T(),u(t,{key:0,type:"primary",size:"small",link:"",onClick:a=>Da(e.file)},{default:c(()=>[D(h(b(I)("common.download")),1)]),_:1},8,["onClick"])):(T(),n("span",Re,"-"))]),_:1},8,["label"])]),_:1},8,["data"])]),d(la),g("div",He,[g("h3",null,h(b(I)("approvalDashboard.approvalHistory")),1),ra.value.length?(T(),u(ma,{key:0},{default:c(()=>[(T(!0),n(v,null,m(ra.value,e=>(T(),u(va,{key:e.id,timestamp:ja(e.decidedAt),type:"approved"===e.decision?"success":"danger"},{default:c(()=>[g("div",Oe,[g("div",Je,[d(ae,{type:"approved"===e.decision?"success":"danger",size:"small"},{default:c(()=>[D(h(b(I)(`approvalDashboard.decisions.${e.decision}`)),1)]),_:2},1032,["type"]),g("span",Xe,h(e.stepName),1)]),g("div",Ze,[g("div",Ge,h(e.decidedByName),1),e.comments?(T(),n("div",Ke,h(e.comments),1)):p("",!0)])])]),_:2},1032,["timestamp","type"]))),128))]),_:1})):(T(),u(ee,{key:1,description:b(I)("approvalDashboard.noHistory")},null,8,["description"]))]),d(la),"pending"===oa.value&&_a(sa.value)?(T(),n("div",Qe,[g("h3",null,h(b(I)("approvalDashboard.makeDecision")),1),d(Y,{model:na.value,"label-width":"100px"},{default:c(()=>[d(i,{label:b(I)("approvalDashboard.decision")},{default:c(()=>[d(Ea,{modelValue:na.value.decision,"onUpdate:modelValue":a[3]||(a[3]=e=>na.value.decision=e)},{default:c(()=>[d(ga,{value:"approved"},{default:c(()=>[D(h(b(I)("approvalDashboard.approve")),1)]),_:1}),d(ga,{value:"rejected"},{default:c(()=>[D(h(b(I)("approvalDashboard.reject")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["label"]),d(i,{label:b(I)("approvalDashboard.comments")},{default:c(()=>[d(Z,{modelValue:na.value.comments,"onUpdate:modelValue":a[4]||(a[4]=e=>na.value.comments=e),type:"textarea",rows:4,placeholder:b(I)("approvalDashboard.commentsPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),d(i,null,{default:c(()=>[d(t,{type:"primary",onClick:ya,loading:ea.value,disabled:!na.value.decision},{default:c(()=>[D(h(b(I)("approvalDashboard.submitDecision")),1)]),_:1},8,["loading","disabled"]),d(t,{onClick:a[5]||(a[5]=e=>ta.value=!1)},{default:c(()=>[D(h(b(I)("common.cancel")),1)]),_:1})]),_:1})]),_:1},8,["model"])])):p("",!0)])),[[qa,Ye.value]]):p("",!0)]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-9b123981"]]);export{Ye as default};
