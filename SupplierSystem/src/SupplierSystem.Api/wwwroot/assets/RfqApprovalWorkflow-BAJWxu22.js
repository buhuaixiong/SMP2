import{h as e,d as a,u as l,g as r,i as s,c as t,C as o,z as n,y as p,k as c,j as i,b as d,r as u,e as m,t as v,x as f,f as h,F as y,E as g,A as q,H as _,a1 as j,aE as w,P as k,W as C,o as b,_ as A}from"./index-CyQdnTIC.js";import{E as I}from"./el-card-DJj_OhI8.js";import{E as V}from"./el-tag-eQgnjs1v.js";import{E,a as x}from"./el-select-CdADVnxU.js";import"./el-scrollbar-CTtrnhms.js";import{E as P,a as R}from"./el-form-item-DJ87vTOW.js";import{a as S,E as z}from"./el-timeline-item-CvFovLIE.js";/* empty css                 */import{E as U}from"./el-divider-BEySWtZA.js";import{k as $,m as N,r as F,n as T}from"./rfq-M3h8wC6E.js";import{a as D,u as H}from"./useNotification-DAUqvaBw.js";import"./castArray-C2ko8TfK.js";import"./_baseClone-CxGxK45k.js";const L={approveSuccess:"审批通过",approveError:"审批失败",rejectSuccess:"已驳回",rejectError:"驳回失败",requestChangesSuccess:"已提交变更请求",requestChangesError:"提交变更请求失败",commentSuccess:"评论已添加",commentError:"添加评论失败",inviteSuccess:"已邀请采购员",inviteError:"邀请失败",emptyInvites:"请选择至少一名采购员"};const W={class:"card-header"},K={class:"card-title"},O={class:"approval-step"},B={class:"step-header"},G={class:"step-details"},J={class:"step-info"},M={class:"label"},Q={class:"value"},X={key:0,class:"step-info"},Y={class:"label"},Z={class:"value"},ee={key:1,class:"step-info"},ae={class:"label"},le={class:"value"},re={key:2,class:"step-info"},se={class:"label"},te={class:"value"},oe={key:3,class:"step-info"},ne={class:"label"},pe={class:"value text-danger"},ce={key:0,class:"comments-section"},ie={style:{"font-size":"13px",color:"#606266"}},de={class:"comment-header"},ue={class:"comment-author"},me={class:"comment-time"},ve={class:"comment-content"},fe={class:"add-comment-section"},he={style:{display:"flex",gap:"8px","align-items":"center"}},ye={key:1,class:"step-actions"},ge={key:0,style:{"margin-top":"8px",color:"#909399","font-size":"12px"}},qe=A(a({__name:"RfqApprovalWorkflow",props:{rfqId:{},approvals:{}},emits:["refresh"],setup(a,{emit:A}){const{t:qe}=l(),_e=r(),je=H(),we=function(a,l={}){const r=D("http"),s=D("audit"),t=H(),o=e(!1),n=e([]),p=e(null),c=e=>l.messages?.[e]??L[e],i=(e,l,r)=>`/api/${a}/${e}/approvals/${l}/${r}`,d=async(e,a,l)=>{o.value=!0,p.value=null;try{const l=await e();return a&&t.success(a),l}catch(r){const e=r?.message||l;throw p.value=e??null,t.error(e??"操作失败"),r}finally{o.value=!1}};return{loading:o,history:n,lastError:p,approve:async(e,t,o)=>{await d(()=>l.approveApi?l.approveApi(e,t,o):r.post(i(e,t,"approve"),o??{},{silent:!0}),c("approveSuccess"),c("approveError")),s.logUpdate(a,{entityId:e,action:"approve",approvalId:t,payload:o})},reject:async(e,t,o)=>{await d(()=>l.rejectApi?l.rejectApi(e,t,o):r.post(i(e,t,"reject"),o,{silent:!0}),c("rejectSuccess"),c("rejectError")),s.logUpdate(a,{entityId:e,action:"reject",approvalId:t,payload:o})},requestChanges:async(e,t,o)=>{await d(()=>l.requestChangesApi?l.requestChangesApi(e,t,o):r.post(i(e,t,"request-changes"),o,{silent:!0}),c("requestChangesSuccess"),c("requestChangesError")),s.logUpdate(a,{entityId:e,action:"update",approvalId:t,payload:o})},addComment:async(e,a,s)=>{await d(()=>l.commentApi?l.commentApi(e,a,{content:s}):r.post(i(e,a,"comments"),{content:s},{silent:!0}),c("commentSuccess"),c("commentError"))},invitePurchasers:async(e,a,s)=>{s.purchaserIds?.length?await d(()=>l.inviteApi?l.inviteApi(e,a,s):r.post(i(e,a,"invite-purchasers"),s,{silent:!0}),c("inviteSuccess"),c("inviteError")):t.warning(c("emptyInvites"))},fetchHistory:async e=>{o.value=!0;try{const s=l.historyApi?await l.historyApi(e):await r.get(`/api/${a}/${e}/approvals`);return n.value=Array.isArray(s)?s:[],n.value}catch(s){throw p.value=s?.message??null,t.error(s?.message||"加载审批历史失败"),s}finally{o.value=!1}}}}("rfq",{approveApi:(e,a,l)=>T(e,a,l??{}),rejectApi:(e,a,l)=>F(e,a,l??{reason:""}),commentApi:N,inviteApi:$}),ke=a,Ce=A,be=e(!1),Ae=e(!1),Ie=e(!1),Ve=e(!1),Ee=e(null),xe=s({}),Pe=e([]),Re=e({comments:""}),Se=e({reason:""}),ze=e({purchaserIds:[],message:""}),Ue=t(()=>0===ke.approvals.length?"none":ke.approvals.some(e=>"rejected"===e.status)?"rejected":ke.approvals.every(e=>"approved"===e.status)?"approved":"pending");function $e(e){const a=_e.user?.role;return!!a&&a===e}function Ne(e){const a=_e.user?.role;return!!a&&"procurement_director"===a}function Fe(e){return{pending:"warning",approved:"success",rejected:"danger"}[e]||"info"}function Te(e){return{approved:k,rejected:w,pending:j}[e]||j}async function De(){if(Ee.value){Ve.value=!0;try{await we.approve(ke.rfqId,Ee.value.id,{comments:Re.value.comments}),be.value=!1,Ce("refresh")}catch(e){}finally{Ve.value=!1}}}async function He(){if(Ee.value)if(Se.value.reason.trim()){Ve.value=!0;try{await we.reject(ke.rfqId,Ee.value.id,{reason:Se.value.reason}),Ae.value=!1,Ce("refresh")}catch(e){}finally{Ve.value=!1}}else je.warning(qe("rfq.approval.rejectionReasonRequired"))}async function Le(){if(Ee.value)if(ze.value.purchaserIds&&0!==ze.value.purchaserIds.length){Ve.value=!0;try{await we.invitePurchasers(ke.rfqId,Ee.value.id,{purchaserIds:ze.value.purchaserIds,message:ze.value.message}),Ie.value=!1,Ce("refresh")}catch(e){je.error(e.message||qe("rfq.approval.inviteError"))}finally{Ve.value=!1}}else je.warning(qe("rfq.approval.selectPurchasersFirst"))}function We(e){if(!e)return"-";const a=new Date(e);return Number.isNaN(a.getTime())?"-":a.toLocaleString()}return o(()=>{!async function(){try{const e=await C("/users",{params:{role:"purchaser"}});console.log("=== Loaded purchasers ==="),console.log("Count:",e.data?.length||0),console.log("Data:",e.data),console.log("========================"),e.data&&0!==e.data.length||je.warning("娌℃湁鎵惧埌鍙敤鐨勯噰璐憳"),Pe.value=e.data||[]}catch(e){console.error("Failed to load purchasers:",e),je.error("鍔犺浇閲囪喘鍛樺垪琛ㄥけ璐? "+e.message)}}()}),(e,l)=>{const r=V,s=U,t=g,o=q,j=S,w=z,k=R,C=P,A=_,$=x,N=E,F=I;return a.approvals.length>0?(b(),n(F,{key:0,class:"approval-workflow-card",shadow:"never"},{header:c(()=>{return[m("div",W,[m("span",K,v(h(qe)("rfq.approval.workflowTitle")),1),i(r,{type:(e=Ue.value,{pending:"warning",approved:"success",rejected:"danger",none:"info"}[e]||"info"),size:"large"},{default:c(()=>[f(v(h(qe)(`rfq.approval.status.${Ue.value}`)),1)]),_:1},8,["type"])])];var e}),default:c(()=>[i(w,null,{default:c(()=>[(b(!0),d(y,null,u(a.approvals,e=>{return b(),n(j,{key:e.id,type:(a=e.status,{approved:"success",rejected:"danger",pending:"warning"}[a]||"info"),icon:Te(e.status),size:"pending"===e.status?"large":"normal"},{default:c(()=>[m("div",O,[m("div",B,[m("h4",null,v(e.step_name||e.stepName),1),i(r,{type:Fe(e.status),size:"small"},{default:c(()=>[f(v(h(qe)(`rfq.approval.stepStatus.${e.status}`)),1)]),_:2},1032,["type"])]),m("div",G,[m("div",J,[m("span",M,v(h(qe)("rfq.approval.approverRole"))+":",1),m("span",Q,v(h(qe)(`common.roles.${e.approver_role||e.approverRole}`)),1)]),e.approver_name||e.approverName?(b(),d("div",X,[m("span",Y,v(h(qe)("rfq.approval.approver"))+":",1),m("span",Z,v(e.approver_name||e.approverName),1)])):p("",!0),e.decided_at||e.decidedAt?(b(),d("div",ee,[m("span",ae,v(h(qe)("rfq.approval.decidedAt"))+":",1),m("span",le,v(We(e.decided_at||e.decidedAt)),1)])):p("",!0),e.comments?(b(),d("div",re,[m("span",se,v(h(qe)("rfq.approval.comments"))+":",1),m("span",te,v(e.comments),1)])):p("",!0),e.rejection_reason||e.rejectionReason?(b(),d("div",oe,[m("span",ne,v(h(qe)("rfq.approval.rejectionReason"))+":",1),m("span",pe,v(e.rejection_reason||e.rejectionReason),1)])):p("",!0)]),Array.isArray(e.comments)&&e.comments.length>0?(b(),d("div",ce,[i(s,{"content-position":"left"},{default:c(()=>[m("span",ie,v(h(qe)("rfq.approval.comments")),1)]),_:1}),(b(!0),d(y,null,u(e.comments,e=>(b(),d("div",{key:e.id,class:"comment-item"},[m("div",de,[m("span",ue,v(e.author_name||e.authorName),1),m("span",me,v(We(e.created_at||e.createdAt)),1)]),m("div",ve,v(e.content),1)]))),128))])):p("",!0),m("div",fe,[i(t,{modelValue:xe[e.id],"onUpdate:modelValue":a=>xe[e.id]=a,type:"textarea",rows:2,placeholder:h(qe)("rfq.approval.addCommentPlaceholder"),style:{"margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue","placeholder"]),m("div",he,[i(o,{type:"primary",size:"small",disabled:!xe[e.id]||!xe[e.id].trim(),onClick:a=>async function(e){const a=xe[e.id];if(a&&a.trim())try{await we.addComment(ke.rfqId,e.id,a.trim()),xe[e.id]="",Ce("refresh")}catch(l){je.error(l.message||qe("rfq.approval.commentError"))}else je.warning(qe("rfq.approval.commentRequired"))}(e)},{default:c(()=>[f(v(h(qe)("rfq.approval.addComment")),1)]),_:1},8,["disabled","onClick"]),Ne()?(b(),n(o,{key:0,type:"info",size:"small",onClick:a=>function(e){Ee.value=e,ze.value.purchaserIds=[],ze.value.message="",Ie.value=!0}(e)},{default:c(()=>[f(v(h(qe)("rfq.approval.invitePurchaser")),1)]),_:1},8,["onClick"])):p("",!0)])]),"pending"===e.status&&(e.approver_role||e.approverRole)&&$e(e.approver_role||e.approverRole)?(b(),d("div",ye,[i(o,{type:"success",size:"small",onClick:a=>function(e){Ee.value=e,Re.value.comments="",be.value=!0}(e)},{default:c(()=>[f(v(h(qe)("rfq.approval.approve")),1)]),_:1},8,["onClick"]),i(o,{type:"danger",size:"small",onClick:a=>function(e){Ee.value=e,Se.value.reason="",Ae.value=!0}(e)},{default:c(()=>[f(v(h(qe)("rfq.approval.reject")),1)]),_:1},8,["onClick"])])):p("",!0)])]),_:2},1032,["type","icon","size"]);var a}),128))]),_:1}),i(A,{modelValue:Ae.value,"onUpdate:modelValue":l[2]||(l[2]=e=>Ae.value=e),title:h(qe)("rfq.approval.rejectTitle"),width:"500px"},{footer:c(()=>[i(o,{onClick:l[1]||(l[1]=e=>Ae.value=!1)},{default:c(()=>[f(v(h(qe)("common.cancel")),1)]),_:1}),i(o,{type:"danger",loading:Ve.value,onClick:He},{default:c(()=>[f(v(h(qe)("rfq.approval.confirmReject")),1)]),_:1},8,["loading"])]),default:c(()=>[i(C,{model:Se.value,"label-width":"120px"},{default:c(()=>[i(k,{label:h(qe)("rfq.approval.rejectionReason"),required:""},{default:c(()=>[i(t,{modelValue:Se.value.reason,"onUpdate:modelValue":l[0]||(l[0]=e=>Se.value.reason=e),type:"textarea",rows:4,placeholder:h(qe)("rfq.approval.rejectionReasonPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),i(A,{modelValue:be.value,"onUpdate:modelValue":l[5]||(l[5]=e=>be.value=e),title:h(qe)("rfq.approval.approveTitle"),width:"500px"},{footer:c(()=>[i(o,{onClick:l[4]||(l[4]=e=>be.value=!1)},{default:c(()=>[f(v(h(qe)("common.cancel")),1)]),_:1}),i(o,{type:"success",loading:Ve.value,onClick:De},{default:c(()=>[f(v(h(qe)("rfq.approval.confirmApprove")),1)]),_:1},8,["loading"])]),default:c(()=>[i(C,{model:Re.value,"label-width":"120px"},{default:c(()=>[i(k,{label:h(qe)("rfq.approval.comments")},{default:c(()=>[i(t,{modelValue:Re.value.comments,"onUpdate:modelValue":l[3]||(l[3]=e=>Re.value.comments=e),type:"textarea",rows:4,placeholder:h(qe)("rfq.approval.commentsPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),i(A,{modelValue:Ie.value,"onUpdate:modelValue":l[9]||(l[9]=e=>Ie.value=e),title:h(qe)("rfq.approval.invitePurchaser"),width:"600px"},{footer:c(()=>[i(o,{onClick:l[8]||(l[8]=e=>Ie.value=!1)},{default:c(()=>[f(v(h(qe)("common.cancel")),1)]),_:1}),i(o,{type:"primary",loading:Ve.value,disabled:!ze.value.purchaserIds||0===ze.value.purchaserIds.length,onClick:Le},{default:c(()=>[f(v(h(qe)("common.confirm")),1)]),_:1},8,["loading","disabled"])]),default:c(()=>[i(C,{model:ze.value,"label-width":"120px"},{default:c(()=>[i(k,{label:h(qe)("rfq.approval.selectPurchasers")},{default:c(()=>[i(N,{modelValue:ze.value.purchaserIds,"onUpdate:modelValue":l[6]||(l[6]=e=>ze.value.purchaserIds=e),multiple:"",placeholder:h(qe)("rfq.approval.selectPurchasersPlaceholder"),style:{width:"100%"},filterable:""},{default:c(()=>[(b(!0),d(y,null,u(Pe.value,e=>(b(),n($,{key:e.id,label:`${e.name} (${e.role||"purchaser"})`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"]),0===Pe.value.length?(b(),d("div",ge,v(h(qe)("common.none"))+" - 娌℃湁鍙敤鐨勯噰璐憳 ",1)):p("",!0)]),_:1},8,["label"]),i(k,{label:h(qe)("rfq.approval.comments")},{default:c(()=>[i(t,{modelValue:ze.value.message,"onUpdate:modelValue":l[7]||(l[7]=e=>ze.value.message=e),type:"textarea",rows:3,placeholder:h(qe)("rfq.approval.addCommentPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})):p("",!0)}}}),[["__scopeId","data-v-7c19b94e"]]);export{qe as default};
