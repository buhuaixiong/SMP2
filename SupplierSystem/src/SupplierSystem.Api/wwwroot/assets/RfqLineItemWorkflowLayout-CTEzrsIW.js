import{W as e,a as l,c as t,ev as a,aV as r,d as i,u as o,h as n,i as s,B as u,b as d,e as c,j as m,t as p,f,k as v,x as y,m as b,y as q,A as h,O as g,bW as _,F as w,r as k,S as I,z as C,w as N,aF as $,E as S,H as U,a5 as P,ew as x,cA as D,o as z,_ as V,bA as A,ak as R,Z as T,a1 as j,C as L,aE as F,P as E,V as Q,aO as W,R as O,aU as Y,cI as B,I as M,N as H,g as G}from"./index-DYFFjkr1.js";import{v as K}from"./el-loading-BgAruwZt.js";import{E as Z}from"./el-empty-BZtwHSAL.js";import{E as J}from"./el-tag-CJZxRmaO.js";import{E as X}from"./el-alert-C0fAK8MY.js";import{u as ee,q as le,d as te,t as ae}from"./rfq-BTYHEdgI.js";import{r as re,d as ie}from"./RfqDetailView-Bb6n1XZX.js";import{p as oe,f as ne}from"./dataParsing-BO9ZKtBB.js";import{E as se,a as ue}from"./el-tab-pane-DxO0eH8S.js";import{E as de}from"./el-text-DzDQCiej.js";import{E as ce,a as me}from"./el-descriptions-item-C_W8beT_.js";import{E as pe}from"./el-link-DchQUWJv.js";import{a as fe,E as ve,b as ye,c as be}from"./el-table-column-iGvGjXfJ.js";import{E as qe}from"./el-scrollbar-BV1KhhWB.js";import{E as he,a as ge}from"./el-form-item-Dt8bC1C1.js";/* empty css                 */import{E as _e}from"./el-divider-BLUImpPp.js";import{E as we,a as ke}from"./el-col-BhPR-uP-.js";import{E as Ie}from"./el-card-DXuwoUdg.js";import{u as Ce}from"./useNotification-7LT1DUze.js";import{E as Ne}from"./el-result-BP4Jwk5q.js";import{E as $e,a as Se}from"./el-select-BS36fOcX.js";import{E as Ue}from"./el-switch-DUQXZzjR.js";import{E as Pe,a as xe}from"./el-timeline-item-B355P2pK.js";import{E as De}from"./el-upload-DOcifh5X.js";import"./el-progress-CHtcwiEk.js";import{P as ze}from"./PriceComparisonDetailDialog-C8wp3oWB.js";import{C as Ve}from"./ConfirmButton-1ycULN59.js";/* empty css                          */import"./PageHeader-CAZ_tKZR.js";import"./apiBaseUrl-Bx8aB0Mq.js";import"./index-CKH4tMiN.js";import"./_baseClone-B1OBbKeE.js";import"./castArray-DWuU9tbi.js";import"./debounce-CrnOfj79.js";import"./cloneDeep-DFLr2lo-.js";import"./el-image-viewer-C6LFezhh.js";async function Ae(l,t,a){return e(`/rfq/${l}/line-items/${t}/director-approve`,{method:"POST",body:a})}const Re=(e,l=r(),t={})=>{const a=(e=>{if(e instanceof Date)return Number.isNaN(e.getTime())?null:e;if("number"==typeof e){const l=new Date(e);return Number.isNaN(l.getTime())?null:l}if("string"==typeof e){const l=new Date(e);return Number.isNaN(l.getTime())?null:l}return null})(e);if(!a)return"";return new Intl.DateTimeFormat(l,t).format(a)},Te=(e,l=r(),t={})=>{const a=(e=>{if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){const l=Number(e);return Number.isFinite(l)?l:null}return null})(e);if(null===a)return"";return new Intl.NumberFormat(l,t).format(a)},je=()=>{const e=l(),i=t(()=>a(e.currentLocale));return{currentLocale:t(()=>e.currentLocale),intlLocale:i,formatDate:(e,l={})=>Re(e,i.value,l),formatNumber:(e,l={})=>Te(e,i.value,l),formatCurrency:(e,l,t={})=>((e,l,t=r(),a={})=>Te(e,t,{style:"currency",currency:l,...a}))(e,l,i.value,t)}},Le={class:"rfq-quote-comparison"},Fe={class:"comparison-header"},Ee={key:0,class:"empty-state"},Qe={key:1,class:"comparison-content"},We={class:"quote-cards-section"},Oe={class:"cards-wrapper"},Ye={class:"detail-button-container"},Be={class:"supplier-cards-grid"},Me=["onClick"],He=["title"],Ge={class:"unit-price-display"},Ke={class:"supplier-cell"},Ze={class:"price-cell"},Je={key:0,class:"price-cell standard-cost-cell"},Xe={class:"price-meta"},el={key:1,class:"price-cell standard-cost-cell"},ll={class:"comparison-summary"},tl={class:"summary-card"},al={class:"summary-label"},rl={class:"summary-value"},il={class:"summary-card"},ol={class:"summary-label"},nl={class:"summary-value"},sl={class:"summary-card"},ul={class:"summary-label"},dl={class:"summary-value"},cl={class:"summary-card"},ml={class:"summary-label"},pl={class:"summary-value"},fl={class:"summary-card"},vl={class:"summary-label"},yl={class:"summary-value"},bl={class:"summary-card"},ql={class:"summary-label"},hl={class:"summary-value"},gl={class:"summary-card"},_l={class:"summary-label"},wl={class:"summary-value"},kl={class:"summary-card"},Il={class:"summary-label"},Cl={class:"summary-value"},Nl={key:0,class:"standard-cost-comparison"},$l={style:{"font-size":"16px","font-weight":"600"}},Sl={style:{"font-size":"13px",color:"#909399","margin-left":"8px"}},Ul={class:"cost-cards-container"},Pl={class:"supplier-name"},xl={class:"cost-amount"},Dl={class:"usd-cost"},zl={class:"local-cost"},Vl={key:1,class:"price-comparison-section"},Al={style:{"font-size":"16px","font-weight":"600"}},Rl={class:"platform-header"},Tl={class:"platform-name"},jl={key:0,class:"uploaded-info"},Ll={key:1},Fl={class:"uploaded-meta"},El={key:0},Ql={key:2,class:"uploaded-meta uploaded-meta--timestamp"},Wl=["disabled"],Ol={key:0,style:{"margin-top":"4px","font-size":"12px",color:"#909399"}},Yl={class:"platform-header"},Bl={class:"platform-name"},Ml={key:0,class:"uploaded-info"},Hl={key:1},Gl={class:"uploaded-meta"},Kl={key:0},Zl={key:2,class:"uploaded-meta uploaded-meta--timestamp"},Jl=["disabled"],Xl={key:0,style:{"margin-top":"4px","font-size":"12px",color:"#909399"}},et={class:"platform-header"},lt={class:"platform-name"},tt={key:0,class:"uploaded-info"},at={key:1},rt={class:"uploaded-meta"},it={key:0},ot={key:2,class:"uploaded-meta uploaded-meta--timestamp"},nt=["disabled"],st={key:0,style:{"margin-top":"4px","font-size":"12px",color:"#909399"}},ut={key:0,class:"quote-detail"},dt={key:0,style:{margin:"0","white-space":"pre-wrap","word-break":"break-word"}},ct={key:1},mt={key:0,style:{margin:"0","white-space":"pre-wrap","word-break":"break-word"}},pt={key:1},ft={class:"item-name"},vt={key:0,class:"item-spec"},yt={key:0},bt={class:"tariff-detail-value"},qt={key:0,class:"tariff-detail-meta"},ht={key:1,class:"tariff-detail-meta"},gt={key:1},_t={key:0},wt={key:1},kt={key:2},It={key:1},Ct={key:0,class:"supplier-profile"},Nt={key:1},$t={key:0},St={key:1},Ut={key:0,class:"attachment-list"},Pt={key:1},xt={key:1},Dt=V(i({__name:"RfqQuoteComparison",props:{quotes:{},selectable:{type:Boolean,default:!1},rfqItems:{default:()=>[]},rfqId:{default:void 0},materialCategoryType:{default:void 0},distributionCategory:{default:void 0},existingPriceComparisons:{default:()=>[]}},setup(e){const l=Ce(),{t:a}=o(),{formatCurrency:r,formatDate:i,formatNumber:V}=je(),A=["1688","jd","zkh"],R=e,T=n(!1),j=n(null),L=n(!1),F=n(null),E=e=>(e??[]).map(e=>{const l=e.storedName??e.stored_name??e.storedFileName??e.stored_file_name??null,t=e.filePath??e.file_path??null,a=re(t,l,"rfq-attachments")??e.downloadUrl??null;return{...e,storedName:l,originalName:e.originalName??e.original_name??e.fileName??e.file_name,downloadUrl:a}}),Q=t(()=>E(j.value?.attachments??[])),W=n(null),O=n(!1),Y=s({1688:{file:null,url:"",price:null,uploaded:!1,records:[]},jd:{file:null,url:"",price:null,uploaded:!1,records:[]},zkh:{file:null,url:"",price:null,uploaded:!1,records:[]}}),B=e=>{if("string"!=typeof e&&"number"!=typeof e)return null;const l=String(e).toLowerCase();return"1688"===l?"1688":"jd"===l?"jd":"zkh"===l||"������"===l||"zhenkunxing"===l?"zkh":null},M=e=>{A.forEach(e=>{const l=Y[e];l.uploaded=!1,l.records=[],l.file||(l.url="",l.price=null)}),Array.isArray(e)&&e.map(e=>(e=>{const l=B(e?.platform??e?.platformKey??e?.platform_key)??String(e?.platform??""),t=e?.original_file_name??e?.originalFileName??e?.file_name??e?.fileName??"",a=e?.filePath??e?.file_path??"",r=e?.stored_file_name??e?.storedFileName??("string"==typeof a?a.split("/").pop():"")??"",i=e?.productUrl??e?.product_url??null,o=e?.platformPrice??e?.platform_price??null,n=re(a,r,"rfq_price_comparison"),s="number"==typeof o?o:null==o||Number.isNaN(Number(o))?null:Number(o);return{...e,platform:l,fileName:t,storedFileName:r,productUrl:i,platformPrice:s,downloadUrl:n}})(e)).forEach(e=>{const l=B(e.platform);if(!l)return;const t=Y[l];if(t.uploaded=!0,t.records.push(e),e.productUrl&&(t.url=String(e.productUrl)),null!==e.platformPrice&&void 0!==e.platformPrice){const l="number"==typeof e.platformPrice?e.platformPrice:Number(e.platformPrice);Number.isFinite(l)&&(t.price=l)}})};u(()=>R.existingPriceComparisons,e=>{M(e)},{immediate:!0,deep:!0});const H=n(!1),G=t(()=>(console.log("[RfqQuoteComparison] Price comparison check:",{rfqId:R.rfqId,materialCategoryType:R.materialCategoryType,distributionCategory:R.distributionCategory,shouldShow:R.rfqId&&"IDM"===R.materialCategoryType}),!!R.rfqId&&"IDM"===R.materialCategoryType)),K=e=>{if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){const l=e.replace(/[��$���,\s]/g,""),t=Number(l);if(Number.isFinite(t))return t}return null},le=e=>{let l=e.unitPrice??e.unit_price??null;if(!l&&e.quoteItems&&Array.isArray(e.quoteItems)&&e.quoteItems.length>0){const t=e.quoteItems.map(e=>K(e.unitPrice??e.unit_price)).filter(e=>null!==e);t.length>0&&(l=t.reduce((e,l)=>e+l,0)/t.length)}return K(l)},te=e=>e.tariffSummary??e.tariff_summary??null??null,ae=e=>{const l=te(e);if(l){if("USD"===l.standardCostCurrency&&null!==l.totalStandardCostUsd)return{amount:l.totalStandardCostUsd,currency:"USD"};if(null!==l.totalStandardCostLocal){const t=l.standardCostCurrency||l.currency||e.currency||"CNY";return{amount:l.totalStandardCostLocal,currency:t}}}if(e.quoteItems&&e.quoteItems.length>0){let l=0,t=!1;const a={};if(e.quoteItems.forEach(r=>{const i=K(r.tariffLineTotalUsd??r.standardLineCostUsd??r.standardUnitCostUsd),o=K(r.tariffLineTotal??r.standardLineCostLocal??r.standardUnitCostLocal);if(null!==i)l+=i,t=!0;else if(null!==o){const l=r.tariffCalculation?.standardCostCurrency??r.standardCostCurrency??e.currency??"CNY";a[l]=(a[l]||0)+o}}),t)return{amount:l,currency:"USD"};const[r,i]=Object.entries(a)[0]??[];if(r&&void 0!==i)return{amount:i,currency:r}}return{amount:null,currency:e.currency||"CNY"}},ie=e=>{const l=ae(e),t=(e=>e.quoteItems&&0!==e.quoteItems.length?e.quoteItems.reduce((e,l)=>{const t=Number(l.quantity??l.rfqQuantity??l.lineQuantity??l.minimumOrderQuantity??0);return Number.isFinite(t)?e+t:e},0):0)(e);return l.amount&&t?{amount:l.amount/t,currency:l.currency}:{amount:null,currency:l.currency}},oe=e=>{const l=te(e);return!!l?.hasSpecialTariff||!!(e.quoteItems&&e.quoteItems.length>0)&&e.quoteItems.some(e=>Boolean(e.tariffCalculation?.hasSpecialTariff))},ne=t(()=>{console.log("[RfqQuoteComparison] Computing numeric unit prices from quotes:",R.quotes);const e=R.quotes.map(e=>{const l=le(e);return console.log(`[RfqQuoteComparison] Quote ${e.id}:`,{unitPrice:e.unitPrice,unit_price:e.unit_price,totalAmount:e.totalAmount,quoteItemsCount:e.quoteItems?.length||0,calculated:l}),l}).filter(e=>null!==e);return console.log("[RfqQuoteComparison] Final numeric prices:",e),e}),ye=t(()=>0===ne.value.length?null:Math.min(...ne.value)),be=t(()=>0===ne.value.length?null:Math.max(...ne.value)),qe=t(()=>{if(0===ne.value.length)return null;return ne.value.reduce((e,l)=>e+l,0)/ne.value.length}),Ne=t(()=>null===ye.value||null===be.value||ye.value<=0||be.value<=0?null:(be.value-ye.value)/ye.value*100),$e=t(()=>R.quotes.reduce((e,l)=>(e[l.id]={total:ae(l),unit:ie(l),summary:te(l),hasSpecialTariff:oe(l)},e),{})),Se=t(()=>Object.values($e.value).map(e=>null!==e.summary?.totalStandardCostUsd&&void 0!==e.summary?.totalStandardCostUsd?e.summary.totalStandardCostUsd:"USD"===e.total.currency&&null!==e.total.amount?e.total.amount:null).filter(e=>null!==e)),Ue=t(()=>0===Se.value.length?null:Math.min(...Se.value)),Pe=t(()=>0===Se.value.length?null:Math.max(...Se.value)),xe=t(()=>{if(0===Se.value.length)return null;return Se.value.reduce((e,l)=>e+l,0)/Se.value.length}),De=t(()=>{let e=null,l=null;return Object.entries($e.value).forEach(([t,a])=>{const r=a.summary?.totalStandardCostUsd??("USD"===a.total.currency?a.total.amount:null);null!=r&&(null===e||r<e)&&(e=r,l=Number(t))}),l}),ze=t(()=>Object.values($e.value).filter(e=>e.hasSpecialTariff).length),Ve=t(()=>[...R.quotes].filter(e=>{const l=$e.value[e.id];if(!l)return!1;const t=l.summary?.totalStandardCostUsd??("USD"===l.total.currency?l.total.amount:null);return null!=t}).sort((e,l)=>{const t=$e.value[e.id],a=$e.value[l.id];return(t.summary?.totalStandardCostUsd??t.total.amount??0)-(a.summary?.totalStandardCostUsd??a.total.amount??0)})),Ae=(e,l)=>{const t=$e.value[e.id];if(!t)return"-";if("USD"===l){const e=t.summary?.totalStandardCostUsd??("USD"===t.total.currency?t.total.amount:null);return null==e?"-":`US${e.toFixed(2)}`}{const e=t.summary?.totalStandardCostLocal??t.total.amount;return t.summary?.standardCostCurrency??t.total.currency,null==e?"-":`¥${e.toFixed(2)}`}},Re=n(!1),Te=n(null),Dt=(e,l="CNY")=>{const t=K(e);return null===t?"-":r(t,l)},zt=e=>e?i(e,{year:"numeric",month:"2-digit",day:"2-digit"}):"-",Vt=e=>e?i(e,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",At=t(()=>{const e=new Map;return R.rfqItems.forEach(l=>{const t=l.id??(null!=l.rfqLineItemId?Number(l.rfqLineItemId):void 0)??(null!=l.rfqItemId?Number(l.rfqItemId):void 0);null!=t&&e.set(t,l)}),e}),Rt=t(()=>{const e=j.value;return e?.quoteItems&&0!==e.quoteItems.length?e.quoteItems.map((l,t)=>{const r=l,i=l.rfqLineItemId??l.rfqItemId??("number"==typeof r.rfq_line_item_id?r.rfq_line_item_id:null==r.rfq_line_item_id||Number.isNaN(Number(r.rfq_line_item_id))?void 0:Number(r.rfq_line_item_id))??("number"==typeof r.rfq_item_id?r.rfq_item_id:null==r.rfq_item_id||Number.isNaN(Number(r.rfq_item_id))?void 0:Number(r.rfq_item_id)),o=null!=i?At.value.get(i):void 0,n=l.quantity??("number"==typeof r.quantity?r.quantity:void 0)??o?.quantity??null,s=o?.unit??null,u="number"==typeof n?n:null==n||Number.isNaN(Number(n))?null:Number(n),d=null!=u?s?`${u} ${s}`:`${u}`:s||"-",c=K(l.unitPrice),m=K(l.totalPrice??l.totalAmount),p=o?.itemName??o?.materialCategory??a("rfq.quotes.items.unknownItem",{index:t+1}),f=o?.specifications??o?.parameters??("string"==typeof l.parameters?l.parameters:"string"==typeof r.parameters?r.parameters:void 0),v="string"==typeof l.brand&&l.brand.trim().length>0?l.brand.trim():o?.brand?String(o.brand):"",y=l.productGroup??r.product_group??o?.materialCategory??null,b=l.productOrigin??r.product_origin??null,q=l.tariffCalculation??(r.tariffCalculation||r.tariff_calculation)??null;let h=K(q?.standardCost),g=q?.standardCostCurrency?.toString()??r.standard_cost_currency??(null!==h?e.currency??"CNY":"USD"),_=K(l.standardLineCostUsd??l.standardLineCostLocal??r.standard_line_cost_usd??r.standard_line_cost_local);if(q&&void 0!==q.standardCostUsd&&null!==q.standardCostUsd){const e=K(q.standardCostUsd);null!==e&&(h=e,g="USD",null!=u&&(_=Number((e*u).toFixed(2))))}else null===h||null==u||null!==_&&!Number.isNaN(_)||(_=Number((h*u).toFixed(2)));null===h&&null!==_&&u&&(h=Number((_/u).toFixed(4)));const w=q&&"number"==typeof q.tariffRate?q.tariffRate:null,k=q&&"number"==typeof q.specialTariffRate?q.specialTariffRate:null,I=Boolean(q?.hasSpecialTariff)??!1;return g=g||e.currency||"CNY",{key:`${e.id}-${t}`,itemName:p,specifications:f||void 0,quantityLabel:d,unitPrice:c,totalPrice:m,deliveryDate:l.deliveryDate??null,brandLabel:v,productGroup:y||null,productOrigin:b||null,standardUnitCost:h,standardUnitCostCurrency:g,standardLineTotal:_,tariffRate:w,specialTariffRate:k,hasSpecialTariff:I}}):[]}),Tt=e=>null===e?"-":`${V(e,{minimumFractionDigits:1,maximumFractionDigits:1})}%`,jt=e=>null===e?"-":Tt(100*e),Lt=e=>{const l="string"==typeof e.brand&&e.brand.trim().length>0?e.brand.trim():"",t=(e=>{if(!e?.quoteItems||0===e.quoteItems.length)return[];const l=new Set;return e.quoteItems.forEach(e=>{const t=e.brand;"string"==typeof t&&t.trim().length>0&&l.add(t.trim())}),Array.from(l)})(e),a=new Set;return l&&l.split(",").map(e=>e.trim()).forEach(e=>{e.length>0&&a.add(e)}),t.forEach(e=>{e.length>0&&a.add(e)}),0===a.size?"-":Array.from(a).join(", ")},Ft=e=>{if(null==e||Number.isNaN(e))return"-";if(e<1024)return`${e} B`;const l=e/1024;if(l<1024)return`${V(l,{maximumFractionDigits:1})} KB`;const t=l/1024;if(t<1024)return`${V(t,{maximumFractionDigits:1})} MB`;return`${V(t/1024,{maximumFractionDigits:1})} GB`},Et=({row:e})=>{const l=[];"selected"===e.status&&l.push("selected-row");const t=K(e.unitPrice??e.unit_price);var a;return null!==t&&null!==ye.value&&t===ye.value&&l.push("lowest-price-row"),null!==De.value&&e.id===De.value&&l.push("lowest-standard-row"),(a=e,$e.value[a.id])?.hasSpecialTariff&&l.push("special-tariff-row"),l.join(" ")},Qt=e=>{Wt(e)},Wt=e=>{j.value=e,T.value=!0},Ot=t(()=>{if(0===R.quotes.length)return[];return[{key:"standardCost",label:"rfq.priceComparison.detailLabels.standardCost"},{key:"originalPrice",label:"rfq.priceComparison.detailLabels.originalPrice"},{key:"shippingFee",label:"rfq.quoteComparison.shippingFee"},{key:"specialTariff",label:"rfq.priceComparison.detailLabels.specialTariff"},{key:"moq",label:"rfq.priceComparison.detailLabels.moq"},{key:"spq",label:"rfq.priceComparison.detailLabels.spq"},{key:"deliveryTime",label:"rfq.priceComparison.detailLabels.leadTime"},{key:"productOrigin",label:"rfq.priceComparison.detailLabels.productOrigin"},{key:"quoteAttachments",label:"rfq.quoteComparison.quoteAttachments"}].map(e=>{const l={};let t=null,a=null;return R.quotes.forEach(r=>{const i=$e.value[r.id];let o=null;switch(e.key){case"standardCost":o=null!==i?.total.amount?Dt(i.total.amount,i.total.currency||"USD"):"-",null!==i?.total.amount&&(null===a||i.total.amount<a)&&(a=i.total.amount,t=r.id);break;case"originalPrice":o=Dt(le(r),r.currency||"CNY");const e=le(r);null!==e&&(null===a||e<a)&&(a=e,t=r.id);break;case"shippingFee":o="-";break;case"specialTariff":if(r.quoteItems&&r.quoteItems[0]?.tariffCalculation){const e=r.quoteItems[0].tariffCalculation.specialTariffRate;o=null!=e?jt(e):"-"}else o="-";break;case"moq":if(r.quoteItems&&r.quoteItems[0]){const e=r.quoteItems[0].minimumOrderQuantity||r.quoteItems[0].moq;o=null!=e?Yt(e):"-",null!=e&&(null===a||e<a)&&(a=e,t=r.id)}else o="-";break;case"spq":if(r.quoteItems&&r.quoteItems[0]){const e=r.quoteItems[0].standardPackageQuantity||r.quoteItems[0].spq;o=null!=e?Yt(e):"-"}else o="-";break;case"deliveryTime":if(r.quoteItems&&r.quoteItems[0]){const e=r.quoteItems[0].deliveryDate||r.deliveryDate;o=e?zt(e):"-"}else o=r.deliveryDate?zt(r.deliveryDate):"-";break;case"productOrigin":o=r.quoteItems&&r.quoteItems[0]?r.quoteItems[0].productOrigin||r.shippingCountry||"-":r.shippingCountry||"-";break;case"quoteAttachments":{const e=E(r.attachments??[]);o=e.length?e:[];break}}l[r.id]=o}),{key:e.key,field:e.label,values:l,bestQuoteId:["standardCost","originalPrice","moq"].includes(e.key)?t:null}})}),Yt=e=>{if(null==e)return"-";const l=K(e);return null!==l?(new Intl.NumberFormat).format(l):"string"==typeof e?e:String(e)},Bt=(e,l,t="EA")=>{if(null==e)return"-";return`${{CNY:"¥",USD:"$",EUR:"€",JPY:"¥",THB:"฿"}[l]||l}${new Intl.NumberFormat("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}/${t}`},Mt=e=>e.quoteItems&&e.quoteItems.length>0&&e.quoteItems[0].unit||"EA",Ht=e=>e.taxStatus?e.taxStatus:e.quoteItems&&e.quoteItems.length>0&&e.quoteItems[0]?.taxStatus?e.quoteItems[0].taxStatus:"inclusive",Gt=(e,l)=>{const t=l.target;t.files&&t.files.length>0&&(Y[e].file=t.files[0])},Kt=async e=>{if(!R.rfqId)return void l.error("RFQ ID is missing");const t=Y[e];if(t.file&&t.url&&null!==t.price){H.value=!0;try{const r=await ee(R.rfqId,e,t.file,t.price,t.url);t.uploaded=!0,t.uploadedData=r,l.success(a("rfq.priceComparison.uploadSuccess",{platform:a(`rfq.priceComparison.${e}`)})||`${e}�۸�Ա��ϴ��ɹ�`)}catch(r){l.error(D(r))}finally{H.value=!1}}else l.warning(a("rfq.priceComparison.required",{platforms:a(`rfq.priceComparison.${e}`)}))};return(l,t)=>{const r=de,i=Z,o=g,n=h,s=J,u=ve,D=fe,V=Ie,A=ke,R=we,E=_e,B=X,M=pe,K=ge,ee=S,te=he,ae=me,re=ce,ie=U,oe=ue,ne=se;return z(),d("div",Le,[c("div",Fe,[c("h3",null,p(f(a)("rfq.quotes.comparison")),1),m(r,{type:"info"},{default:v(()=>[y(p(f(a)("rfq.quotes.totalQuotes",{count:e.quotes.length})),1)]),_:1})]),0===e.quotes.length?(z(),d("div",Ee,[m(i,{description:f(a)("rfq.quotes.noQuotes")},null,8,["description"])])):(z(),d("div",Qe,[c("div",We,[c("div",Oe,[c("div",Ye,[m(n,{type:"primary",text:"",onClick:t[0]||(t[0]=e=>O.value=!0)},{default:v(()=>[y(p(f(a)("rfq.quoteComparison.viewDetails"))+" ",1),m(o,null,{default:v(()=>[m(f(_))]),_:1})]),_:1})]),c("div",Be,[(z(!0),d(w,null,k(e.quotes,e=>(z(),d("div",{key:e.id,class:I(["supplier-card",{selected:W.value===e.id,"has-special-tariff":$e.value[e.id]?.hasSpecialTariff}]),onClick:l=>{return t=e.id,void(W.value=t);var t}},[c("div",{class:"company-name",title:e.companyName||e.supplierName},p(e.companyName||e.supplierName),9,He),c("div",Ge,[e.quoteItems&&e.quoteItems[0]?(z(),d(w,{key:0},[null!==e.quoteItems[0].standardUnitCostLocal&&void 0!==e.quoteItems[0].standardUnitCostLocal?(z(),d(w,{key:0},[y(p(Bt(e.quoteItems[0].standardUnitCostLocal,e.quoteItems[0].currency||"CNY",e.quoteItems[0].unit||"EA")),1)],64)):null!==e.quoteItems[0].standardUnitCostUsd&&void 0!==e.quoteItems[0].standardUnitCostUsd?(z(),d(w,{key:1},[y(p(Bt(e.quoteItems[0].standardUnitCostUsd,"USD",e.quoteItems[0].unit||"EA")),1)],64)):(z(),d(w,{key:2},[y(p(Bt(e.quoteItems[0].unitPrice,e.quoteItems[0].currency||"CNY",e.quoteItems[0].unit||"EA")),1)],64))],64)):(z(),d(w,{key:1},[y(p(Bt(le(e),e.currency||"CNY",Mt(e))),1)],64))]),c("div",{class:I(["radio-dot",{selected:W.value===e.id}])},null,2),$e.value[e.id]?.hasSpecialTariff?(z(),C(s,{key:0,type:"warning",size:"small",class:"tariff-badge"},{default:v(()=>[y(p(f(a)("rfq.quote.specialTariffTag")),1)]),_:1})):q("",!0)],10,Me))),128))])])]),b(m(D,{data:e.quotes,style:{width:"100%"},"row-class-name":Et,onRowClick:Qt},{default:v(()=>[e.selectable?(z(),C(u,{key:0,type:"selection",width:"55"})):q("",!0),m(u,{label:f(a)("supplier.companyName"),"min-width":"180"},{default:v(({row:e})=>[c("div",Ke,[c("strong",null,p(e.companyName),1),"selected"===e.status?(z(),C(s,{key:0,type:"success",size:"small",style:{"margin-left":"8px"}},{default:v(()=>[y(p(f(a)("rfq.quotes.selected")),1)]),_:1})):q("",!0)])]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.unitPrice"),width:"150",sortable:""},{default:v(({row:e})=>[c("div",Ze,[c("strong",null,p(Dt(le(e),e.currency||"CNY")),1),null!==le(e)&&null!==ye.value&&le(e)===ye.value?(z(),C(s,{key:0,type:"success",size:"small",effect:"dark"},{default:v(()=>[y(p(f(a)("rfq.quotes.lowest")),1)]),_:1})):q("",!0)])]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.totalAmount"),width:"150",sortable:""},{default:v(({row:e})=>[y(p(Dt(e.totalAmount,e.currency||"CNY")),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.standardCost"),width:"220",sortable:""},{default:v(({row:e})=>[null!==$e.value[e.id]?.total.amount?(z(),d("div",Je,[c("strong",null,p(Dt($e.value[e.id]?.total.amount??null,$e.value[e.id]?.total.currency||"USD")),1),$e.value[e.id]?.hasSpecialTariff?(z(),C(s,{key:0,type:"warning",size:"small",effect:"dark"},{default:v(()=>[y(p(f(a)("rfq.quote.specialTariffTag")),1)]),_:1})):q("",!0),c("div",Xe,p(f(a)("rfq.quotes.unitStandardCost",{value:Dt($e.value[e.id]?.unit.amount??null,$e.value[e.id]?.unit.currency||"USD")})),1)])):(z(),d("div",el,[...t[17]||(t[17]=[c("span",null,"-",-1)])]))]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.brand"),width:"120"},{default:v(({row:e})=>[y(p(Lt(e)),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.taxStatus"),width:"110"},{default:v(({row:e})=>[m(s,{type:"inclusive"===Ht(e)?"success":"warning",size:"small"},{default:v(()=>[y(p(f(a)(`rfq.taxStatus.${Ht(e)||"inclusive"}`)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.version"),width:"100",align:"center"},{default:v(({row:e})=>[e.version>1?(z(),C(r,{key:0,type:"warning",size:"small"},{default:v(()=>[y(" v"+p(e.version)+" ("+p(e.modifiedCount)+" "+p(f(a)("rfq.quotes.modifications"))+") ",1)]),_:2},1024)):(z(),C(r,{key:1,type:"info",size:"small"},{default:v(()=>[...t[18]||(t[18]=[y(" v1 ",-1)])]),_:1}))]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.deliveryDate"),width:"140"},{default:v(({row:e})=>[y(p(zt(e.deliveryDate)),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.paymentTerms"),width:"150"},{default:v(({row:e})=>[y(p(e.paymentTerms||"-"),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.status"),width:"120"},{default:v(({row:e})=>{return[m(s,{type:(l=e.status,{submitted:"info",under_review:"warning",selected:"success",rejected:"danger",withdrawn:"info"}[l]||"info"),size:"small"},{default:v(()=>[y(p(f(a)(`rfq.quoteStatus.${e.status}`)),1)]),_:2},1032,["type"])];var l}),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.submittedAt"),width:"160"},{default:v(({row:e})=>[y(p(Vt(e.submittedAt)),1)]),_:1},8,["label"]),m(u,{label:f(a)("common.actions"),width:"200",align:"center",fixed:"right"},{default:v(({row:e})=>[m(n,{type:"primary",size:"small",link:"",onClick:N(l=>Wt(e),["stop"])},{default:v(()=>[y(p(f(a)("common.view")),1)]),_:1},8,["onClick"]),m(n,{type:"info",size:"small",link:"",onClick:N(l=>{return t=e,F.value=t,void(L.value=!0);var t},["stop"])},{default:v(()=>[y(p(f(a)("rfq.quotes.viewSupplierProfile")),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"]),[[$,!1]]),c("div",ll,[m(R,{gutter:16},{default:v(()=>[m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",tl,[c("div",al,p(f(a)("rfq.quotes.lowestPrice")),1),c("div",rl,p(null!==ye.value?Dt(ye.value,"CNY"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",il,[c("div",ol,p(f(a)("rfq.quotes.highestPrice")),1),c("div",nl,p(null!==be.value?Dt(be.value,"CNY"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",sl,[c("div",ul,p(f(a)("rfq.quotes.averagePrice")),1),c("div",dl,p(null!==qe.value?Dt(qe.value,"CNY"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",cl,[c("div",ml,p(f(a)("rfq.quotes.priceRange")),1),c("div",pl,p(Tt(Ne.value)),1)])]),_:1})]),_:1})]),_:1}),m(R,{gutter:16,style:{"margin-top":"16px"}},{default:v(()=>[m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",fl,[c("div",vl,p(f(a)("rfq.quotes.lowestStandardCost")),1),c("div",yl,p(null!==Ue.value?Dt(Ue.value,"USD"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",bl,[c("div",ql,p(f(a)("rfq.quotes.highestStandardCost")),1),c("div",hl,p(null!==Pe.value?Dt(Pe.value,"USD"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",gl,[c("div",_l,p(f(a)("rfq.quotes.averageStandardCost")),1),c("div",wl,p(null!==xe.value?Dt(xe.value,"USD"):"-"),1)])]),_:1})]),_:1}),m(A,{span:6},{default:v(()=>[m(V,{shadow:"hover"},{default:v(()=>[c("div",kl,[c("div",Il,p(f(a)("rfq.quotes.specialTariffCount")),1),c("div",Cl,p(ze.value),1)])]),_:1})]),_:1})]),_:1})]),Ve.value.length>0?(z(),d("div",Nl,[m(E,{"content-position":"left"},{default:v(()=>[c("span",$l,p(f(a)("rfq.priceComparison.standardCostComparison")),1),c("span",Sl,"("+p(f(a)("rfq.priceComparison.sortedByStandardCost"))+")",1)]),_:1}),c("div",Ul,[(z(!0),d(w,null,k(Ve.value,(e,l)=>(z(),d("div",{key:e.id,class:I(["cost-card",{recommended:0===l}])},[0===l?(z(),C(s,{key:0,type:"success",size:"small",class:"recommend-tag"},{default:v(()=>[y(p(f(a)("rfq.priceComparison.recommended")),1)]),_:1})):q("",!0),c("div",Pl,p(e.companyName||e.supplierName),1),c("div",xl,[c("div",Dl,p(Ae(e,"USD")),1),c("div",zl,"("+p(Ae(e,"local"))+")",1)]),m(n,{type:"primary",size:"small",onClick:l=>(e=>{Te.value=e,Re.value=!0})(e)},{default:v(()=>[y(p(f(a)("rfq.priceComparison.viewDetail")),1)]),_:1},8,["onClick"])],2))),128))])])):q("",!0),G.value?(z(),d("div",Vl,[m(E,{"content-position":"left"},{default:v(()=>[c("span",Al,p(f(a)("rfq.priceComparison.title")),1)]),_:1}),m(B,{title:f(a)("rfq.priceComparison.alert"),type:"info",closable:!1,style:{"margin-bottom":"20px"}},null,8,["title"]),m(R,{gutter:20},{default:v(()=>[m(A,{span:8},{default:v(()=>[m(V,{shadow:"hover",class:I({"uploaded-card":Y[1688].uploaded})},{header:v(()=>[c("div",Rl,[c("span",Tl,p(f(a)("rfq.priceComparison.1688")),1),Y[1688].uploaded?(z(),C(s,{key:0,type:"success",size:"small"},{default:v(()=>[y(p(f(a)("rfq.priceComparison.uploaded")),1)]),_:1})):q("",!0)])]),default:v(()=>[Y[1688].records.length?(z(),d("div",jl,[(z(!0),d(w,null,k(Y[1688].records,(e,l)=>(z(),d("div",{key:"1688-"+(e.id??e.fileName??l),class:"uploaded-item"},[e.downloadUrl?(z(),C(M,{key:0,href:String(e.downloadUrl),target:"_blank",underline:!1},{default:v(()=>[y(p(e.fileName||f(a)("rfq.priceComparison.screenshot")),1)]),_:2},1032,["href"])):(z(),d("span",Ll,p(e.fileName||f(a)("rfq.priceComparison.screenshot")),1)),c("div",Fl,[null!==e.platformPrice&&void 0!==e.platformPrice?(z(),d("span",El,p(f(a)("rfq.priceComparison.pricePlaceholder"))+": "+p(Dt(e.platformPrice,"CNY")),1)):q("",!0),e.productUrl?(z(),C(M,{key:1,href:String(e.productUrl),target:"_blank",type:"primary",underline:!1},{default:v(()=>[y(p(f(a)("rfq.priceComparison.urlPlaceholder")),1)]),_:1},8,["href"])):q("",!0)]),e.uploadedAt?(z(),d("div",Ql,p(Vt(String(e.uploadedAt))),1)):q("",!0)]))),128))])):q("",!0),m(te,{"label-position":"top",size:"small"},{default:v(()=>[m(K,{label:f(a)("rfq.priceComparison.screenshot")},{default:v(()=>[c("input",{type:"file",accept:"image/*",onChange:t[1]||(t[1]=e=>Gt("1688",e)),disabled:Y[1688].uploaded,style:{width:"100%"}},null,40,Wl),Y[1688].file?(z(),d("div",Ol,p(Y[1688].file?.name),1)):q("",!0)]),_:1},8,["label"]),m(K,{label:f(a)("rfq.priceComparison.urlPlaceholder")},{default:v(()=>[m(ee,{modelValue:Y[1688].url,"onUpdate:modelValue":t[2]||(t[2]=e=>Y[1688].url=e),placeholder:f(a)("rfq.priceComparison.urlPlaceholder"),disabled:Y[1688].uploaded},null,8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),m(K,{label:f(a)("rfq.priceComparison.pricePlaceholder")},{default:v(()=>[m(ee,{modelValue:Y[1688].price,"onUpdate:modelValue":t[3]||(t[3]=e=>Y[1688].price=e),modelModifiers:{number:!0},type:"number",placeholder:f(a)("rfq.priceComparison.pricePlaceholder"),disabled:Y[1688].uploaded},{prepend:v(()=>[...t[19]||(t[19]=[y("��",-1)])]),_:1},8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),Y[1688].uploaded?q("",!0):(z(),C(n,{key:0,type:"primary",size:"small",onClick:t[4]||(t[4]=e=>Kt("1688")),loading:H.value,disabled:!Y[1688].file||!Y[1688].url||null===Y[1688].price,style:{width:"100%"}},{default:v(()=>[y(p(f(a)("rfq.priceComparison.upload")),1)]),_:1},8,["loading","disabled"]))]),_:1})]),_:1},8,["class"])]),_:1}),m(A,{span:8},{default:v(()=>[m(V,{shadow:"hover",class:I({"uploaded-card":Y.jd.uploaded})},{header:v(()=>[c("div",Yl,[c("span",Bl,p(f(a)("rfq.priceComparison.jd")),1),Y.jd.uploaded?(z(),C(s,{key:0,type:"success",size:"small"},{default:v(()=>[y(p(f(a)("rfq.priceComparison.uploaded")),1)]),_:1})):q("",!0)])]),default:v(()=>[Y.jd.records.length?(z(),d("div",Ml,[(z(!0),d(w,null,k(Y.jd.records,(e,l)=>(z(),d("div",{key:"jd-"+(e.id??e.fileName??l),class:"uploaded-item"},[e.downloadUrl?(z(),C(M,{key:0,href:String(e.downloadUrl),target:"_blank",underline:!1},{default:v(()=>[y(p(e.fileName||f(a)("rfq.priceComparison.screenshot")),1)]),_:2},1032,["href"])):(z(),d("span",Hl,p(e.fileName||f(a)("rfq.priceComparison.screenshot")),1)),c("div",Gl,[null!==e.platformPrice&&void 0!==e.platformPrice?(z(),d("span",Kl,p(f(a)("rfq.priceComparison.pricePlaceholder"))+": "+p(Dt(e.platformPrice,"CNY")),1)):q("",!0),e.productUrl?(z(),C(M,{key:1,href:String(e.productUrl),target:"_blank",type:"primary",underline:!1},{default:v(()=>[y(p(f(a)("rfq.priceComparison.urlPlaceholder")),1)]),_:1},8,["href"])):q("",!0)]),e.uploadedAt?(z(),d("div",Zl,p(Vt(String(e.uploadedAt))),1)):q("",!0)]))),128))])):q("",!0),m(te,{"label-position":"top",size:"small"},{default:v(()=>[m(K,{label:f(a)("rfq.priceComparison.screenshot")},{default:v(()=>[c("input",{type:"file",accept:"image/*",onChange:t[5]||(t[5]=e=>Gt("jd",e)),disabled:Y.jd.uploaded,style:{width:"100%"}},null,40,Jl),Y.jd.file?(z(),d("div",Xl,p(Y.jd.file?.name),1)):q("",!0)]),_:1},8,["label"]),m(K,{label:f(a)("rfq.priceComparison.urlPlaceholder")},{default:v(()=>[m(ee,{modelValue:Y.jd.url,"onUpdate:modelValue":t[6]||(t[6]=e=>Y.jd.url=e),placeholder:f(a)("rfq.priceComparison.urlPlaceholder"),disabled:Y.jd.uploaded},null,8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),m(K,{label:f(a)("rfq.priceComparison.pricePlaceholder")},{default:v(()=>[m(ee,{modelValue:Y.jd.price,"onUpdate:modelValue":t[7]||(t[7]=e=>Y.jd.price=e),modelModifiers:{number:!0},type:"number",placeholder:f(a)("rfq.priceComparison.pricePlaceholder"),disabled:Y.jd.uploaded},{prepend:v(()=>[...t[20]||(t[20]=[y("��",-1)])]),_:1},8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),Y.jd.uploaded?q("",!0):(z(),C(n,{key:0,type:"primary",size:"small",onClick:t[8]||(t[8]=e=>Kt("jd")),loading:H.value,disabled:!Y.jd.file||!Y.jd.url||null===Y.jd.price,style:{width:"100%"}},{default:v(()=>[y(p(f(a)("rfq.priceComparison.upload")),1)]),_:1},8,["loading","disabled"]))]),_:1})]),_:1},8,["class"])]),_:1}),m(A,{span:8},{default:v(()=>[m(V,{shadow:"hover",class:I({"uploaded-card":Y.zkh.uploaded})},{header:v(()=>[c("div",et,[c("span",lt,p(f(a)("rfq.priceComparison.zkh")),1),Y.zkh.uploaded?(z(),C(s,{key:0,type:"success",size:"small"},{default:v(()=>[y(p(f(a)("rfq.priceComparison.uploaded")),1)]),_:1})):q("",!0)])]),default:v(()=>[Y.zkh.records.length?(z(),d("div",tt,[(z(!0),d(w,null,k(Y.zkh.records,(e,l)=>(z(),d("div",{key:"zkh-"+(e.id??e.fileName??l),class:"uploaded-item"},[e.downloadUrl?(z(),C(M,{key:0,href:String(e.downloadUrl),target:"_blank",underline:!1},{default:v(()=>[y(p(e.fileName||f(a)("rfq.priceComparison.screenshot")),1)]),_:2},1032,["href"])):(z(),d("span",at,p(e.fileName||f(a)("rfq.priceComparison.screenshot")),1)),c("div",rt,[null!==e.platformPrice&&void 0!==e.platformPrice?(z(),d("span",it,p(f(a)("rfq.priceComparison.pricePlaceholder"))+": "+p(Dt(e.platformPrice,"CNY")),1)):q("",!0),e.productUrl?(z(),C(M,{key:1,href:String(e.productUrl),target:"_blank",type:"primary",underline:!1},{default:v(()=>[y(p(f(a)("rfq.priceComparison.urlPlaceholder")),1)]),_:1},8,["href"])):q("",!0)]),e.uploadedAt?(z(),d("div",ot,p(Vt(String(e.uploadedAt))),1)):q("",!0)]))),128))])):q("",!0),m(te,{"label-position":"top",size:"small"},{default:v(()=>[m(K,{label:f(a)("rfq.priceComparison.screenshot")},{default:v(()=>[c("input",{type:"file",accept:"image/*",onChange:t[9]||(t[9]=e=>Gt("zkh",e)),disabled:Y.zkh.uploaded,style:{width:"100%"}},null,40,nt),Y.zkh.file?(z(),d("div",st,p(Y.zkh.file?.name),1)):q("",!0)]),_:1},8,["label"]),m(K,{label:f(a)("rfq.priceComparison.urlPlaceholder")},{default:v(()=>[m(ee,{modelValue:Y.zkh.url,"onUpdate:modelValue":t[10]||(t[10]=e=>Y.zkh.url=e),placeholder:f(a)("rfq.priceComparison.urlPlaceholder"),disabled:Y.zkh.uploaded},null,8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),m(K,{label:f(a)("rfq.priceComparison.pricePlaceholder")},{default:v(()=>[m(ee,{modelValue:Y.zkh.price,"onUpdate:modelValue":t[11]||(t[11]=e=>Y.zkh.price=e),modelModifiers:{number:!0},type:"number",placeholder:f(a)("rfq.priceComparison.pricePlaceholder"),disabled:Y.zkh.uploaded},{prepend:v(()=>[...t[21]||(t[21]=[y("��",-1)])]),_:1},8,["modelValue","placeholder","disabled"])]),_:1},8,["label"]),Y.zkh.uploaded?q("",!0):(z(),C(n,{key:0,type:"primary",size:"small",onClick:t[12]||(t[12]=e=>Kt("zkh")),loading:H.value,disabled:!Y.zkh.file||!Y.zkh.url||null===Y.zkh.price,style:{width:"100%"}},{default:v(()=>[y(p(f(a)("rfq.priceComparison.upload")),1)]),_:1},8,["loading","disabled"]))]),_:1})]),_:1},8,["class"])]),_:1})]),_:1})])):q("",!0)])),m(ie,{modelValue:T.value,"onUpdate:modelValue":t[13]||(t[13]=e=>T.value=e),title:f(a)("rfq.quotes.quoteDetail"),width:"600px"},{default:v(()=>[j.value?(z(),d("div",ut,[m(re,{column:1,border:""},{default:v(()=>[m(ae,{label:f(a)("supplier.companyName")},{default:v(()=>[y(p(j.value.companyName),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.unitPrice")},{default:v(()=>[y(p(Dt(j.value.unitPrice,j.value.currency||"CNY")),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.totalAmount")},{default:v(()=>[y(p(Dt(j.value.totalAmount,j.value.currency||"CNY")),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.brand")},{default:v(()=>[y(p(Lt(j.value)),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.taxStatus")},{default:v(()=>[m(s,{type:"inclusive"===Ht(j.value)?"success":"warning",size:"small"},{default:v(()=>[y(p(f(a)(`rfq.taxStatus.${Ht(j.value)||"inclusive"}`)),1)]),_:1},8,["type"])]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.parameters")},{default:v(()=>[j.value.parameters?(z(),d("pre",dt,p(j.value.parameters),1)):(z(),d("span",ct,"-"))]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.optionalConfig")},{default:v(()=>[j.value.optionalConfig?(z(),d("pre",mt,p(j.value.optionalConfig),1)):(z(),d("span",pt,"-"))]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.deliveryDate")},{default:v(()=>[y(p(zt(j.value.deliveryDate)),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.paymentTerms")},{default:v(()=>[y(p(j.value.paymentTerms||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quote.deliveryTerms")},{default:v(()=>[y(p(j.value.deliveryTerms||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quote.shippingCountry")},{default:v(()=>[y(p(j.value.shippingCountry||j.value.shipping_country||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quote.shippingLocation")},{default:v(()=>[y(p(j.value.shippingLocation||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.version")},{default:v(()=>[c("div",null,[m(r,{type:"primary"},{default:v(()=>[y("v"+p(j.value.version||1),1)]),_:1}),(j.value.modifiedCount||0)>0?(z(),C(r,{key:0,type:"info",size:"small",style:{"margin-left":"8px"}},{default:v(()=>[y(" ("+p(j.value.modifiedCount)+" "+p(f(a)("rfq.quotes.modifications"))+") ",1)]),_:1})):q("",!0)])]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.submittedAt")},{default:v(()=>[y(p(Vt(j.value.submittedAt)),1)]),_:1},8,["label"]),m(ae,{label:f(a)("rfq.quotes.notes")},{default:v(()=>[y(p(j.value.notes||"-"),1)]),_:1},8,["label"])]),_:1}),Rt.value.length?(z(),C(D,{key:0,data:Rt.value,border:"",size:"small",style:{"margin-top":"16px"}},{default:v(()=>[m(u,{type:"index",width:"60"}),m(u,{label:f(a)("rfq.quote.summaryColumns.item"),"min-width":"160"},{default:v(({row:e})=>[c("div",ft,p(e.itemName),1),e.specifications?(z(),d("div",vt,p(e.specifications),1)):q("",!0)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quote.summaryColumns.quantity"),width:"140"},{default:v(({row:e})=>[y(p(e.quantityLabel),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quote.summaryColumns.brand"),width:"160"},{default:v(({row:e})=>[y(p(e.brandLabel||"-"),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quote.productGroupLabel"),width:"160"},{default:v(({row:e})=>[y(p(e.productGroup||"-"),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quote.productOriginLabel"),width:"160"},{default:v(({row:e})=>[y(p(e.productOrigin||"-"),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quote.summaryColumns.unitPrice"),width:"150"},{default:v(({row:e})=>[y(p(Dt(e.unitPrice,j.value?.currency||"CNY")),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quote.summaryColumns.totalPrice"),width:"150"},{default:v(({row:e})=>[y(p(Dt(e.totalPrice,j.value?.currency||"CNY")),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quote.standardUnitCost"),width:"180"},{default:v(({row:e})=>[null!==e.standardUnitCost?(z(),d("div",yt,[c("div",bt,[y(p(Dt(e.standardUnitCost,e.standardUnitCostCurrency||"USD"))+" ",1),e.hasSpecialTariff?(z(),C(s,{key:0,type:"warning",size:"small",effect:"dark",style:{"margin-left":"8px"}},{default:v(()=>[y(p(f(a)("rfq.quote.specialTariffTag")),1)]),_:1})):q("",!0)]),null!==e.tariffRate?(z(),d("div",qt,p(f(a)("rfq.quote.tariffRateLabel",{rate:jt(e.tariffRate)})),1)):q("",!0),null!==e.specialTariffRate?(z(),d("div",ht,p(f(a)("rfq.quote.specialTariffRateLabel",{rate:jt(e.specialTariffRate)})),1)):q("",!0)])):(z(),d("span",gt,"-"))]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quote.standardLineTotalColumn"),width:"180"},{default:v(({row:e})=>[null!==e.standardLineTotal?(z(),d("span",_t,p(Dt(e.standardLineTotal,e.standardUnitCostCurrency||"USD")),1)):(z(),d("span",wt,"-"))]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quote.deliveryDate"),width:"160"},{default:v(({row:e})=>[y(p(zt(e.deliveryDate)),1)]),_:1},8,["label"])]),_:1},8,["data"])):(z(),C(B,{key:1,title:f(a)("rfq.quotes.noLineItems"),type:"info",closable:!1,style:{"margin-top":"16px"}},null,8,["title"])),m(E,{"content-position":"left"},{default:v(()=>[y(p(f(a)("rfq.quotes.attachments")),1)]),_:1}),Q.value.length?(z(),d("div",kt,[m(D,{data:Q.value,border:"",size:"small"},{default:v(()=>[m(u,{label:f(a)("rfq.quotes.fileName"),"min-width":"220"},{default:v(({row:e})=>[e.downloadUrl?(z(),C(M,{key:0,href:e.downloadUrl,type:"primary",target:"_blank",download:""},{default:v(()=>[y(p(e.originalName||e.storedName||"-"),1)]),_:2},1032,["href"])):(z(),d("span",It,p(e.originalName||e.storedName||"-"),1))]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.fileSize"),width:"130"},{default:v(({row:e})=>[y(p(Ft(e.fileSize)),1)]),_:1},8,["label"]),m(u,{label:f(a)("rfq.quotes.uploadedAt"),width:"180"},{default:v(({row:e})=>[y(p(Vt(e.uploadedAt??null)),1)]),_:1},8,["label"])]),_:1},8,["data"])])):(z(),C(B,{key:3,title:f(a)("rfq.quotes.noAttachments"),type:"info",closable:!1},null,8,["title"]))])):q("",!0)]),_:1},8,["modelValue","title"]),m(ie,{modelValue:L.value,"onUpdate:modelValue":t[14]||(t[14]=e=>L.value=e),title:f(a)("rfq.quotes.supplierProfile"),width:"700px"},{default:v(()=>[F.value?(z(),d("div",Ct,[m(ne,{type:"border-card"},{default:v(()=>[m(oe,{label:f(a)("rfq.quotes.basicInfo")},{default:v(()=>[m(re,{column:2,border:""},{default:v(()=>[m(ae,{label:f(a)("supplier.companyName")},{default:v(()=>[y(p(F.value.companyName),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.companyId")},{default:v(()=>[y(p(F.value.companyId||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.stage")},{default:v(()=>[m(s,{type:"formal"===F.value.stage?"success":"warning"},{default:v(()=>[y(p(f(a)(`supplier.stages.${F.value.stage??"null"}`)),1)]),_:1},8,["type"])]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.category")},{default:v(()=>[y(p(F.value.category||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.region")},{default:v(()=>[y(p(F.value.region||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.address")},{default:v(()=>[y(p(F.value.address||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(oe,{label:f(a)("rfq.quotes.financialInfo")},{default:v(()=>[m(re,{column:2,border:""},{default:v(()=>[m(ae,{label:f(a)("supplier.registeredCapital")},{default:v(()=>[F.value.registeredCapital?(z(),C(r,{key:0,type:"primary",size:"large"},{default:v(()=>[y(p(Dt(F.value.registeredCapital,"CNY")),1)]),_:1})):(z(),d("span",Nt,"-"))]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.registrationDate")},{default:v(()=>[y(p(F.value.registrationDate?zt(F.value.registrationDate):"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.paymentTerms")},{default:v(()=>[y(p(F.value.paymentTerms||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.paymentCurrency")},{default:v(()=>[y(p(F.value.paymentCurrency||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.bankName")},{default:v(()=>[y(p(F.value.bankName||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.bankAccount")},{default:v(()=>[y(p(F.value.bankAccount||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.taxRegistrationNumber")},{default:v(()=>[y(p(F.value.taxRegistrationNumber||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(oe,{label:f(a)("rfq.quotes.legalInfo")},{default:v(()=>[m(re,{column:2,border:""},{default:v(()=>[m(ae,{label:f(a)("supplier.businessRegistrationNumber")},{default:v(()=>[m(r,{type:"primary"},{default:v(()=>[y(p(F.value.businessRegistrationNumber||"-"),1)]),_:1})]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.legalRepresentative")},{default:v(()=>[y(p(F.value.legalRepresentative||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(oe,{label:f(a)("rfq.quotes.contactInfo")},{default:v(()=>[m(re,{column:2,border:""},{default:v(()=>[m(ae,{label:f(a)("supplier.contactPerson")},{default:v(()=>[y(p(F.value.contactPerson||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.contactPhone")},{default:v(()=>[y(p(F.value.contactPhone||"-"),1)]),_:1},8,["label"]),m(ae,{label:f(a)("supplier.contactEmail"),span:2},{default:v(()=>[y(p(F.value.contactEmail||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),F.value.supplierDocuments?.length?(z(),C(oe,{key:0,label:f(a)("rfq.quotes.documentsInfo")},{default:v(()=>[m(D,{data:F.value.supplierDocuments,border:""},{default:v(()=>[m(u,{label:f(a)("supplier.documentCategory"),width:"180"},{default:v(({row:e})=>[m(s,{size:"small"},{default:v(()=>[y(p(f(a)(`supplier.documentCategories.${e.category}`)),1)]),_:2},1024)]),_:1},8,["label"]),m(u,{label:f(a)("supplier.fileName"),prop:"file_name"},null,8,["label"]),m(u,{label:f(a)("supplier.uploadedAt"),width:"160"},{default:v(({row:e})=>[y(p(zt(e.uploaded_at)),1)]),_:1},8,["label"]),m(u,{label:f(a)("supplier.expiryDate"),width:"120"},{default:v(({row:e})=>[e.expiry_date?(z(),d("span",$t,p(zt(e.expiry_date)),1)):(z(),d("span",St,"-"))]),_:1},8,["label"]),m(u,{label:f(a)("supplier.verified"),width:"100",align:"center"},{default:v(({row:e})=>[e.verified?(z(),C(o,{key:0,color:"green",size:"20"},{default:v(()=>[(z(),C(P("CircleCheck")))]),_:1})):(z(),C(o,{key:1,color:"gray",size:"20"},{default:v(()=>[(z(),C(P("Clock")))]),_:1}))]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["label"])):q("",!0)]),_:1})])):q("",!0)]),_:1},8,["modelValue","title"]),m(ie,{modelValue:O.value,"onUpdate:modelValue":t[16]||(t[16]=e=>O.value=e),title:f(a)("rfq.quoteComparison.detailDialogTitle"),width:"1200px","close-on-click-modal":!1,class:"quote-detail-comparison-dialog"},{footer:v(()=>[m(n,{onClick:t[15]||(t[15]=e=>O.value=!1)},{default:v(()=>[y(p(f(a)("common.close")),1)]),_:1})]),default:v(()=>[m(D,{data:Ot.value,border:"",stripe:""},{default:v(()=>[m(u,{label:f(a)("rfq.quoteComparison.comparisonField"),prop:"field",width:"160",fixed:""},{default:v(({row:e})=>[c("strong",null,p(f(a)(e.field)),1)]),_:1},8,["label"]),(z(!0),d(w,null,k(e.quotes,e=>(z(),C(u,{key:e.id,align:"center","min-width":"150"},{header:v(()=>[m(M,{type:"primary",underline:!1,class:"supplier-name-link",onClick:N(l=>(e=>{F.value=e,L.value=!0})(e),["stop"])},{default:v(()=>[y(p(e.companyName||e.supplierName)+" ",1),m(o,{class:"link-icon"},{default:v(()=>[m(f(x))]),_:1})]),_:2},1032,["onClick"])]),default:v(({row:l})=>["quoteAttachments"===l.key?(z(),d("div",Ut,[l.values[e.id]&&l.values[e.id].length?(z(!0),d(w,{key:0},k(l.values[e.id],e=>(z(),d("div",{key:e.id||e.storedName||e.originalName||e.downloadUrl},[e.downloadUrl?(z(),C(M,{key:0,href:e.downloadUrl,target:"_blank",underline:!1,download:e.originalName||e.storedName||""},{default:v(()=>[y(p(e.originalName||e.storedName||"-"),1)]),_:2},1032,["href","download"])):(z(),d("span",Pt,p(e.originalName||e.storedName||"-"),1))]))),128)):(z(),d("span",xt,"-"))])):(z(),d("div",{key:1,class:I({"best-value":l.bestQuoteId===e.id})},p(l.values[e.id]),3))]),_:2},1024))),128))]),_:1},8,["data"])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-fbec7fca"]]),zt={class:"price-comparison-section"},Vt={class:"section-header"},At={class:"item-name"},Rt={key:0,class:"brand"},Tt={class:"specifications"},jt={key:1},Lt={key:0,class:"quote-comparison"},Ft={class:"quote-header"},Et={class:"quote-count"},Qt={class:"quote-cards-wrapper"},Wt={class:"detail-button-container"},Ot={class:"supplier-cards-grid"},Yt=["onClick"],Bt={class:"card-header"},Mt={class:"supplier-avatar"},Ht={class:"supplier-info"},Gt=["title"],Kt={class:"tag-row"},Zt={class:"price-highlight"},Jt={class:"price-value"},Xt={class:"price-sub"},ea={class:"moq-chip"},la={class:"meta-label"},ta={class:"meta-value"},aa={class:"card-footer"},ra={class:"selection-hint"},ia={key:0,class:"dialog-header-info"},oa={style:{color:"#409eff"}},na={key:0},sa={key:1},ua={key:0,class:"quote-attachments-cell"},da=["title"],ca={key:1},ma={key:0,class:"supplier-profile"},pa={key:1},fa={key:0},va={key:1},ya=V(i({__name:"RfqPriceComparisonSection",props:{rfq:{},lineItems:{},quotes:{},selectedLineItemId:{},userRole:{}},emits:["selectItem","selectQuote"],setup(e,{emit:l}){const a=e,r=l,{t:i}=o(),s=n(!1),b=n(!1),$=n(null),S=n(!1),P=n(null),D=t(()=>$.value?[$.value]:[]),V={CNY:"¥",USD:"$",EUR:"€",JPY:"¥",THB:"฿"},L=new Intl.NumberFormat("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),F=new Intl.NumberFormat("zh-CN",{maximumFractionDigits:0}),E={pending_director:"procurement_director",pending_po:"purchaser"};function Q(e){if(e.currentApproverRole){const l=`common.roles.${e.currentApproverRole}`;return i(l)}const l=e.status??"",t=E[l];return t?i(`common.roles.${t}`):"completed"===e.status?i("common.completed"):"draft"===e.status||"rejected"===e.status?i("common.roles.purchaser"):"-"}const W=t(()=>a.selectedLineItemId?a.lineItems.find(e=>e.id===a.selectedLineItemId):null),O=t(()=>W.value?.selectedQuoteId??null),Y=n(O.value),B=(...e)=>{for(const l of e){if(null==l||""===l)continue;const e=Number(l);if(!Number.isNaN(e))return e}return null},M=e=>{if(null==e||""===e)return null;const l=Number(e);return Number.isFinite(l)?l:null},H=e=>{if(null==e||""===e)return null;if("string"==typeof e){const l=e.replace("%","").trim();if(!l.length)return null;const t=Number(l);return Number.isNaN(t)?null:t/100}const l=Number(e);return Number.isNaN(l)?null:l},G=e=>e&&"object"==typeof e?e:null,K=(e,l)=>{const t=e.tariffCalculation??null,a=((e,l)=>{const t=e.tariffCalculation??null,a=G(t),r=M(t?.standardCostUsd??e.standardUnitCostUsd??e.standardCostUsd??e.standard_unit_cost_usd);if(null!==r)return r;const i=M(t?.standardCostLocal??e.standardUnitCostLocal??e.standardCostLocal??e.standard_unit_cost_local),o=M(t?.exchangeRate??e.exchangeRate??l.exchangeRate);if(null!==i&&null!==o&&o>0)return i*o;const n=M(e.unitPrice??e.standardUnitCost??e.standardUnitCostLocal??l.unitPrice??l.unit_price);if(null===n||null===o||o<=0)return null;const s=1+(H(a?.freightRate??a?.freight_rate??a?.tariffRate??e.freightRate??e.freight_rate??l.freightRate??l.freight_rate)??0)+(H(a?.specialTariffRate??a?.special_tariff_rate??e.specialTariffRate??e.special_tariff_rate??l.special_tariff_rate)??0);return s<=0?null:n*o*s})(e,l);if(null!==a)return{amount:Number(a),currency:"USD"};const r=[{amount:t?.standardCost,currency:t?.standardCostCurrency||"USD"},{amount:e.standardUnitCostLocal,currency:e.currency},{amount:e.standardUnitCost,currency:e.currency},{amount:e.unitPrice,currency:e.currency},{amount:l.unitPrice,currency:l.currency}];for(const i of r)if(void 0!==i.amount&&null!==i.amount&&""!==i.amount){const e=Number(i.amount);if(Number.isNaN(e))continue;return{amount:e,currency:i.currency||"USD"}}return{amount:null,currency:"USD"}};u(O,e=>{Y.value=e??null},{immediate:!0});const X=t(()=>{if(!W.value)return!1;if("procurement_director"===a.userRole)return!0;const e=W.value.status??"";return!["draft","rejected"].includes(e)});const ee=t(()=>{if(!W.value)return[];const e=a.quotes.map(e=>{const l=e.quoteItems?.find(e=>e.rfqLineItemId===W.value?.id);if(!l)return null;const t=l.tariffCalculation??null,a=G(t),{amount:r,currency:i}=K(l,e),o=W.value?.unit||"EA",n=B(l.totalAmount,l.totalPrice,e.totalAmount),s=B(M(a?.freightAmount),M(a?.shippingFee),M(a?.freightCost),l.freightAmount,l.shippingFee,l.shipping_fee,e.freightAmount,e.shippingFee,e.shipping_fee),u=B(M(a?.specialTariffRate),l.specialTariffRate,e.special_tariff_rate),d=H(a?.freightRate)??H(a?.freight_rate)??H(l.freightRate)??H(l.freight_rate)??H(e.freightRate)??H(e.freight_rate)??0,c=B(l.minimumOrderQuantity,l.minimum_order_quantity,l.moq),m=B(l.spq,l.standardPackageQuantity,l.standard_package_quantity,l.standardPackQuantity),p=((...e)=>{for(const l of e)if(null!=l&&""!==l)return l;return null})(l.deliveryPeriod,l.delivery_period,l.delivery_time,e.deliveryPeriod,e.delivery_period,e.delivery_time,l.deliveryDate,e.deliveryDate);return{id:e.id??e.quoteId??l.id??`${e.companyName}-${W.value?.id}`,supplierName:e.companyName||e.supplierName||e.vendorName||e.supplier?.name||"-",unitPrice:r,currency:i,originalCurrency:e.currency||"CNY",unit:o,totalAmount:n,deliveryTime:p,status:e.status,originalUnitPrice:B(l.unitPrice,l.unit_price),shippingFee:s,freightRate:d,specialTariff:u,moq:c,spq:m,productOrigin:l.productOrigin??e.productOrigin??null,hasSpecialTariff:Boolean(l.tariffCalculation?.hasSpecialTariff),attachments:ae(e.attachments??[])}}).filter(e=>Boolean(e));if(!e.length)return[];let l=e;if("department_user"===a.userRole){const t=W.value?.selectedQuoteId??W.value?.selected_quote_id??null;l=t?e.filter(e=>Number(e.id)===Number(t)):e.filter(e=>"selected"===e.status)}if(!l.length)return[];const t=l.reduce((e,l)=>null===l.unitPrice||void 0===l.unitPrice?e:l.unitPrice<e?l.unitPrice:e,Number.POSITIVE_INFINITY);return l.map(e=>({...e,isLowest:t!==Number.POSITIVE_INFINITY&&null!==e.unitPrice&&void 0!==e.unitPrice&&e.unitPrice===t}))});function le(e){e&&r("selectItem",e.id)}function te({row:e}){return e.id===a.selectedLineItemId?"selected-row":""}const ae=e=>(e??[]).map(e=>{const l=e.storedName??e.stored_name??e.storedFileName??e.stored_file_name??null,t=e.filePath??e.file_path??null,a=re(t,l,"rfq-attachments")??e.downloadUrl??null;return{...e,storedName:l,originalName:e.originalName??e.original_name??e.fileName??e.file_name,downloadUrl:a}});function oe(e,l="CNY"){if(null==e)return"-";return`${V[l]||l}${L.format(e)}`}function ne(e,l="CNY"){return oe(e,l)}function ye(e){if(!e)return"-";const l=new Date(e);return isNaN(l.getTime())?"-":l.toLocaleDateString("zh-CN")}function be(e,l="CNY",t="EA"){const a=oe(e,l);return"-"===a?"-":`${a}/${t}`}function qe(e,l="EA"){return null==e||e<=0?"-":`${F.format(e)} ${l}`}function he(e){if(!e)return"?";const l=e.trim();if(!l)return"?";const t=l.split(/\s+/).filter(Boolean);return 0===t.length?l.slice(0,2).toUpperCase():1===t.length?t[0].slice(0,2).toUpperCase():(t[0][0]+t[1][0]).toUpperCase()}function ge(e){return null!==Y.value&&void 0!==Y.value&&String(e)===String(Y.value)}return(l,t)=>{const i=ve,o=J,n=A,u=fe,V=g,L=h,F=Z,E=pe,O=U,B=me,M=ce,H=ue,G=de,K=se;return z(),d("div",zt,[c("div",Vt,[c("h4",null,p(l.$t("rfq.lineItemWorkflow.priceComparison")),1)]),m(u,{data:e.lineItems,border:"","highlight-current-row":"","row-class-name":te,onCurrentChange:le,height:"400",style:{width:"100%"}},{default:v(()=>[m(i,{type:"index",label:"#",width:"50",align:"center"}),m(i,{prop:"lineNumber",label:l.$t("rfq.items.lineNumber"),width:"80",align:"center"},null,8,["label"]),m(i,{label:l.$t("rfq.items.itemName"),"min-width":"180"},{default:v(({row:e})=>[c("div",At,[c("div",null,p(e.itemName||e.description),1),e.brand?(z(),d("div",Rt,[m(o,{size:"small",type:"info"},{default:v(()=>[y(p(e.brand),1)]),_:2},1024)])):q("",!0)])]),_:1},8,["label"]),m(i,{label:l.$t("rfq.items.specifications"),width:"180"},{default:v(({row:e})=>[e.specifications?(z(),C(n,{key:0,content:e.specifications,placement:"top"},{default:v(()=>{return[c("div",Tt,p((l=e.specifications,t=30,l?l.length<=t?l:l.substring(0,t)+"...":"")),1)];var l,t}),_:2},1032,["content"])):(z(),d("span",jt,"-"))]),_:1},8,["label"]),m(i,{label:l.$t("rfq.items.quantity"),width:"100"},{default:v(({row:e})=>[y(p(e.quantity)+" "+p(e.unit),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.lineItemWorkflow.status"),width:"140"},{default:v(({row:e})=>{return[m(o,{type:(t=e.status,{draft:"info",pending_director:"warning",pending_po:"primary",completed:"success",rejected:"danger"}[t]||"info"),size:"small"},{default:v(()=>[y(p(l.$t(`rfq.lineItemWorkflow.statuses.${e.status}`)),1)]),_:2},1032,["type"])];var t}),_:1},8,["label"]),m(i,{label:l.$t("rfq.lineItemWorkflow.currentApprover"),width:"120"},{default:v(({row:e})=>[c("span",null,p(Q(e)),1)]),_:1},8,["label"])]),_:1},8,["data"]),e.selectedLineItemId&&ee.value.length>0?(z(),d("div",Lt,[c("div",Ft,[c("h4",null,p(l.$t("rfq.lineItemWorkflow.quoteComparison")),1),c("span",Et,p(ee.value.length)+" "+p(l.$t("rfq.quote.quotes")),1)]),c("div",Qt,[c("div",Wt,[m(L,{type:"primary",text:"",onClick:t[0]||(t[0]=e=>s.value=!0)},{default:v(()=>[y(p(l.$t("rfq.quoteComparison.viewDetails"))+" ",1),m(V,null,{default:v(()=>[m(f(_))]),_:1})]),_:1})]),c("div",Ot,[(z(!0),d(w,null,k(ee.value,e=>{return z(),d("div",{key:e.id,class:I(["supplier-card",{selected:ge(e.id),"has-special-tariff":e.hasSpecialTariff,"read-only":X.value}]),onClick:l=>{return t=e.id,void(X.value||(Y.value=t,r("selectQuote",t)));var t}},[c("div",Bt,[c("div",Mt,p(he(e.supplierName)),1),c("div",Ht,[c("div",{class:"company-name",title:e.supplierName},p(e.supplierName||"-"),9,Gt),X.value&&ge(e.id)?(z(),C(o,{key:0,type:"success",size:"small"},{default:v(()=>[y(p(l.$t("rfq.lineItemWorkflow.purchaserSelected")),1)]),_:1})):q("",!0),c("div",Kt,[e.status&&"submitted"!==e.status?(z(),C(o,{key:0,type:(t=e.status,{draft:"info",submitted:"primary",selected:"success",rejected:"danger"}[t]||"info"),size:"small",effect:"plain",class:"status-pill"},{default:v(()=>[y(p(l.$t(`rfq.quote.statuses.${e.status}`)),1)]),_:2},1032,["type"])):q("",!0),e.hasSpecialTariff?(z(),C(o,{key:1,type:"warning",size:"small",effect:"plain",class:"tariff-pill"},{default:v(()=>[y(p(l.$t("rfq.quote.specialTariffTag")),1)]),_:1})):q("",!0)])]),e.isLowest?(z(),C(o,{key:0,size:"small",type:"success",effect:"dark",class:"lowest-badge"},{default:v(()=>[y(p(l.$t("rfq.priceComparison.lowest")),1)]),_:1})):q("",!0)]),c("div",Zt,[c("span",Jt,p(be(e.unitPrice,e.currency,e.unit)),1),c("span",Xt,p(ne(e.totalAmount,e.currency)),1)]),c("div",ea,[c("span",la,p(l.$t("rfq.quote.moq")),1),c("span",ta,p(qe(e.moq,e.unit)),1)]),c("div",aa,[c("span",ra,p(ge(e.id)?X.value?l.$t("rfq.lineItemWorkflow.purchaserSelected"):l.$t("rfq.review.selected"):X.value?l.$t("rfq.lineItemWorkflow.viewOnly"):l.$t("rfq.review.select")),1),c("div",{class:I(["radio-dot",{selected:ge(e.id),disabled:X.value}])},null,2)])],10,Yt);var t}),128))])])])):e.selectedLineItemId?(z(),C(F,{key:1,description:l.$t("rfq.lineItemWorkflow.noQuotes"),"image-size":100},null,8,["description"])):q("",!0),m(O,{modelValue:s.value,"onUpdate:modelValue":t[2]||(t[2]=e=>s.value=e),title:l.$t("rfq.quoteComparison.detailDialogTitle"),width:"1200px","close-on-click-modal":!1},{footer:v(()=>[m(L,{onClick:t[1]||(t[1]=e=>s.value=!1)},{default:v(()=>[y(p(l.$t("common.close")),1)]),_:1})]),default:v(()=>[W.value?(z(),d("div",ia,[c("p",null,[c("strong",null,p(l.$t("rfq.items.itemName"))+":",1),y(" "+p(W.value.itemName||W.value.description),1)]),c("p",null,[c("strong",null,p(l.$t("rfq.items.quantity"))+":",1),y(" "+p(W.value.quantity)+" "+p(W.value.unit),1)])])):q("",!0),m(u,{data:ee.value,border:"",stripe:""},{default:v(()=>[m(i,{label:l.$t("supplier.companyName"),"min-width":"160",fixed:""},{default:v(({row:e})=>[m(E,{type:"primary",underline:!1,class:"supplier-name-link",onClick:N(l=>function(e){const l=a.quotes.find(l=>Number(l.id)===Number(e.id));l?(P.value=l,S.value=!0):console.warn("[RfqPriceComparisonSection] Full quote not found for ID:",e.id)}(e),["stop"])},{default:v(()=>[y(p(e.supplierName)+" ",1),m(V,{class:"link-icon"},{default:v(()=>[m(f(x))]),_:1})]),_:2},1032,["onClick"])]),_:1},8,["label"]),m(i,{label:l.$t("rfq.lineItemWorkflow.unitStandardCost"),width:"130"},{default:v(({row:e})=>[c("strong",oa,p(be(e.unitPrice,e.currency,e.unit)),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.originalUnitPrice"),width:"130"},{default:v(({row:e})=>[y(p(be(e.originalUnitPrice,e.originalCurrency,e.unit)),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quoteComparison.shippingFee"),width:"120"},{default:v(({row:e})=>{return[null!==e.shippingFee&&void 0!==e.shippingFee?(z(),d("span",na,p(ne(e.shippingFee,e.currency)),1)):(z(),d("span",sa,p((l=e.freightRate??0,null==l||Number.isNaN(l)?"-":`${(100*l).toFixed(2)}%`)),1))];var l}),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.specialTariff"),width:"100"},{default:v(({row:e})=>[c("span",{style:R({color:e.specialTariff>0?"#e6a23c":"#67c23a"})},p(e.specialTariff>0?`${e.specialTariff}%`:"0%"),5)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.moq"),width:"90",align:"center"},{default:v(({row:e})=>[y(p(e.moq||"-"),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.spq"),width:"90",align:"center"},{default:v(({row:e})=>[y(p(e.spq||"-"),1)]),_:1},8,["label"]),m(i,{label:l.$t("rfq.quote.deliveryTime"),width:"110",prop:"deliveryTime"},null,8,["label"]),m(i,{label:l.$t("rfq.quote.productOrigin"),width:"100",prop:"productOrigin"},null,8,["label"]),m(i,{label:l.$t("rfq.quoteComparison.quoteAttachments"),"min-width":"180"},{default:v(({row:e})=>[e.attachments&&e.attachments.length?(z(),d("div",ua,[(z(!0),d(w,null,k(e.attachments,e=>(z(),d("div",{key:e.id||e.storedName||e.originalName||e.downloadUrl,class:"quote-attachment-row"},[c("span",{class:"quote-attachment-name",title:e.originalName||e.storedName},p(e.originalName||e.storedName||"-"),9,da),m(L,{size:"small",link:"",type:"primary",onClick:N(l=>{var t;(t=e).downloadUrl&&window.open(String(t.downloadUrl),"_blank")},["stop"])},{default:v(()=>[y(p(l.$t("common.view")),1)]),_:1},8,["onClick"]),m(L,{size:"small",link:"",type:"info",onClick:N(l=>async function(e){if(!e.downloadUrl)return;const l=e.originalName||e.storedName||"download";try{await ie(String(e.downloadUrl),l)}catch(t){console.error("[RfqPriceComparisonSection] download failed",t)}}(e),["stop"])},{default:v(()=>[y(p(l.$t("rfq.quotes.download")),1)]),_:1},8,["onClick"])]))),128))])):(z(),d("span",ca,"-"))]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["modelValue","title"]),m(O,{modelValue:S.value,"onUpdate:modelValue":t[3]||(t[3]=e=>S.value=e),title:l.$t("rfq.quotes.supplierProfile"),width:"700px"},{default:v(()=>[P.value?(z(),d("div",ma,[m(K,{type:"border-card"},{default:v(()=>[m(H,{label:l.$t("rfq.quotes.basicInfo")},{default:v(()=>[m(M,{column:2,border:""},{default:v(()=>[m(B,{label:l.$t("supplier.companyName")},{default:v(()=>[y(p(P.value.companyName||P.value.supplierName),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.companyId")},{default:v(()=>[y(p(P.value.companyId||"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.stage")},{default:v(()=>[m(o,{type:"formal"===P.value.stage?"success":"warning"},{default:v(()=>[y(p(l.$t(`supplier.stages.${P.value.stage??"null"}`)),1)]),_:1},8,["type"])]),_:1},8,["label"]),m(B,{label:l.$t("supplier.category")},{default:v(()=>[y(p(P.value.category||"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.region")},{default:v(()=>[y(p(P.value.region||"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.address")},{default:v(()=>[y(p(P.value.address||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(H,{label:l.$t("rfq.quotes.financialInfo")},{default:v(()=>[m(M,{column:2,border:""},{default:v(()=>[m(B,{label:l.$t("supplier.registeredCapital")},{default:v(()=>[P.value.registeredCapital?(z(),C(G,{key:0,type:"primary",size:"large"},{default:v(()=>[y(p(oe(P.value.registeredCapital,"CNY")),1)]),_:1})):(z(),d("span",pa,"-"))]),_:1},8,["label"]),m(B,{label:l.$t("supplier.registrationDate")},{default:v(()=>[y(p(P.value.registrationDate?ye(P.value.registrationDate):"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.paymentTerms")},{default:v(()=>[y(p(P.value.paymentTerms||"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.paymentCurrency")},{default:v(()=>[y(p(P.value.paymentCurrency||"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.bankName")},{default:v(()=>[y(p(P.value.bankName||"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.bankAccount")},{default:v(()=>[y(p(P.value.bankAccount||"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.taxRegistrationNumber")},{default:v(()=>[y(p(P.value.taxRegistrationNumber||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(H,{label:l.$t("rfq.quotes.legalInfo")},{default:v(()=>[m(M,{column:2,border:""},{default:v(()=>[m(B,{label:l.$t("supplier.businessRegistrationNumber")},{default:v(()=>[m(G,{type:"primary"},{default:v(()=>[y(p(P.value.businessRegistrationNumber||"-"),1)]),_:1})]),_:1},8,["label"]),m(B,{label:l.$t("supplier.legalRepresentative")},{default:v(()=>[y(p(P.value.legalRepresentative||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),m(H,{label:l.$t("rfq.quotes.contactInfo")},{default:v(()=>[m(M,{column:2,border:""},{default:v(()=>[m(B,{label:l.$t("supplier.contactPerson")},{default:v(()=>[y(p(P.value.contactPerson||"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.contactPhone")},{default:v(()=>[y(p(P.value.contactPhone||"-"),1)]),_:1},8,["label"]),m(B,{label:l.$t("supplier.contactEmail"),span:2},{default:v(()=>[y(p(P.value.contactEmail||"-"),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),P.value.supplierDocuments?.length?(z(),C(H,{key:0,label:l.$t("rfq.quotes.documentsInfo")},{default:v(()=>[m(u,{data:P.value.supplierDocuments,border:""},{default:v(()=>[m(i,{label:l.$t("supplier.documentCategory"),width:"180"},{default:v(({row:e})=>[m(o,{size:"small"},{default:v(()=>[y(p(l.$t(`supplier.documentCategories.${e.category}`)),1)]),_:2},1024)]),_:1},8,["label"]),m(i,{label:l.$t("supplier.fileName"),width:"200"},{default:v(({row:e})=>[y(p(e.originalName||e.file_name||"-"),1)]),_:1},8,["label"]),m(i,{label:l.$t("supplier.uploadedAt"),width:"160"},{default:v(({row:e})=>[y(p(ye(e.uploadedAt||e.uploaded_at)),1)]),_:1},8,["label"]),m(i,{label:l.$t("supplier.expiryDate"),width:"120"},{default:v(({row:e})=>[e.expiresAt||e.expiry_date?(z(),d("span",fa,p(ye(e.expiresAt||e.expiry_date)),1)):(z(),d("span",va,"-"))]),_:1},8,["label"]),m(i,{label:l.$t("supplier.verified"),width:"100",align:"center"},{default:v(({row:e})=>[e.verified?(z(),C(V,{key:0,color:"green",size:"20"},{default:v(()=>[m(f(T))]),_:1})):(z(),C(V,{key:1,color:"gray",size:"20"},{default:v(()=>[m(f(j))]),_:1}))]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["label"])):q("",!0)]),_:1})])):q("",!0)]),_:1},8,["modelValue","title"]),m(O,{modelValue:b.value,"onUpdate:modelValue":t[4]||(t[4]=e=>b.value=e),title:l.$t("rfq.quote.details"),width:"800px"},{default:v(()=>[$.value?(z(),C(Dt,{key:0,quotes:D.value,"line-item":W.value},null,8,["quotes","line-item"])):q("",!0)]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-5ebfd9fa"]]),ba={class:"approval-history-timeline"},qa={class:"history-item"},ha={class:"item-header"},ga={class:"step-info"},_a={class:"step-name"},wa={class:"approver-info"},ka={class:"approver-name"},Ia={class:"approver-role"},Ca={key:0,class:"comments"},Na={key:1,class:"quote-change"},$a={class:"change-details"},Sa={key:0},Ua=V(i({__name:"RfqApprovalHistoryTimeline",props:{rfqId:{},lineItemId:{}},setup(l){const t=Ce(),a=l,{t:r}=o(),i=n(!1),s=n([]);async function u(){i.value=!0;try{s.value=await async function(l,t){return(await e(`/rfq/${l}/line-items/${t}/history`)).data}(a.rfqId,a.lineItemId)}catch(l){t.error(l.message||r("common.loadFailed"))}finally{i.value=!1}}function f(e){return{approved:T,rejected:Q,confirmed:E,refused:F}[e]||void 0}function h(e){return{approved:"success",rejected:"danger",confirmed:"success",refused:"danger",submitted:"primary"}[e]||"info"}function g(e){if(!e)return"-";return new Date(e).toLocaleString()}return L(()=>{u()}),(e,l)=>{const t=J,a=X,r=Ie,o=xe,n=Pe,u=Z,_=K;return b((z(),d("div",ba,[s.value.length>0?(z(),C(n,{key:0},{default:v(()=>[(z(!0),d(w,null,k(s.value,l=>{return z(),C(o,{key:l.id,timestamp:g(l.createdAt),type:(i=l.decision,{approved:"success",rejected:"danger",confirmed:"success",refused:"danger",submitted:"primary"}[i]||"info"),icon:f(l.decision),placement:"top"},{default:v(()=>[m(r,null,{default:v(()=>[c("div",qa,[c("div",ha,[c("div",ga,[m(t,{type:h(l.decision),size:"small"},{default:v(()=>[y(p(e.$t(`rfq.lineItemWorkflow.decisions.${l.decision}`)),1)]),_:2},1032,["type"]),c("span",_a,p(e.$t(`rfq.lineItemWorkflow.steps.${l.step}`)),1)]),c("div",wa,[c("span",ka,p(l.approverName),1),c("span",Ia," ("+p(e.$t(`roles.${l.approverRole}`))+") ",1)])]),l.comments?(z(),d("div",Ca,[c("strong",null,p(e.$t("common.comments"))+":",1),c("p",null,p(l.comments),1)])):q("",!0),l.newQuoteId&&l.previousQuoteId?(z(),d("div",Na,[m(a,{title:e.$t("rfq.lineItemWorkflow.quoteChanged"),type:"warning",closable:!1,"show-icon":""},{default:v(()=>[c("div",$a,[c("div",null,p(e.$t("rfq.lineItemWorkflow.previousQuote"))+": #"+p(l.previousQuoteId),1),c("div",null,p(e.$t("rfq.lineItemWorkflow.newQuote"))+": #"+p(l.newQuoteId),1),l.changeReason?(z(),d("div",Sa,p(e.$t("common.reason"))+": "+p(l.changeReason),1)):q("",!0)])]),_:2},1032,["title"])])):q("",!0)])]),_:2},1024)]),_:2},1032,["timestamp","type","icon"]);var i}),128))]),_:1})):(z(),C(u,{key:1,description:e.$t("rfq.lineItemWorkflow.noHistory"),"image-size":100},null,8,["description"]))])),[[_,i.value]])}}}),[["__scopeId","data-v-7ecabef8"]]),Pa={class:"price-comparison-cell"},xa={key:0,class:"uploaded-state"},Da={key:0,class:"price-display"},za={key:0,class:"not-uploaded-state"},Va={key:1,class:"upload-restricted-state"},Aa={class:"restricted-copy"},Ra={class:"title"},Ta={class:"hint"},ja={class:"el-upload__tip"},La=V(i({__name:"PriceComparisonCell",props:{rfqId:{default:void 0},lineItem:{},platform:{},comparisonData:{},canUpload:{type:Boolean,default:!0}},emits:["uploaded","viewDetail"],setup(e,{emit:l}){const a=Ce(),r=e,i=l,{t:s}=o(),u=n(!1),b=n(!1),_=n([]),k=n(null),I=n({price:null,url:"",notes:""}),C=t(()=>({1688:"1688",jd:s("rfq.priceComparison.platforms.jd"),zkh:s("rfq.priceComparison.platforms.zkh")}[r.platform]||r.platform));function $(){r.canUpload&&(u.value=!0,I.value={price:null,url:"",notes:""},_.value=[],k.value=null)}function P(e){k.value=e.raw,_.value=[e]}async function x(){if(r.canUpload)if(r.rfqId)if(k.value)if(!I.value.price||I.value.price<=0)a.warning(s("rfq.priceComparison.uploadDialog.pleaseEnterPrice"));else{b.value=!0;try{await ee(r.rfqId,r.platform,k.value,I.value.price,I.value.url,r.lineItem.id),a.success(s("rfq.priceComparison.uploadSuccess")),u.value=!1,i("uploaded")}catch(e){console.error("Upload failed:",e),a.error(e.message||s("rfq.priceComparison.uploadFailed"))}finally{b.value=!1}}else a.warning(s("rfq.priceComparison.uploadDialog.pleaseSelectFile"));else a.error(s("rfq.priceComparison.uploadDialog.rfqIdRequired"))}function D(){i("viewDetail",{...r.comparisonData,lineItemId:r.lineItem.id,lineItemNumber:r.lineItem.itemNumber,lineItemDescription:r.lineItem.description})}return(l,t)=>{const a=J,r=h,i=g,o=De,n=ge,k=S,V=he,A=U;return z(),d("div",Pa,[e.comparisonData?(z(),d("div",xa,[m(a,{type:"success",size:"small"},{default:v(()=>[y(p(f(s)("rfq.priceComparison.cell.uploaded")),1)]),_:1}),e.comparisonData.platformPrice?(z(),d("div",Da," ¥"+p(e.comparisonData.platformPrice.toFixed(2)),1)):q("",!0),m(r,{text:"",type:"primary",size:"small",onClick:D},{default:v(()=>[y(p(f(s)("rfq.priceComparison.cell.viewDetail")),1)]),_:1})])):(z(),d(w,{key:1},[e.canUpload?(z(),d("div",za,[m(r,{size:"small",type:"primary",plain:"",disabled:!e.rfqId,onClick:$},{default:v(()=>[m(i,null,{default:v(()=>[m(f(W))]),_:1}),y(" "+p(f(s)("rfq.lineItemWorkflow.uploadMarketPrice")),1)]),_:1},8,["disabled"])])):(z(),d("div",Va,[m(i,{class:"lock-icon"},{default:v(()=>[m(f(O))]),_:1}),c("div",Aa,[c("span",Ra,p(f(s)("rfq.priceComparison.cell.purchaserOnly")),1),c("span",Ta,p(f(s)("rfq.priceComparison.cell.viewOnlyHint")),1)])]))],64)),m(A,{modelValue:u.value,"onUpdate:modelValue":t[4]||(t[4]=e=>u.value=e),title:f(s)("rfq.priceComparison.uploadDialog.title",{platform:C.value,item:e.lineItem.itemNumber}),width:"500px"},{footer:v(()=>[m(r,{onClick:t[3]||(t[3]=e=>u.value=!1)},{default:v(()=>[y(p(f(s)("common.cancel")),1)]),_:1}),m(r,{type:"primary",loading:b.value,onClick:x},{default:v(()=>[y(p(f(s)("common.submit")),1)]),_:1},8,["loading"])]),default:v(()=>[m(V,{model:I.value,"label-width":"100px",onSubmit:N(x,["prevent"])},{default:v(()=>[m(n,{label:f(s)("rfq.priceComparison.uploadDialog.screenshot")},{default:v(()=>[m(o,{ref:"uploadRef","auto-upload":!1,limit:1,accept:"image/*","on-change":P,"file-list":_.value},{tip:v(()=>[c("div",ja,p(f(s)("rfq.priceComparison.uploadDialog.fileHint")),1)]),default:v(()=>[m(r,{size:"small"},{default:v(()=>[y(p(f(s)("rfq.priceComparison.uploadDialog.chooseFile")),1)]),_:1})]),_:1},8,["file-list"])]),_:1},8,["label"]),m(n,{label:f(s)("rfq.priceComparison.uploadDialog.price"),required:""},{default:v(()=>[m(k,{modelValue:I.value.price,"onUpdate:modelValue":t[0]||(t[0]=e=>I.value.price=e),modelModifiers:{number:!0},type:"number",placeholder:f(s)("rfq.priceComparison.uploadDialog.pricePlaceholder"),step:"0.01"},{prepend:v(()=>[...t[5]||(t[5]=[y("¥",-1)])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),m(n,{label:f(s)("rfq.priceComparison.uploadDialog.productUrl")},{default:v(()=>[m(k,{modelValue:I.value.url,"onUpdate:modelValue":t[1]||(t[1]=e=>I.value.url=e),placeholder:f(s)("rfq.priceComparison.uploadDialog.urlPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),m(n,{label:f(s)("rfq.priceComparison.uploadDialog.notes")},{default:v(()=>[m(k,{modelValue:I.value.notes,"onUpdate:modelValue":t[2]||(t[2]=e=>I.value.notes=e),type:"textarea",rows:3,placeholder:f(s)("rfq.priceComparison.uploadDialog.notesPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-b6497c9b"]]),Fa={class:"approval-operation-panel"},Ea={class:"panel-header"},Qa={class:"selected-quote-info"},Wa={class:"price"},Oa={key:0,class:"operation-section"},Ya={key:1,class:"operation-section"},Ba={key:0,class:"invite-link"},Ma={class:"action-buttons"},Ha={key:2,class:"operation-section"},Ga={class:"approval-history"},Ka={key:3,class:"price-comparison-upload-section"},Za={class:"section-header"},Ja={class:"platforms-grid"},Xa={class:"platform-header"},er={class:"platform-name"},lr={class:"platform-header"},tr={class:"platform-name"},ar={key:0,class:"invite-hint"},rr=V(i({__name:"RfqApprovalOperationPanel",props:{rfq:{},lineItem:{},selectedQuote:{},userRole:{},priceComparisons:{}},emits:["approve","reject","submit","refresh","priceUploaded"],setup(l,{emit:a}){const r=Ce(),i=l,f=a,{t:b}=o(),g=n(!1),_=n(!1),I=n(!1),N=n(!1),$=n(null),P=s({purchaserIds:[],message:""}),x=n([]),V=n(!1),A=n(!1),R=n(null),T=n([]),j=s({changeQuote:!1,newQuoteId:null,comments:""}),L=t(()=>i.rfq?.quotes||[]),F=t(()=>("purchaser"===i.userRole||"admin"===i.userRole)&&("draft"===i.lineItem.status||"rejected"===i.lineItem.status)),E=t(()=>("procurement_director"===i.userRole||"admin"===i.userRole)&&"pending_director"===i.lineItem.status),Q=t(()=>"purchaser"===i.userRole),W=t(()=>"procurement_director"===i.userRole),O=t(()=>W.value),Y=t(()=>W.value),B=t(()=>{const e=b("rfq.approval.invitePurchaser");return $.value?`${e} - ${b("common.roles.procurement_director")}`:e});async function M(){const e=i.selectedQuote?.id;if("number"==typeof e){g.value=!0;try{f("submit",e),r.success(b("rfq.lineItemWorkflow.submitSuccess"))}catch(l){r.error(b("rfq.lineItemWorkflow.submitFailed"))}finally{g.value=!1}}}async function H(){g.value=!0;try{const e={comments:j.comments};j.changeQuote&&j.newQuoteId&&(e.newQuoteId=j.newQuoteId),f("approve",e),r.success(b("rfq.lineItemWorkflow.approveSuccess"))}catch(e){r.error(b("rfq.lineItemWorkflow.approveFailed"))}finally{g.value=!1}}async function G(){g.value=!0;try{f("reject",j.comments),r.success(b("rfq.lineItemWorkflow.rejectSuccess"))}catch(e){r.error(b("rfq.lineItemWorkflow.rejectFailed"))}finally{g.value=!1}}async function K(){if(!V.value)try{const l=await e("/users",{params:{role:"purchaser"}});x.value=l.data||[],V.value=!0}catch(l){console.error("[RfqApprovalOperationPanel] Failed to load purchasers",l),r.error(b("rfq.approval.inviteError"))}}async function Z(){if(i.rfq?.id&&i.lineItem?.id)if(P.purchaserIds.length){N.value=!0;try{await async function(l,t,a){return e(`/rfq/${l}/line-items/${t}/invite-purchasers`,{method:"POST",body:a})}(i.rfq.id,i.lineItem.id,{purchaserIds:P.purchaserIds,message:P.message}),r.success(b("rfq.approval.inviteSuccess")),I.value=!1}catch(l){r.error(D(l))}finally{N.value=!1}}else r.warning(b("rfq.approval.selectPurchasersFirst"));else r.error(b("rfq.approval.inviteError"))}function ee(){_.value=!0}function le(e,l="CNY"){return e?`${e.toFixed(2)} ${l}`:"-"}function te(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e.toString():null;if("string"==typeof e){const l=e.trim();if(!l)return null;const t=Number(l);return!Number.isNaN(t)&&Number.isFinite(t)?t.toString():l.toLowerCase()}try{const l=Number(e);if(!Number.isNaN(l)&&Number.isFinite(l))return l.toString()}catch{}const l=String(e).trim();return l?l.toLowerCase():null}function ae(e){if(!i.rfq?.quotes)return[];const l=function(e){const l=new Set,t=i.lineItem||{};return[t.id,t.lineItemId,t.line_item_id,t.lineId,t.line_id,t.itemId,t.item_id,t.lineNumber,t.line_number,t.itemNumber,t.item_number,e?.lineItemId,e?.lineItemNumber,e?.lineItemId??e?.line_item_id].forEach(e=>{const t=te(e);t&&l.add(t)}),l}(e);if(0===l.size)return[];const t=[];return i.rfq.quotes.forEach(e=>{const a=Array.isArray(e?.items)?e.items:Array.isArray(e?.quoteItems)?e.quoteItems:[];if(0===a.length)return;const r=function(e,l){return Array.isArray(e)&&0!==e.length&&0!==l.size?e.find(e=>[e?.lineItemId,e?.rfqLineItemId,e?.rfq_line_item_id,e?.lineId,e?.line_id,e?.id,e?.lineNumber,e?.line_number,e?.itemNumber,e?.item_number,e?.sku].some(e=>{const t=te(e);return null!==t&&l.has(t)})):null}(a,l);r&&void 0!==r.unitPrice&&null!==r.unitPrice&&!Number.isNaN(Number(r.unitPrice))&&t.push({supplierId:e.supplierId??e.supplier_id??e.id,supplierName:e.supplierName||e.companyName||e.supplier_name||b("rfq.quote.unknownSupplier"),price:Number(r.unitPrice)})}),t}function re(e){e&&(R.value=e,T.value=ae(e),A.value=!0)}function ie(e){const l=e?.downloadUrl;l&&window.open(l,"_blank","noopener")}function oe(e){if(!i.priceComparisons)return null;const l=e=>{const l=String(e||"").toLowerCase();return"zhenkunxing"===l?"zkh":l},t=e=>{if(null==e||""===e)return null;const l=Number(e);return Number.isFinite(l)?l:null},a=t(i.lineItem?.id),r=l(e);return i.priceComparisons.find(e=>{if(l(e.platform??e.platformKey??"")!==r)return!1;const i=t(e.lineItemId??e.line_item_id);return null===a?null===i:i===a})}function ne(){f("priceUploaded")}return u(()=>O.value,e=>{e&&!V.value&&K()},{immediate:!0}),(e,t)=>{const a=J,o=me,n=ce,s=_e,u=X,f=Ue,D=ge,W=Se,O=$e,te=S,ae=he,se=h,ue=Ne,de=Ie,pe=U;return z(),d("div",Fa,[c("div",Ea,[c("h4",null,p(e.$t("rfq.lineItemWorkflow.approvalOperations")),1),m(a,{type:(fe=l.lineItem.status,{draft:"info",pending_director:"warning",completed:"success",rejected:"danger"}[fe??"draft"]||"info"),size:"small"},{default:v(()=>[y(p(e.$t(`rfq.lineItemWorkflow.statuses.${l.lineItem.status}`)),1)]),_:1},8,["type"])]),m(n,{column:1,border:"",size:"small",class:"item-info"},{default:v(()=>[m(o,{label:e.$t("rfq.items.lineNumber")},{default:v(()=>[y(" #"+p(l.lineItem.lineNumber),1)]),_:1},8,["label"]),m(o,{label:e.$t("rfq.items.itemName")},{default:v(()=>[y(p(l.lineItem.itemName||l.lineItem.description),1)]),_:1},8,["label"]),m(o,{label:e.$t("rfq.items.quantity")},{default:v(()=>[y(p(l.lineItem.quantity)+" "+p(l.lineItem.unit),1)]),_:1},8,["label"]),l.selectedQuote?(z(),C(o,{key:0,label:e.$t("rfq.quote.selectedQuote")},{default:v(()=>[c("div",Qa,[c("div",null,p(l.selectedQuote.supplierName),1),c("div",Wa,p(le(l.selectedQuote.totalAmount,l.selectedQuote.currency)),1)])]),_:1},8,["label"])):q("",!0)]),_:1}),m(s),F.value?(z(),d("div",Oa,[c("h5",null,p(e.$t("rfq.lineItemWorkflow.submitForApproval")),1),m(u,{title:e.$t("rfq.lineItemWorkflow.selectQuoteHint"),type:"info",closable:!1,"show-icon":"",class:"hint-alert"},null,8,["title"]),m(Ve,{type:"primary",disabled:!l.selectedQuote,loading:g.value,text:e.$t("rfq.lineItemWorkflow.submitToDirector"),"confirm-text":e.$t("rfq.lineItemWorkflow.confirmSubmit"),onConfirm:M,block:""},null,8,["disabled","loading","text","confirm-text"])])):E.value?(z(),d("div",Ya,[c("h5",null,p(e.$t("rfq.lineItemWorkflow.directorApproval")),1),m(ae,{model:j,"label-position":"top"},{default:v(()=>[m(D,{label:e.$t("rfq.lineItemWorkflow.changeQuote")},{default:v(()=>[m(f,{modelValue:j.changeQuote,"onUpdate:modelValue":t[0]||(t[0]=e=>j.changeQuote=e),"active-text":e.$t("common.yes"),"inactive-text":e.$t("common.no")},null,8,["modelValue","active-text","inactive-text"])]),_:1},8,["label"]),j.changeQuote?(z(),C(D,{key:0,label:e.$t("rfq.quote.selectNewQuote")},{default:v(()=>[m(O,{modelValue:j.newQuoteId,"onUpdate:modelValue":t[1]||(t[1]=e=>j.newQuoteId=e),placeholder:"Select quote",style:{width:"100%"}},{default:v(()=>[(z(!0),d(w,null,k(L.value,e=>(z(),C(W,{key:e.id,label:`${e.supplierName} - ${le(e.totalAmount,e.currency)}`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"])):q("",!0),m(D,{label:e.$t("common.comments")},{default:v(()=>[m(te,{modelValue:j.comments,"onUpdate:modelValue":t[2]||(t[2]=e=>j.comments=e),type:"textarea",rows:3,placeholder:e.$t("rfq.lineItemWorkflow.commentsPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"]),Y.value?(z(),d("div",Ba,[m(se,{type:"primary",plain:"",size:"small",onClick:t[3]||(t[3]=e=>async function(e){i.rfq?.id&&i.lineItem?.id?($.value=e,V.value||await K(),P.purchaserIds=[],P.message="",I.value=!0):r.error(b("rfq.approval.inviteError"))}("procurement_director"))},{default:v(()=>[y(p(e.$t("rfq.approval.invitePurchaser")),1)]),_:1})])):q("",!0),c("div",Ma,[m(Ve,{type:"success",loading:g.value,text:e.$t("common.approve"),"confirm-text":e.$t("rfq.lineItemWorkflow.confirmApprove"),onConfirm:H},null,8,["loading","text","confirm-text"]),m(Ve,{type:"danger","confirm-type":"danger",loading:g.value,text:e.$t("common.reject"),"confirm-text":e.$t("rfq.lineItemWorkflow.confirmReject"),onConfirm:G},null,8,["loading","text","confirm-text"])])])):(z(),d("div",Ha,[m(ue,{icon:"completed"===l.lineItem.status?"success":"info",title:"completed"===i.lineItem.status?b("rfq.lineItemWorkflow.completed"):b("rfq.lineItemWorkflow.noActionRequired"),"sub-title":b(`rfq.lineItemWorkflow.statusDescriptions.${i.lineItem.status}`)},null,8,["icon","title","sub-title"])])),m(s),c("div",Ga,[c("h5",null,p(e.$t("rfq.lineItemWorkflow.approvalHistory")),1),m(se,{type:"primary",text:"",onClick:ee},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.viewHistory")),1)]),_:1})]),m(s),l.lineItem?(z(),d("div",Ka,[c("div",Za,[c("h5",null,p(e.$t("rfq.lineItemWorkflow.marketPriceReference")),1),m(a,{size:"small",type:"info"},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.optionalUpload")),1)]),_:1})]),m(u,{title:e.$t("rfq.lineItemWorkflow.priceReferenceHint"),type:"info",closable:!1,"show-icon":"",class:"hint-alert"},null,8,["title"]),c("div",Ja,[m(de,{shadow:"hover",class:"platform-card"},{header:v(()=>[...t[10]||(t[10]=[c("div",{class:"platform-header"},[c("span",{class:"platform-name"},"1688")],-1)])]),default:v(()=>[m(La,{"rfq-id":l.rfq.id,"line-item":l.lineItem,platform:"1688","comparison-data":oe("1688"),"can-upload":Q.value,onViewDetail:re,onUploaded:ne},null,8,["rfq-id","line-item","comparison-data","can-upload"])]),_:1}),m(de,{shadow:"hover",class:"platform-card"},{header:v(()=>[c("div",Xa,[c("span",er,p(e.$t("rfq.priceComparison.jd")),1)])]),default:v(()=>[m(La,{"rfq-id":l.rfq.id,"line-item":l.lineItem,platform:"jd","comparison-data":oe("jd"),"can-upload":Q.value,onViewDetail:re,onUploaded:ne},null,8,["rfq-id","line-item","comparison-data","can-upload"])]),_:1}),m(de,{shadow:"hover",class:"platform-card"},{header:v(()=>[c("div",lr,[c("span",tr,p(e.$t("rfq.priceComparison.zkh")),1)])]),default:v(()=>[m(La,{"rfq-id":l.rfq.id,"line-item":l.lineItem,platform:"zkh","comparison-data":oe("zkh"),"can-upload":Q.value,onViewDetail:re,onUploaded:ne},null,8,["rfq-id","line-item","comparison-data","can-upload"])]),_:1})])])):q("",!0),m(ze,{visible:A.value,"onUpdate:visible":t[4]||(t[4]=e=>A.value=e),"detail-data":R.value,"supplier-prices":T.value,onDownload:ie},null,8,["visible","detail-data","supplier-prices"]),m(pe,{modelValue:I.value,"onUpdate:modelValue":t[8]||(t[8]=e=>I.value=e),title:B.value,width:"520px"},{footer:v(()=>[m(se,{onClick:t[7]||(t[7]=e=>I.value=!1)},{default:v(()=>[y(p(e.$t("common.cancel")),1)]),_:1}),m(se,{type:"primary",loading:N.value,disabled:0===P.purchaserIds.length,onClick:Z},{default:v(()=>[y(p(e.$t("common.confirm")),1)]),_:1},8,["loading","disabled"])]),default:v(()=>[m(ae,{"label-position":"top"},{default:v(()=>[m(D,{label:e.$t("rfq.approval.selectPurchasers")},{default:v(()=>[m(O,{modelValue:P.purchaserIds,"onUpdate:modelValue":t[5]||(t[5]=e=>P.purchaserIds=e),multiple:"",filterable:"","collapse-tags":"",style:{width:"100%"},placeholder:e.$t("rfq.approval.selectPurchasersPlaceholder")},{default:v(()=>[(z(!0),d(w,null,k(x.value,e=>(z(),C(W,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"]),0===x.value.length?(z(),d("div",ar,p(e.$t("rfq.approval.selectPurchasersPlaceholder")),1)):q("",!0)]),_:1},8,["label"]),m(D,{label:e.$t("common.comments")},{default:v(()=>[m(te,{modelValue:P.message,"onUpdate:modelValue":t[6]||(t[6]=e=>P.message=e),type:"textarea",rows:3,placeholder:e.$t("rfq.lineItemWorkflow.commentsPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1},8,["modelValue","title"]),m(pe,{modelValue:_.value,"onUpdate:modelValue":t[9]||(t[9]=e=>_.value=e),title:e.$t("rfq.lineItemWorkflow.approvalHistory"),width:"700px"},{default:v(()=>[m(Ua,{"rfq-id":l.rfq.id,"line-item-id":l.lineItem.id},null,8,["rfq-id","line-item-id"])]),_:1},8,["modelValue","title"])]);var fe}}}),[["__scopeId","data-v-0d33f60d"]]),ir={class:"pr-excel-generator"},or={class:"items-selection"},nr={class:"currency-list"},sr={class:"selection-header"},ur={class:"item-info"},dr={class:"item-name"},cr={class:"item-qty"},mr={key:0,class:"quote-info"},pr={class:"supplier"},fr={class:"price"},vr={class:"total"},yr={key:1,class:"quote-warning"},br={class:"instruction-list"},qr={class:"dialog-footer"},hr=V(i({__name:"RfqPoAttachmentDialog",props:{modelValue:{type:Boolean},rfqId:{},rfq:{},lineItems:{},preselectedItemId:{}},emits:["update:modelValue","success"],setup(e,{emit:l}){const a=Ce(),r=e,i=l,{t:b}=o(),g=t({get:()=>r.modelValue,set:e=>i("update:modelValue",e)}),_=n(),N=n(!1),$=n([]),P=n(!1),x=s({prNumber:"",department:"",accountNo:""}),D=t(()=>Array.isArray(r.lineItems)?r.lineItems:[]),V=t(()=>D.value.length>0&&$.value.length===D.value.length),A=t(()=>$.value.length>0&&!V.value),R=t(()=>{const e={};return D.value.forEach(l=>{const t=l.selectedQuote?.currency||l.currency||"CNY";e[t]||(e[t]=[]),e[t].push(l)}),e}),T=t(()=>Object.keys(R.value).length>1);function j(){const e=new Date,l=`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}`,t=(x.department||r.rfq?.requestingDepartment||"IT").toUpperCase();x.prNumber=`HZ_${t}_${l}001`}function F(){const e=D.value;return 0===e.length?[]:r.preselectedItemId&&e.some(e=>e.id===r.preselectedItemId)?[r.preselectedItemId]:e.map(e=>e.id)}function E(e){$.value=e?D.value.map(e=>e.id):[]}function Q(e){if(null==e||""===e)return"0.00";const l=Number(e);return Number.isNaN(l)?String(e):new Intl.NumberFormat("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:4}).format(l)}async function W(){try{if(N.value)return void console.warn("[PR Excel] Generation already in progress, ignoring duplicate request");if(N.value=!0,0===D.value.length)return void a.warning(b("rfq.pr.noLineItemsSelected"));if(0===$.value.length)return void a.warning(b("rfq.pr.pleaseSelectItems"));const l=new Set(D.value.map(e=>e.id)),t=$.value.filter(e=>l.has(e));if(0===t.length)return void a.error(b("rfq.pr.noLineItemsSelected"));let o;t.length>500&&a.warning({message:b("rfq.pr.exportCount",{count:t.length}),duration:5e3}),t.length>100&&(o=a.info({message:b("rfq.pr.generatingProgress",{count:t.length}),duration:0,showClose:!1}));try{const e=await le(r.rfqId,t,{prNumber:x.prNumber||void 0,department:x.department||void 0,accountNo:x.accountNo||void 0});if(o&&o.close(),e.size<102400)console.warn(`[PR Excel] Generated file is small: ${(e.size/1024).toFixed(2)} KB`),a.warning({message:b("rfq.pr.fileSmallWarning",{size:(e.size/1024).toFixed(2)}),duration:8e3});else if(e.size>52428800)return void a.error({message:b("rfq.pr.fileLargeError",{size:(e.size/1024/1024).toFixed(2)}),duration:8e3});if(!(await(async()=>!(!P.value||"undefined"==typeof document||"undefined"==typeof window||(await M(),0)))()))return;const l=window.URL.createObjectURL(e),n=document.createElement("a");n.href=l;const s=(new Date).getTime(),u=x.prNumber||`HZ_PR_${s}`;n.download=`PR_(${u})_${s}.xlsm`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(l),a.success({message:b("rfq.pr.generateSuccessWithSize",{size:(e.size/1024).toFixed(2)}),duration:5e3}),i("success"),O()}catch(e){throw o&&o.close(),e}}catch(l){if(console.error("[PR Excel] Generation error:",l),"INVALID_LINE_ITEM_STATUS"===l?.code)!function(e){const l=e?.details?.invalidItems??[];if(!l.length)return void a.warning(e?.message||b("rfq.pr.invalidStatusMessage"));const t=l.map(e=>`${e.lineNumber?`#${e.lineNumber}`:`ID:${e.id}`} - ${e.reason||e.status||"invalid"}`).join("\n");H.alert(`<div>${b("rfq.pr.invalidStatusMessage")}<pre style="background:#f5f5f5;padding:10px;margin-top:10px;max-height:200px;overflow:auto;">${t}</pre></div>`,b("rfq.pr.invalidStatusTitle"),{dangerouslyUseHTMLString:!0,type:"warning",confirmButtonText:b("common.ok")});const r=new Set(l.map(e=>e.id));$.value=$.value.filter(e=>!r.has(e))}(l);else if("MISSING_SELECTED_QUOTE"===l?.code)!function(e){const l=e?.details?.missingQuoteItems??[];if(!l.length)return void a.error(e?.message||b("rfq.pr.generateFailed"));const t=l.map(e=>e.lineNumber?`#${e.lineNumber}`:`ID:${e.id}`).join(", ");a.error(`${b("rfq.pr.missingQuoteMessage")}: ${t}`,void 0,{duration:1e4,showClose:!0});const r=new Set(l.map(e=>e.id));$.value=$.value.filter(e=>!r.has(e))}(l);else{const e=l?.code||"UNKNOWN",t=l?.message||b("rfq.pr.generateFailed");"NO_VALID_LINE_ITEMS"===e||"INVALID_LINE_ITEMS"===e?a.warning({message:t,duration:8e3,showClose:!0}):"TEMPLATE_ERROR"===e||"FILE_TOO_SMALL"===e?a.error({message:t,duration:1e4,showClose:!0}):a.error({message:t,duration:8e3,showClose:!0})}l?.details&&console.error("[PR Excel] Error details:",l.details)}finally{N.value=!1}}function O(){x.prNumber="",x.department="",x.accountNo="",$.value=[],i("update:modelValue",!1)}return L(()=>{P.value=!0}),Y(()=>{P.value=!1}),u(()=>r.modelValue,e=>{e?(r.rfq&&(x.department=r.rfq.requestingDepartment||""),$.value=F()):$.value=[]}),u(()=>r.lineItems,e=>{const l=Array.isArray(e)?e:[],t=new Set(l.map(e=>e.id));$.value=$.value.filter(e=>t.has(e)),r.modelValue&&0===$.value.length&&l.length>0&&($.value=F())},{deep:!0}),(l,t)=>{const a=X,r=ye,i=J,o=be,n=qe,s=h,u=S,b=ge,P=ke,D=we,L=he,F=U;return z(),C(F,{modelValue:g.value,"onUpdate:modelValue":t[4]||(t[4]=e=>g.value=e),title:l.$t("rfq.pr.generatePrExcel"),width:"700px","close-on-click-modal":!1,onClose:O},{footer:v(()=>[c("div",qr,[m(s,{onClick:O},{default:v(()=>[y(p(l.$t("common.cancel")),1)]),_:1}),m(s,{type:"primary",loading:N.value,disabled:0===$.value.length,icon:f(B),onClick:W},{default:v(()=>[y(p(l.$t("rfq.pr.generateAndDownload"))+" ",1),$.value.length?(z(),d(w,{key:0},[y(" ("+p($.value.length)+") ",1)],64)):q("",!0)]),_:1},8,["loading","disabled","icon"])])]),default:v(()=>[c("div",ir,[m(a,{title:l.$t("rfq.pr.selectItemsToExport"),type:"info",closable:!1,"show-icon":"",class:"selected-items-alert"},{default:v(()=>[c("div",or,[T.value?(z(),C(a,{key:0,type:"warning",closable:!1,"show-icon":"",class:"currency-warning"},{title:v(()=>[y(p(l.$t("rfq.pr.multipleCurrencyWarning")),1)]),default:v(()=>[c("div",null,[y(p(l.$t("rfq.pr.multipleCurrencyHint"))+" ",1),c("ul",nr,[(z(!0),d(w,null,k(R.value,(e,t)=>(z(),d("li",{key:t},p(t)+": "+p(e.length)+" "+p(l.$t("rfq.pr.items")),1))),128))])])]),_:1})):q("",!0),c("div",sr,[m(r,{"model-value":V.value,indeterminate:A.value,onChange:E},{default:v(()=>[y(p(l.$t("rfq.pr.selectAll"))+" ("+p($.value.length)+"/"+p(e.lineItems.length)+") ",1)]),_:1},8,["model-value","indeterminate"])]),m(n,{"max-height":"280px"},{default:v(()=>[m(o,{modelValue:$.value,"onUpdate:modelValue":t[0]||(t[0]=e=>$.value=e),class:"item-checkbox-group"},{default:v(()=>[(z(!0),d(w,null,k(e.lineItems,e=>(z(),d("div",{key:e.id,class:I(["item-row",{"is-selected":$.value.includes(e.id)}])},[m(r,{label:e.id,class:"item-checkbox"},{default:v(()=>[c("div",ur,[m(i,{size:"small",type:"primary"},{default:v(()=>[y("#"+p(e.lineNumber),1)]),_:2},1024),c("span",dr,p(e.itemName||e.description),1),c("span",cr,p(e.quantity)+" "+p(e.unit),1)])]),_:2},1032,["label"]),e.selectedQuote?(z(),d("div",mr,[c("span",pr,p(e.selectedQuote.supplierName),1),c("span",fr,p(e.selectedQuote.currency)+" "+p(Q(e.selectedQuote.unitPrice)),1),c("span",vr,p(l.$t("rfq.pr.total"))+": "+p(e.selectedQuote.currency)+" "+p(Q(e.selectedQuote.totalPrice)),1)])):(z(),d("div",yr,[m(i,{type:"warning",size:"small"},{default:v(()=>[y(p(l.$t("rfq.pr.noQuoteSelected")),1)]),_:1})]))],2))),128))]),_:1},8,["modelValue"])]),_:1})])]),_:1},8,["title"]),m(L,{ref_key:"formRef",ref:_,model:x,"label-position":"top",class:"pr-form"},{default:v(()=>[m(D,{gutter:20},{default:v(()=>[m(P,{span:12},{default:v(()=>[m(b,{label:l.$t("rfq.pr.prNumber")},{default:v(()=>[m(u,{modelValue:x.prNumber,"onUpdate:modelValue":t[1]||(t[1]=e=>x.prNumber=e),placeholder:l.$t("rfq.pr.autoGenerated"),clearable:""},{append:v(()=>[m(s,{onClick:j},{default:v(()=>[y(p(l.$t("rfq.pr.autoGenerate")),1)]),_:1})]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1}),m(P,{span:12},{default:v(()=>[m(b,{label:l.$t("rfq.pr.department")},{default:v(()=>[m(u,{modelValue:x.department,"onUpdate:modelValue":t[2]||(t[2]=e=>x.department=e),placeholder:e.rfq?.requestingDepartment||l.$t("rfq.pr.departmentPlaceholder"),clearable:""},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1}),m(D,{gutter:20},{default:v(()=>[m(P,{span:12},{default:v(()=>[m(b,{label:l.$t("rfq.pr.accountNo")},{default:v(()=>[m(u,{modelValue:x.accountNo,"onUpdate:modelValue":t[3]||(t[3]=e=>x.accountNo=e),placeholder:l.$t("rfq.pr.accountNoPlaceholder"),clearable:""},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1})]),_:1}),m(a,{title:l.$t("rfq.pr.instructions"),type:"success",closable:!1,"show-icon":""},{default:v(()=>[c("ul",br,[c("li",null,p(l.$t("rfq.pr.instruction1")),1),c("li",null,p(l.$t("rfq.pr.instruction2")),1),c("li",null,p(l.$t("rfq.pr.instruction3")),1),c("li",null,p(l.$t("rfq.pr.instruction4")),1)])]),_:1},8,["title"])]),_:1},8,["model"])])]),_:1},8,["modelValue","title"])}}}),[["__scopeId","data-v-976be8d8"]]),gr={class:"rfq-line-item-workflow"},_r={class:"quote-lock-meta"},wr={key:0},kr={class:"workflow-header"},Ir={class:"header-info"},Cr={class:"workflow-content"},Nr={class:"price-comparison-section"},$r={class:"approval-operation-section"},Sr=V(i({__name:"RfqLineItemWorkflowLayout",props:{rfqId:{}},setup(l){const a=Ce(),r=l,{t:i}=o(),s=G(),g=n(!1),_=n({}),w=n([]),k=n([]),I=n(null),N=n(null),$=n(!1),S=t(()=>s.user?.role||""),U=t(()=>!1===_.value.quotesVisible&&Boolean(_.value.visibilityReason)),P=t(()=>_.value?.visibilityReason||null),x=t(()=>I.value?w.value.find(e=>e.id===I.value):null),V=t(()=>N.value?k.value.find(e=>e.id===N.value):null),A=t(()=>"purchaser"===S.value),R=t(()=>{if(!x.value)return!1;if("purchaser"!==S.value)return!1;const e=x.value.status??"";return["draft","rejected"].includes(e)}),T=t(()=>{const e=["pending_director","pending_po"];return w.value.filter(l=>e.includes(l.status??"")).length}),j=t(()=>w.value.filter(e=>"completed"===(e.status??"")).length),F=t(()=>w.value.filter(e=>"pending_po"===(e.status??""))),E=t(()=>{const e=Array.isArray(k.value)?k.value:[];return F.value.map(l=>{const t=oe(l.selectedQuoteId,l.selected_quote_id),a=t?e.find(e=>oe(e.id)===t):null,r=(a&&(a.lineItems||a.items||a.quoteItems)||[]).find(e=>ne(e.rfqLineItemId,e.lineItemId,e.rfq_line_item_id)===l.id),i=String(ne(r?.currency,r?.currency_code,a?.currency,l.currency,"CNY")??"CNY"),o=oe(r?.unitPrice,r?.unit_price,a?.unitPrice,a?.unit_price,l.unitPrice,l.unit_price,0)??0,n=oe(l.quantity,1)??1,s=oe(r?.totalPrice,r?.total_price,a?.totalAmount,a?.total_price,l.totalPrice,l.total_price,o*n)??0,u=oe(a?.supplierId,a?.supplier_id)??0,d=String(ne(a?.supplierName,a?.companyName,a?.supplier_name,"")??""),c=ne(a?.companyId,a?.company_id,a?.supplierCode),m=null==c?void 0:String(c);return{id:l.id,lineNumber:Number(l.lineNumber??l.line_number??0),quantity:Number(l.quantity??0),unit:String(l.unit??""),itemName:l.itemName,description:l.description??void 0,currency:l.currency??void 0,status:l.status??void 0,selectedQuoteId:t??null,selectedQuote:a?{id:a.id,supplierId:u,supplierName:d,supplierCode:m,currency:i,unitPrice:o,totalPrice:s,deliveryPeriod:ne(r?.deliveryPeriod,r?.delivery_period,a?.deliveryPeriod,a?.delivery_period,null)}:null}})});async function Q(){g.value=!0;try{let l;try{l=await te(r.rfqId)}catch(e){console.warn("[RfqLineItemWorkflow] fetchRfqWorkflow failed, falling back to fetchRfqById",e),l=await ae(r.rfqId)}!Array.isArray(l.items)&&Array.isArray(l.lineItems)&&(l.items=l.lineItems),l.priceComparisons=function(e){if(!Array.isArray(e))return[];const l=e=>{if(null==e||""===e)return null;const l=Number(e);return Number.isFinite(l)?l:null},t=e=>{if(null==e)return null;if("string"==typeof e){return e.trim()||null}return"number"==typeof e||"boolean"==typeof e?String(e):null};return e.map(e=>e&&"object"==typeof e?e:null).filter(e=>null!==e).map(e=>{const a=e.platform??e.platformKey??e.platform_key??"";let r=String(a||"").toLowerCase();"zhenkunxing"===r&&(r="zkh"),"1688"!==r&&"jd"!==r&&"zkh"!==r&&(r=String(a||""));const i=ne(e.originalFileName,e.original_file_name,e.fileName,e.file_name),o=t(i),n=ne(e.filePath,e.file_path),s="string"==typeof n?n:null,u=ne(e.storedFileName,e.stored_file_name,s?s.split("/").pop():null),d=t(u),c=t(ne(e.productUrl,e.product_url)),m=oe(e.platformPrice,e.platform_price),p=re(s,d,"rfq_price_comparison");return{...e,platform:r,fileName:o,originalFileName:t(ne(e.originalFileName,e.original_file_name))??o,productUrl:c,platformPrice:m,downloadUrl:p,lineItemId:l(e.lineItemId??e.line_item_id)}})}(l.priceComparisons),_.value=l;const t=(Array.isArray(l.lineItems)?l.lineItems:Array.isArray(l.items)?l.items:[]).map(e=>{const l=oe(e.id);if(null===l)return null;const t=oe(e.selectedQuoteId,e.selected_quote_id);return{...e,lineNumber:Number(e.lineNumber??e.line_number??0),id:l,status:e.status??void 0,selectedQuoteId:t??null}}).filter(e=>null!==e);if(w.value=t,k.value=l.quotes||[],!I.value&&t.length>0&&(I.value=t[0].id),I.value){const e=t.find(e=>e.id===I.value),l=e?.selectedQuoteId??null;null!==l&&(N.value=l)}}catch(l){a.error(D(l)||i("common.loadFailed"))}finally{g.value=!1}}function W(e){I.value=e;const l=w.value.find(l=>l.id===e),t=l?.selectedQuoteId??null;null!==t&&(N.value=t)}function O(e){if(!R.value)return;const l=oe(e);N.value=l??null}function Y(e){if(!e)return"-";try{return new Date(e).toLocaleString()}catch{return e}}async function M(l){if(I.value){g.value=!0;try{await async function(l,t,a){return e(`/rfq/${l}/line-items/${t}/submit`,{method:"POST",body:{selectedQuoteId:a}})}(r.rfqId,I.value,l),a.success(i("rfq.lineItemWorkflow.submitSuccess")),await Q()}catch(t){a.error(D(t)||i("common.operationFailed"))}finally{g.value=!1}}}async function H(e){if(I.value){g.value=!0;try{const l=x.value;if(!l)return;const t={decision:"approved",comments:e.comments,newQuoteId:e.newQuoteId};"pending_director"===l.status&&(await Ae(r.rfqId,I.value,t),a.success(i("rfq.lineItemWorkflow.directorApproveSuccess"))),await Q()}catch(l){a.error(D(l)||i("common.operationFailed"))}finally{g.value=!1}}}async function ee(e){if(I.value){g.value=!0;try{const l=x.value;if(!l)return;const t={decision:"rejected",comments:e};"pending_director"===l.status&&(await Ae(r.rfqId,I.value,t),a.success(i("rfq.lineItemWorkflow.directorRejectSuccess"))),await Q()}catch(l){a.error(D(l)||i("common.operationFailed"))}finally{g.value=!1}}}function le(){A.value&&(0!==F.value.length?$.value=!0:a.warning(i("rfq.pr.noLineItemsSelected")))}function ie(){a.success(i("rfq.pr.generateSuccess")),Q()}return u(()=>r.rfqId,()=>{Q()},{immediate:!0}),L(()=>{Q()}),(e,t)=>{const a=X,r=J,i=h,o=Z,n=K;return b((z(),d("div",gr,[U.value&&P.value?(z(),C(a,{key:0,type:"warning",closable:!1,class:"quote-lock-alert"},{title:v(()=>[y(p(P.value.message),1)]),default:v(()=>[c("p",_r,[c("span",null,p(P.value.submittedCount??0)+"/"+p(P.value.totalInvited??0)+" "+p(e.$t("rfq.quote.quotes")),1),P.value.deadline?(z(),d("span",wr," · "+p(Y(P.value.deadline)),1)):q("",!0)])]),_:1})):q("",!0),c("div",kr,[c("h3",null,p(e.$t("rfq.lineItemWorkflow.title")),1),c("div",Ir,[m(r,{type:"info",size:"large"},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.totalItems",{count:w.value.length})),1)]),_:1}),T.value>0?(z(),C(r,{key:0,type:"warning",size:"large"},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.pendingItems",{count:T.value})),1)]),_:1})):q("",!0),j.value>0?(z(),C(r,{key:1,type:"success",size:"large"},{default:v(()=>[y(p(e.$t("rfq.lineItemWorkflow.completedItems",{count:j.value})),1)]),_:1})):q("",!0),A.value&&F.value.length>0?(z(),C(i,{key:2,type:"primary",icon:f(B),onClick:le},{default:v(()=>[y(p(e.$t("rfq.pr.batchGenerate"))+" ("+p(F.value.length)+") ",1)]),_:1},8,["icon"])):q("",!0)])]),c("div",Cr,[c("div",Nr,[m(ya,{rfq:_.value,"line-items":w.value,quotes:k.value,"selected-line-item-id":I.value,"user-role":S.value,onSelectItem:W,onSelectQuote:O},null,8,["rfq","line-items","quotes","selected-line-item-id","user-role"])]),c("div",$r,[x.value?(z(),C(rr,{key:0,rfq:_.value,"line-item":x.value,"selected-quote":V.value,"user-role":S.value,"price-comparisons":_.value.priceComparisons,onApprove:H,onReject:ee,onSubmit:M,onRefresh:Q,onPriceUploaded:Q},null,8,["rfq","line-item","selected-quote","user-role","price-comparisons"])):(z(),C(o,{key:1,description:e.$t("rfq.lineItemWorkflow.selectItemHint"),"image-size":120},null,8,["description"]))])]),m(hr,{modelValue:$.value,"onUpdate:modelValue":t[0]||(t[0]=e=>$.value=e),"rfq-id":l.rfqId,rfq:_.value,"line-items":E.value,"preselected-item-id":I.value,onSuccess:ie},null,8,["modelValue","rfq-id","rfq","line-items","preselected-item-id"])])),[[n,g.value]])}}}),[["__scopeId","data-v-c493ec09"]]);export{Sr as default};
