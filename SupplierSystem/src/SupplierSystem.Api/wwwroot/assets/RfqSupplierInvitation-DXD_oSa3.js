import{d as e,u as l,h as a,c as t,B as o,C as i,b5 as n,b as s,e as r,j as u,t as p,f as c,k as d,x as m,b4 as v,A as f,aM as g,E as y,z as h,y as w,m as b,H as _,o as S,I as q,_ as V}from"./index-CCqGYNFr.js";import{v as k}from"./el-loading-CeH9dPv-.js";import{E as x}from"./el-alert-BOgZ4qug.js";import{a as C,E}from"./el-col-OyBhPjof.js";/* empty css                 */import{E as N}from"./el-divider-7vUSkRdr.js";import{E as j}from"./el-text-TMhtW17j.js";import{E as I,a as P}from"./el-table-column-DCpf9QO4.js";import"./el-scrollbar-HEKQGe9s.js";import{E as z}from"./el-tag-Bf7VMiNb.js";import{E as R}from"./el-empty-iUxuHyT_.js";import{u as A}from"./useNotification-Dbz2eEEB.js";import"./_baseClone-CCAPxH5k.js";import"./castArray-l0xfRcZR.js";import"./debounce-D6_n1lNn.js";const D={class:"rfq-supplier-invitation"},T={class:"invitation-header"},U={key:0,class:"empty-state"},$={key:1,class:"selected-suppliers"},H={class:"supplier-summary"},O={style:{"font-size":"16px","font-weight":"600"}},B={class:"external-invitation-section"},F={class:"external-form"},L={key:0,class:"external-emails-table",style:{"margin-top":"16px"}},M={key:0},Y={key:0},G={class:"email-summary"},J={key:1,class:"external-empty-hint"},K={class:"supplier-dialog-content"},Q={key:1,class:"search-result-info"},W=V(e({__name:"RfqSupplierInvitation",props:{modelValue:{},externalEmails:{}},emits:["update:modelValue","update:externalEmails"],setup(e,{emit:V}){const W=A(),{t:X}=l(),Z=e,ee=V,le=a(!1),ae=a(""),te=a([]),oe=a([]),ie=a(),ne=a(!1),se=a(null),re=a(new Map),ue=a({email:"",companyName:"",contactPerson:""}),pe=t({get:()=>Z.externalEmails||[],set:e=>ee("update:externalEmails",e)}),ce=t({get:()=>(console.log("[selectedSupplierIds.get] props.modelValue:",Z.modelValue),Z.modelValue),set:e=>{console.log("[selectedSupplierIds.set] Emitting update:modelValue with:",e),ee("update:modelValue",e),console.log("[selectedSupplierIds.set] After emit, props.modelValue:",Z.modelValue)}}),de=t(()=>{console.log("[selectedSuppliers] Computing..."),console.log("[selectedSuppliers] selectedSupplierIds:",ce.value),console.log("[selectedSuppliers] Cache size:",re.value.size),console.log("[selectedSuppliers] Cache contents:",Array.from(re.value.entries()));const e=ce.value.map(e=>re.value.get(e)).filter(e=>void 0!==e);return console.log("[selectedSuppliers] Result:",e),e});async function me(e=""){try{ne.value=!0;const l={forRfq:!0,limit:100};e&&e.trim()&&(l.q=e.trim());const a=(await n(l)).data||[],t=ce.value,o=t.map(e=>re.value.get(e)).filter(e=>void 0!==e),i=new Set(a.map(e=>e.id)),s=o.filter(e=>!i.has(e.id));te.value=[...s,...a],a.forEach(e=>{t.includes(e.id)&&!re.value.has(e.id)&&re.value.set(e.id,e)})}catch(l){W.error(X("rfq.invitation.loadSuppliersError"))}finally{ne.value=!1}}function ve(e){oe.value=e}function fe(){console.log("[confirmSelection] START"),console.log("[confirmSelection] tempSelection:",oe.value),console.log("[confirmSelection] selectedSupplierIds BEFORE:",ce.value);const e=oe.value.map(e=>e.id);oe.value.forEach(e=>{re.value.set(e.id,e)}),console.log("[confirmSelection] Cache after update:",Array.from(re.value.entries()));const l=[...new Set([...ce.value,...e])];console.log("[confirmSelection] updatedIds:",l),ce.value=l,console.log("[confirmSelection] selectedSupplierIds AFTER:",ce.value),console.log("[confirmSelection] props.modelValue:",Z.modelValue),le.value=!1,W.success(X("rfq.invitation.suppliersAdded",{count:oe.value.length}))}function ge(){const e=ue.value.email.trim();if(!e)return void W.warning(X("rfq.invitation.emailRequired"));/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?pe.value.some(l=>l.email.toLowerCase()===e.toLowerCase())?W.warning(X("rfq.invitation.emailDuplicate")):(pe.value=[...pe.value,{email:e,companyName:ue.value.companyName.trim()||void 0,contactPerson:ue.value.contactPerson.trim()||void 0}],ue.value={email:"",companyName:"",contactPerson:""},W.success(X("rfq.invitation.emailAdded"))):W.warning(X("rfq.invitation.emailInvalid"))}return o(ae,e=>{le.value&&(null!==se.value&&clearTimeout(se.value),se.value=window.setTimeout(()=>{me(e)},500))}),o(le,e=>{console.log("[showSupplierDialog watch] isOpen:",e),console.log("[showSupplierDialog watch] selectedSupplierIds:",ce.value),console.log("[showSupplierDialog watch] props.modelValue:",Z.modelValue),console.log("[showSupplierDialog watch] Cache size:",re.value.size),e?(ae.value="",me()):(null!==se.value&&(clearTimeout(se.value),se.value=null),console.log("[showSupplierDialog watch] Resetting tempSelection"),oe.value=[])}),o([le,te],([e,l])=>{e&&l.length>0&&ie.value&&q(()=>{ie.value&&(ie.value.clearSelection(),l.forEach(e=>{ce.value.includes(e.id)&&ie.value.toggleRowSelection(e,!0)}))})}),i(async()=>{await me()}),o(()=>Z.modelValue,async(e,l)=>{if(void 0===l&&e.length>0){e.filter(e=>!re.value.has(e)).length>0&&await me()}},{immediate:!0}),(e,l)=>{const a=f,t=R,o=I,i=z,n=P,q=j,V=N,A=y,Z=C,ee=E,se=x,me=_,ye=k;return S(),s("div",D,[r("div",T,[r("h3",null,p(c(X)("rfq.invitation.selectSuppliers")),1),u(a,{type:"primary",icon:c(v),onClick:l[0]||(l[0]=e=>le.value=!0)},{default:d(()=>[m(p(ce.value.length>0?c(X)("rfq.invitation.addSuppliers")+`(已选择${ce.value.length}项)`:c(X)("rfq.invitation.addSuppliers")),1)]),_:1},8,["icon"])]),0===de.value.length?(S(),s("div",U,[u(t,{description:c(X)("rfq.invitation.noSuppliersSelected")},{default:d(()=>[u(a,{type:"primary",onClick:l[1]||(l[1]=e=>le.value=!0)},{default:d(()=>[m(p(c(X)("rfq.invitation.selectNow")),1)]),_:1})]),_:1},8,["description"])])):(S(),s("div",$,[u(n,{data:de.value,style:{width:"100%"}},{default:d(()=>[u(o,{prop:"companyName",label:c(X)("supplier.companyName"),"min-width":"200"},null,8,["label"]),u(o,{prop:"companyId",label:c(X)("supplier.companyId"),width:"150"},null,8,["label"]),u(o,{prop:"stage",label:c(X)("supplier.stage"),width:"120"},{default:d(({row:e})=>[u(i,{type:"temporary"===e.stage?"warning":"success",size:"small"},{default:d(()=>[m(p(c(X)(`supplier.stages.${e.stage??"null"}`)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),u(o,{prop:"category",label:c(X)("supplier.category"),width:"150"},null,8,["label"]),u(o,{label:c(X)("common.actions"),width:"100",align:"center"},{default:d(({row:e})=>[u(a,{type:"danger",icon:c(g),size:"small",link:"",onClick:l=>{return a=e.id,ce.value=ce.value.filter(e=>e!==a),re.value.delete(a),void W.success(X("rfq.invitation.supplierRemoved"));var a}},{default:d(()=>[m(p(c(X)("common.remove")),1)]),_:1},8,["icon","onClick"])]),_:1},8,["label"])]),_:1},8,["data"]),r("div",H,[u(q,{type:"info"},{default:d(()=>[m(p(c(X)("rfq.invitation.selectedCount",{count:de.value.length})),1)]),_:1})])])),u(V,{"content-position":"left"},{default:d(()=>[r("span",O,p(c(X)("rfq.invitation.externalSuppliers")),1)]),_:1}),r("div",B,[r("div",F,[u(ee,{gutter:12},{default:d(()=>[u(Z,{span:8},{default:d(()=>[u(A,{modelValue:ue.value.email,"onUpdate:modelValue":l[2]||(l[2]=e=>ue.value.email=e),placeholder:c(X)("rfq.invitation.emailPlaceholder"),clearable:""},{prepend:d(()=>[m(p(c(X)("rfq.invitation.email")),1)]),_:1},8,["modelValue","placeholder"])]),_:1}),u(Z,{span:6},{default:d(()=>[u(A,{modelValue:ue.value.companyName,"onUpdate:modelValue":l[3]||(l[3]=e=>ue.value.companyName=e),placeholder:c(X)("rfq.invitation.companyNamePlaceholder"),clearable:""},{prepend:d(()=>[m(p(c(X)("rfq.invitation.companyName")),1)]),_:1},8,["modelValue","placeholder"])]),_:1}),u(Z,{span:6},{default:d(()=>[u(A,{modelValue:ue.value.contactPerson,"onUpdate:modelValue":l[4]||(l[4]=e=>ue.value.contactPerson=e),placeholder:c(X)("rfq.invitation.contactPersonPlaceholder"),clearable:""},{prepend:d(()=>[m(p(c(X)("rfq.invitation.contactPerson")),1)]),_:1},8,["modelValue","placeholder"])]),_:1}),u(Z,{span:4},{default:d(()=>[u(a,{type:"primary",onClick:ge,style:{width:"100%"}},{default:d(()=>[m(p(c(X)("rfq.invitation.addEmail")),1)]),_:1})]),_:1})]),_:1})]),pe.value.length>0?(S(),s("div",L,[u(n,{data:pe.value,style:{width:"100%"}},{default:d(()=>[u(o,{prop:"email",label:c(X)("rfq.invitation.email"),"min-width":"200"},null,8,["label"]),u(o,{prop:"companyName",label:c(X)("rfq.invitation.companyName"),"min-width":"150"},{default:d(({row:e})=>[e.companyName?(S(),s("span",M,p(e.companyName),1)):(S(),h(q,{key:1,type:"info",size:"small"},{default:d(()=>[...l[8]||(l[8]=[m("-",-1)])]),_:1}))]),_:1},8,["label"]),u(o,{prop:"contactPerson",label:c(X)("rfq.invitation.contactPerson"),"min-width":"150"},{default:d(({row:e})=>[e.contactPerson?(S(),s("span",Y,p(e.contactPerson),1)):(S(),h(q,{key:1,type:"info",size:"small"},{default:d(()=>[...l[9]||(l[9]=[m("-",-1)])]),_:1}))]),_:1},8,["label"]),u(o,{label:c(X)("common.actions"),width:"100",align:"center"},{default:d(({row:e})=>[u(a,{type:"danger",icon:c(g),size:"small",link:"",onClick:l=>{return a=e.email,pe.value=pe.value.filter(e=>e.email!==a),void W.success(X("rfq.invitation.emailRemoved"));var a}},{default:d(()=>[m(p(c(X)("common.remove")),1)]),_:1},8,["icon","onClick"])]),_:1},8,["label"])]),_:1},8,["data"]),r("div",G,[u(q,{type:"info"},{default:d(()=>[m(p(c(X)("rfq.invitation.externalEmailCount",{count:pe.value.length})),1)]),_:1})])])):(S(),s("div",J,[u(q,{type:"info",size:"small"},{default:d(()=>[m(p(c(X)("rfq.invitation.externalEmailHint")),1)]),_:1})]))]),u(me,{modelValue:le.value,"onUpdate:modelValue":l[7]||(l[7]=e=>le.value=e),title:c(X)("rfq.invitation.selectSuppliers"),width:"900px","close-on-click-modal":!1},{footer:d(()=>[u(a,{onClick:l[6]||(l[6]=e=>le.value=!1)},{default:d(()=>[m(p(c(X)("common.cancel")),1)]),_:1}),u(a,{type:"primary",onClick:fe},{default:d(()=>[m(p(c(X)("common.confirm"))+" ("+p(oe.value.length)+") ",1)]),_:1})]),default:d(()=>[r("div",K,[u(A,{modelValue:ae.value,"onUpdate:modelValue":l[5]||(l[5]=e=>ae.value=e),placeholder:c(X)("rfq.invitation.searchSuppliers"),"prefix-icon":c(v),clearable:"",style:{"margin-bottom":"16px"}},null,8,["modelValue","placeholder","prefix-icon"]),ae.value||0!==te.value.length?w("",!0):(S(),h(se,{key:0,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:d(()=>[m(p(c(X)("rfq.invitation.searchHint")),1)]),_:1})),b((S(),h(n,{ref_key:"tableRef",ref:ie,data:te.value,onSelectionChange:ve,"max-height":"400px","row-key":"id"},{default:d(()=>[u(o,{type:"selection",width:"55","reserve-selection":!0}),u(o,{prop:"companyName",label:c(X)("supplier.companyName"),"min-width":"180"},null,8,["label"]),u(o,{prop:"companyId",label:c(X)("supplier.companyId"),width:"120"},null,8,["label"]),u(o,{prop:"stage",label:c(X)("supplier.stage"),width:"100"},{default:d(({row:e})=>[u(i,{type:"temporary"===e.stage?"warning":"success",size:"small"},{default:d(()=>[m(p(c(X)(`supplier.stages.${e.stage??"null"}`)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),u(o,{prop:"category",label:c(X)("supplier.category"),width:"120"},null,8,["label"]),u(o,{prop:"region",label:c(X)("supplier.region"),width:"100"},null,8,["label"])]),_:1},8,["data"])),[[ye,ne.value]]),te.value.length>0?(S(),s("div",Q,[u(q,{type:"info",size:"small"},{default:d(()=>[m(p(c(X)("rfq.invitation.searchResultCount",{count:te.value.length})),1)]),_:1})])):w("",!0)])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-e45898ac"]]);export{W as default};
