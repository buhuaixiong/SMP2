import{W as e,d as a,h as l,c as s,C as t,b as r,j as o,k as u,H as d,A as i,x as n,O as c,f as m,aY as p,e as v,ag as f,z as g,y,F as _,r as h,t as b,E as w,aZ as V,a4 as k,R as j,a0 as S,P as T,Z as M,aM as x,a_ as E,q as P,o as U,_ as N}from"./index-BvBqerML.js";import{a as C,E as q}from"./el-table-column-BDlBRaH7.js";import"./el-scrollbar-DxKOmehB.js";import{E as z}from"./el-tag-CQCG2cqX.js";import{E as F}from"./el-card-w4rvP2gj.js";import{E as L,a as A}from"./el-form-item-Co_AiMYC.js";import{E as O}from"./el-space-Cuc2GxMp.js";import{E as R}from"./el-link-By0ttYls.js";import{E as $}from"./el-switch-oZP41S1V.js";/* empty css                 */import{E as B}from"./el-input-number-DbCPwvje.js";import{E as H,a as W}from"./el-select-C1K6T0CN.js";import{E as Y}from"./el-alert-4ZKBtufh.js";import{P as Z}from"./PageHeader-B9bazl_i.js";import{u as D}from"./useNotification-kSmgsM5O.js";import"./_baseClone-E152d4sm.js";import"./castArray-Ba2iVpgQ.js";import"./debounce-Btf_H3_4.js";import"./index-CD4A5jnZ.js";const I={class:"email-settings-container"},G={class:"header-content"},J={class:"card-header"},K={class:"provider-option"},Q={key:0,class:"help-text"},X={class:"card-header"},ee=N(a({__name:"EmailSettingsView",setup(a){const N=D(),ee=P(),ae=l(),le=l(!1),se=l(!1),te=l(!1),re=l(!1),oe=l(""),ue=l({configured:!1,provider:null,host:"",port:587,secure:!1,user:"",from:"",fromName:"Supplier Management System",testMode:!1,hasPassword:!1}),de=l({provider:"sendgrid",host:"",port:587,secure:!1,user:"",password:"",from:"",fromName:"Supplier Management System",testMode:!1}),ie=l([]),ne=l([]),ce=s(()=>ie.value.find(e=>e.id===de.value.provider)),me=s(()=>"custom"!==de.value.provider),pe=s(()=>de.value.host&&de.value.user&&de.value.password),ve={provider:[{required:!0,message:"请选择邮件服务商",trigger:"change"}],host:[{required:!0,message:"请输入SMTP服务器地址",trigger:"blur"}],port:[{required:!0,message:"请输入端口号",trigger:"blur"}],user:[{required:!0,message:"请输入用户名",trigger:"blur"}],from:[{required:!0,message:"请输入发件人邮箱",trigger:"blur"},{type:"email",message:"请输入有效的邮箱地址",trigger:"blur"}],fromName:[{required:!0,message:"请输入发件人名称",trigger:"blur"}]},fe=()=>{ee.back()},ge=()=>{const e=ce.value;e&&"custom"!==e.id&&(de.value.host=e.host,de.value.port=e.port,de.value.secure=e.secure)},ye=async()=>{ae.value&&await ae.value.validate(async a=>{if(a)try{se.value=!0,await async function(a){return(await e("/email-settings",{method:"PUT",body:a})).data}(de.value),N.success("SMTP配置保存成功"),await we()}catch(l){console.error("Failed to save SMTP config:",l),N.error(l.message||"保存配置失败")}finally{se.value=!1}})},_e=()=>{re.value=!0},he=async()=>{if(!oe.value)return void N.warning("请输入测试邮箱地址");if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(oe.value))if(!pe.value||ue.value.configured)try{te.value=!0;const a=await async function(a){return await e("/email-settings/test",{method:"POST",body:{testEmail:a}})}(oe.value);a.success?(N.success("测试邮件发送成功！请检查收件箱。"),re.value=!1,oe.value=""):N.error(`测试失败: ${a.error||a.message}`)}catch(a){console.error("Test email failed:",a),N.error(a.message||"发送测试邮件失败")}finally{te.value=!1}else N.warning("请先保存配置");else N.error("请输入有效的邮箱地址")},be=async()=>{try{await N.confirm("删除配置后，系统将无法发送邮件通知。确定要删除吗？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await async function(){await e("/email-settings",{method:"DELETE"})}(),N.success("配置已删除"),await we()}catch(a){"cancel"!==a&&(console.error("Failed to delete config:",a),N.error(a.message||"删除配置失败"))}},we=async()=>{try{le.value=!0,ue.value=await async function(){return(await e("/email-settings")).data}(),ue.value.configured&&(de.value={provider:ue.value.provider||"custom",host:ue.value.host,port:ue.value.port,secure:ue.value.secure,user:ue.value.user,password:"",from:ue.value.from,fromName:ue.value.fromName,testMode:ue.value.testMode})}catch(a){console.error("Failed to load SMTP config:",a),N.error("加载配置失败")}finally{le.value=!1}},Ve=async()=>{try{ie.value=await async function(){return(await e("/email-settings/providers")).data}()}catch(a){console.error("Failed to load providers:",a)}},ke=async()=>{try{const a=await async function(){return(await e("/email-settings/templates")).data}();ne.value=a.map(e=>({...e,variables:Array.isArray(e.variables)?e.variables:[]}))}catch(a){console.error("Failed to load templates:",a)}};return t(()=>{we(),Ve(),ke()}),(e,a)=>{const l=c,s=i,t=z,P=Y,N=W,D=H,ee=A,le=w,we=B,Ve=$,ke=R,je=O,Se=L,Te=F,Me=q,xe=C,Ee=d;return U(),r("div",I,[o(Z,null,{title:u(()=>[v("div",G,[o(l,{class:"header-icon"},{default:u(()=>[o(m(f))]),_:1}),a[12]||(a[12]=v("span",{class:"header-title"},"邮件服务配置",-1))])]),actions:u(()=>[o(s,{link:"",class:"back-button",onClick:fe},{default:u(()=>[o(l,null,{default:u(()=>[o(m(p))]),_:1}),a[13]||(a[13]=n(" 返回 ",-1))]),_:1})]),_:1}),o(Te,{class:"settings-card",shadow:"never"},{header:u(()=>[v("div",J,[a[16]||(a[16]=v("span",null,"SMTP 服务配置",-1)),ue.value.configured?(U(),g(t,{key:0,type:"success",effect:"dark"},{default:u(()=>[...a[14]||(a[14]=[n("已配置",-1)])]),_:1})):(U(),g(t,{key:1,type:"warning",effect:"dark"},{default:u(()=>[...a[15]||(a[15]=[n("未配置",-1)])]),_:1}))])]),default:u(()=>[ue.value.configured?y("",!0):(U(),g(P,{key:0,title:"邮件服务未配置",type:"warning",description:"系统需要配置SMTP服务才能发送邮件通知。请选择邮件服务提供商并填写相关配置。",closable:!1,"show-icon":"",class:"alert-box"})),o(Se,{ref_key:"formRef",ref:ae,model:de.value,rules:ve,"label-width":"140px",class:"settings-form"},{default:u(()=>[o(ee,{label:"邮件服务商",prop:"provider"},{default:u(()=>[o(D,{modelValue:de.value.provider,"onUpdate:modelValue":a[0]||(a[0]=e=>de.value.provider=e),placeholder:"请选择邮件服务商",onChange:ge,class:"full-width"},{default:u(()=>[(U(!0),r(_,null,h(ie.value,e=>(U(),g(N,{key:e.id,label:e.name,value:e.id},{default:u(()=>[v("div",K,[v("span",null,b(e.name),1),"sendgrid"===e.id||"aws-ses"===e.id?(U(),g(t,{key:0,type:"success",size:"small"},{default:u(()=>[...a[17]||(a[17]=[n("企业推荐",-1)])]),_:1})):y("",!0)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),ce.value&&ce.value.note?(U(),g(P,{key:0,title:ce.value.note,type:"info",closable:!1,"show-icon":"",class:"provider-note"},null,8,["title"])):y("",!0),o(ee,{label:"SMTP 服务器",prop:"host"},{default:u(()=>[o(le,{modelValue:de.value.host,"onUpdate:modelValue":a[1]||(a[1]=e=>de.value.host=e),placeholder:"例如: smtp.sendgrid.net",disabled:me.value&&"custom"!==de.value.provider},{prepend:u(()=>[o(l,null,{default:u(()=>[o(m(V))]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),o(ee,{label:"端口",prop:"port"},{default:u(()=>[o(we,{modelValue:de.value.port,"onUpdate:modelValue":a[2]||(a[2]=e=>de.value.port=e),min:1,max:65535,disabled:me.value&&"custom"!==de.value.provider,class:"full-width"},null,8,["modelValue","disabled"])]),_:1}),o(ee,{label:"SSL/TLS"},{default:u(()=>[o(Ve,{modelValue:de.value.secure,"onUpdate:modelValue":a[3]||(a[3]=e=>de.value.secure=e),disabled:me.value&&"custom"!==de.value.provider,"active-text":"启用 (端口 465)","inactive-text":"STARTTLS (端口 587)"},null,8,["modelValue","disabled"])]),_:1}),o(ee,{label:"用户名",prop:"user"},{default:u(()=>[o(le,{modelValue:de.value.user,"onUpdate:modelValue":a[4]||(a[4]=e=>de.value.user=e),placeholder:ce.value?.userLabel||"请输入SMTP用户名"},{prepend:u(()=>[o(l,null,{default:u(()=>[o(m(k))]),_:1})]),_:1},8,["modelValue","placeholder"])]),_:1}),o(ee,{label:"密码",prop:"password"},{default:u(()=>[o(le,{modelValue:de.value.password,"onUpdate:modelValue":a[5]||(a[5]=e=>de.value.password=e),type:"password","show-password":"",placeholder:ue.value.hasPassword?"留空则保持不变":ce.value?.passwordLabel||"请输入SMTP密码"},{prepend:u(()=>[o(l,null,{default:u(()=>[o(m(j))]),_:1})]),_:1},8,["modelValue","placeholder"]),ce.value?.docs?(U(),r("div",Q,[o(ke,{href:ce.value.docs,type:"primary",target:"_blank",underline:!1},{default:u(()=>[o(l,null,{default:u(()=>[o(m(S))]),_:1}),a[18]||(a[18]=n(" 查看配置文档 ",-1))]),_:1},8,["href"])])):y("",!0)]),_:1}),o(ee,{label:"发件人邮箱",prop:"from"},{default:u(()=>[o(le,{modelValue:de.value.from,"onUpdate:modelValue":a[6]||(a[6]=e=>de.value.from=e),placeholder:"例如: noreply@company.com"},{prepend:u(()=>[o(l,null,{default:u(()=>[o(m(f))]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(ee,{label:"发件人名称",prop:"fromName"},{default:u(()=>[o(le,{modelValue:de.value.fromName,"onUpdate:modelValue":a[7]||(a[7]=e=>de.value.fromName=e),placeholder:"例如: 供应商管理系统"},null,8,["modelValue"])]),_:1}),o(ee,{label:"测试模式"},{default:u(()=>[o(Ve,{modelValue:de.value.testMode,"onUpdate:modelValue":a[8]||(a[8]=e=>de.value.testMode=e),"active-text":"启用 (邮件不会真实发送)","inactive-text":"关闭 (生产模式)"},null,8,["modelValue"])]),_:1}),o(ee,null,{default:u(()=>[o(je,null,{default:u(()=>[o(s,{type:"primary",loading:se.value,onClick:ye},{default:u(()=>[o(l,null,{default:u(()=>[o(m(T))]),_:1}),a[19]||(a[19]=n(" 保存配置 ",-1))]),_:1},8,["loading"]),o(s,{loading:te.value,onClick:_e,disabled:!ue.value.configured&&!pe.value},{default:u(()=>[o(l,null,{default:u(()=>[o(m(M))]),_:1}),a[20]||(a[20]=n(" 发送测试邮件 ",-1))]),_:1},8,["loading","disabled"]),ue.value.configured?(U(),g(s,{key:0,type:"danger",plain:"",onClick:be},{default:u(()=>[o(l,null,{default:u(()=>[o(m(x))]),_:1}),a[21]||(a[21]=n(" 删除配置 ",-1))]),_:1})):y("",!0)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),o(Te,{class:"templates-card",shadow:"never"},{header:u(()=>[v("div",X,[a[22]||(a[22]=v("span",null,"邮件模板列表",-1)),o(t,null,{default:u(()=>[n(b(ne.value.length)+" 个模板",1)]),_:1})])]),default:u(()=>[o(xe,{data:ne.value,stripe:""},{default:u(()=>[o(Me,{prop:"name",label:"模板名称",width:"200"}),o(Me,{prop:"description",label:"说明","min-width":"300"}),o(Me,{prop:"category",label:"类别",width:"100"},{default:u(({row:e})=>["rfq"===e.category?(U(),g(t,{key:0,type:"primary",size:"small"},{default:u(()=>[...a[23]||(a[23]=[n("询价",-1)])]),_:1})):"contract"===e.category?(U(),g(t,{key:1,type:"warning",size:"small"},{default:u(()=>[...a[24]||(a[24]=[n("合同",-1)])]),_:1})):"document"===e.category?(U(),g(t,{key:2,type:"info",size:"small"},{default:u(()=>[...a[25]||(a[25]=[n("文档",-1)])]),_:1})):(U(),g(t,{key:3,size:"small"},{default:u(()=>[...a[26]||(a[26]=[n("其他",-1)])]),_:1}))]),_:1}),o(Me,{label:"变量","min-width":"200"},{default:u(({row:e})=>[(U(!0),r(_,null,h(e.variables.slice(0,3),e=>(U(),g(t,{key:e,size:"small",class:"variable-tag"},{default:u(()=>[n(b(e),1)]),_:2},1024))),128)),e.variables.length>3?(U(),g(t,{key:0,size:"small",type:"info"},{default:u(()=>[n(" +"+b(e.variables.length-3),1)]),_:2},1024)):y("",!0)]),_:1})]),_:1},8,["data"])]),_:1}),o(Ee,{modelValue:re.value,"onUpdate:modelValue":a[11]||(a[11]=e=>re.value=e),title:"发送测试邮件",width:"500px"},{footer:u(()=>[o(s,{onClick:a[10]||(a[10]=e=>re.value=!1)},{default:u(()=>[...a[27]||(a[27]=[n("取消",-1)])]),_:1}),o(s,{type:"primary",loading:te.value,onClick:he},{default:u(()=>[o(l,null,{default:u(()=>[o(m(E))]),_:1}),a[28]||(a[28]=n(" 发送测试邮件 ",-1))]),_:1},8,["loading"])]),default:u(()=>[o(Se,null,{default:u(()=>[o(ee,{label:"收件人邮箱"},{default:u(()=>[o(le,{modelValue:oe.value,"onUpdate:modelValue":a[9]||(a[9]=e=>oe.value=e),placeholder:"请输入接收测试邮件的邮箱地址",type:"email"},{prepend:u(()=>[o(l,null,{default:u(()=>[o(m(f))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-85d21b1d"]]);export{ee as default};
