# 批量标签分配和按标签分配供应商功能使用指南

## 概述

系统现已支持两项核心批量操作功能：

1. **批量标签分配**：在供应商目录中批量为多个供应商添加或移除标签
2. **按标签分配供应商给采购员**：根据标签批量分配供应商到指定采购员

---

## 功能 1: 批量标签分配

### 访问位置
**供应商目录** (`/suppliers`)

### 使用步骤

#### 1. 选择供应商
- 在供应商列表的第一列，您会看到复选框
- 勾选表头的复选框可以选择当前页的所有供应商
- 也可以单独勾选需要操作的供应商
- 已选择的供应商行会以蓝色背景高亮显示

![选择供应商示例]
```
✓ | 公司名称 | 类别 | 地区 | ...
---------------------------
☑ | ABC公司  | 电子 | 北京 | ...  ← 已选中
☐ | XYZ公司  | 机械 | 上海 | ...
☑ | DEF公司  | 化工 | 广州 | ...  ← 已选中
```

#### 2. 批量操作工具栏
当选择一个或多个供应商后，页面顶部会出现紫色渐变的批量操作工具栏：

```
✓ 已选择 3 个供应商  [批量添加标签] [批量移除标签] [清除选择]
```

#### 3. 批量添加标签
1. 点击「批量添加标签」按钮
2. 在弹出的对话框中，从下拉列表选择一个或多个标签
3. 标签以彩色圆点显示，便于识别
4. 点击「确定添加」
5. 系统将为所有选中的供应商批量添加标签
6. 操作完成后显示成功消息（如："成功为 3 个供应商添加了 2 个标签"）

#### 4. 批量移除标签
1. 点击「批量移除标签」按钮
2. 在弹出的对话框中，选择要移除的标签
3. 点击「确定移除」
4. 系统将从所有选中的供应商中移除指定标签
5. 显示操作结果

### 权限要求
- **角色**: Admin（管理员）或 Procurement Manager（采购经理）
- **权限代码**: `admin.tags.manage` (ADMIN_SUPPLIER_TAGS)

### API端点
- **批量添加**: `POST /api/suppliers/tags/:tagId/batch-assign`
- **批量移除**: `POST /api/suppliers/tags/:tagId/batch-remove`

### 特性
✅ 支持跨页选择（选择状态在翻页时保持）
✅ 实时显示已选择数量
✅ 支持同时添加/移除多个标签
✅ 自动去重（避免重复添加标签）
✅ 详细的操作反馈（成功/失败计数）
✅ 完整的审计日志记录

---

## 功能 2: 按标签分配供应商给采购员

### 访问位置
**权限管理 > 采购员分配** (`/admin/permissions` → Delegations 标签页)

### 使用步骤

#### 1. 选择采购员
- 在左侧买家列表中选择一个采购员
- 右侧将显示该采购员当前负责的供应商列表

#### 2. 按标签批量分配
在「添加供应商」区域，您会看到两个部分：

**方式一：按标签批量分配** （推荐，快速）
```
📌 按标签批量分配
┌─────────────────────────────────┐
│ [VIP供应商      ]  [按标签分配]  │
│ [重点关注        ]                │
│ [长期合作伙伴   ]                │
└─────────────────────────────────┘
将分配所有包含所选标签的供应商到当前采购员
```

**操作步骤**:
1. 在多选下拉框中选择一个或多个标签
2. 系统会提示将分配的供应商数量
3. 点击「按标签分配」按钮
4. 系统自动找到所有拥有这些标签的供应商，并批量分配给当前采购员
5. 显示成功消息（如："成功分配 15 个供应商到采购员 张三"）

**方式二：搜索单个供应商** （传统方式）
```
🔍 搜索单个供应商
┌─────────────────────────────────┐
│ 搜索供应商名称...    [搜索]      │
└─────────────────────────────────┘
```

#### 3. 查看分配结果
- 分配完成后，供应商列表会自动刷新
- 可以看到新分配的供应商出现在「负责供应商」列表中
- 每个供应商旁边有访问权限设置（资料访问、合同提醒）

### 权限要求
- **角色**: Admin（管理员）
- **权限代码**: `admin.buyer_assignments.manage` (ADMIN_BUYER_ASSIGNMENTS_MANAGE)

### API端点
- **按标签分配**: `POST /api/buyer-assignments/by-tag`
  ```json
  {
    "buyerId": "purch001",
    "tagIds": [1, 2, 3]
  }
  ```
- **查询分配**: `GET /api/buyer-assignments/suppliers?buyerId=xxx`
- **移除分配**: `DELETE /api/buyer-assignments/:id`

### 特性
✅ 支持多标签批量分配（交集逻辑）
✅ 自动去重（避免重复分配）
✅ 实时更新分配列表
✅ 显示分配统计（分配数量/总供应商数）
✅ 完整的审计日志
✅ 支持撤销（可单独移除分配）

---

## 使用场景示例

### 场景 1: 新供应商批量分类
**目标**: 为刚注册的10个电子产品供应商添加"新供应商"和"电子类"标签

**步骤**:
1. 进入供应商目录
2. 筛选显示最近注册的供应商
3. 勾选需要添加标签的10个供应商
4. 点击「批量添加标签」
5. 选择"新供应商"和"电子类"标签
6. 确认，系统自动完成

**结果**: ✅ 10个供应商同时获得2个标签，节省20次单独操作

---

### 场景 2: VIP供应商分配给专属采购员
**目标**: 将所有VIP供应商分配给高级采购员李四管理

**步骤**:
1. 进入权限管理 → Delegations
2. 选择采购员"李四"
3. 在「按标签批量分配」区域选择"VIP供应商"标签
4. 点击「按标签分配」
5. 系统自动找到25个VIP供应商并全部分配给李四

**结果**: ✅ 一键完成25个供应商的分配，替代逐个搜索添加

---

### 场景 3: 供应商分类管理重组
**目标**: 将"长期合作"和"战略供应商"两个标签下的所有供应商重新分配给新的采购团队负责人

**步骤**:
1. 权限管理 → 选择新负责人
2. 勾选"长期合作"和"战略供应商"两个标签
3. 执行按标签分配
4. 系统合并两个标签的供应商（去重后）进行分配

**结果**: ✅ 快速完成组织架构调整，确保供应商管理无缝衔接

---

## 技术架构

### 前端组件
- **SupplierTable.vue**: 添加了复选框列和批量选择逻辑
- **SupplierDirectoryView.vue**: 批量操作工具栏和对话框
- **AdminPermissionsView.vue**: 按标签分配供应商UI

### 后端API
| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/suppliers/tags/:tagId/batch-assign` | POST | 批量添加标签 |
| `/api/suppliers/tags/:tagId/batch-remove` | POST | 批量移除标签 |
| `/api/buyer-assignments/by-tag` | POST | 按标签分配供应商 |
| `/api/suppliers/tags/:tagId/suppliers` | GET | 查询标签关联的供应商 |

### 数据库表
- **supplier_tag_mappings**: 供应商-标签映射（多对多）
- **buyer_supplier_assignments**: 买家-供应商分配关系
- **audit_log**: 所有操作的审计记录

### 权限控制
```javascript
// 标签管理权限
Permissions.ADMIN_SUPPLIER_TAGS = 'admin.tags.manage'
// 角色: admin, procurement_manager

// 买家分配管理权限
Permissions.ADMIN_BUYER_ASSIGNMENTS_MANAGE = 'admin.buyer_assignments.manage'
// 角色: admin
```

---

## 审计日志

所有批量操作都会记录详细的审计日志：

### 批量标签分配日志示例
```json
{
  "actorId": "admin001",
  "actorName": "Alex Administrator",
  "entityType": "tag",
  "entityId": "5",
  "action": "batch_assign_suppliers",
  "changes": {
    "tagName": "VIP供应商",
    "supplierIds": [101, 102, 103, 104, 105],
    "added": 5,
    "skipped": 0
  },
  "timestamp": "2025-10-20T10:30:00Z"
}
```

### 按标签分配供应商日志示例
```json
{
  "actorId": "admin001",
  "actorName": "Alex Administrator",
  "entityType": "buyer_assignment",
  "entityId": "purch001",
  "action": "assign_by_tags",
  "changes": {
    "buyerId": "purch001",
    "buyerName": "Purchaser 001",
    "tagIds": [1, 3, 5],
    "supplierIds": [10, 15, 20, 25, 30],
    "assignedCount": 5
  },
  "timestamp": "2025-10-20T10:35:00Z"
}
```

---

## 性能优化

### 批量操作性能
- ✅ 使用数据库事务确保原子性
- ✅ `ON CONFLICT DO NOTHING` 避免重复插入异常
- ✅ 批量INSERT减少数据库往返次数
- ✅ 前端并发处理多个标签操作

### 缓存机制
- 买家-供应商分配关系使用内存缓存
- 分配操作后自动重建缓存
- 提供快速的访问权限检查

---

## 常见问题 (FAQ)

### Q1: 批量添加标签时，如果部分供应商已有该标签会怎样？
**A**: 系统会自动跳过已有标签的供应商（幂等性），不会重复添加。操作完成后会显示"添加数"和"跳过数"。

### Q2: 按标签分配时，选择多个标签是"AND"还是"OR"逻辑？
**A**: 当前实现是"OR"逻辑（并集）。选择多个标签会分配所有拥有**任一标签**的供应商。如果需要"AND"逻辑，可以联系技术团队调整。

### Q3: 批量操作会影响已有的标签或分配吗？
**A**: 不会。批量添加标签只会新增标签，不会移除供应商原有的其他标签。按标签分配只会新增分配关系，不会影响买家已有的其他供应商分配。

### Q4: 批量操作失败了怎么办？
**A**: 系统会显示详细的错误信息。如果是部分失败，会显示成功和失败的数量。所有操作都有审计日志，可以追溯。建议联系管理员查看日志。

### Q5: 供应商被分配后，采购员能看到什么？
**A**: 采购员登录后，在供应商目录中只能看到分配给自己的供应商。可以查看供应商资料、合同、文档等信息（根据权限配置）。

### Q6: 如何撤销批量分配的标签？
**A**: 使用「批量移除标签」功能，选择相同的供应商和标签即可批量撤销。

### Q7: 按标签分配的供应商可以单独移除吗？
**A**: 可以。在Delegations页面的"负责供应商"列表中，每个供应商旁边有「移除」按钮，可以单独解除分配。

---

## 更新日志

### v1.0.0 (2025-10-20)
- ✅ 实现批量标签分配功能（添加/移除）
- ✅ 实现按标签分配供应商给采购员功能
- ✅ 添加批量操作UI和工具栏
- ✅ 实现跨页选择支持
- ✅ 添加完整的审计日志
- ✅ 添加权限控制和安全检查

---

## 技术支持

如遇问题，请联系：
- **技术支持**: support@company.com
- **系统管理员**: admin@company.com
- **查看审计日志**: 系统管理 → 审计日志

---

**文档版本**: 1.0.0
**最后更新**: 2025-10-20
**适用系统版本**: Supplier Management System v2.0+
